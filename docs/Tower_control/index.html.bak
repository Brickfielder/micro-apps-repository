<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tower Control ‚Äî Executive Function Trainer</title>
<meta name="description" content="Manage changing protocols and prioritise actions under pressure to train working memory, cognitive flexibility, and inhibition." />
<style>
  /* ===== Micro Apps brand tokens (light first) ===== */
  :root{
    color-scheme: light;
    --bg:#f7f8fb;
    --surface:#ffffff;
    --card:#ffffff;
    --text:#1f2937;         /* slate-800 */
    --muted:#6b7280;        /* slate-500 */
    --line:#e5e7eb;         /* slate-200 */
    --accent:#ff7a6e;       /* softened coral */
    --accent-600:#ff6254;
    --accent-700:#f24f40;
    --pill:#f2f4f7;         /* neutral chip bg */
    --success:#16a34a;
    --warning:#f59e0b;
    --danger:#ef4444;
    --primary:#334155;      /* slate-700 for buttons */
    --radius:16px;
    --shadow:0 10px 30px rgba(2,6,23,0.08);
  }
  @media (prefers-color-scheme: dark){
    :root{
      color-scheme: dark;
      --bg:#0b1020;
      --surface:#111729;
      --card:#0f172a;
      --text:#eef2f7;
      --muted:#98a2b3;
      --line:#20293a;
      --accent:#ff7a6e;
      --accent-600:#ff6254;
      --accent-700:#f24f40;
      --pill:#0e1526;
      --success:#22c55e;
      --warning:#fbbf24;
      --danger:#f87171;
      --primary:#1f2a44;
      --shadow:0 14px 34px rgba(0,0,0,0.35);
    }
  }

  /* ===== Base ===== */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    background:var(--bg);
    color:var(--text);
    line-height:1.5;
  }
  .container{
    min-height:100dvh;
    display:grid;
    grid-template-rows:auto 1fr auto;
  }

  /* ===== Header / hero ===== */
  header{
    border-bottom:1px solid var(--line);
    background:linear-gradient(180deg, var(--surface), var(--card));
  }
  .wrap{max-width:1200px;margin:0 auto;padding:20px 20px 16px}
  .hero{
    display:grid;grid-template-columns:1fr auto;gap:16px;align-items:end;
  }
  .title{
    display:flex;flex-direction:column;gap:8px;
  }
  h1{
    margin:0;
    font-size:clamp(28px,3.2vw,40px);
    letter-spacing:0.2px;
    line-height:1.1;
    font-weight:800;
    background:linear-gradient(90deg, var(--accent) 0%, var(--accent-700) 60%, var(--text) 120%);
    -webkit-background-clip:text;background-clip:text;color:transparent;
  }
  .subtitle{
    margin:0;color:var(--muted);font-size:clamp(14px,1.4vw,16px);
  }
  .badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 12px;border-radius:999px;background:var(--pill);border:1px solid var(--line);
    font-size:12px;color:var(--text)
  }
  .toolbar{
    display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end
  }
  .btn{
    appearance:none;border:1px solid var(--line);background:var(--surface);color:var(--text);
    padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;
    transition:transform .06s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
    box-shadow:0 1px 0 rgba(0,0,0,0.02);
    font-size:14px;
  }
  .btn:hover:not(:disabled){transform:translateY(-1px);background:var(--card)}
  .btn:active:not(:disabled){transform:translateY(0)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.primary{background:var(--accent);border-color:var(--accent-600);color:#fff}
  .btn.warning{background:var(--warning);border-color:var(--warning);color:#111827}
  .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
  .btn.ghost{background:var(--surface)}

  /* ===== Main layout ===== */
  main{
    background:transparent;
  }
  .main-wrap{max-width:1200px;margin:0 auto;padding:16px 20px 24px}
  .grid{
    display:grid;
    grid-template-columns:300px 1fr 320px;
    gap:16px;
  }
  @media (max-width:1100px){
    .grid{grid-template-columns:1fr;gap:12px}
  }
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
  }
  .card.pad{padding:16px}
  .section-title{margin:0 0 10px 0;font-size:15px;letter-spacing:.2px;color:var(--muted);font-weight:700;text-transform:uppercase}

  /* ===== Left panel ===== */
  .instructions{font-size:14px;color:var(--text);background:var(--surface);border:1px solid var(--line);border-radius:12px;padding:12px}
  .protocols{margin-top:12px}
  .protocol-card{
    background:var(--surface);
    border:1px solid var(--line);
    border-radius:12px;padding:12px;margin-bottom:10px
  }
  .protocol-card.active{border-color:var(--warning);box-shadow:0 0 0 3px color-mix(in oklab, var(--warning) 25%, transparent)}

  .queue-item{
    background:var(--surface);
    border:1px dashed var(--line);
    border-left:4px solid var(--accent);
    padding:10px 12px;border-radius:10px;margin-bottom:8px;font-size:13px
  }
  .queue-item.priority{border-left-color:var(--danger)}

  /* ===== Center (radar) ===== */
  .radar-zone{display:flex;align-items:center;justify-content:center;min-height:520px}
  .radar-shell{position:relative; width:min(520px, 100%); aspect-ratio:1/1; border-radius:20px; background:
      radial-gradient(120% 120% at 50% 50%, color-mix(in oklab, var(--accent) 18%, transparent) 0%, transparent 60%),
      var(--surface);
      border:1px solid var(--line); box-shadow:var(--shadow); overflow:hidden}
  .radar-screen{
    position:absolute; inset:16px; border-radius:50%; border:2px solid color-mix(in oklab, var(--accent) 45%, var(--text) 0%);
    background:
      radial-gradient(circle at 50% 50%, color-mix(in oklab, var(--accent) 18%, transparent) 0%, transparent 65%);
  }
  .radar-grid{
    position:absolute; inset:16px; border-radius:50%;
    background:
      conic-gradient(from 0deg, color-mix(in oklab, var(--accent) 40%, transparent) 0deg, transparent 0deg),
      repeating-conic-gradient(color-mix(in oklab, var(--accent) 25%, transparent) 0deg 1deg, transparent 1deg 30deg);
    mask: radial-gradient(circle at center, black 65%, transparent 66%);
    opacity:.35;
  }
  #aircraftContainer{position:absolute; inset:16px}
  .aircraft{
    position:absolute; width:24px; height:24px; border-radius:50%;
    border:2px solid currentColor; display:flex; align-items:center; justify-content:center;
    font-weight:800; font-size:11px; transform:translate(-50%,-50%); cursor:pointer;
    transition:transform .12s ease, box-shadow .12s ease, outline .12s ease;
    outline:2px solid transparent; background:currentColor; color:#fff;
  }
  .aircraft.civilian{color:#3b82f6}
  .aircraft.military{color:#f59e0b}
  .aircraft.emergency{color:#ef4444; animation:pulse 1.1s infinite}
  .aircraft.selected{box-shadow:0 0 0 6px color-mix(in oklab, currentColor 25%, transparent)}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.65}}

  /* ===== Right panel ===== */
  .stats{
    display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:12px
  }
  .stat{
    background:var(--surface); border:1px solid var(--line); border-radius:12px; padding:10px; text-align:center
  }
  .stat .big{font-size:20px;font-variant-numeric:tabular-nums;font-weight:800}
  .aircraft-info{
    background:var(--surface); border:1px solid var(--line); border-radius:12px; padding:10px; margin-bottom:8px; font-size:13px; cursor:pointer
  }
  .aircraft-info.selected{outline:2px solid var(--accent); outline-offset:2px}
  .actions{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px}

  /* ===== Footer ===== */
  footer{
    border-top:1px solid var(--line); color:var(--muted); font-size:13px;
    background:var(--surface)
  }
  .footer-inner{max-width:1200px;margin:0 auto;padding:10px 20px;display:flex;gap:14px;justify-content:center;flex-wrap:wrap}

  /* ===== Modal ===== */
  .modal{
    position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:50
  }
  .modal-content{
    background:var(--card); border:1px solid var(--line); border-radius:20px; padding:22px; max-width:560px; width:92%; text-align:center; box-shadow:var(--shadow)
  }
  .modal-content h3{margin:0 0 8px 0; color:var(--accent)}
  .hidden{display:none !important}

  /* ===== Accessibility helpers ===== */
  .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="wrap hero" role="banner">
        <div class="title">
          <h1 aria-label="Tower Control">Tower Control</h1>
          <p class="subtitle">Executive Function Trainer ‚Ä¢ Micro Rehab Apps</p>
          <div class="badges" aria-hidden="true">
            <span class="pill">üß† Working Memory</span>
            <span class="pill">üîÅ Flexibility</span>
            <span class="pill">üõë Inhibition</span>
          </div>
        </div>
        <div class="toolbar" aria-label="Session controls">
          <button class="btn primary" id="startBtn" aria-controls="main">Start mission</button>
          <button class="btn ghost" id="pauseBtn" disabled>Pause</button>
          <button class="btn danger" id="emergencyBtn" disabled aria-label="Trigger emergency">üö® Emergency</button>
          <button class="btn" id="downloadBtn" aria-label="Export CSV">üìä Export data</button>
        </div>
      </div>
    </header>

    <main id="main" tabindex="-1">
      <div class="main-wrap">
        <div class="grid">
          <!-- LEFT: Instructions / Protocols / Queue -->
          <section class="card pad" aria-labelledby="instTitle">
            <h2 class="section-title" id="instTitle">Mission briefing</h2>
            <div class="instructions">
              <strong>How it works</strong><br/>
              Select aircraft on the radar, then apply the correct action based on the active protocol(s).
              Prioritise emergencies and adapt when rules change.
              <ul>
                <li>Click an aircraft to select</li>
                <li>Use the action buttons to Clear / Land / Hold / Redirect</li>
                <li>Watch the <em>Active Protocols</em> below</li>
              </ul>
            </div>

            <h3 class="section-title" style="margin-top:14px">Active protocols</h3>
            <div id="protocols" class="protocols"></div>

            <h3 class="section-title" style="margin-top:12px">Task queue</h3>
            <div id="taskQueue"></div>
          </section>

          <!-- CENTER: Radar -->
          <section class="card pad radar-zone" aria-labelledby="radarTitle">
            <h2 class="sr-only" id="radarTitle">Radar</h2>
            <div class="radar-shell">
              <div class="radar-screen" aria-hidden="true"></div>
              <div class="radar-grid" aria-hidden="true"></div>
              <div id="aircraftContainer" aria-label="Aircraft positions"></div>
            </div>
          </section>

          <!-- RIGHT: Stats / List / Actions -->
          <aside class="card pad" aria-labelledby="statusTitle">
            <h2 class="section-title" id="statusTitle">Status</h2>
            <div class="stats" role="group" aria-label="Session stats">
              <div class="stat">
                <div>Success Rate</div>
                <div id="successRate" class="big">---%</div>
              </div>
              <div class="stat">
                <div>Completed</div>
                <div id="completed" class="big">0</div>
              </div>
              <div class="stat">
                <div>Working Mem</div>
                <div id="memoryLoad" class="big">0/4</div>
              </div>
            </div>

            <h3 class="section-title">Aircraft</h3>
            <div id="aircraftList" aria-live="polite"></div>

            <div class="actions" role="group" aria-label="Aircraft actions">
              <button class="btn" id="clearBtn" disabled>Clear Route</button>
              <button class="btn" id="landBtn" disabled>Land</button>
              <button class="btn" id="holdBtn" disabled>Hold Pattern</button>
              <button class="btn" id="redirectBtn" disabled>Redirect</button>
            </div>

            <div style="margin-top:14px;">
              <h4 style="margin:0 0 6px 0">Selected: <span id="selectedInfo">None</span></h4>
              <div id="selectedDetails" style="font-size:13px;color:var(--muted)">Click an aircraft to select</div>
            </div>
          </aside>
        </div>
      </div>
    </main>

    <footer>
      <div class="footer-inner">
        <span>Executive Function Training</span>
        <span aria-hidden="true">‚Ä¢</span>
        <span>Working Memory ‚Ä¢ Cognitive Flexibility ‚Ä¢ Inhibitory Control</span>
      </div>
    </footer>
  </div>

  <!-- Modal -->
  <div class="modal" id="resultModal" role="dialog" aria-modal="true" aria-labelledby="resultTitle">
    <div class="modal-content">
      <h3 id="resultTitle">Mission Complete</h3>
      <p id="resultMessage"></p>
      <button class="btn primary" id="nextLevelBtn">Continue</button>
    </div>
  </div>

<script>
/* ===== Game state (kept as in your original) ===== */
let gameState = {
  running:false, paused:false, level:1, score:0, timer:120,
  aircraft:[], protocols:[], tasks:[], selectedAircraft:null,
  completedTasks:0, failedTasks:0, memoryItems:[]
};
let sessionData = { sessions:[], currentSession:null };
let gameLoop=null, protocolChangeInterval=null;

const AIRCRAFT_TYPES = [
  { type:'civilian', emoji:'C', priority:1, color:'#3b82f6' },
  { type:'military', emoji:'M', priority:2, color:'#f59e0b' },
  { type:'emergency', emoji:'E', priority:3, color:'#ef4444' }
];
const PROTOCOLS = [
  { id:'standard',   name:'Standard Operations', rule:'Process aircraft in order of arrival' },
  { id:'priority',   name:'Priority Override',   rule:'Military aircraft have landing priority' },
  { id:'emergency',  name:'Emergency Protocol',  rule:'Emergency aircraft must be cleared immediately' },
  { id:'weather',    name:'Weather Hold',        rule:'All civilian aircraft must hold pattern' },
  { id:'restricted', name:'Airspace Restriction',rule:'No military aircraft in north quadrant' }
];

/* ===== DOM ===== */
const elements = {
  level: document.getElementById('level'),      // not shown in new header; kept for logic reuse if needed
  score: document.getElementById('score'),      // (same)
  timer: document.getElementById('timer'),      // (same)
  startBtn: document.getElementById('startBtn'),
  pauseBtn: document.getElementById('pauseBtn'),
  emergencyBtn: document.getElementById('emergencyBtn'),
  downloadBtn: document.getElementById('downloadBtn'),
  protocols: document.getElementById('protocols'),
  taskQueue: document.getElementById('taskQueue'),
  aircraftContainer: document.getElementById('aircraftContainer'),
  aircraftList: document.getElementById('aircraftList'),
  selectedInfo: document.getElementById('selectedInfo'),
  selectedDetails: document.getElementById('selectedDetails'),
  successRate: document.getElementById('successRate'),
  completed: document.getElementById('completed'),
  memoryLoad: document.getElementById('memoryLoad'),
  clearBtn: document.getElementById('clearBtn'),
  landBtn: document.getElementById('landBtn'),
  holdBtn: document.getElementById('holdBtn'),
  redirectBtn: document.getElementById('redirectBtn'),
  resultModal: document.getElementById('resultModal'),
  resultTitle: document.getElementById('resultTitle'),
  resultMessage: document.getElementById('resultMessage'),
  nextLevelBtn: document.getElementById('nextLevelBtn')
};

/* ===== Init ===== */
function initGame(){ updateDisplay(); setActiveProtocol('standard'); }

/* ===== Start / Pause / Stop ===== */
function startGame(){
  sessionData.currentSession = {
    sessionId: Date.now(),
    startTime: new Date().toISOString(),
    startLevel: gameState.level,
    actions:[], protocolChanges:[], aircraftHandled:[]
  };
  gameState.running = true; gameState.paused = false;
  gameState.timer = 90 + (gameState.level * 30);
  // enable controls
  elements.startBtn.disabled = true;
  elements.pauseBtn.disabled = false;
  elements.emergencyBtn.disabled = false;
  // reset
  gameState.aircraft = []; gameState.tasks = []; gameState.selectedAircraft = null;
  // spawn & loops
  spawnAircraft();
  gameLoop = setInterval(updateGame, 1000);
  protocolChangeInterval = setInterval(changeProtocol, 15000 + Math.random()*10000);
  updateDisplay();
}
function pauseGame(){
  gameState.paused = !gameState.paused;
  elements.pauseBtn.textContent = gameState.paused ? 'Resume' : 'Pause';
}
function stopGame(){
  if (sessionData.currentSession){
    const s = sessionData.currentSession;
    s.endTime = new Date().toISOString();
    s.finalLevel = gameState.level;
    s.finalScore = gameState.score;
    s.completedTasks = gameState.completedTasks;
    s.failedTasks = gameState.failedTasks;
    s.successRate = gameState.completedTasks + gameState.failedTasks > 0
      ? Math.round((gameState.completedTasks/(gameState.completedTasks+gameState.failedTasks))*100) : 100;
    s.duration = Math.floor((Date.now()-s.sessionId)/1000);
    sessionData.sessions.push(s);
    sessionData.currentSession = null;
  }
  gameState.running = false;
  clearInterval(gameLoop); clearInterval(protocolChangeInterval);
  elements.startBtn.disabled = false;
  elements.pauseBtn.disabled = true;
  elements.emergencyBtn.disabled = true;
  showResults();
}

/* ===== Aircraft ===== */
function spawnAircraft(){
  const maxAircraft = Math.min(3 + gameState.level, 8);
  if (gameState.aircraft.length < maxAircraft && Math.random() < 0.7){
    const type = chooseAircraftType();
    const aircraft = createAircraft(type);
    gameState.aircraft.push(aircraft);
    createAircraftElement(aircraft);
    addTask(aircraft);
  }
  setTimeout(spawnAircraft, 2000 + Math.random()*4000);
}
function chooseAircraftType(){
  const r=Math.random();
  if (r < 0.1 + gameState.level*0.05) return AIRCRAFT_TYPES[2];
  if (r < 0.3) return AIRCRAFT_TYPES[1];
  return AIRCRAFT_TYPES[0];
}
function createAircraft(type){
  return {
    id:'aircraft_'+Date.now()+Math.random(),
    type:type.type, emoji:type.emoji, priority:type.priority,
    x: Math.random()* (document.querySelector('.radar-shell').clientWidth - 64) + 32,
    y: Math.random()* (document.querySelector('.radar-shell').clientHeight - 64) + 32,
    status:'approaching', timeRemaining:20+Math.random()*15, selected:false
  };
}
function createAircraftElement(aircraft){
  const el=document.createElement('div');
  el.className=`aircraft ${aircraft.type}`;
  el.id=aircraft.id;
  el.style.left=aircraft.x+'px';
  el.style.top=aircraft.y+'px';
  el.textContent=aircraft.emoji;
  el.setAttribute('role','button');
  el.setAttribute('aria-label', `${aircraft.type} aircraft`);
  el.onclick=()=>selectAircraft(aircraft.id);
  elements.aircraftContainer.appendChild(el);
}
function selectAircraft(id){
  if (gameState.selectedAircraft){
    const prev=document.getElementById(gameState.selectedAircraft);
    if (prev) prev.classList.remove('selected');
  }
  gameState.selectedAircraft=id;
  const el=document.getElementById(id);
  if (el) el.classList.add('selected');
  updateControlButtons(); updateDisplay();
}

/* ===== Protocols ===== */
function setActiveProtocol(protocolId){ gameState.protocols=[protocolId]; updateDisplay(); }
function changeProtocol(){
  if (!gameState.running || gameState.paused) return;
  const avail=PROTOCOLS.filter(p=>!gameState.protocols.includes(p.id));
  if (avail.length>0){
    const np=avail[Math.floor(Math.random()*avail.length)];
    gameState.protocols=[np.id];
    if (sessionData.currentSession){
      sessionData.currentSession.protocolChanges.push({
        timestamp:new Date().toISOString(),
        protocolId:np.id, protocolName:np.name,
        gameTime: 90 + (gameState.level*30) - gameState.timer
      });
    }
    addMemoryItem(`Protocol: ${np.name}`); updateDisplay();
  }
}

/* ===== Tasks / memory ===== */
function addTask(a){
  const t={ id:'task_'+Date.now(), aircraftId:a.id, description:`Handle ${a.type} ${a.emoji}`,
    priority:a.type==='emergency', completed:false, timeAdded:Date.now() };
  gameState.tasks.push(t); addMemoryItem(`New ${a.type}: ${a.emoji}`); updateDisplay();
}
function completeTask(aircraftId){
  const t=gameState.tasks.find(x=>x.aircraftId===aircraftId && !x.completed);
  if (t){
    t.completed=true; gameState.completedTasks++;
    gameState.score += t.priority ? 50 : 25;
    removeMemoryItem(`New ${t.aircraftId}`);
  }
}
function addMemoryItem(item){
  gameState.memoryItems.push(item);
  if (gameState.memoryItems.length > 4 + gameState.level) gameState.memoryItems.shift();
  updateDisplay();
}
function removeMemoryItem(partial){
  gameState.memoryItems = gameState.memoryItems.filter(i=>!i.includes(partial));
  updateDisplay();
}

/* ===== Actions ===== */
function handleLand(){
  const a=gameState.aircraft.find(x=>x.id===gameState.selectedAircraft);
  if (!a) return;
  recordAction('land', a); completeTask(a.id); removeAircraft(a.id); gameState.score+=25;
}
function handleHold(){
  const a=gameState.aircraft.find(x=>x.id===gameState.selectedAircraft);
  if (!a) return;
  recordAction('hold', a); a.status='holding'; a.timeRemaining+=10; gameState.score+=5; updateDisplay();
}
function handleRedirect(){
  const a=gameState.aircraft.find(x=>x.id===gameState.selectedAircraft);
  if (!a) return;
  recordAction('redirect', a); completeTask(a.id); removeAircraft(a.id); gameState.score+=15;
}
function handleClear(){
  const a=gameState.aircraft.find(x=>x.id===gameState.selectedAircraft);
  if (!a) return;
  recordAction('clear', a); a.status='cleared'; gameState.score+=10; updateDisplay();
}
function recordAction(action,a){
  if (!sessionData.currentSession) return;
  const s=sessionData.currentSession;
  s.actions.push({
    timestamp:new Date().toISOString(), action, aircraftType:a.type, aircraftId:a.id,
    gameTime: 90 + (gameState.level*30) - gameState.timer, level:gameState.level,
    currentProtocol: gameState.protocols[0] || 'standard',
    scoreAtTime: gameState.score, memoryLoad: gameState.memoryItems.length
  });
  if (!s.aircraftHandled.find(x=>x.aircraftId===a.id)){
    s.aircraftHandled.push({
      aircraftId:a.id, type:a.type, spawnTime:new Date().toISOString(),
      handledTime:new Date().toISOString(), action, timeToHandle: 20 - a.timeRemaining
    });
  }
}
function removeAircraft(id){
  gameState.aircraft = gameState.aircraft.filter(x=>x.id!==id);
  const el=document.getElementById(id); if (el) el.remove();
  if (gameState.selectedAircraft===id){ gameState.selectedAircraft=null; updateControlButtons(); }
  updateDisplay();
}

/* ===== Loop ===== */
function updateGame(){
  if (gameState.paused) return;
  gameState.timer--;
  gameState.aircraft.forEach(a=>{
    a.timeRemaining -= 1;
    if (a.timeRemaining<=0){ gameState.failedTasks++; removeAircraft(a.id); }
  });
  if (gameState.timer<=0){ stopGame(); }
  else if (gameState.completedTasks >= 5 + gameState.level*2){
    gameState.level++;
    if (gameState.level>5){ stopGame(); }
    else { gameState.timer += 30; spawnAircraft(); }
  }
  updateDisplay();
}

/* ===== UI updates ===== */
function updateDisplay(){
  // (level/score/timer not visually shown, but kept in case you re-add)
  if (elements.timer) elements.timer.textContent = formatTime(gameState.timer);
  if (elements.completed) elements.completed.textContent = gameState.completedTasks;
  if (elements.memoryLoad) elements.memoryLoad.textContent = `${gameState.memoryItems.length}/${4+gameState.level}`;

  const sr = gameState.completedTasks + gameState.failedTasks > 0
    ? Math.round((gameState.completedTasks/(gameState.completedTasks+gameState.failedTasks))*100) : 100;
  if (elements.successRate) elements.successRate.textContent = sr + '%';

  updateProtocolsDisplay();
  updateTaskQueueDisplay();
  updateAircraftListDisplay();
  updateSelectedAircraftDisplay();
}
function updateProtocolsDisplay(){
  elements.protocols.innerHTML='';
  gameState.protocols.forEach(id=>{
    const p=PROTOCOLS.find(x=>x.id===id);
    if (!p) return;
    const div=document.createElement('div');
    div.className='protocol-card active';
    div.innerHTML = `<strong>${p.name}</strong><br><small>${p.rule}</small>`;
    elements.protocols.appendChild(div);
  });
}
function updateTaskQueueDisplay(){
  elements.taskQueue.innerHTML='';
  const sorted = gameState.tasks.filter(t=>!t.completed)
    .sort((a,b)=>(b.priority?1:0)-(a.priority?1:0));
  sorted.forEach(t=>{
    const d=document.createElement('div');
    d.className=`queue-item ${t.priority?'priority':''}`;
    d.textContent=t.description;
    elements.taskQueue.appendChild(d);
  });
}
function updateAircraftListDisplay(){
  elements.aircraftList.innerHTML='';
  gameState.aircraft.forEach(a=>{
    const d=document.createElement('div');
    d.className=`aircraft-info ${a.id===gameState.selectedAircraft?'selected':''}`;
    d.innerHTML = `<strong>${a.emoji} ${a.type.toUpperCase()}</strong><br>
                   <small>Status: ${a.status} ‚Ä¢ Time: ${Math.round(a.timeRemaining)}s</small>`;
    d.onclick=()=>selectAircraft(a.id);
    elements.aircraftList.appendChild(d);
  });
}
function updateSelectedAircraftDisplay(){
  const s=gameState.aircraft.find(a=>a.id===gameState.selectedAircraft);
  if (s){
    elements.selectedInfo.textContent = `${s.emoji} ${s.type}`;
    elements.selectedDetails.innerHTML = `<small>Status: ${s.status}<br/>
      Time Remaining: ${Math.round(s.timeRemaining)}s<br/>Priority: ${s.priority}</small>`;
  } else {
    elements.selectedInfo.textContent='None';
    elements.selectedDetails.innerHTML='<small>Click an aircraft to select</small>';
  }
}
function updateControlButtons(){
  const has = gameState.selectedAircraft !== null;
  elements.clearBtn.disabled = !has;
  elements.landBtn.disabled = !has;
  elements.holdBtn.disabled = !has;
  elements.redirectBtn.disabled = !has;
}
function formatTime(s){
  const m=Math.floor(s/60), sec=s%60;
  return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}
function showResults(){
  const sr = gameState.completedTasks + gameState.failedTasks > 0
    ? Math.round((gameState.completedTasks/(gameState.completedTasks+gameState.failedTasks))*100) : 100;
  elements.resultTitle.textContent = gameState.level>5 ? 'üéâ Mission Complete!' : '‚è∞ Mission Ended';
  elements.resultMessage.innerHTML = `
    <strong>üéØ Final Results:</strong><br><br>
    <div style="text-align:left;display:inline-block">
      üìä <strong>Level Reached:</strong> ${gameState.level}<br>
      üèÜ <strong>Total Score:</strong> ${gameState.score} points<br>
      ‚úÖ <strong>Success Rate:</strong> ${sr}%<br>
      üìã <strong>Tasks Completed:</strong> ${gameState.completedTasks}
    </div>
    <div style="background:var(--surface);border:1px solid var(--line);padding:12px;border-radius:12px;margin-top:12px">
      <strong>üß† Executive Skills Trained:</strong><br>
      <small>‚Ä¢ <strong>Working Memory:</strong> Track multiple aircraft & changing rules<br>
      ‚Ä¢ <strong>Cognitive Flexibility:</strong> Adapt to protocol changes<br>
      ‚Ä¢ <strong>Inhibitory Control:</strong> Follow rules under pressure</small>
    </div>`;
  elements.resultModal.style.display='flex';
}

/* ===== CSV export ===== */
function exportToCSV(){
  if (sessionData.sessions.length===0){ alert('No training data to export yet.'); return; }
  const csv = generateCSVData();
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.href = url;
  link.download = `tower_control_training_${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
function generateCSVData(){
  let csv = 'Session_ID,Start_Time,End_Time,Duration_Seconds,Start_Level,Final_Level,Final_Score,Completed_Tasks,Failed_Tasks,Success_Rate,Total_Actions,Protocol_Changes,Avg_Response_Time,Working_Memory_Peak\n';
  sessionData.sessions.forEach(s=>{
    const avg = s.aircraftHandled.length>0
      ? s.aircraftHandled.reduce((sum,a)=>sum+(a.timeToHandle||0),0)/s.aircraftHandled.length : 0;
    const peak = s.actions.length>0 ? Math.max(...s.actions.map(a=>a.memoryLoad)) : 0;
    csv += `${s.sessionId},${s.startTime},${s.endTime},${s.duration},${s.startLevel},${s.finalLevel},${s.finalScore},${s.completedTasks},${s.failedTasks},${s.successRate},${s.actions.length},${s.protocolChanges.length},${avg.toFixed(2)},${peak}\n`;
  });
  csv += '\n\nDetailed Actions:\n';
  csv += 'Session_ID,Timestamp,Action,Aircraft_Type,Game_Time,Level,Protocol,Score_At_Time,Memory_Load\n';
  sessionData.sessions.forEach(s=>{
    s.actions.forEach(a=>{
      csv += `${s.sessionId},${a.timestamp},${a.action},${a.aircraftType},${a.gameTime},${a.level},${a.currentProtocol},${a.scoreAtTime},${a.memoryLoad}\n`;
    });
  });
  csv += '\n\nProtocol Changes:\n';
  csv += 'Session_ID,Timestamp,Protocol_ID,Protocol_Name,Game_Time\n';
  sessionData.sessions.forEach(s=>{
    s.protocolChanges.forEach(p=>{
      csv += `${s.sessionId},${p.timestamp},${p.protocolId},${p.protocolName},${p.gameTime}\n`;
    });
  });
  return csv;
}

/* ===== Events ===== */
elements.startBtn.addEventListener('click', startGame);
elements.pauseBtn.addEventListener('click', pauseGame);
elements.downloadBtn.addEventListener('click', exportToCSV);
elements.clearBtn.addEventListener('click', handleClear);
elements.landBtn.addEventListener('click', handleLand);
elements.holdBtn.addEventListener('click', handleHold);
elements.redirectBtn.addEventListener('click', handleRedirect);
elements.nextLevelBtn.addEventListener('click', ()=>{
  elements.resultModal.style.display='none';
  gameState = { running:false, paused:false, level:1, score:0, timer:120,
    aircraft:[], protocols:[], tasks:[], selectedAircraft:null,
    completedTasks:0, failedTasks:0, memoryItems:[] };
  updateDisplay();
});

/* Kick off */
initGame();
</script>
</body>
</html>
