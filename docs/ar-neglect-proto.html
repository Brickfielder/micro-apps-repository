<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>AR Neglect Scanner Prototype</title>
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.2.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.js"></script>
  <style>
    :root {
      color-scheme: light;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      font-size: 16px;
      line-height: 1.5;
      --bg: rgba(10, 10, 15, 0.8);
      --panel: rgba(255, 255, 255, 0.92);
      --accent: #0069ff;
      --accent-soft: rgba(0, 105, 255, 0.12);
      --danger: #d93f3f;
      --success: #0a9952;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: #04060c;
      color: #111;
      overflow: hidden;
    }

    a-scene {
      width: 100vw;
      height: 100vh;
    }

    .hidden { display: none !important; }

    #primer, #protocol-warning {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      padding: 1.5rem;
      background: #02030a;
      color: #f4f7ff;
      z-index: 20;
    }

    .card {
      background: var(--panel);
      color: #061027;
      border-radius: 1rem;
      padding: 1.75rem;
      max-width: 420px;
      width: min(100%, 420px);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
      display: grid;
      gap: 1rem;
    }

    h1 {
      margin: 0;
      font-size: 1.55rem;
      font-weight: 700;
    }

    .steps {
      background: var(--accent-soft);
      border-radius: 0.85rem;
      padding: 1rem;
      font-size: 0.95rem;
      display: grid;
      gap: 0.4rem;
      color: #0b2152;
    }

    button, select {
      appearance: none;
      border: none;
      border-radius: 999px;
      padding: 0.75rem 1.25rem;
      font-size: 1rem;
      font-weight: 600;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(0, 90, 255, 0.3);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    button.secondary {
      background: #ffffff;
      color: #0b2152;
      border: 2px solid rgba(0, 24, 73, 0.1);
      box-shadow: none;
    }

    button.danger {
      background: var(--danger);
      box-shadow: 0 10px 20px rgba(217, 63, 63, 0.3);
    }

    button:active {
      transform: scale(0.98);
    }

    .hud {
      position: fixed;
      inset: 0;
      pointer-events: none;
      display: grid;
      grid-template-rows: auto 1fr auto;
      z-index: 10;
    }

    .hud > * {
      pointer-events: auto;
    }

    .hud-top {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      justify-content: center;
      padding: 0.75rem;
    }

    .metric {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 0.9rem;
      padding: 0.65rem 1rem;
      min-width: 110px;
      text-align: center;
      font-weight: 600;
      color: #04103c;
      display: grid;
      gap: 0.2rem;
    }

    .metric span {
      font-size: 1.2rem;
    }

    .hud-controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.75rem;
      padding: 0.75rem;
    }

    .hud-controls select {
      min-width: 120px;
      background: rgba(7, 31, 74, 0.9);
      color: #fff;
      pointer-events: auto;
    }

    #hint {
      position: fixed;
      left: 50%;
      bottom: 1.5rem;
      transform: translateX(-50%);
      background: var(--bg);
      color: #f7fbff;
      padding: 0.65rem 1.1rem;
      border-radius: 999px;
      font-size: 0.95rem;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      z-index: 12;
    }

    #toast {
      position: fixed;
      left: 50%;
      bottom: 4.5rem;
      transform: translateX(-50%);
      background: rgba(20, 20, 30, 0.85);
      color: #fff;
      padding: 0.55rem 1rem;
      border-radius: 0.75rem;
      font-size: 0.9rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 12;
    }

    #toast.show {
      opacity: 1;
    }

    .legend {
      font-size: 0.85rem;
      color: rgba(6, 16, 50, 0.8);
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    a-marker, a-entity, a-camera {
      touch-action: manipulation;
    }

    .note {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.8);
    }

    #primer .note {
      color: rgba(11, 33, 82, 0.8);
    }
  </style>
</head>
<body>
  <div id="protocol-warning" class="hidden">
    <div class="card">
      <h1>Run from GitHub Pages</h1>
      <p>This AR prototype must be served over HTTPS. Please upload to GitHub Pages or another secure host, then reload.</p>
      <div class="legend">
        <span>Current protocol: <strong id="protocol-label"></strong></span>
      </div>
    </div>
  </div>

  <div id="primer">
    <div class="card">
      <h1>AR Neglect Scanner</h1>
      <div class="legend">
        <strong>Quick start</strong>
        <span>1. Host this file via GitHub Pages.</span>
        <span>2. Open on Android Chrome or iOS Safari.</span>
        <span>3. Allow camera access when prompted.</span>
        <span>4. Point at a printed Hiro marker.</span>
      </div>
      <button id="enableCamera">Enable camera</button>
      <div id="primer-status" class="note">Camera permission is required to continue.</div>
    </div>
  </div>

  <div id="hint" class="hidden">Point at the Hiro marker…</div>
  <div id="toast"></div>

  <div id="hud" class="hud hidden">
    <div class="hud-top">
      <div class="metric">
        <label>Timer</label>
        <span id="timer">00:00</span>
      </div>
      <div class="metric">
        <label>Left</label>
        <span id="leftScore">0 / 0</span>
      </div>
      <div class="metric">
        <label>Right</label>
        <span id="rightScore">0 / 0</span>
      </div>
      <div class="metric">
        <label>Remaining</label>
        <span id="remaining">0</span>
      </div>
      <div class="metric">
        <label>First left</label>
        <span id="firstLeft">—</span>
      </div>
    </div>
    <div></div>
    <div class="hud-controls">
      <select id="difficulty" aria-label="Difficulty">
        <option value="easy">Easy</option>
        <option value="standard" selected>Standard</option>
        <option value="hard">Hard</option>
      </select>
      <button id="startBtn">Start</button>
      <button id="resetBtn" class="secondary">Reset</button>
      <button id="downloadBtn" class="secondary">Download CSV</button>
      <button id="exitBtn" class="danger">Exit</button>
    </div>
  </div>

  <a-scene
    id="scene"
    embedded
    vr-mode-ui="enabled: false"
    renderer="antialias: false; alpha: true; precision: mediump; powerPreference: high-performance"
    arjs="sourceType: webcam; sourceWidth: 640; sourceHeight: 480; detectionMode: mono; maxDetectionRate: 30; videoTexture: true; facingMode: environment"
    style="display: none;">
    <a-assets>
      <!-- Inline SVG star sprites: update fills if you need alternate colors -->
      <img id="star-blue" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><polygon fill='%230069ff' stroke='%23ffffff' stroke-width='8' points='60 5 73 44 114 46 81 71 92 111 60 88 28 111 39 71 6 46 47 44'/></svg>" />
      <img id="star-gold" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><polygon fill='%23ffb400' stroke='%23ffffff' stroke-width='8' points='60 5 73 44 114 46 81 71 92 111 60 88 28 111 39 71 6 46 47 44'/></svg>" />
    </a-assets>

    <a-marker id="hiroMarker" type="preset" preset="hiro">
      <!-- Swap to a custom marker by replacing preset attributes with url="path/to/your-marker.patt" -->
      <a-entity id="starContainer"></a-entity>
    </a-marker>

    <a-entity camera></a-entity>
    <a-entity id="cursor" cursor="rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>
  </a-scene>

  <script>
    (function () {
      const protocolWarning = document.getElementById('protocol-warning');
      const protocolLabel = document.getElementById('protocol-label');
      const primer = document.getElementById('primer');
      const primerStatus = document.getElementById('primer-status');
      const enableBtn = document.getElementById('enableCamera');
      const sceneEl = document.getElementById('scene');
      const markerEl = document.getElementById('hiroMarker');
      const starContainer = document.getElementById('starContainer');
      const hud = document.getElementById('hud');
      const timerLabel = document.getElementById('timer');
      const leftLabel = document.getElementById('leftScore');
      const rightLabel = document.getElementById('rightScore');
      const remainingLabel = document.getElementById('remaining');
      const firstLeftLabel = document.getElementById('firstLeft');
      const hint = document.getElementById('hint');
      const toast = document.getElementById('toast');
      const startBtn = document.getElementById('startBtn');
      const resetBtn = document.getElementById('resetBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const exitBtn = document.getElementById('exitBtn');
      const difficultySelect = document.getElementById('difficulty');

      const difficultyPresets = {
        easy: {
          left: 5,
          right: 5,
          size: 0.28,
          yRange: [0.15, 0.25],
          zRange: [-0.25, 0.15],
          leftX: [-0.32, -0.08],
          rightX: [0.08, 0.32]
        },
        standard: {
          left: 8,
          right: 8,
          size: 0.24,
          yRange: [0.16, 0.3],
          zRange: [-0.3, 0.18],
          leftX: [-0.36, -0.1],
          rightX: [0.1, 0.36]
        },
        hard: {
          left: 10,
          right: 10,
          size: 0.21,
          yRange: [0.16, 0.32],
          zRange: [-0.35, 0.22],
          leftX: [-0.42, -0.12],
          rightX: [0.12, 0.42]
        }
      };

      const state = {
        awaitingMarker: false,
        active: false,
        markerVisible: false,
        startTimePerf: 0,
        startTimeWall: 0,
        timerHandle: 0,
        totals: { left: 0, right: 0 },
        found: { left: 0, right: 0 },
        logs: [],
        timeToFirstLeft: null,
        difficulty: 'standard'
      };

      const starSources = {
        left: '#star-blue',
        right: '#star-gold'
      };

      function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
        const seconds = (totalSeconds % 60).toString().padStart(2, '0');
        return `${minutes}:${seconds}`;
      }

      function updateHud() {
        leftLabel.textContent = `${state.found.left} / ${state.totals.left}`;
        rightLabel.textContent = `${state.found.right} / ${state.totals.right}`;
        const remaining = state.totals.left + state.totals.right - state.found.left - state.found.right;
        remainingLabel.textContent = remaining;
        firstLeftLabel.textContent = state.timeToFirstLeft != null ? `${formatTime(state.timeToFirstLeft)}` : '—';
      }

      function updateTimer() {
        if (!state.active) return;
        const elapsed = performance.now() - state.startTimePerf;
        timerLabel.textContent = formatTime(elapsed);
        state.timerHandle = requestAnimationFrame(updateTimer);
      }

      function stopTimer() {
        if (state.timerHandle) {
          cancelAnimationFrame(state.timerHandle);
          state.timerHandle = 0;
        }
      }

      function randomBetween([min, max]) {
        return Math.random() * (max - min) + min;
      }

      function createStar(side, index, preset) {
        const star = document.createElement('a-image');
        star.classList.add('clickable', 'star', `star-${side}`);
        star.setAttribute('src', starSources[side]);
        const xRange = side === 'left' ? preset.leftX : preset.rightX;
        const x = randomBetween(xRange);
        const y = randomBetween(preset.yRange);
        const z = randomBetween(preset.zRange);
        star.setAttribute('position', `${x.toFixed(3)} ${y.toFixed(3)} ${z.toFixed(3)}`);
        star.setAttribute('scale', `${preset.size} ${preset.size} ${preset.size}`);
        star.setAttribute('animation__bob', `property: position; dir: alternate; dur: ${1200 + Math.random() * 600}; easing: easeInOutSine; loop: true; to: ${x.toFixed(3)} ${(y + 0.05).toFixed(3)} ${z.toFixed(3)}`);
        const id = `${side}-${index + 1}`;
        star.dataset.starId = id;
        star.addEventListener('click', () => collectStar(star, side));
        starContainer.appendChild(star);
      }

      function spawnTargets() {
        starContainer.innerHTML = '';
        const preset = difficultyPresets[state.difficulty];
        state.totals.left = preset.left;
        state.totals.right = preset.right;
        for (let i = 0; i < preset.left; i += 1) {
          createStar('left', i, preset);
        }
        for (let i = 0; i < preset.right; i += 1) {
          createStar('right', i, preset);
        }
        updateHud();
      }

      function collectStar(star, side) {
        if (!state.active || star.dataset.collected === 'true') return;
        star.dataset.collected = 'true';
        star.classList.remove('clickable');
        star.setAttribute('animation__pop', 'property: scale; to: 0 0 0; dur: 180; easing: easeInBack');
        setTimeout(() => {
          if (star.parentNode) {
            star.parentNode.removeChild(star);
          }
        }, 200);

        state.found[side] += 1;
        const elapsedMs = Math.round(performance.now() - state.startTimePerf);
        if (side === 'left' && state.timeToFirstLeft == null) {
          state.timeToFirstLeft = elapsedMs;
          updateHud();
          showToast('First left target found!', 1600);
        }

        state.logs.push({
          timestamp: Date.now(),
          elapsed: elapsedMs,
          side,
          id: star.dataset.starId || `${side}-${state.found[side]}`,
          leftFound: state.found.left,
          rightFound: state.found.right,
          leftTotal: state.totals.left,
          rightTotal: state.totals.right,
          timeToFirstLeft: state.timeToFirstLeft
        });

        updateHud();

        if (state.found.left + state.found.right >= state.totals.left + state.totals.right) {
          completeSession();
        }
      }

      function showToast(message, duration = 2000) {
        toast.textContent = message;
        toast.classList.add('show');
        clearTimeout(showToast.timeout);
        showToast.timeout = setTimeout(() => {
          toast.classList.remove('show');
        }, duration);
      }

      function setHint(message, accent) {
        hint.textContent = message;
        hint.classList.remove('hidden');
        hint.style.background = accent === 'good' ? 'rgba(10, 117, 67, 0.85)' : accent === 'warn' ? 'rgba(140, 26, 26, 0.85)' : 'var(--bg)';
      }

      function hideHint() {
        hint.classList.add('hidden');
      }

      function startSession() {
        state.active = true;
        state.awaitingMarker = false;
        state.logs = [];
        state.found.left = 0;
        state.found.right = 0;
        state.timeToFirstLeft = null;
        state.startTimePerf = performance.now();
        state.startTimeWall = Date.now();
        timerLabel.textContent = '00:00';
        firstLeftLabel.textContent = '—';
        spawnTargets();
        updateHud();
        stopTimer();
        state.timerHandle = requestAnimationFrame(updateTimer);
        showToast('Session started', 1200);
      }

      function completeSession() {
        state.active = false;
        stopTimer();
        showToast('Complete — download CSV', 2600);
        setHint('Session complete. Download your log.', 'good');
      }

      function resetSession() {
        stopTimer();
        state.active = false;
        state.awaitingMarker = false;
        state.logs = [];
        state.found.left = 0;
        state.found.right = 0;
        state.totals.left = 0;
        state.totals.right = 0;
        state.timeToFirstLeft = null;
        timerLabel.textContent = '00:00';
        leftLabel.textContent = '0 / 0';
        rightLabel.textContent = '0 / 0';
        remainingLabel.textContent = '0';
        firstLeftLabel.textContent = '—';
        starContainer.innerHTML = '';
        setHint('Point at the Hiro marker…');
      }

      function downloadCsv() {
        if (!state.logs.length) {
          showToast('No collection data yet.', 1600);
          return;
        }
        const header = 'timestamp_ms,side,id,elapsed_total_ms,left_found,right_found,left_total,right_total,time_to_first_left_ms';
        const rows = state.logs.map(entry => [
          entry.timestamp,
          entry.side,
          entry.id,
          entry.elapsed,
          entry.leftFound,
          entry.rightFound,
          entry.leftTotal,
          entry.rightTotal,
          entry.timeToFirstLeft ?? ''
        ].join(','));
        const csv = [header, ...rows].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const stamp = new Date().toISOString().replace(/[:.]/g, '-');
        link.href = url;
        link.download = `ar-neglect-session-${stamp}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        showToast('CSV downloaded');
      }

      function ensureGesture() {
        window.removeEventListener('touchend', ensureGesture);
        sceneEl.emit('user-gesture');
      }

      function initCameraPriming() {
        enableBtn.disabled = true;
        primerStatus.textContent = 'Requesting camera access…';
        const constraints = {
          audio: false,
          video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        };
        navigator.mediaDevices.getUserMedia(constraints).then(stream => {
          stream.getTracks().forEach(track => track.stop());
          primer.classList.add('hidden');
          hud.classList.remove('hidden');
          sceneEl.style.display = 'block';
          setHint('Point at the Hiro marker…');
        }).catch(err => {
          console.error(err);
          enableBtn.disabled = false;
          primerStatus.textContent = 'Camera access failed. Use Chrome (Android) or Safari (iOS), then allow via the lock icon ▸ Site settings ▸ Camera: Allow.';
        });
      }

      function handleMarkerFound() {
        state.markerVisible = true;
        setHint('Marker found ✓', 'good');
        if (state.awaitingMarker && !state.active) {
          startSession();
        }
      }

      function handleMarkerLost() {
        state.markerVisible = false;
        if (state.active) {
          setHint('Marker lost…', 'warn');
          showToast('Hold steady / move closer');
        } else {
          setHint('Point at the Hiro marker…');
        }
      }

      startBtn.addEventListener('click', () => {
        state.difficulty = difficultySelect.value;
        resetSession();
        state.awaitingMarker = true;
        showToast('Waiting for marker to begin', 1400);
        if (state.markerVisible) {
          startSession();
        }
      });

      resetBtn.addEventListener('click', () => {
        resetSession();
      });

      downloadBtn.addEventListener('click', downloadCsv);
      exitBtn.addEventListener('click', () => location.reload());

      if (!/^https?:/.test(window.location.protocol)) {
        protocolLabel.textContent = window.location.protocol;
        protocolWarning.classList.remove('hidden');
      }

      enableBtn.addEventListener('click', initCameraPriming);

      if (markerEl) {
        markerEl.addEventListener('markerFound', handleMarkerFound);
        markerEl.addEventListener('markerLost', handleMarkerLost);
      }

      window.addEventListener('touchend', ensureGesture, { once: true });

      // Provide a helpful status on orientation changes
      window.addEventListener('orientationchange', () => {
        if (state.active) {
          showToast('Realign with marker after rotating');
        }
      });
    })();
  </script>
</body>
</html>
