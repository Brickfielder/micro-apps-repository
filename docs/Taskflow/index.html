<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TaskFlow ‚Äî Plan ¬∑ Check ¬∑ Feedback</title>
<style>
:root{
  --bg:#f7f9fc; 
  --fg:#222; 
  --muted:#666;
  --card:#ffffff; 
  --accent:#3a5bff; 
  --good:#1a8d5f;
  --pill:#eef2fa;
}
*{box-sizing:border-box}
body{
  margin:0; 
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
  background:linear-gradient(180deg,#f7f9fc 0%, #e8eef9 100%); 
  color:var(--fg);
}
header{
  padding:20px 16px; 
  border-bottom:1px solid #d0d7e7; 
  position:sticky; 
  top:0; 
  backdrop-filter: blur(6px);
  background: rgba(255,255,255,0.85);
}
h1{margin:0 0 4px; font-weight:700; font-size: clamp(18px, 2.4vw, 28px)}
.sub{color:var(--muted); font-size:14px}
main{padding:16px; max-width:1200px; margin:0 auto}
.controls{display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin:10px 0 18px;}
select, button{
  background:var(--card); 
  color:var(--fg); 
  border:1px solid #c2cce7; 
  border-radius:10px; 
  padding:10px 12px;
  font-size:14px; 
  cursor:pointer;
}
button.primary{ background:linear-gradient(180deg,#4c6dff,#2746d9); border:none; color:#fff; }
button.ghost{ background:transparent; border:1px dashed var(--accent); color:var(--accent); }
button:disabled{opacity:.6; cursor:not-allowed}

.panel{
  background:var(--card); 
  border:1px solid #d0d7e7; 
  border-radius:18px; 
  padding:14px;
  box-shadow: 0 4px 12px rgba(0,0,0,.08); 
  margin-bottom:16px;
}
.panel h2{ margin:0 0 10px; font-size:18px; display:flex; align-items:center; gap:8px; }
.hint{ color:var(--muted); font-size:13px; margin-top:6px }
.brief-title{ font-weight:700; margin-bottom:4px }
.brief-body{ color:var(--muted); line-height:1.4 }

.grid{ display:grid; gap:16px; grid-template-columns: 1fr; }
@media (min-width: 980px){ .grid{ grid-template-columns: repeat(3, 1fr); } }

.list{
  min-height: 180px; 
  border:1px dashed #b8c4e3; 
  border-radius:14px; 
  padding:10px; 
  display:flex; 
  flex-direction:column; 
  gap:8px;
  background:#f1f4fb;
}
.pill{
  background:var(--pill); 
  border:1px solid #c2cce7; 
  border-radius:999px; 
  padding:10px 12px; 
  display:flex; 
  align-items:center; 
  gap:10px;
  font-size:15px; 
  user-select:none;
}
.pill .handle{ font-size:16px; opacity:.6; cursor:grab }
.dragging{ opacity:.6; transform: scale(0.98) }
.drop-target{ outline:2px dashed var(--accent); border-radius:12px }

.badge{font-size:12px; padding:3px 8px; border-radius:999px; background:#dfe6fb; color:#2746d9; margin-left:auto}
.inactive{ opacity:0.45; pointer-events:none; filter: grayscale(0.3); }

.aligned{ border-color:#1c7f5f; background:#dff5ec }

.split{ display:grid; grid-template-columns: 1fr; gap:10px; margin-top:8px; }
@media (min-width: 680px){ .split{ grid-template-columns: 1fr 1fr; } }
.mono{ font-family: ui-monospace, Menlo, Consolas, monospace; font-size:13px }
.reflections h3{ margin:8px 0 4px; font-size:15px }
.reflections ul{ margin:6px 0 0 18px }
.soft{ color:var(--muted); font-size:13px }
footer{ color:#666; font-size:12px; margin:12px 0 30px }

</style>
</head>
<body>
<header>
  <h1>TaskFlow ‚Äî Plan ¬∑ Check ¬∑ Feedback</h1>
  <div class="sub">Drag steps from the left (Plan) into the middle (Check) in the order you think is best. When the left is empty, it locks‚Äîreview and adjust in the middle, then Confirm for feedback.</div>
</header>
<main>
  <div class="controls">
    <label>Scenario: 
      <select id="scenarioSelect">
        <option value="clinic">üè• Clinic Day Planner</option>
        <option value="meal">üçù Simple Meal + Child Pickup</option>
      </select>
    </label>
    <label>Difficulty:
      <select id="difficultySelect">
        <option value="easy">Easy (6 steps)</option>
        <option value="medium">Medium</option>
      </select>
    </label>
    <button id="startBtn" class="primary">Start New Trial ‚ñ∂</button>
    <button id="resetBtn">Reset</button>
    <button id="downloadBtn" class="ghost">Download CSV</button>
    <span id="status" class="sub"></span>
  </div>

  <!-- Briefing panel -->
  <section class="panel" id="briefPanel" aria-label="Scenario briefing">
    <div id="briefTitle" class="brief-title">Scenario:</div>
    <div id="briefBody" class="brief-body"></div>
  </section>

  <div class="grid" id="sections">

    <!-- 1) PLAN (source-only) -->
    <section class="panel" id="planPanel" aria-label="Planning board">
      <h2>1) Plan (choose your steps & order) üß†</h2>
      <div class="hint">Drag each item into the middle list in the order you think is correct. The left list is a source ‚Äî it will lock when empty.</div>
      <div id="planList" class="list" aria-live="polite"></div>
      <div class="soft" style="margin-top:6px">Tip: use the ‚ãÆ handle to drag</div>
    </section>

    <!-- 2) CHECK (review & adjust) -->
    <section class="panel" id="checkPanel" aria-label="Check board">
      <h2>2) Check & adjust üîç</h2>
      <div class="hint">When the left list empties, it will grey out. You can then reorder here until you‚Äôre happy, and press Confirm.</div>
      <div id="checkList" class="list" aria-live="polite"></div>
      <div style="display:flex; gap:10px; margin-top:10px">
        <button id="confirmBtn" class="primary" disabled>Confirm Plan ‚úì</button>
      </div>
    </section>

    <!-- 3) FEEDBACK -->
    <section class="panel" id="feedbackPanel" aria-label="Feedback board">
      <h2>3) Feedback ‚Äî Alignment & Reflection üßæ</h2>
      <div class="split">
        <div>
          <div class="hint"><strong>Suggested sequence</strong></div>
          <div id="idealList" class="list"></div>
        </div>
        <div>
          <div class="hint">Your sequence</div>
          <div id="userList" class="list"></div>
        </div>
      </div>
      <div id="summary" style="margin-top:10px; font-weight:600"></div>
      <div id="reflections" class="reflections" style="margin-top:6px"></div>
    </section>

  </div>

  <footer>
    Prototype for research/demonstration only ‚Äî not a medical device. No data leaves your browser. ¬©
  </footer>
</main>

<script>
/* ------------------ Scenario Briefings ------------------ */
const BRIEFINGS = {
  meal: {
    title: 'Scenario: üçù Simple Meal + Child Pickup',
    body: `Briefing for the participant:<br>
    You are preparing an evening meal while also needing to pick up your child from nursery, which is only <strong>2 minutes away</strong>.
    The challenge is to organise the cooking so that the food is ready, the kitchen is safe, and you collect your child on time.
    Follow food-safety rules, manage timing, and make sure the kitchen is safe before leaving.`
  },
  clinic: {
    title: 'Scenario: üè• Clinic Day Planner',
    body: `Briefing for the participant:<br>
    You have an outpatient appointment this afternoon. Plan the tasks to get there and back safely and efficiently:
    bring the right documents, travel to the hospital, check in and attend your appointment, handle any payments/validation,
    collect any prescription, optionally pick up a few groceries, and return home. Aim to follow sensible time windows and safety rules
    (e.g., have your travel card/phone ready).`
  }
};

/* ------------------ Scenario Definitions ------------------ */
const SCENARIOS = {
  clinic: {
    name: "Clinic Day Planner",
    emoji: "üè•",
    steps: {
      easy: [
        {id:"bus_to_hospital", txt:"Take the bus to hospital", icon:"üöå"},
        {id:"check_in", txt:"Check in at reception", icon:"üßæ"},
        {id:"see_doctor", txt:"See the doctor", icon:"üë©‚Äç‚öïÔ∏è"},
        {id:"collect_rx", txt:"Collect prescription", icon:"üíä"},
        {id:"groceries", txt:"Buy quick groceries", icon:"üõí"},
        {id:"bus_home", txt:"Bus back home", icon:"üè†"},
      ],
      medium: [
        {id:"prepare_docs", txt:"Bring NHS number & appointment letter", icon:"üìÑ"},   // 1
        {id:"ready_travel", txt:"Charge phone / prepare travel card", icon:"üîãüé´"},    // 2
        {id:"leave_home", txt:"Leave home in good time", icon:"üö™"},                    // 3
        {id:"bus_to_hospital", txt:"Take the bus to hospital", icon:"üöå"},             // 4
        {id:"check_in", txt:"Check in at reception", icon:"üßæ"},                        // 5
        {id:"wait_call", txt:"Wait to be called", icon:"ü™ë"},                           // 6
        {id:"see_doctor", txt:"See the doctor", icon:"üë©‚Äç‚öïÔ∏è"},                          // 7
        {id:"validate_pay", txt:"Validate ticket / pay as needed", icon:"üÖøÔ∏è"},        // 8
        {id:"collect_rx", txt:"Collect prescription", icon:"üíä"},                       // 9
        {id:"groceries", txt:"Buy quick groceries (optional)", icon:"üõí"},              // 10
        {id:"bus_home", txt:"Bus back home", icon:"üè†"},                                // 11
      ]
    },
    ideal: {
      easy: ["bus_to_hospital","check_in","see_doctor","collect_rx","groceries","bus_home"],
      medium: ["prepare_docs","ready_travel","leave_home","bus_to_hospital","check_in","wait_call","see_doctor","validate_pay","collect_rx","groceries","bus_home"]
    },
    flexGroups: { easy: [], medium: [] }
  },
  meal: {
    name: "Simple Meal + Child Pickup",
    emoji: "üçù",
    steps: {
      easy: [
        {id:"wash_hands", txt:"Wash hands", icon:"üßº"},
        {id:"boil_pasta", txt:"Start pasta cooking", icon:"üçù"},
        {id:"set_timer", txt:"Set timer", icon:"‚è≤Ô∏è"},
        {id:"switch_off", txt:"Switch hob off", icon:"üî•‚úñÔ∏è"},
        {id:"pickup_child", txt:"Pick up child (nursery 2 min away)", icon:"üë∂"},
        {id:"enjoy_meal", txt:"Enjoy the meal at home", icon:"üè°üçΩÔ∏è"},
      ],
      medium: [
        {id:"wash_hands", txt:"Wash hands", icon:"üßº"},                                      // 1
        {id:"gather_items", txt:"Gather ingredients & equipment", icon:"ü•ïüçÖüî™"},            // 2
        {id:"boil_water", txt:"Boil water in a pot", icon:"üíßüî•"},                           // 3 (flex with 4)
        {id:"prep_sauce", txt:"Prepare the simple sauce", icon:"üçÖüßÑ"},                      // 4 (flex with 3)
        {id:"boil_pasta", txt:"Put pasta in boiling water", icon:"üçù"},                      // 5 (flex with 6)
        {id:"set_timer", txt:"Set a timer for the pasta", icon:"‚è≤Ô∏è"},                        // 6 (flex with 5)
        {id:"lay_table", txt:"Lay the table", icon:"üçΩÔ∏èüß∫"},                                  // 7
        {id:"switch_off", txt:"Switch off the hob/stove", icon:"üî•‚úñÔ∏è"},                      // 8
        {id:"pasta_to_table", txt:"Put the pasta on the table", icon:"üç≤"},                  // 9
        {id:"pickup_child", txt:"Pick up child (nursery 2 min away)", icon:"üë∂"},           //10
        {id:"enjoy_meal", txt:"Enjoy the meal at home", icon:"üè°üçΩÔ∏è"},                       //11
      ]
    },
    ideal: {
      easy: ["wash_hands","boil_pasta","set_timer","switch_off","pickup_child","enjoy_meal"],
      medium: ["wash_hands","gather_items","boil_water","prep_sauce","boil_pasta","set_timer","lay_table","switch_off","pasta_to_table","pickup_child","enjoy_meal"]
    },
    flexGroups: {
      easy: [],
      medium: [
        ["boil_water","prep_sauce"],    // 3 & 4 can swap
        ["boil_pasta","set_timer"]      // 5 & 6 can swap
      ]
    }
  }
};

/* ------------------ State ------------------ */
let currentScenarioKey = "clinic";
let currentDifficulty = "easy";
let trialId = 0;

let addedOrder = [];
let checkOrder = [];
let trialStart = null;

const el = id => document.getElementById(id);

/* ------------------ Helpers ------------------ */
function clearNode(node){ while(node.firstChild) node.removeChild(node.firstChild); }
function makePill(step){
  const div = document.createElement('div');
  div.className = "pill";
  div.draggable = true;
  div.dataset.id = step.id;
  div.innerHTML = `<span class="handle">‚ãÆ‚ãÆ</span> <span>${step.icon}</span> <span>${step.txt}</span>`;
  return div;
}
function shuffleArray(a){ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
function readOrder(container){ return [...container.querySelectorAll('.pill')].map(p=>p.dataset.id); }
function tag(text){ const b=document.createElement('span'); b.className='badge'; b.textContent=text; return b; }

/* ------------------ Drag & Drop ------------------ */
function makeSourceToTarget(sourceEl, targetEl, onAdd, onReorder){
  let dragEl = null;
  targetEl.addEventListener('dragstart', e=>{
    const t = e.target.closest('.pill'); if(!t) return;
    dragEl=t; t.classList.add('dragging'); e.dataTransfer.effectAllowed='move';
  });
  targetEl.addEventListener('dragend', e=>{
    if(dragEl){ dragEl.classList.remove('dragging'); dragEl=null; onReorder && onReorder(readOrder(targetEl)); }
  });
  targetEl.addEventListener('dragover', e=>{
    e.preventDefault();
    const after = getDragAfter(targetEl, e.clientY);
    const dragging = targetEl.querySelector('.pill.dragging');
    if(dragging){ if(after==null) targetEl.appendChild(dragging); else targetEl.insertBefore(dragging, after); }
    else targetEl.classList.add('drop-target');
  });
  targetEl.addEventListener('dragleave', ()=> targetEl.classList.remove('drop-target'));
  targetEl.addEventListener('drop', e=>{
    targetEl.classList.remove('drop-target');
    const dataId = e.dataTransfer.getData('text/id');
    if(!dataId) return;
    const pill = sourceEl.querySelector(`.pill[data-id="${CSS.escape(dataId)}"]`);
    if(!pill) return;
    const after = getDragAfter(targetEl, e.clientY);
    if(after==null) targetEl.appendChild(pill); else targetEl.insertBefore(pill, after);
    pill.draggable = true; onAdd && onAdd(dataId); updateSourceLockState();
  });
  sourceEl.addEventListener('dragstart', e=>{
    const t = e.target.closest('.pill'); if(!t) return;
    dragEl=t; t.classList.add('dragging'); e.dataTransfer.effectAllowed='move';
    e.dataTransfer.setData('text/id', t.dataset.id);
  });
  sourceEl.addEventListener('dragend', e=>{ if(dragEl){ dragEl.classList.remove('dragging'); dragEl=null; } });

  function getDragAfter(container, y){
    const els = [...container.querySelectorAll('.pill:not(.dragging)')];
    return els.reduce((closest, child)=>{
      const box=child.getBoundingClientRect(); const offset=y-box.top-box.height/2;
      return (offset<0 && offset>closest.offset)?{offset,element:child}:closest;
    }, {offset:Number.NEGATIVE_INFINITY}).element;
  }
}

/* ------------------ App Flow ------------------ */
function updateBriefing(){
  const key = currentScenarioKey;
  el('briefTitle').textContent = BRIEFINGS[key].title;
  el('briefBody').innerHTML = BRIEFINGS[key].body;
}
function loadScenario(){
  const s = SCENARIOS[currentScenarioKey];
  const steps = s.steps[currentDifficulty];
  const shuffled = shuffleArray(steps);
  const planList = el('planList'); const checkList = el('checkList');
  clearNode(planList); clearNode(checkList);
  shuffled.forEach(st=> planList.appendChild(makePill(st)));
  addedOrder = [];
  el('confirmBtn').disabled = true;
  el('planList').classList.remove('inactive');
  el('status').textContent = `Scenario: ${s.emoji} ${s.name} ¬∑ ${currentDifficulty}`;
  wireDnD();
  updateBriefing();
}
function wireDnD(){
  makeSourceToTarget(
    el('planList'),
    el('checkList'),
    (id)=> { addedOrder.push(id); updateSourceLockState(); },
    (order)=> { /* reorder ok */ }
  );
}
function updateSourceLockState(){
  const src = el('planList');
  const empty = src.querySelectorAll('.pill').length===0;
  el('confirmBtn').disabled = !empty;
  if(empty){ src.classList.add('inactive'); } else { src.classList.remove('inactive'); }
}

/* ------------------ Alignment & Reflection Feedback ------------------ */
function computeFeedback(){
  const s = SCENARIOS[currentScenarioKey];
  const steps = s.steps[currentDifficulty];
  const suggested = s.ideal[currentDifficulty];
  const flex = (s.flexGroups?.[currentDifficulty]) || [];
  const stepsById = Object.fromEntries(steps.map(st=>[st.id,st]));

  // Suggested (render)
  const idealList = el('idealList'); clearNode(idealList);
  suggested.forEach((id, idx)=>{
    const p = makePill(stepsById[id]); p.appendChild(tag(`#${idx+1}`)); idealList.appendChild(p);
  });

  // User (render; mark aligned anchors only)
  const userList = el('userList'); clearNode(userList);
  const alignedIndices = evaluateAlignmentWithFlex(suggested, checkOrder, flex);
  checkOrder.forEach((id, idx)=>{
    const p = makePill(stepsById[id]); p.appendChild(tag(`#${idx+1}`));
    if(alignedIndices.has(idx)) p.classList.add('aligned'); // ‚úÖ only positive marking
    userList.appendChild(p);
  });

  // Summary (soft)
  el('summary').textContent = `Aligned anchors: ${alignedIndices.size} / ${suggested.length}`;

  // Reflection points
  const refl = el('reflections'); clearNode(refl);
  const points = buildReflections(currentScenarioKey, currentDifficulty, suggested, checkOrder);
  if(points.length===0){
    const p = document.createElement('p'); p.textContent = "üü¶ Reflection: Compare your plan with the suggested one. Do the steps you have taken seem similar? If not - would you change anything, and if so, what and why?";
    refl.appendChild(p);
  } else {
    const grouped = groupReflections(points);
    for(const [title, items] of grouped){
      const h3 = document.createElement('h3'); h3.textContent = title; refl.appendChild(h3);
      const ul = document.createElement('ul');
      items.forEach(t=>{ const li=document.createElement('li'); li.textContent = t; ul.appendChild(li); });
      refl.appendChild(ul);
    }
  }
}

/* Which indices count as aligned (exact match or flexible pair occupying correct two slots) */
function evaluateAlignmentWithFlex(suggested, user, flexGroups){
  const aligned = new Set();
  const indexOf = Object.fromEntries(suggested.map((id,i)=>[id,i]));

  // Flex groups: if the two suggested slots contain the two items in any order, mark both aligned
  const flexIndexPairs = flexGroups.map(([a,b])=>{
    const ia = indexOf[a], ib = indexOf[b];
    return ia<ib ? [ia,ib,a,b] : [ib,ia,b,a];
  });
  flexIndexPairs.forEach(([i1,i2,a,b])=>{
    const setIdeal = new Set([a,b]), userSet = new Set([user[i1], user[i2]]);
    const ok = setIdeal.has(user[i1]) && setIdeal.has(user[i2]) && user[i1]!==user[i2];
    if(ok){ aligned.add(i1); aligned.add(i2); }
  });

  // Non-flex exact matches
  for(let i=0;i<suggested.length;i++){
    if(aligned.has(i)) continue;
    if(user[i] === suggested[i]) aligned.add(i);
  }
  return aligned;
}

/* Build reflection points from soft rules (no ‚Äúwrong‚Äù, only prompts) */
function buildReflections(sKey, diff, suggested, user){
  const pos = Object.fromEntries(user.map((id,i)=>[id,i]));
  const pts = [];

  if(sKey === 'meal' && diff === 'medium'){
    const before = (a,b)=> pos[a]!=null && pos[b]!=null && pos[a] < pos[b];
    const exists = id => pos[id]!=null;

    // Safety & timing
    if(exists('pickup_child') && exists('switch_off') && !before('switch_off','pickup_child')){
      pts.push({cat:'Safety', msg:'Before leaving, consider switching the hob off first.'});
    }
    if(exists('pickup_child') && exists('pasta_to_table') && !before('pasta_to_table','pickup_child')){
      pts.push({cat:'Safety', msg:'Placing hot pasta safely on the table before leaving can help avoid leaving food unattended.'});
    }

    // Dependencies
    if(exists('boil_pasta') && exists('boil_water') && pos['boil_pasta'] < pos['boil_water']){
      pts.push({cat:'Dependencies', msg:'Pasta usually goes in after the water is boiling ‚Äî does your order account for that?'});
    }
    if(exists('prep_sauce') && exists('gather_items') && pos['prep_sauce'] < pos['gather_items']){
      pts.push({cat:'Dependencies', msg:'Prepping the sauce works best after gathering ingredients and equipment.'});
    }
    if(exists('set_timer') && exists('pickup_child') && !before('set_timer','pickup_child')){
      pts.push({cat:'Timing', msg:'Setting a timer before leaving can help prevent overcooking.'});
    }

    // Efficiency / flow
    if(exists('lay_table') && exists('pickup_child') && !before('lay_table','pickup_child')){
      pts.push({cat:'Efficiency', msg:'Laying the table before pickup can make serving easier when you return.'});
    }
    if(exists('wash_hands') && (exists('boil_pasta')||exists('prep_sauce')) && !before('wash_hands', (exists('prep_sauce')?'prep_sauce':'boil_pasta'))){
      pts.push({cat:'Hygiene', msg:'Consider washing hands before handling food or equipment.'});
    }
    if(exists('enjoy_meal') && exists('pickup_child') && !before('pickup_child','enjoy_meal')){
      pts.push({cat:'Flow', msg:'Enjoying the meal typically comes after the pickup ‚Äî does your plan reflect that?'});
    }
  }

  if(sKey === 'clinic' && diff === 'medium'){
    const before = (a,b)=> pos[a]!=null && pos[b]!=null && pos[a] < pos[b];
    const exists = id => pos[id]!=null;

    // Prep & travel
    if(exists('prepare_docs') && exists('leave_home') && !before('prepare_docs','leave_home')){
      pts.push({cat:'Preparation', msg:'Having documents ready before leaving can reduce stress at check-in.'});
    }
    if(exists('ready_travel') && exists('leave_home') && !before('ready_travel','leave_home')){
      pts.push({cat:'Preparation', msg:'Charging phone / getting the travel card ready before leaving may help avoid delays.'});
    }

    // Clinical flow
    if(exists('check_in') && exists('see_doctor') && !before('check_in','see_doctor')){
      pts.push({cat:'Clinic flow', msg:'Check-in usually happens before seeing the doctor.'});
    }
    if(exists('validate_pay') && exists('bus_home') && !before('validate_pay','bus_home')){
      pts.push({cat:'Logistics', msg:'Validating tickets / payments before heading home can be helpful.'});
    }

    // Optional errands
    if(exists('groceries') && exists('collect_rx') && pos['groceries'] < pos['collect_rx']){
      pts.push({cat:'Efficiency', msg:'Would collecting the prescription before groceries make the route simpler? (Either can be sensible.)'});
    }
  }

  // Deduplicate messages
  const seen = new Set(); 
  return pts.filter(p=>{ const key=p.cat+'|'+p.msg; if(seen.has(key)) return false; seen.add(key); return true; });
}

function groupReflections(points){
  const map = new Map();
  for(const p of points){
    if(!map.has(p.cat)) map.set(p.cat, []);
    map.get(p.cat).push('üí° ' + p.msg);
  }
  // Keep a stable order of categories
  const order = ['Safety','Hygiene','Timing','Dependencies','Preparation','Clinic flow','Logistics','Efficiency','Flow'];
  const out = [];
  order.forEach(cat=>{ if(map.has(cat)) out.push([cat, map.get(cat)]); });
  // Add any others
  for(const [k,v] of map){ if(!order.includes(k)) out.push([k,v]); }
  return out;
}

/* ------------------ CSV Logging (no ‚Äúwrong‚Äù scoring) ------------------ */
const LOG = [];
function appendLog(){
  const now = new Date();
  const s = SCENARIOS[currentScenarioKey];
  const suggested = s.ideal[currentDifficulty];
  const flex = (s.flexGroups?.[currentDifficulty]) || [];
  const aligned = evaluateAlignmentWithFlex(suggested, checkOrder, flex).size;
  const duration = trialStart ? Math.round((now - trialStart)/1000) : null;

  LOG.push({
    timestamp: now.toISOString(),
    trial_id: trialId,
    scenario: s.name,
    difficulty: currentDifficulty,
    steps_n: suggested.length,
    added_order: addedOrder.join('|'),
    final_order: checkOrder.join('|'),
    suggested_order: suggested.join('|'),
    aligned_anchors: aligned,
    seconds: duration
  });
  try{ localStorage.setItem('taskflow_log_soft', JSON.stringify(LOG)); }catch(e){}
}
function downloadCSV(){
  const rows = [
    ["timestamp","trial_id","scenario","difficulty","steps_n","added_order","final_order","suggested_order","aligned_anchors","seconds"],
    ...LOG.map(r=>[
      r.timestamp, r.trial_id, r.scenario, r.difficulty, r.steps_n, r.added_order, r.final_order, r.suggested_order, r.aligned_anchors, r.seconds
    ])
  ];
  const csv = rows.map(r=>r.map(cell=> String(cell).includes(',')||String(cell).includes('|') ? `"${String(cell).replaceAll('"','""')}"` : String(cell)).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `taskflow_log_${new Date().toISOString().replace(/[:.]/g,'-')}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
}

/* ------------------ Wiring ------------------ */
function init(){
  try{
    const saved = localStorage.getItem('taskflow_log_soft');
    if(saved) { const parsed = JSON.parse(saved); if(Array.isArray(parsed)) LOG.push(...parsed); }
  }catch(e){}

  el('scenarioSelect').addEventListener('change', e=>{
    currentScenarioKey = e.target.value; updateBriefing();
  });
  el('difficultySelect').addEventListener('change', e=>{ currentDifficulty = e.target.value; });

  el('startBtn').addEventListener('click', ()=>{
    trialId += 1; trialStart = new Date();
    loadScenario();
    el('planPanel').scrollIntoView({behavior:'smooth', block:'start'});
    el('confirmBtn').disabled = true;
  });
  el('confirmBtn').addEventListener('click', ()=>{
    checkOrder = readOrder(el('checkList'));
    computeFeedback();
    appendLog();
    el('feedbackPanel').scrollIntoView({behavior:'smooth', block:'start'});
  });
  el('resetBtn').addEventListener('click', ()=>{
    addedOrder = []; checkOrder = []; trialStart = null;
    clearNode(el('planList')); clearNode(el('checkList'));
    clearNode(el('idealList')); clearNode(el('userList'));
    el('summary').textContent=''; clearNode(el('reflections'));
    el('status').textContent=''; el('confirmBtn').disabled = true;
    el('planList').classList.remove('inactive');
  });
  el('downloadBtn').addEventListener('click', downloadCSV);

  currentScenarioKey = el('scenarioSelect').value;
  currentDifficulty = el('difficultySelect').value;
  updateBriefing();
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
