<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="screen.title">Emotion Chat — Social Cognition Micro-App</title>

  <link rel="stylesheet" href="../../shared/theme.css" />
  <meta name="theme" content="bold dense" />
  <meta name="app-slug" content="emotion-chat" />
  <meta name="i18n-langs" content="en,it,es" />
  <script defer src="../../shared/frame.js"></script>
  <script defer src="../../shared/clinician_feedback.js"></script>
  <script defer src="../../shared/i18n.js"></script>

  <style>
    /* App-local (light) */
    .toolbar{ display:flex; flex-wrap:wrap; gap:.75rem; align-items:flex-end; margin-bottom: .75rem; }
    .toolbar .ctrl{ display:inline-grid; gap:.35rem; }
    .toolbar label{ font-weight:600; }

    .app-grid{ display:grid; gap:clamp(12px,1.2vw,18px); grid-template-columns:1fr 1fr; }
    @media (max-width:980px){ .app-grid{ grid-template-columns:1fr; } }

    .card{ background:var(--surface); border:1px solid var(--line); border-radius:var(--radius);
           box-shadow:var(--shadow); padding: clamp(14px,1.6vw,18px); }
    .card h2{ margin:0 0 .5rem; }

    .chat{ background: color-mix(in oklab, var(--surface), var(--line) 10%);
           border:1px solid var(--line); border-radius:14px; padding:12px; height:520px; overflow:auto; }
    .bubble{ max-width:78%; padding:10px 12px; border-radius:14px; margin:10px 0; display:inline-block;
             word-wrap:break-word; box-shadow:0 2px 8px rgba(0,0,0,.06); font-size:clamp(15px,1.4vw,16px); }
    .fromA{ background:#fff; border:1px solid #e6e6e6 }
    .fromB{ background: color-mix(in oklab, var(--accent), white 85%); border:1px solid color-mix(in oklab, var(--accent), var(--line) 75%); }
    .name{ display:block; font-size:.95rem; color:var(--muted); margin-bottom:4px }
    .footer{ display:flex; gap:10px; justify-content:space-between; align-items:center; margin-top:8px }
    .small{ color:var(--muted); font-size:.95rem; }

    .step{ background:var(--surface); border:1px solid var(--line); border-radius:12px; padding:12px }
    .row{ display:grid; gap:12px; grid-template-columns:1fr 1fr; }
    @media (max-width:720px){ .row{ grid-template-columns:1fr; } }
    textarea{ width:100%; min-height:120px; resize:vertical; }
    .legend{ color:var(--muted); }

    .pillgrid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:10px }
    .pill-btn{ display:inline-flex; align-items:center; justify-content:center; min-height:42px; padding:10px 14px;
               border-radius:999px; border:1px solid var(--line); background:#f2f4f7; cursor:pointer; font-weight:600;
               transition: transform .06s ease; }
    .pill-btn:active{ transform:scale(.98) }
    .pill-btn[aria-pressed="true"]{ background:var(--accent); color:#fff; border-color:var(--accent-600); }

    .tags{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
    .tag{ border-radius:999px; padding:6px 10px; }
    .tag.good{ border:1px solid #b7e3c4; background:#ecfdf5; color:#065f46 }
    .tag.bad{  border:1px solid #f6c7c7; background:#fef2f2; color:#7f1d1d }
    .divider{ height:1px; background:var(--line); margin:10px 0 }
  </style>
</head>
<body>
  <main id="app-root">
    <div class="toolbar" role="region" data-i18n="toolbar.aria" data-i18n-attr="aria-label">
      <div class="ctrl">
        <label for="scenario" data-i18n="toolbar.scenario.label">Scenario</label>
        <select id="scenario"></select>
      </div>
      <div class="ctrl">
        <label for="distractors" data-i18n="toolbar.distractors.label">Distractors per person</label>
        <select id="distractors">
          <option>6</option><option selected>8</option><option>10</option><option>12</option><option>14</option>
        </select>
      </div>

      <button class="button primary" id="play" data-i18n="toolbar.play">Play chat</button>
      <button class="button" id="skip" disabled data-i18n="toolbar.skip">Skip chat</button>
      <button class="button" id="reset" disabled data-i18n="toolbar.reset">Reset</button>
      <button class="button" id="download" title="Download CSV of your results" disabled
              data-i18n="toolbar.download.label" data-i18n-attr="title">Download CSV</button>
      <span class="small" id="status" aria-live="polite" data-i18n="toolbar.status.ready">Ready</span>
    </div>

    <div class="app-grid">
      <section class="card" aria-labelledby="chatTitle">
        <h2 id="chatTitle" data-i18n="sections.chat.title">Chat</h2>
        <div id="chat" class="chat" aria-label="Chat transcript" aria-live="polite"
             data-i18n="sections.chat.aria" data-i18n-attr="aria-label"></div>
        <div class="footer">
          <span class="small" id="progress" aria-live="polite" data-i18n="toolbar.status.progress"
                data-i18n-current="0" data-i18n-total="0">0 / 0</span>
          <span class="small" id="timerText"></span>
        </div>
      </section>

      <section class="card" aria-labelledby="respTitle">
        <h2 id="respTitle" data-i18n="sections.responses.title">Your responses</h2>

        <div class="step" id="step1">
          <h3 data-i18n="sections.step1.title">Step 1 — Free choice</h3>
          <div class="row">
            <div>
              <label class="legend" for="freeA" id="labelA" data-i18n="sections.step1.label">What emotions was {name} feeling?</label>
              <textarea id="freeA" data-i18n="sections.step1.placeholder" data-i18n-attr="placeholder"
                        placeholder="Type one or more emotions…"></textarea>
            </div>
            <div>
              <label class="legend" for="freeB" id="labelB" data-i18n="sections.step1.label">What emotions was {name} feeling?</label>
              <textarea id="freeB" data-i18n="sections.step1.placeholder" data-i18n-attr="placeholder"
                        placeholder="Type one or more emotions…"></textarea>
            </div>
          </div>
          <div class="divider"></div>
          <button class="button primary" id="proceed" disabled data-i18n="sections.step1.continue">Continue to Step 2</button>
          <span class="small" id="step1Hint" data-i18n="sections.step1.hint.wait">Finish the chat, then fill both boxes to proceed.</span>
        </div>

        <div class="step" id="step2" hidden>
          <h3 data-i18n="sections.step2.title">Step 2 — Select emotions (choose all that apply)</h3>
          <div class="row" style="grid-template-columns:1fr 1fr">
            <div>
              <div class="legend" id="pillTitleA" data-i18n="sections.step2.legend"></div>
              <div class="pillgrid" id="pillsA"></div>
            </div>
            <div>
              <div class="legend" id="pillTitleB" data-i18n="sections.step2.legend"></div>
              <div class="pillgrid" id="pillsB"></div>
            </div>
          </div>
          <div class="divider"></div>
          <button class="button primary" id="submit" disabled data-i18n="sections.step2.submit">Show feedback</button>
        </div>

        <div class="step" id="step3" hidden>
          <h3 data-i18n="sections.step3.title">Step 3 — Feedback</h3>
          <div class="feedback" id="fbA"></div>
          <div class="feedback" id="fbB"></div>
          <div class="tags" id="kpi"></div>
        </div>
      </section>
    </div>
  </main>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    const whenI18N = window.I18N?.ready || Promise.resolve();
    whenI18N.then(() => {
      const { I18N } = window;
      const t = (key, vars = {}) => I18N.t(key, vars);

      const $ = (id) => document.getElementById(id);

      const chatEl = $("chat");
      const scenarioSel = $("scenario");
      const playBtn = $("play");
      const skipBtn = $("skip");
      const resetBtn = $("reset");
      const downloadBtn = $("download");
      const statusEl = $("status");
      const progressEl = $("progress");
      const chatTitle = $("chatTitle");
      const timerText = $("timerText");
      const proceedBtn = $("proceed");
      const step1Hint = $("step1Hint");
      const step2 = $("step2");
      const submitBtn = $("submit");
      const step3 = $("step3");
      const freeA = $("freeA");
      const freeB = $("freeB");
      const labelA = $("labelA");
      const labelB = $("labelB");
      const pillTitleA = $("pillTitleA");
      const pillTitleB = $("pillTitleB");
      const pillsA = $("pillsA");
      const pillsB = $("pillsB");
      const fbA = $("fbA");
      const fbB = $("fbB");
      const kpi = $("kpi");
      const distractorsSel = $("distractors");

      const RESULTS = [];
      const DEFAULT_EMOTION_IDS = [
        "happy","excited","frustrated","irritated","calm","disappointed","guilty","sad","defensive","anxious",
        "embarrassed","angry","relieved","neutral","confused","optimistic","proud","distant","supportive",
        "jealous","envious","hurt","curious","content","resentful","surprised","hopeful","grateful",
        "appreciative","concerned","bored","regretful","apathetic","withdrawn"
      ];

      let masterEmotionIds = DEFAULT_EMOTION_IDS.slice();
      let scenarios = [];
      let current = null;
      let idx = 0;
      let revealed = false;
      let startTime = 0;
      let endTime = 0;
      let timer = null;
      let tickInt = null;
      let listFormatter = new Intl.ListFormat(I18N.lang, { style: 'long', type: 'conjunction' });

      const setDisabled = (el, value) => el.toggleAttribute('disabled', !!value);

      function hydrateData() {
        const dict = I18N.dict || {};
        const emotions = dict.emotions || {};
        if (Array.isArray(emotions.master) && emotions.master.length) {
          masterEmotionIds = emotions.master.slice();
        } else {
          masterEmotionIds = DEFAULT_EMOTION_IDS.slice();
        }
        listFormatter = new Intl.ListFormat(I18N.lang, { style: 'long', type: 'conjunction' });

        const scenarioDict = dict.scenarios || {};
        const order = Array.isArray(scenarioDict.order)
          ? scenarioDict.order
          : Object.keys(scenarioDict).filter(key => key !== 'order');
        scenarios = order.map((id) => {
          const entry = scenarioDict[id];
          if (!entry) return null;
          const messages = Array.isArray(entry.messages)
            ? entry.messages.map((m) => ({ from: m.from, text: m.text }))
            : [];
          return {
            id,
            title: entry.title || id,
            people: entry.people || {},
            messages,
            correct: entry.correct || {},
            cues: entry.cues || {}
          };
        }).filter(Boolean);
      }

      function formatEmotion(id) {
        const key = `emotions.labels.${id}`;
        const label = t(key);
        return label === key ? id : label;
      }

      function formatList(ids) {
        if (!ids || !ids.length) return t('sections.step3.none');
        return listFormatter.format(ids.map(formatEmotion));
      }

      function clearChat() {
        chatEl.innerHTML = '';
      }

      function addBubble(message) {
        const wrap = document.createElement('div');
        const bubble = document.createElement('div');
        const who = document.createElement('span');
        const from = message.from;
        const name = current?.people?.[from] || from;
        who.className = 'name';
        who.textContent = name;
        bubble.className = 'bubble ' + (from === 'A' ? 'fromA' : 'fromB');
        bubble.textContent = message.text;
        wrap.appendChild(who);
        wrap.appendChild(bubble);
        wrap.style.textAlign = from === 'A' ? 'left' : 'right';
        chatEl.appendChild(wrap);
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      function shuffle(arr) {
        return [...arr].sort(() => Math.random() - 0.5);
      }

      function clearI18nVars(el) {
        Array.from(el.attributes).forEach((attr) => {
          if (attr.name.startsWith('data-i18n-') && attr.name !== 'data-i18n' && attr.name !== 'data-i18n-attr') {
            el.removeAttribute(attr.name);
          }
        });
      }

      function setI18n(el, key, vars = {}) {
        if (!el) return;
        clearI18nVars(el);
        if (key) {
          el.setAttribute('data-i18n', key);
          Object.entries(vars).forEach(([name, value]) => {
            el.setAttribute(`data-i18n-${name}`, value);
          });
          I18N.apply(el);
        } else {
          el.removeAttribute('data-i18n');
          el.textContent = '';
        }
      }

      function setProgress(currentValue, totalValue) {
        setI18n(progressEl, 'toolbar.status.progress', { current: currentValue, total: totalValue });
      }

      function setTimerValue(seconds) {
        if (seconds == null) {
          clearI18nVars(timerText);
          timerText.removeAttribute('data-i18n');
          timerText.textContent = '';
          return;
        }
        setI18n(timerText, 'toolbar.status.timer', { seconds });
      }

      function setStatus(key, vars = {}) {
        setI18n(statusEl, key, vars);
      }

      function secondsSince(t0) {
        return Math.max(0, Math.round((Date.now() - t0) / 1000));
      }

      function stopTicking() {
        if (tickInt) {
          clearInterval(tickInt);
          tickInt = null;
        }
      }

      function startTicking() {
        stopTicking();
        tickInt = setInterval(() => {
          if (startTime) {
            setTimerValue(secondsSince(startTime));
          }
        }, 1000);
      }

      function stopPlaybackTimer() {
        if (timer) {
          clearInterval(timer);
          timer = null;
        }
      }

      function populateScenarioList(selectedId) {
        scenarioSel.innerHTML = '';
        scenarios.forEach((s) => {
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = s.title || s.id;
          scenarioSel.appendChild(opt);
        });
        if (selectedId) {
          scenarioSel.value = selectedId;
        }
      }

      function loadScenario(id) {
        if (!scenarios.length) return;
        current = scenarios.find((s) => s.id === id) || scenarios[0];
        scenarioSel.value = current.id;
        idx = 0;
        revealed = false;
        startTime = 0;
        endTime = 0;
        stopPlaybackTimer();
        stopTicking();
        clearChat();
        step3.hidden = true;
        setProgress(0, current.messages.length || 0);
        setTimerValue(null);
        setStatus('toolbar.status.ready');
        setDisabled(playBtn, false);
        setDisabled(skipBtn, true);
        setDisabled(resetBtn, true);
        setDisabled(downloadBtn, RESULTS.length === 0);

        freeA.value = '';
        freeB.value = '';
        setI18n(chatTitle, 'sections.chat.title_with_names', {
          name_a: current.people?.A || 'A',
          name_b: current.people?.B || 'B'
        });
        setI18n(labelA, 'sections.step1.label', { name: current.people?.A || 'A' });
        setI18n(labelB, 'sections.step1.label', { name: current.people?.B || 'B' });

        step2.hidden = true;
        submitBtn.disabled = true;
        setI18n(pillTitleA, 'sections.step2.legend', { name: current.people?.A || 'A' });
        setI18n(pillTitleB, 'sections.step2.legend', { name: current.people?.B || 'B' });

        buildPills();
        updateProceedState();
      }

      function buildPills() {
        const N = parseInt(distractorsSel.value, 10) || 8;
        const correctA = Array.isArray(current?.correct?.A) ? current.correct.A : [];
        const correctB = Array.isArray(current?.correct?.B) ? current.correct.B : [];

        const makeGrid = (arr) => {
          const set = new Set(arr);
          const pool = masterEmotionIds.filter((id) => !set.has(id));
          const distractors = shuffle(pool).slice(0, Math.max(0, N));
          return shuffle([...new Set([...arr, ...distractors])]);
        };

        const listA = makeGrid(correctA);
        const listB = makeGrid(correctB);

        pillsA.innerHTML = '';
        pillsB.innerHTML = '';

        listA.forEach((id) => {
          const btn = document.createElement('button');
          btn.className = 'pill-btn';
          btn.type = 'button';
          btn.dataset.emotionId = id;
          btn.textContent = formatEmotion(id);
          btn.setAttribute('aria-pressed', 'false');
          btn.addEventListener('click', () => {
            togglePill(btn);
            updateSubmitState();
          });
          pillsA.appendChild(btn);
        });

        listB.forEach((id) => {
          const btn = document.createElement('button');
          btn.className = 'pill-btn';
          btn.type = 'button';
          btn.dataset.emotionId = id;
          btn.textContent = formatEmotion(id);
          btn.setAttribute('aria-pressed', 'false');
          btn.addEventListener('click', () => {
            togglePill(btn);
            updateSubmitState();
          });
          pillsB.appendChild(btn);
        });
      }

      function togglePill(el) {
        const pressed = el.getAttribute('aria-pressed') === 'true';
        el.setAttribute('aria-pressed', String(!pressed));
      }

      function updateProceedState() {
        const filled = freeA.value.trim().length > 0 && freeB.value.trim().length > 0;
        setDisabled(proceedBtn, !(filled && revealed));
        if (!revealed) {
          setI18n(step1Hint, 'sections.step1.hint.wait');
        } else if (filled) {
          setI18n(step1Hint, 'sections.step1.hint.ready');
        } else {
          setI18n(step1Hint, 'sections.step1.hint.fill');
        }
      }

      function updateSubmitState() {
        const aChosen = !!pillsA.querySelector('.pill-btn[aria-pressed="true"]');
        const bChosen = !!pillsB.querySelector('.pill-btn[aria-pressed="true"]');
        setDisabled(submitBtn, !(aChosen && bChosen));
      }

      function playChat() {
        if (!current) return;
        setDisabled(playBtn, true);
        setDisabled(skipBtn, false);
        setDisabled(resetBtn, false);
        setStatus('toolbar.status.playing');
        startTime = Date.now();
        setTimerValue(0);
        startTicking();
        stopPlaybackTimer();
        timer = setInterval(() => {
          if (idx >= current.messages.length) {
            finishChat();
            return;
          }
          const message = current.messages[idx++];
          addBubble(message);
          setProgress(idx, current.messages.length);
          if (idx >= current.messages.length) {
            finishChat();
          }
        }, 3500);
      }

      function finishChat() {
        stopPlaybackTimer();
        setDisabled(skipBtn, true);
        endTime = Date.now();
        stopTicking();
        if (startTime) {
          setTimerValue(secondsSince(startTime));
        }
        setStatus('toolbar.status.complete');
        revealed = true;
        updateProceedState();
      }

      function skipChat() {
        if (!current) return;
        if (!startTime) {
          startTime = Date.now();
          setTimerValue(0);
          startTicking();
        }
        stopPlaybackTimer();
        while (idx < current.messages.length) {
          const message = current.messages[idx++];
          addBubble(message);
        }
        setProgress(current.messages.length, current.messages.length);
        finishChat();
      }

      function resetAll() {
        loadScenario(scenarioSel.value);
      }

      function computeFeedback() {
        const selectedA = [...pillsA.querySelectorAll('.pill-btn[aria-pressed="true"]')]
          .map((btn) => btn.dataset.emotionId);
        const selectedB = [...pillsB.querySelectorAll('.pill-btn[aria-pressed="true"]')]
          .map((btn) => btn.dataset.emotionId);

        const corrA = Array.isArray(current?.correct?.A) ? current.correct.A : [];
        const corrB = Array.isArray(current?.correct?.B) ? current.correct.B : [];

        const setFrom = (arr) => new Set(arr);
        const aSet = setFrom(selectedA);
        const bSet = setFrom(selectedB);
        const cA = setFrom(corrA);
        const cB = setFrom(corrB);

        const aHits = selectedA.filter((id) => cA.has(id));
        const aMiss = corrA.filter((id) => !aSet.has(id));
        const aExtra = selectedA.filter((id) => !cA.has(id));

        const bHits = selectedB.filter((id) => cB.has(id));
        const bMiss = corrB.filter((id) => !bSet.has(id));
        const bExtra = selectedB.filter((id) => !cB.has(id));

        const precision = (hits, picks) => (picks === 0 ? 0 : Math.round((hits / picks) * 100));
        const recall = (hits, total) => (total === 0 ? 0 : Math.round((hits / total) * 100));

        const aPrec = precision(aHits.length, selectedA.length);
        const aRec = recall(aHits.length, corrA.length);
        const bPrec = precision(bHits.length, selectedB.length);
        const bRec = recall(bHits.length, corrB.length);

        fbA.innerHTML = `
          <strong>${current.people?.A || 'A'}</strong><br/>
          <span class="small">${t('sections.step3.correct')}</span> ${formatList(corrA)}<br/>
          <span class="small">${t('sections.step3.selected')}</span> ${formatList(selectedA)}<br/>
          <div class="small" style="margin-top:6px">${current.cues?.A || ''}</div>
          <div class="small" style="margin-top:6px;color:${aExtra.length ? '#7f1d1d' : '#065f46'}">
            ${t('sections.step3.hits')}: ${formatList(aHits)} | ${t('sections.step3.missed')}: ${formatList(aMiss)} | ${t('sections.step3.extra')}: ${formatList(aExtra)}
          </div>
        `;

        fbB.innerHTML = `
          <strong>${current.people?.B || 'B'}</strong><br/>
          <span class="small">${t('sections.step3.correct')}</span> ${formatList(corrB)}<br/>
          <span class="small">${t('sections.step3.selected')}</span> ${formatList(selectedB)}<br/>
          <div class="small" style="margin-top:6px">${current.cues?.B || ''}</div>
          <div class="small" style="margin-top:6px;color:${bExtra.length ? '#7f1d1d' : '#065f46'}">
            ${t('sections.step3.hits')}: ${formatList(bHits)} | ${t('sections.step3.missed')}: ${formatList(bMiss)} | ${t('sections.step3.extra')}: ${formatList(bExtra)}
          </div>
        `;

        kpi.innerHTML = `
          <span class="tag ${aRec >= 75 ? 'good' : 'bad'}">${t('sections.step3.summary', { name: current.people?.A || 'A', metric: t('sections.step3.metrics.recall'), value: aRec })}</span>
          <span class="tag ${aPrec >= 75 ? 'good' : 'bad'}">${t('sections.step3.summary', { name: current.people?.A || 'A', metric: t('sections.step3.metrics.precision'), value: aPrec })}</span>
          <span class="tag ${bRec >= 75 ? 'good' : 'bad'}">${t('sections.step3.summary', { name: current.people?.B || 'B', metric: t('sections.step3.metrics.recall'), value: bRec })}</span>
          <span class="tag ${bPrec >= 75 ? 'good' : 'bad'}">${t('sections.step3.summary', { name: current.people?.B || 'B', metric: t('sections.step3.metrics.precision'), value: bPrec })}</span>
        `;

        step3.hidden = false;

        const durationSec = Math.max(0, Math.round(((endTime || Date.now()) - (startTime || Date.now())) / 1000));
        RESULTS.push({
          scenario_id: current.id,
          scenario_title: current.title,
          personA: current.people?.A || 'A',
          personB: current.people?.B || 'B',
          freeA: freeA.value.replace(/\s+/g, ' ').trim(),
          freeB: freeB.value.replace(/\s+/g, ' ').trim(),
          selectedA: formatList(selectedA),
          selectedB: formatList(selectedB),
          hitsA: formatList(aHits),
          hitsB: formatList(bHits),
          missedA: formatList(aMiss),
          missedB: formatList(bMiss),
          extraA: formatList(aExtra),
          extraB: formatList(bExtra),
          precisionA: aPrec,
          recallA: aRec,
          precisionB: bPrec,
          recallB: bRec,
          distractors_per_person: parseInt(distractorsSel.value, 10),
          duration_s: durationSec,
          timestamp: new Date().toISOString()
        });
        setDisabled(downloadBtn, RESULTS.length === 0);
      }

      function toCSV(rows) {
        const headers = Object.keys(rows[0]);
        const escape = (value) => `"${String(value ?? '').replace(/"/g, '""')}"`;
        const lines = [headers.join(',')].concat(rows.map((row) => headers.map((h) => escape(row[h])).join(',')));
        return lines.join('\n');
      }

      function downloadCSV() {
        if (!RESULTS.length) return;
        const csv = toCSV(RESULTS);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const anchor = document.createElement('a');
        anchor.href = url;
        anchor.download = t('csv.fileName');
        document.body.appendChild(anchor);
        anchor.click();
        anchor.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      }

      scenarioSel.addEventListener('change', (e) => loadScenario(e.target.value));
      distractorsSel.addEventListener('change', () => buildPills());
      playBtn.addEventListener('click', playChat);
      skipBtn.addEventListener('click', skipChat);
      resetBtn.addEventListener('click', resetAll);
      downloadBtn.addEventListener('click', downloadCSV);
      proceedBtn.addEventListener('click', () => {
        step2.hidden = false;
        const first = pillsA.querySelector('.pill-btn');
        if (first) first.focus();
      });
      submitBtn.addEventListener('click', computeFeedback);
      freeA.addEventListener('input', updateProceedState);
      freeB.addEventListener('input', updateProceedState);

      hydrateData();
      populateScenarioList(scenarios[0]?.id || '');
      if (scenarios.length) {
        loadScenario(scenarios[0].id);
      }

      const originalApply = I18N.apply.bind(I18N);
      let rerendering = false;
      I18N.apply = (root = document) => {
        originalApply(root);
        if (!rerendering && (!root || root === document)) {
          rerendering = true;
          try {
            const currentId = current?.id;
            hydrateData();
            const fallbackId = currentId && scenarios.some((s) => s.id === currentId)
              ? currentId
              : (scenarios[0]?.id || '');
            populateScenarioList(fallbackId);
            if (fallbackId) {
              loadScenario(fallbackId);
            }
          } finally {
            rerendering = false;
          }
        }
      };
    });
  });
  </script>
</body>
</html>
