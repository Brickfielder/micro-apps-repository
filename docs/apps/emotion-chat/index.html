<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Emotion Chat Ã¢â‚¬â€ Social Cognition Micro-App</title>
<meta content="WhatsApp-style scenarios to practice emotion recognition, theory of mind, and social reasoning." name="description"/>
<style>
  /* ===================== Design tokens ===================== */
  :root{
    color-scheme: light dark;

    /* Colors (light) */
    --bg:#f6f7fb;
    --surface:#ffffff;
    --surface-alt:#f1f5f9;
    --text:#0f172a;        /* slate-900 */
    --muted:#475569;       /* slate-600 */
    --line:#e2e8f0;        /* slate-200 */
    --brand:#3b82f6;       /* blue-500 */
    --brand-600:#2563eb;   /* blue-600 */
    --brand-700:#1d4ed8;   /* blue-700 */
    --chip-bg:#eef2ff;
    --chip-fg:#4f46e5;

    --good:#16a34a; --bad:#b91c1c;

    /* Type scale */
    --font-base: clamp(17px, 1.2vw, 19px);
    --h1: clamp(30px, 3.4vw, 44px);
    --h2: clamp(18px, 2vw, 22px);
    --h3: clamp(16px, 1.6vw, 18px);
    --small: clamp(13px, 1.2vw, 14.5px);

    /* Layout */
    --r:16px; --r-lg:22px;
    --shadow: 0 8px 28px rgba(2,6,23,.08);
    --shadow-sm: 0 2px 8px rgba(2,6,23,.06);
  }

  *{ box-sizing:border-box }
  html, body { height:100% }
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
    font-size: var(--font-base); line-height:1.55;
    -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
  }

  /* ===================== Header ===================== */
  header{
    position: sticky; top: 0; z-index: 10;
    background: linear-gradient(180deg,#fff,rgba(255,255,255,.94));
    backdrop-filter: saturate(1.05) blur(6px);
    border-bottom: 1px solid var(--line);
  }
  .wrap{ max-width: 1200px; margin: 0 auto; padding: 20px 22px; }
  .stack{ display:grid; gap:10px }
  .chip{
    width:max-content; display:inline-flex; align-items:center; gap:8px;
    padding:6px 12px; border-radius:999px; font-size: var(--small);
    background:var(--chip-bg); color:var(--chip-fg); border:1px solid var(--line);
    box-shadow: var(--shadow-sm);
  }
  .brandtitle{
    margin:0; font-weight:800; letter-spacing:-0.01em; line-height:1.15; font-size:var(--h1);
  }
  .brandtitle .accent{ color: var(--brand) }
  p.sub{ margin:0; color:var(--muted); font-size: var(--small) }

  /* Controls bar */
  .bar{ display:flex; flex-wrap:wrap; gap: 12px 14px; align-items:flex-end; margin-top: 8px }
  .bar label{ font-size: var(--small); color:var(--muted); display:inline-grid; gap:6px }
  select,button,textarea,input{ font:inherit }
  select,button{
    border:1px solid var(--line); border-radius: 12px; padding: 12px 14px; background:#fff; box-shadow: var(--shadow-sm);
  }
  button.primary{ background:var(--brand); color:#fff; border:none }
  button.primary:hover{ background:var(--brand-600) }
  button.secondary{ background:#fff }
  button.ghost{ background:transparent; border-color:transparent; color:var(--muted) }
  button:disabled{ opacity:.6; cursor:not-allowed }

  /* Visible, accessible focus */
  :where(button,a,select,textarea,input):focus-visible{
    outline: 3px solid color-mix(in oklab, var(--brand) 60%, white);
    outline-offset: 2px;
    border-color: var(--brand-600);
  }

  /* ===================== Main ===================== */
  main{ padding: 22px }
  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 22px }
  @media (max-width: 980px){ .grid{ grid-template-columns:1fr } }

  .card{
    background:var(--surface); border:1px solid var(--line); border-radius:var(--r-lg); box-shadow:var(--shadow);
  }
  .pad{ padding: 18px 18px 16px }
  .card h2{ font-size: var(--h2); margin: 0 0 12px }

  /* Chat */
  .chat{
    background: var(--surface-alt); border-radius: var(--r);
    padding: 16px; height: 560px; overflow:auto; border:1px solid var(--line);
  }
  .bubble{
    max-width: 78%; padding: 12px 14px; border-radius: 16px; margin: 10px 0;
    display:inline-block; word-wrap:break-word; box-shadow: var(--shadow-sm);
    font-size: clamp(15px, 1.4vw, 16px);
  }
  .fromA{ background:#fff; border:1px solid #e6e6e6 }
  .fromB{ background:#ffe8e5; border:1px solid #ffd2cc }
  .name{ display:block; font-size: var(--small); color:var(--muted); margin-bottom:4px }
  .footer{ display:flex; gap:8px; justify-content:space-between; align-items:center; margin-top:12px }
  .divider{ height:1px; background:var(--line); margin:12px 0 }
  .small{ font-size: var(--small); color:var(--muted) }

  /* Steps */
  .step{ background:#fff; border:1px solid var(--line); border-radius:14px; padding:14px }
  .step h3{ margin:6px 0 12px; font-size: var(--h3) }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
  @media(max-width: 720px){ .row{ grid-template-columns:1fr } }
  textarea{ width:100%; min-height:130px; padding:12px 14px; border-radius:12px; border:1px solid var(--line); background:#fff; resize:vertical }
  textarea::placeholder{ color:#94a3b8 }
  .legend{ color:var(--muted); font-size: var(--small) }

  /* Pills */
  .pills{ display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:12px; padding:6px 0 }
  .pill{
    display:inline-flex; align-items:center; justify-content:center;
    padding: 12px 16px; min-height: 46px; font-weight:600;
    background:#eef2ff; border:1px solid #c7d2fe; border-radius:999px; cursor:pointer; user-select:none;
    transition: transform .06s ease-out;
  }
  .pill:active{ transform: scale(.98) }
  .pill[aria-pressed="true"]{ background:var(--brand); color:#fff; border-color:transparent }

  .feedback{ border-left:4px solid var(--brand); padding-left:12px; margin:10px 0 }
  .kpi{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
  .tag{ display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border-radius:999px; font-size:var(--small); border:1px solid var(--line); background:#fff }
  .tag.good{ border-color:#b7e3c4; background:#ecfdf5; color:#065f46 }
  .tag.bad{ border-color:#f6c7c7; background:#fef2f2; color:#7f1d1d }

  /* Dark mode */
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0b1220; --surface:#0f172a; --surface-alt:#111827; --text:#e6edf7; --muted:#9fb0c8; --line:#233047;
      --chip-bg:#1e293b; --chip-fg:#93c5fd;
    }
    header{ background: linear-gradient(180deg,#0f172a,rgba(15,23,42,.92)); }
    select,button{ background:#0f172a; color:var(--text); border-color:#233047 }
    .fromA{ background:#0b1220; border-color:#233047 }
    .fromB{ background:#172554; border-color:#1e3a8a }
    textarea{ background:#0b1220; color:var(--text); border-color:#233047 }
    .card{ box-shadow: 0 8px 28px rgba(0,0,0,.35) }
  }

  /* Motion */
  @media (prefers-reduced-motion: reduce){
    *{ animation-duration:0.01ms !important; animation-iteration-count:1 !important; transition-duration:0.01ms !important; scroll-behavior:auto !important }
  }
</style>
<meta content="emotion_chat" name="app-slug"/><link href="/shared/theme.css" rel="stylesheet"/><script defer="" src="/shared/frame.js"></script><link href="../../../shared/theme.css" rel="stylesheet"/><script defer="" src="../../../shared/frame.js"></script><script defer="" src="../../../shared/clinician_feedback.js"></script>  <meta name="app-slug" content="emotion-chat">
</head>
<body><main id="app-root">
<header>
<div class="wrap stack">
<span class="chip">Prototype</span>
<h1 class="brandtitle">Emotion Chat Ã¢â‚¬â€ <span class="accent" id="accentWord"></span></h1>
<p class="sub">WhatsApp-style scenarios to practice emotion recognition, theory of mind, and social reasoning.</p>
<div class="bar">
<label>
          Scenario
          <select id="scenario"></select>
</label>
<label>
          Distractors per person
          <select id="distractors">
<option>6</option>
<option selected="">8</option>
<option>10</option>
<option>12</option>
<option>14</option>
</select>
</label>
<button class="primary" id="play">Play chat</button>
<button class="secondary" disabled="" id="skip">Skip chat</button>
<button class="ghost" disabled="" id="reset">Reset</button>
<button class="secondary" disabled="" id="download" title="Download CSV of your results">Download CSV</button>
<span aria-live="polite" class="small" id="status"></span>
</div>
</div>
</header>
<main class="wrap">
<div class="grid">
<!-- Left: Chat -->
<section aria-labelledby="chatTitle" class="card pad">
<h2 id="chatTitle">Chat</h2>
<div aria-label="Chat transcript" aria-live="polite" class="chat" id="chat"></div>
<div class="footer">
<span class="small" id="progress">0 / 0</span>
<span class="small" id="timerText"></span>
</div>
</section>
<!-- Right: Steps -->
<section aria-labelledby="respTitle" class="card pad">
<h2 id="respTitle">Your responses</h2>
<div class="step" id="step1">
<h3>Step 1 Ã¢â‚¬â€ Free choice</h3>
<div class="row">
<div>
<label class="legend" for="freeA" id="labelA"></label>
<textarea id="freeA" placeholder="Type one or more emotionsÃ¢â‚¬Â¦"></textarea>
</div>
<div>
<label class="legend" for="freeB" id="labelB"></label>
<textarea id="freeB" placeholder="Type one or more emotionsÃ¢â‚¬Â¦"></textarea>
</div>
</div>
<div class="divider"></div>
<button class="primary" disabled="" id="proceed">Continue to Step 2</button>
<span class="small" id="step1Hint">Finish the chat, then fill both boxes to proceed.</span>
</div>
<div class="step" hidden="" id="step2">
<h3>Step 2 Ã¢â‚¬â€ Select emotions (choose all that apply)</h3>
<div class="row" style="grid-template-columns:1fr 1fr">
<div>
<div class="legend" id="pillTitleA"></div>
<div class="pills" id="pillsA"></div>
</div>
<div>
<div class="legend" id="pillTitleB"></div>
<div class="pills" id="pillsB"></div>
</div>
</div>
<div class="divider"></div>
<button class="primary" disabled="" id="submit">Show feedback</button>
</div>
<div class="step" hidden="" id="step3">
<h3>Step 3 Ã¢â‚¬â€ Feedback</h3>
<div class="feedback" id="fbA"></div>
<div class="feedback" id="fbB"></div>
<div class="kpi" id="kpi"></div>
</div>
</section>
</div>
</main>
<script>
/* ========= Global master list ========= */
const MASTER_PILLS = [
  "Happy","Excited","Frustrated","Irritated","Calm","Disappointed","Guilty","Sad","Defensive","Anxious",
  "Embarrassed","Angry","Relieved","Neutral","Confused","Optimistic","Proud","Distant","Supportive",
  "Jealous","Envious","Hurt","Curious","Content","Resentful","Surprised","Hopeful",
  "Grateful","Appreciative","Concerned","Bored","Regretful","Apathetic"
];

/* ========= Scenarios (10) ========= */
const SCENARIOS = [
  { id:"A", title:"Group Project", people:{A:"Alex", B:"Sam"},
    messages:[
      {from:"A", text:"Hey, have you added your part to the doc yet?"},
      {from:"B", text:"Not yet, had a busy day. Will do later."},
      {from:"A", text:"Okay, itÃ¢â‚¬â„¢s just due tomorrow Ã°Å¸ËœÂ¬"},
      {from:"B", text:"I know, relax. IÃ¢â‚¬â„¢ll get it done."},
      {from:"A", text:"We still need to check references and format everything."},
      {from:"B", text:"You always stress too much. ItÃ¢â‚¬â„¢ll be fine."},
      {from:"A", text:"IÃ¢â‚¬â„¢m not stressing, just making sure we donÃ¢â‚¬â„¢t lose marks."},
      {from:"B", text:"Well I said IÃ¢â‚¬â„¢ll do it later. Can you chill?"},
      {from:"A", text:"Ã¢â‚¬Â¦"},
      {from:"B", text:"Why the dots? Ã°Å¸â„¢â€ž"},
      {from:"A", text:"Nothing. IÃ¢â‚¬â„¢ll just finish it myself."},
      {from:"B", text:"Suit yourself then."}
    ],
    correct:{ A:["Frustrated","Disappointed","Sad","Withdrawn"], B:["Irritated","Defensive"] },
    cues:{
      A:"Frustration (Ã¢â‚¬Å“due tomorrow Ã°Å¸ËœÂ¬Ã¢â‚¬Â), disappointment (Ã¢â‚¬Å“IÃ¢â‚¬â„¢ll finish it myselfÃ¢â‚¬Â), withdrawal (Ã¢â‚¬Å“Ã¢â‚¬Â¦Ã¢â‚¬Â).",
      B:"Defensiveness (Ã¢â‚¬Å“You always stress too muchÃ¢â‚¬Â), irritation (Ã°Å¸â„¢â€ž)."
    }
  },
  { id:"B", title:"Missed Call", people:{A:"Maya", B:"Leo"},
    messages:[
      {from:"A", text:"Tried calling you 3 times last night, where were you? Ã°Å¸Ëœâ€¢"},
      {from:"B", text:"Sorry, phone was on silent."},
      {from:"A", text:"I was worried. Thought something happened."},
      {from:"B", text:"Nah, just needed some quiet time."},
      {from:"A", text:"Without telling me? We were supposed to chat."},
      {from:"B", text:"DidnÃ¢â‚¬â„¢t think it was a big deal."},
      {from:"A", text:"Well it kind of wasÃ¢â‚¬Â¦ I waited."},
      {from:"B", text:"You always overthink these things."},
      {from:"A", text:"Maybe. But it hurt a little."},
      {from:"B", text:"I didnÃ¢â‚¬â„¢t mean to. Just tired."},
      {from:"A", text:"SoÃ¢â‚¬Â¦ are we still talking tonight?"},
      {from:"B", text:"Might be busy again. DonÃ¢â‚¬â„¢t wait up."},
      {from:"A", text:"Oh. Okay then."}
    ],
    correct:{ A:["Anxious","Hurt","Disappointed"], B:["Distant","Defensive","Irritated"] },
    cues:{
      A:"Anxiety (Ã¢â‚¬Å“worriedÃ¢â‚¬Â), hurt/disappointment (Ã¢â‚¬Å“I waitedÃ¢â‚¬Â, Ã¢â‚¬Å“hurt a littleÃ¢â‚¬Â).",
      B:"Avoidance, defensiveness (Ã¢â‚¬Å“overthinkÃ¢â‚¬Â), distance (Ã¢â‚¬Å“DonÃ¢â‚¬â„¢t wait upÃ¢â‚¬Â)."
    }
  },
  { id:"C", title:"Forgotten Favour", people:{A:"Liam", B:"Noah"},
    messages:[
      {from:"A", text:"Hey, did you manage to pick up my parcel?"},
      {from:"B", text:"Ah, totally slipped my mind Ã°Å¸ËœÂ¬ sorry."},
      {from:"A", text:"ThatÃ¢â‚¬â„¢s the third time youÃ¢â‚¬â„¢ve forgottenÃ¢â‚¬Â¦"},
      {from:"B", text:"IÃ¢â‚¬â„¢ve been super busy, cut me some slack."},
      {from:"A", text:"I waited at home all afternoon."},
      {from:"B", text:"I said I was sorry. Do you want me to drive there now?"},
      {from:"A", text:"It closes in 10 minutes. Forget it."},
      {from:"B", text:"Come on, donÃ¢â‚¬â„¢t be dramatic."},
      {from:"A", text:"Right."},
      {from:"B", text:"Seriously, what do you want me to do?"},
      {from:"A", text:"Nothing. IÃ¢â‚¬â„¢ll figure it out."},
      {from:"B", text:"Fine then."}
    ],
    correct:{ A:["Frustrated","Resentful","Disappointed"], B:["Guilty","Defensive"] },
    cues:{
      A:"Ã¢â‚¬Å“Third timeÃ¢â‚¬Â¦Ã¢â‚¬Â = resentment; Ã¢â‚¬Å“Forget itÃ¢â‚¬Â = disappointment.",
      B:"Ã¢â‚¬Å“Ã°Å¸ËœÂ¬ sorryÃ¢â‚¬Â = guilt; Ã¢â‚¬Å“cut me some slackÃ¢â‚¬Â = defensive."
    }
  },
  { id:"D", title:"Concert Ticket", people:{A:"Ella", B:"Sophie"},
    messages:[
      {from:"A", text:"Guess what, I got tickets to the concert!! Ã°Å¸Å½Â¶Ã°Å¸â€Â¥"},
      {from:"B", text:"No way, lucky you."},
      {from:"A", text:"Front row seats too Ã°Å¸ËœÂ canÃ¢â‚¬â„¢t wait."},
      {from:"B", text:"Wow. MustÃ¢â‚¬â„¢ve cost a fortune."},
      {from:"A", text:"Worth every penny."},
      {from:"B", text:"I tried but they were sold outÃ¢â‚¬Â¦"},
      {from:"A", text:"I was online right when they went live."},
      {from:"B", text:"Not all of us can sit refreshing a page all day Ã°Å¸â„¢â€ž."},
      {from:"A", text:"Hey, sorry. DidnÃ¢â‚¬â„¢t mean to rub it in."},
      {from:"B", text:"No, itÃ¢â‚¬â„¢s fine. Have fun."},
      {from:"A", text:"Want me to record some clips for you?"},
      {from:"B", text:"DonÃ¢â‚¬â„¢t bother."},
      {from:"A", text:"Ã¢â‚¬Â¦"}
    ],
    correct:{ A:["Excited","Guilty"], B:["Jealous","Irritated","Hurt","Envious"] },
    cues:{
      A:"Ã¢â‚¬Å“Front row seats Ã°Å¸ËœÂÃ¢â‚¬Â = excitement; apology hints guilt.",
      B:"Dismissive lines + Ã°Å¸â„¢â€ž + Ã¢â‚¬Å“DonÃ¢â‚¬â„¢t botherÃ¢â‚¬Â = envy, irritation, hurt."
    }
  },
  { id:"E", title:"Lost Wallet", people:{A:"Nina", B:"Omar"},
    messages:[
      {from:"A", text:"I just found your wallet by the cafÃƒÂ©!"},
      {from:"B", text:"No wayÃ¢â‚¬â€are you serious??"},
      {from:"A", text:"Yep. EverythingÃ¢â‚¬â„¢s inside. I can drop it off now."},
      {from:"B", text:"IÃ¢â‚¬â„¢ve been searching for an hour. I thought it was gone forever."},
      {from:"A", text:"IÃ¢â‚¬â„¢m outside your building in 5."},
      {from:"B", text:"YouÃ¢â‚¬â„¢re a lifesaver. I was panicking."},
      {from:"A", text:"All good. See you in a bit."},
      {from:"B", text:"Thank you, really. I owe you one."},
      {from:"A", text:"DonÃ¢â‚¬â„¢t worry about it Ã°Å¸ËœÅ "},
      {from:"B", text:"I can finally breathe."}
    ],
    correct:{ A:["Supportive","Calm","Content"], B:["Relieved","Grateful","Appreciative"] },
    cues:{ A:"Practical reassurance + calm tone.", B:"Relief (Ã¢â‚¬Å“finally breatheÃ¢â‚¬Â), gratitude (Ã¢â‚¬Å“owe you oneÃ¢â‚¬Â)." }
  },
  { id:"F", title:"Presentation Praise", people:{A:"Ava", B:"Ben"},
    messages:[
      {from:"A", text:"Your presentation was fantastic today!"},
      {from:"B", text:"OhÃ¢â‚¬â€thanks! IÃ¢â‚¬â„¢m glad it landed."},
      {from:"A", text:"The Q&A was tough but you handled it."},
      {from:"B", text:"I did prepare for those."},
      {from:"A", text:"You should be proud."},
      {from:"B", text:"I am, actually. It took weeks."},
      {from:"A", text:"It showed."},
      {from:"B", text:"Thanks for saying that."},
      {from:"A", text:"We should submit it to the conference."},
      {from:"B", text:"Great idea!"}
    ],
    correct:{ A:["Supportive","Happy"], B:["Proud","Relieved","Happy"] },
    cues:{ A:"Warm encouragement and affirmation.", B:"Acknowledges effort Ã¢â€ â€™ pride; post-event easing Ã¢â€ â€™ relief." }
  },
  { id:"G", title:"Awkward Joke", people:{A:"Chloe", B:"Dan"},
    messages:[
      {from:"A", text:"About earlierÃ¢â‚¬Â¦ my joke wasnÃ¢â‚¬â„¢t great."},
      {from:"B", text:"It caught people off guard."},
      {from:"A", text:"I didnÃ¢â‚¬â„¢t mean to upset anyone."},
      {from:"B", text:"Maybe just bad timing."},
      {from:"A", text:"I feel silly now."},
      {from:"B", text:"Happens to everyone."},
      {from:"A", text:"Should I apologise to Mira?"},
      {from:"B", text:"A quick message would help."},
      {from:"A", text:"IÃ¢â‚¬â„¢ll do that now."},
      {from:"B", text:"Good call."}
    ],
    correct:{ A:["Embarrassed","Regretful","Anxious"], B:["Supportive","Concerned","Calm"] },
    cues:{ A:"Admits mistake Ã¢â€ â€™ embarrassment/regret.", B:"Gentle guidance; steady tone." }
  },
  { id:"H", title:"Flat Tyre", people:{A:"Priya", B:"Tom"},
    messages:[
      {from:"A", text:"Stuck with a flat tyre on the A2."},
      {from:"B", text:"Are you safe? Hazards on?"},
      {from:"A", text:"Yeah, pulled over."},
      {from:"B", text:"I can come out with the pump."},
      {from:"A", text:"ThatÃ¢â‚¬â„¢d be amazing."},
      {from:"B", text:"Send me your location."},
      {from:"A", text:"Done."},
      {from:"B", text:"On my way. 15 mins."},
      {from:"A", text:"Thanks. I was a bit shaken."},
      {from:"B", text:"YouÃ¢â‚¬â„¢ll be fine. WeÃ¢â‚¬â„¢ve got this."}
    ],
    correct:{ A:["Anxious","Relieved"], B:["Concerned","Supportive","Calm"] },
    cues:{ A:"Stress then relief when help is coming.", B:"Checks safety, offers concrete help." }
  },
  { id:"I", title:"Party Invite", people:{A:"Zoe", B:"Mark"},
    messages:[
      {from:"A", text:"You coming to JessÃ¢â‚¬â„¢s party tonight?"},
      {from:"B", text:"Maybe. Long week."},
      {from:"A", text:"ItÃ¢â‚¬â„¢ll be funÃ¢â‚¬â€lots of people."},
      {from:"B", text:"Hmm."},
      {from:"A", text:"We could go for just an hour."},
      {from:"B", text:"I might skip this one."},
      {from:"A", text:"Ah, okay."},
      {from:"B", text:"Tell her happy birthday from me."},
      {from:"A", text:"Will do."},
      {from:"B", text:"Catch up another time?"}
    ],
    correct:{ A:["Disappointed","Hurt"], B:["Bored","Apathetic","Distant"] },
    cues:{ A:"Deflation after efforts to persuade.", B:"Low-energy, non-committal; opts out." }
  },
  { id:"J", title:"Unexpected Gift", people:{A:"Hana", B:"Luca"},
    messages:[
      {from:"A", text:"Left something at your door Ã°Å¸ËœÅ "},
      {from:"B", text:"What? I just saw a box!"},
      {from:"A", text:"Open it!"},
      {from:"B", text:"WhoaÃ¢â‚¬â€my favourite tea."},
      {from:"A", text:"Figured you needed a pick-me-up."},
      {from:"B", text:"This made my day."},
      {from:"A", text:"Glad it helped."},
      {from:"B", text:"I didnÃ¢â‚¬â„¢t expect this at all."},
      {from:"A", text:"YouÃ¢â‚¬â„¢ve been working so hard."},
      {from:"B", text:"Thank youÃ¢â‚¬â€really."}
    ],
    correct:{ A:["Supportive","Happy"], B:["Surprised","Grateful","Appreciative"] },
    cues:{ A:"Attuned generosity; upbeat tone.", B:"Ã¢â‚¬Å“DidnÃ¢â‚¬â„¢t expect thisÃ¢â‚¬Â + thanks Ã¢â€ â€™ surprise + gratitude." }
  }
];

/* ========= State ========= */
let current=null, timer=null, idx=0, revealed=false, startTime=0, endTime=0;
let RESULTS=[];
const $ = id => document.getElementById(id);

const chatEl = $("chat"), scenarioSel = $("scenario");
const playBtn = $("play"), skipBtn = $("skip"), resetBtn = $("reset"), downloadBtn = $("download");
const statusEl = $("status"), progressEl = $("progress"), chatTitle = $("chatTitle"), timerText = $("timerText");
const step1 = $("step1"), proceedBtn = $("proceed"), step1Hint = $("step1Hint");
const step2 = $("step2"), submitBtn = $("submit"), step3 = $("step3");
const freeA = $("freeA"), freeB = $("freeB");
const labelA = $("labelA"), labelB = $("labelB");
const pillTitleA = $("pillTitleA"), pillTitleB = $("pillTitleB");
const pillsA = $("pillsA"), pillsB = $("pillsB");
const fbA = $("fbA"), fbB = $("fbB"), kpi = $("kpi");
const distractorsSel = $("distractors");
const accentWord = $("accentWord");

/* ========= Helpers ========= */
function clearChat(){ chatEl.innerHTML=""; }
function addBubble(from,name,text){
  const wrap=document.createElement("div");
  const b=document.createElement("div");
  const who=document.createElement("span");
  who.className="name"; who.textContent=name;
  b.className="bubble "+(from==="A"?"fromA":"fromB");
  b.innerText=text; wrap.appendChild(who); wrap.appendChild(b);
  wrap.style.textAlign = from==="A"?"left":"right";
  chatEl.appendChild(wrap); chatEl.scrollTop=chatEl.scrollHeight;
}
function setDisabled(el,v){ el.toggleAttribute("disabled",!!v); }
function shuffle(arr){ return [...arr].sort(()=>Math.random()-0.5); }

function secondsSince(t0){ return Math.round((Date.now()-t0)/1000); }
let tickInt=null;
function startTick(){ stopTick(); tickInt=setInterval(()=>{ timerText.textContent=`Time: ${secondsSince(startTime)}s`; }, 1000); }
function stopTick(){ if(tickInt){ clearInterval(tickInt); tickInt=null; } }

/* ========= Build UI ========= */
function populateScenarioList(){
  scenarioSel.innerHTML="";
  SCENARIOS.forEach(s=>{ const opt=document.createElement("option"); opt.value=s.id; opt.textContent=s.title; scenarioSel.appendChild(opt); });
}
function loadScenario(id){
  current = SCENARIOS.find(s=>s.id===id) || SCENARIOS[0];
  idx=0; revealed=false; startTime=0; endTime=0;
  clearInterval(timer); timer=null; clearChat(); step3.hidden=true;
  progressEl.textContent = `0 / ${current.messages.length}`;
  timerText.textContent = "";
  chatTitle.textContent = `Chat Ã¢â‚¬â€ ${current.people.A} & ${current.people.B}`;
  statusEl.textContent = "Ready";
  accentWord.textContent = current.title;
  setDisabled(playBtn,false); setDisabled(skipBtn,true); setDisabled(resetBtn,true);
  setDisabled(downloadBtn, RESULTS.length===0);

  // Step 1 reset
  freeA.value=""; freeB.value="";
  labelA.textContent=`What emotions was ${current.people.A} feeling?`;
  labelB.textContent=`What emotions was ${current.people.B} feeling?`;

  // Step 2 hidden until Step 1 completed
  step2.hidden=true; submitBtn.disabled=true;
  pillTitleA.textContent = `Select all that apply for ${current.people.A}`;
  pillTitleB.textContent = `Select all that apply for ${current.people.B}`;

  // Pre-build pills
  buildPills();
  updateProceedState();
}
function buildPills(){
  const N = parseInt(distractorsSel.value, 10) || 8;

  const makeGrid = (correctArr)=>{
    const correctSet = new Set(normalise(correctArr));
    const candidates = MASTER_PILLS.filter(p=>!correctSet.has(normalise([p])[0]));
    const distractors = shuffle(candidates).slice(0, Math.max(0,N));
    const final = shuffle([...new Set([...correctArr, ...distractors])]);
    return final;
  };

  const listA = makeGrid(current.correct.A);
  const listB = makeGrid(current.correct.B);

  pillsA.innerHTML=""; pillsB.innerHTML="";
  for(const label of listA){
    const b=document.createElement("button");
    b.className="pill"; b.type="button"; b.textContent=label; b.setAttribute("aria-pressed","false");
    b.addEventListener("click", ()=>{ togglePill(b); updateSubmitState(); });
    pillsA.appendChild(b);
  }
  for(const label of listB){
    const b=document.createElement("button");
    b.className="pill"; b.type="button"; b.textContent=label; b.setAttribute("aria-pressed","false");
    b.addEventListener("click", ()=>{ togglePill(b); updateSubmitState(); });
    pillsB.appendChild(b);
  }
}
function togglePill(el){
  const pressed=el.getAttribute("aria-pressed")==="true";
  el.setAttribute("aria-pressed", String(!pressed));
}
function updateProceedState(){
  const filled = freeA.value.trim().length>0 && freeB.value.trim().length>0;
  setDisabled(proceedBtn, !(filled && revealed));
  step1Hint.textContent = revealed
    ? (filled ? "Ready." : "Fill both boxes to proceed.")
    : "Finish the chat, then fill both boxes to proceed.";
}
function updateSubmitState(){
  const aChosen = !!pillsA.querySelector('.pill[aria-pressed="true"]');
  const bChosen = !!pillsB.querySelector('.pill[aria-pressed="true"]');
  setDisabled(submitBtn, !(aChosen && bChosen));
}

/* ========= Playback ========= */
function playChat(){
  if(!current) return;
  setDisabled(playBtn,true); setDisabled(skipBtn,false); setDisabled(resetBtn,false);
  statusEl.textContent="PlayingÃ¢â‚¬Â¦"; startTime=Date.now(); startTick();
  timer=setInterval(()=>{
    if(idx>=current.messages.length){ finishChat(); return; }
    const m=current.messages[idx++]; addBubble(m.from,current.people[m.from],m.text);
    progressEl.textContent=`${idx} / ${current.messages.length}`;
    if(idx>=current.messages.length){ finishChat(); }
  }, 3500);
}
function finishChat(){
  clearInterval(timer); timer=null; setDisabled(skipBtn,true); endTime=Date.now(); stopTick();
  statusEl.textContent="Chat complete Ã¢â‚¬â€ do Step 1"; revealed=true; updateProceedState();
}
function skipChat(){
  if(!current) return; if(!startTime){ startTime=Date.now(); startTick(); }
  clearInterval(timer); timer=null;
  for(; idx<current.messages.length; idx++){ const m=current.messages[idx]; addBubble(m.from,current.people[m.from],m.text); }
  progressEl.textContent=`${current.messages.length} / ${current.messages.length}`;
  finishChat();
}
function resetAll(){ loadScenario(scenarioSel.value); }

/* ========= Step transitions ========= */
$("proceed").addEventListener("click", ()=>{ step2.hidden = false; const first = pillsA.querySelector('.pill'); if(first) first.focus(); });

/* ========= Normalisation / Feedback ========= */
function normalise(arr){
  return arr.map(x=>{
    const t = (x||"").toString().trim().toLowerCase();
    if(t==="withdrawn") return "Sad";
    if(t==="jealousy") return "Jealous";
    if(t==="envy") return "Envious";
    if(t==="thankful") return "Grateful";
    if(t==="anxiety") return "Anxious";
    if(t==="worry") return "Concerned";
    return x;
  });
}
function computeFeedback(){
  const selA=[...pillsA.querySelectorAll('.pill[aria-pressed="true"]')].map(b=>b.textContent);
  const selB=[...pillsB.querySelectorAll('.pill[aria-pressed="true"]')].map(b=>b.textContent);
  const corrA=current.correct.A, corrB=current.correct.B;

  const S=a=>new Set(a);
  const aSet=S(normalise(selA)), cA=S(normalise(corrA));
  const bSet=S(normalise(selB)), cB=S(normalise(corrB));

  const aHits=[...aSet].filter(x=>cA.has(x)), aMiss=[...cA].filter(x=>!aSet.has(x)), aExtra=[...aSet].filter(x=>!cA.has(x));
  const bHits=[...bSet].filter(x=>cB.has(x)), bMiss=[...cB].filter(x=>!bSet.has(x)), bExtra=[...bSet].filter(x=>!cB.has(x));

  const prec=(hits,picks)=>picks===0?0:Math.round((hits/picks)*100);
  const rec =(hits,total)=>total===0?0:Math.round((hits/total)*100);

  const aPrec=prec(aHits.length, selA.length), aRec=rec(aHits.length, corrA.length);
  const bPrec=prec(bHits.length, selB.length), bRec=rec(bHits.length, corrB.length);

  fbA.innerHTML = `
    <strong>${current.people.A}</strong><br/>
    <span class="small">Correct:</span> ${corrA.join(", ")}<br/>
    <span class="small">You selected:</span> ${selA.join(", ") || "Ã¢â‚¬â€"}<br/>
    <div class="small" style="margin-top:6px">${current.cues.A}</div>
    <div class="small" style="margin-top:6px;color:${aExtra.length?'#7f1d1d':'#065f46'}">
      Hits: ${aHits.join(", ")||"Ã¢â‚¬â€"} | Missed: ${aMiss.join(", ")||"Ã¢â‚¬â€"} | Extra: ${aExtra.join(", ")||"Ã¢â‚¬â€"}
    </div>
  `;
  fbB.innerHTML = `
    <strong>${current.people.B}</strong><br/>
    <span class="small">Correct:</span> ${corrB.join(", ")}<br/>
    <span class="small">You selected:</span> ${selB.join(", ") || "Ã¢â‚¬â€"}<br/>
    <div class="small" style="margin-top:6px">${current.cues.B}</div>
    <div class="small" style="margin-top:6px;color:${bExtra.length?'#7f1d1d':'#065f46'}">
      Hits: ${bHits.join(", ")||"Ã¢â‚¬â€"} | Missed: ${bMiss.join(", ")||"Ã¢â‚¬â€"} | Extra: ${bExtra.join(", ")||"Ã¢â‚¬â€"}
    </div>
  `;
  kpi.innerHTML = `
    <span class="tag ${aRec>=75?'good':'bad'}">${current.people.A} Ã¢â‚¬â€ Recall ${aRec}%</span>
    <span class="tag ${aPrec>=75?'good':'bad'}">${current.people.A} Ã¢â‚¬â€ Precision ${aPrec}%</span>
    <span class="tag ${bRec>=75?'good':'bad'}">${current.people.B} Ã¢â‚¬â€ Recall ${bRec}%</span>
    <span class="tag ${bPrec>=75?'good':'bad'}">${current.people.B} Ã¢â‚¬â€ Precision ${bPrec}%</span>
  `;
  step3.hidden=false;

  // Save result row
  const durationSec = Math.max(0, Math.round(((endTime||Date.now()) - (startTime||Date.now()))/1000));
  RESULTS.push({
    scenario_id: current.id,
    scenario_title: current.title,
    personA: current.people.A,
    personB: current.people.B,
    freeA: freeA.value.replace(/\s+/g,' ').trim(),
    freeB: freeB.value.replace(/\s+/g,' ').trim(),
    selectedA: selA.join('; '),
    selectedB: selB.join('; '),
    hitsA: aHits.join('; '),
    hitsB: bHits.join('; '),
    missedA: aMiss.join('; '),
    missedB: bMiss.join('; '),
    extraA: aExtra.join('; '),
    extraB: bExtra.join('; '),
    precisionA: aPrec, recallA: aRec,
    precisionB: bPrec, recallB: bRec,
    distractors_per_person: parseInt(distractorsSel.value,10),
    duration_s: durationSec,
    timestamp: new Date().toISOString()
  });
  setDisabled(downloadBtn, RESULTS.length===0);
}

/* ========= CSV ========= */
function toCSV(rows){
  const headers = Object.keys(rows[0]);
  const escape = v => `"${String(v??'').replace(/"/g,'""')}"`;
  const lines = [headers.join(',')].concat(rows.map(r => headers.map(h=>escape(r[h])).join(',')));
  return lines.join('\n');
}
function downloadCSV(){
  if(RESULTS.length===0) return;
  const csv = toCSV(RESULTS);
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'emotion_chat_results.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* ========= Events ========= */
scenarioSel.addEventListener("change", e=>loadScenario(e.target.value));
distractorsSel.addEventListener("change", ()=>{ buildPills(); });
playBtn.addEventListener("click", playChat);
skipBtn.addEventListener("click", skipChat);
resetBtn.addEventListener("click", resetAll);
downloadBtn.addEventListener("click", downloadCSV);
$("proceed").addEventListener("click", ()=>{/* handled above */});
$("submit").addEventListener("click", computeFeedback);
freeA.addEventListener("input", updateProceedState);
freeB.addEventListener("input", updateProceedState);

/* ========= Init ========= */
populateScenarioList();
loadScenario(SCENARIOS[0].id);
</script>
<section id="clinician-notes">
<div style="background: var(--surface); border: 1px solid var(--line); border-radius: 12px; box-shadow: var(--shadow); padding: 16px; margin-top: 24px;">
<label for="clinician-comment" style="display:block;font-weight:600;margin-bottom:8px;">
      Clinician comments (optional)
    </label>
<textarea id="clinician-comment" placeholder="Enter any notes relevant to this session..." rows="4" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--line); font: inherit; resize: vertical;"></textarea>
<p style="margin:8px 0 0; color: var(--muted); font-size: 0.9rem;">
      This note will be added as <code>clinician_comment</code> in the exported CSV.
    </p>
</div>
</section></main></body>
</html>

