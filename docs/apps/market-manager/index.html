<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Market Manager — Shopping Under Pressure</title>
  <meta name="description" content="Process customers quickly while handling interruptions and remembering special instructions." />

  <!-- Micro-Apps hero injection -->
  <meta name="app-slug" content="market-manager">
  <meta name="app-title" content="Market Manager — Shopping Under Pressure">
  <meta name="app-desc" content="Working memory, mental arithmetic, and task switching under realistic retail pressure." />
  <meta name="theme" content="bold">

  <style>
    :root{ color-scheme: light; }

    /* Base */
    body{ margin:0; background:#f7f8fb; color:#1f2937; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #app-root{ padding: 16px; }
    .app-wrap{ max-width: 1200px; margin: 0 auto; }

    /* Controls bar */
    .app-controls{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      background:#fff; border:1px solid #e5e7eb; border-radius: 16px;
      box-shadow: 0 1px 2px rgba(16,24,40,.06), 0 8px 24px rgba(16,24,40,.08); 
      padding:12px 14px; margin-bottom:12px;
    }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      appearance:none; border:0; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer;
      background:#ff7a6e; color:#fff; box-shadow:0 6px 14px rgba(0,0,0,.12);
      transition:transform .06s ease, box-shadow .2s ease; 
    }
    button:disabled{ opacity:.4; cursor:not-allowed; }
    button.secondary{ background:#f0f1f6; color:#ff7a6e; box-shadow:none; }
    button.ghost{ background:transparent; border:2px solid #e5e7eb; color:#1f2937; box-shadow:none; }
    button:active:not(:disabled){ transform: translateY(1px); }

    /* Grid */
    .grid{ display:grid; grid-template-columns: 1.2fr 0.8fr; gap:16px; }
    .card{
      background:#fff; border:1px solid #e5e7eb; border-radius:16px;
      box-shadow:0 1px 2px rgba(16,24,40,.06), 0 8px 24px rgba(16,24,40,.08); 
      padding:16px;
    }
    .card h2{ margin:0 0 8px 0; font-size:18px; }
    .muted{ color:#6b7280; font-size:14px; }
    .divider{ height:1px; background:#e5e7eb; margin:12px 0; }

    /* Timer */
    .flex{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .timer{ font-size:20px; font-weight:900; letter-spacing:.5px; }

    /* Customer queue */
    .queue{ display:flex; gap:10px; overflow-x:auto; padding:10px 0; }
    .customer-card{
      min-width:140px; background:#fafbff; border:2px solid #e5e7eb; border-radius:12px;
      padding:12px; text-align:center; cursor:pointer; transition:border-color .2s;
    }
    .customer-card:hover{ border-color:#ff7a6e; }
    .customer-card.active{ border-color:#ff7a6e; background:#fff6f5; }
    .customer-icon{ font-size:32px; margin-bottom:6px; }

    /* Checkout area */
    .checkout{ background:#fafbff; border:2px dashed #e5e7eb; border-radius:12px; padding:16px; min-height:200px; }
    .items-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(80px, 1fr)); gap:10px; margin-top:10px; }
    .item{
      background:#fff; border:2px solid #e5e7eb; border-radius:10px; padding:8px;
      text-align:center; cursor:pointer; transition:all .15s;
    }
    .item:hover{ border-color:#ff7a6e; transform:translateY(-2px); }
    .item.scanned{ opacity:.5; border-color:#10b981; background:#ecfdf5; }
    .item.expired{ border-color:#ef4444; }
    .item.suspicious{ border-color:#f59e0b; animation:pulse 1s infinite; }
    @keyframes pulse{ 0%, 100%{ opacity:1; } 50%{ opacity:.7; } }
    .item-icon{ font-size:24px; }
    .item-name{ font-size:11px; font-weight:600; margin-top:4px; }
    .item-price{ font-size:10px; color:#6b7280; }
    .badge{
      display:inline-block; padding:2px 6px; border-radius:4px;
      font-size:10px; font-weight:800; margin-top:4px;
    }
    .badge.expired{ background:#fee; color:#991b1b; }
    .badge.suspicious{ background:#fef3c7; color:#92400e; }

    /* Register display */
    .register{
      background:#0f172a; color:#e2e8f0; border-radius:10px; padding:12px;
      font-family: ui-monospace, monospace; margin-top:12px;
    }
    .register-line{ display:flex; justify-content:space-between; padding:4px 0; }
    .register-total{ border-top:2px solid #334155; padding-top:8px; margin-top:8px; font-size:18px; font-weight:900; }

    /* Actions */
    .action-btns{ display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }

    /* Interruptions */
    .interrupt{
      background:#fff6d8; border:2px solid #fbbf24; border-radius:12px;
      padding:12px; margin-top:12px; animation:fadeIn .3s;
    }
    @keyframes fadeIn{ from{ opacity:0; transform:translateY(-10px); } to{ opacity:1; transform:translateY(0); } }
    .interrupt.manager{ background:#dbeafe; border-color:#3b82f6; }
    .interrupt.security{ background:#fee; border-color:#ef4444; }

    /* Stats */
    .statbar{ display:flex; gap:12px; flex-wrap:wrap; }
    .pill{ 
      background:#f0f1f6; border-radius:999px; padding:8px 12px; 
      font-weight:700; font-size:13px; 
    }
    .pill.good{ background:#e8fbf2; color:#087a4a; }
    .pill.bad{ background:#ffefef; color:#992f2f; }

    /* Log */
    .log{
      max-height:200px; overflow:auto; background:#0f1222; color:#e9ecff; 
      border-radius:12px; padding:10px;
      font-family: ui-monospace, monospace; font-size:12px;
    }

    /* Modals */
    .modal-backdrop{ 
      position:fixed; inset:0; background:rgba(20,20,30,.55); 
      display:none; align-items:center; justify-content:center; padding:16px; z-index:10; 
    }
    .modal{ 
      background:white; border-radius:16px; 
      box-shadow:0 8px 24px rgba(0,0,0,.2); 
      max-width:700px; width:min(700px, 96vw); padding:20px; 
    }
    .modal h3{ margin:0 0 12px 0; }

    /* Instructions */
    details.app-instructions{ margin: 8px 0 16px; }
    details.app-instructions > summary{
      list-style:none; cursor:pointer; font-weight:800; padding:10px 12px; border-radius:10px;
      background:#f0f1f6; color:#ff7a6e; border:1px solid #e5e7eb;
    }
    details.app-instructions[open]{ background:transparent; }
    details.app-instructions .content{ 
      padding:12px; background:#fff; border:1px solid #e5e7eb; 
      border-radius:12px; margin-top:8px; 
    }

    /* Responsive */
    @media (max-width: 900px){
      .grid{ grid-template-columns:1fr; }
    }

    /* Clinician notes */
    #clinician-notes{
      margin-top:16px;
      background:#fff; border:1px solid #e5e7eb; border-radius:12px;
      box-shadow:0 1px 2px rgba(16,24,40,.06), 0 8px 24px rgba(16,24,40,.08);
      padding:16px;
    }
    #clinician-comment{
      width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb;
      font:inherit; resize:vertical;
    }
  </style>
</head>
<body>

  <main id="app-root">
    <div class="app-wrap">

      <!-- Controls -->
      <div class="app-controls" role="toolbar">
        <div class="left">
          <span class="pill">Prototype</span>
        </div>
        <div class="btns">
          <button id="startBtn">Start shift</button>
          <button id="downloadBtn" class="secondary">Download CSV</button>
          <button id="difficultyBtn" class="ghost">Difficulty</button>
          <button id="helpBtn" class="ghost">How to play</button>
        </div>
      </div>

      <!-- Instructions -->
      <details class="app-instructions">
        <summary>How to play (quick)</summary>
        <div class="content">
          <ol>
            <li><strong>Start shift</strong> to begin serving customers.</li>
            <li>Click a customer from the queue to serve them.</li>
            <li>Scan items by clicking them (watch for expired/suspicious items!).</li>
            <li>Click <strong>Complete sale</strong> when done scanning.</li>
            <li>Handle interruptions: answer manager questions, flag security alerts.</li>
            <li>Work quickly and accurately — difficulty adapts based on performance!</li>
          </ol>
        </div>
      </details>

      <!-- Main grid -->
      <section class="grid">
        <!-- LEFT: Checkout -->
        <div class="card">
          <div class="flex">
            <h2>Checkout Station</h2>
            <div class="timer" id="timer">03:00</div>
          </div>
          <p class="muted">Scan items, process payments, handle interruptions.</p>

          <div class="divider"></div>

          <div>
            <strong>Customer Queue</strong>
            <div class="queue" id="queue"></div>
          </div>

          <div class="divider"></div>

          <div class="checkout">
            <div id="customerInfo" class="muted">Select a customer to begin checkout...</div>
            <div id="itemsGrid" class="items-grid"></div>
            
            <div class="register" id="register" style="display:none;">
              <div id="registerItems"></div>
              <div class="register-total">
                TOTAL: $<span id="registerTotal">0.00</span>
              </div>
            </div>

            <div class="action-btns">
              <button id="completeSaleBtn" class="secondary" disabled>Complete sale</button>
              <button id="flagSecurityBtn" class="ghost" disabled>🚨 Flag security issue</button>
            </div>
          </div>

          <!-- Interruptions appear here -->
          <div id="interruptBox"></div>
        </div>

        <!-- RIGHT: Stats & Log -->
        <div class="card">
          <h2>Shift Status</h2>
          <div id="briefingBox" class="muted" style="background:#fff6d8; padding:10px; border-radius:8px;">
            <strong>Welcome!</strong> Click <em>Start shift</em> to begin your shift at the checkout.
          </div>

          <div class="divider"></div>
          <div id="statsPills" class="statbar"></div>

          <div class="divider"></div>
          <div id="log" class="log"></div>
        </div>
      </section>

      <!-- Clinician notes -->
      <section id="clinician-notes">
        <label for="clinician-comment" style="display:block;font-weight:600;margin-bottom:8px;">
          Clinician comments (optional)
        </label>
        <textarea id="clinician-comment" rows="4"
          placeholder="Enter any notes relevant to this session..."
          data-csv-key="clinician_comment"></textarea>
        <p style="margin:8px 0 0; color:#6b7280; font-size:0.9rem;">
          This note will be added as <code>clinician_comment</code> in the exported CSV.
        </p>
      </section>
    </div>
  </main>

  <!-- Help Modal -->
  <div id="helpBackdrop" class="modal-backdrop" role="dialog">
    <div class="modal">
      <h3>How to play</h3>
      <ol>
        <li><strong>Start shift</strong> to begin. You have 3 minutes.</li>
        <li>Click a customer from the queue to serve them.</li>
        <li>Click items to scan them (prices appear briefly).</li>
        <li>Watch for <span style="color:#ef4444">expired items</span> (don't scan!) and <span style="color:#f59e0b">suspicious customers</span> (flag them).</li>
        <li>Click <strong>Complete sale</strong> when finished scanning.</li>
        <li>Handle interruptions: manager questions require memory, security alerts need quick action.</li>
        <li>Scoring tracks accuracy, speed, and memory performance.</li>
      </ol>
      <div class="btns" style="justify-content:flex-end; margin-top:16px;">
        <button id="closeHelpBtn">Close</button>
      </div>
    </div>
  </div>

  <!-- Difficulty Modal -->
  <div id="difficultyBackdrop" class="modal-backdrop" role="dialog">
    <div class="modal">
      <h3>Difficulty Settings</h3>
      <p class="muted">Changes apply to the next shift. Lock to prevent auto-adaptation.</p>
      
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:16px;">
        <div style="background:#f9fafb; padding:12px; border-radius:8px;">
          <label for="itemsPerCustomer">Items per customer</label>
          <input id="itemsPerCustomer" type="range" min="3" max="8" step="1" style="width:100%"/>
          <output id="itemsPerCustomerOut">4</output>
        </div>
        <div style="background:#f9fafb; padding:12px; border-radius:8px;">
          <label for="customerInterval">Customer interval (s)</label>
          <input id="customerInterval" type="range" min="15" max="45" step="5" style="width:100%"/>
          <output id="customerIntervalOut">25</output>
        </div>
        <div style="background:#f9fafb; padding:12px; border-radius:8px;">
          <label for="expiredRate">Expired item rate</label>
          <input id="expiredRate" type="range" min="0" max="0.3" step="0.05" style="width:100%"/>
          <output id="expiredRateOut">0.10</output>
        </div>
        <div style="background:#f9fafb; padding:12px; border-radius:8px;">
          <label for="suspiciousRate">Suspicious customer rate</label>
          <input id="suspiciousRate" type="range" min="0" max="0.4" step="0.05" style="width:100%"/>
          <output id="suspiciousRateOut">0.15</output>
        </div>
        <div style="background:#f9fafb; padding:12px; border-radius:8px;">
          <label for="interruptRate">Interruption frequency</label>
          <input id="interruptRate" type="range" min="0.05" max="0.35" step="0.05" style="width:100%"/>
          <output id="interruptRateOut">0.15</output>
        </div>
      </div>

      <div class="divider"></div>

      <div style="display:flex; gap:12px; align-items:center;">
        <label style="flex:1;">
          <input id="lockAdapt" type="checkbox"/> Lock difficulty (disable auto-adapt)
        </label>
        <div class="btns">
          <button id="saveDiffBtn">Save</button>
          <button id="resetDiffBtn" class="ghost">Reset</button>
          <button id="closeDiffBtn" class="ghost">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  // ====== Configuration ======
  const SHIFT_SECONDS = 180;
  const DEFAULTS = {
    itemsPerCustomer: 4,
    customerInterval: 25,
    expiredRate: 0.10,
    suspiciousRate: 0.15,
    interruptRate: 0.15,
    lockAdapt: false
  };

  let difficulty = Object.assign({}, DEFAULTS, JSON.parse(localStorage.getItem("marketManagerDifficulty")||"{}"));
  
  // ====== State ======
  let shift = null;
  let stats = null;
  let csvRows = [];
  let timers = [];
  let customerQueue = [];
  let currentCustomer = null;
  let scannedItems = [];
  let totalPrice = 0;
  let customerIdCounter = 0;
  let activeInterrupt = null;
  let memoryTracking = { milkCount: 0, breadCount: 0 };

  // ====== DOM ======
  const el = id => document.getElementById(id);
  const $start = el("startBtn"), $download = el("downloadBtn");
  const $help = el("helpBtn"), $difficultyBtn = el("difficultyBtn");
  const $timer = el("timer"), $queue = el("queue");
  const $customerInfo = el("customerInfo"), $itemsGrid = el("itemsGrid");
  const $register = el("register"), $registerItems = el("registerItems"), $registerTotal = el("registerTotal");
  const $completeSale = el("completeSaleBtn"), $flagSecurity = el("flagSecurityBtn");
  const $interruptBox = el("interruptBox");
  const $briefing = el("briefingBox"), $statsPills = el("statsPills");
  const logEl = el("log");

  // ====== Items database ======
  const ITEMS = [
    { name: "Milk", icon: "🥛", basePrice: 3.49 },
    { name: "Bread", icon: "🍞", basePrice: 2.99 },
    { name: "Eggs", icon: "🥚", basePrice: 4.29 },
    { name: "Cheese", icon: "🧀", basePrice: 5.99 },
    { name: "Apple", icon: "🍎", basePrice: 1.29 },
    { name: "Banana", icon: "🍌", basePrice: 0.89 },
    { name: "Cereal", icon: "🥣", basePrice: 4.49 },
    { name: "Coffee", icon: "☕", basePrice: 8.99 },
    { name: "Juice", icon: "🧃", basePrice: 3.79 },
    { name: "Pasta", icon: "🍝", basePrice: 2.49 },
    { name: "Chips", icon: "🥔", basePrice: 3.99 },
    { name: "Soda", icon: "🥤", basePrice: 1.99 },
  ];

  // ====== Utilities ======
  const rnd = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
  const fmt = s => { const m = Math.floor(s/60), r = s%60; return (m<10?"0"+m:m)+":"+(r<10?"0"+r:r); };
  const clearTimers = () => { timers.forEach(clearInterval); timers = []; };
  
  function log(msg) {
    const t = shift ? fmt(shift.elapsed) : "00:00";
    const line = `[${t}] ${msg}`;
    logEl.textContent += (logEl.textContent ? "\n" : "") + line;
    logEl.scrollTop = logEl.scrollHeight;
    csvRows.push([Date.now(), t, msg]);
  }

  function setStatsPills() {
    $statsPills.innerHTML = "";
    const mk = (label, val, mod) => {
      const s = document.createElement("div");
      s.className = "pill" + (mod ? " " + mod : "");
      s.textContent = `${label}: ${val}`;
      $statsPills.appendChild(s);
    };
    if (!stats) return;
    mk("Customers", stats.customersServed);
    mk("Scan accuracy", `${stats.scanCorrect}/${stats.scanCorrect + stats.scanErrors}`, stats.scanErrors === 0 ? "good" : "");
    mk("Sales complete", stats.salesComplete, "good");
    mk("Memory recalls", `${stats.memoryCorrect}/${stats.memoryCorrect + stats.memoryErrors}`, stats.memoryErrors === 0 ? "good" : "");
    mk("Security flags", stats.securityCorrect, "good");
  }

  function updateTimerUI() {
    if (!shift) return;
    const remaining = Math.max(0, SHIFT_SECONDS - shift.elapsed);
    $timer.textContent = fmt(remaining);
    if (remaining <= 0) endShift();
  }

  // ====== Customer generation ======
  function generateCustomer() {
    const id = ++customerIdCounter;
    const itemCount = Math.max(3, Math.min(8, difficulty.itemsPerCustomer + rnd(-1, 1)));
    const items = [];
    const suspicious = Math.random() < difficulty.suspiciousRate;
    
    for (let i = 0; i < itemCount; i++) {
      const itemData = ITEMS[rnd(0, ITEMS.length - 1)];
      const price = itemData.basePrice + (Math.random() * 0.4 - 0.2);
      const expired = Math.random() < difficulty.expiredRate;
      items.push({
        ...itemData,
        price: Math.round(price * 100) / 100,
        expired,
        scanned: false
      });
    }

    return { id, items, suspicious, startTime: Date.now() };
  }

  function addCustomerToQueue() {
    if (!shift) return;
    const customer = generateCustomer();
    customerQueue.push(customer);
    renderQueue();
    log(`Customer #${customer.id} joined queue (${customer.items.length} items${customer.suspicious ? ', SUSPICIOUS' : ''})`);
  }

  function renderQueue() {
    $queue.innerHTML = "";
    customerQueue.forEach(c => {
      const card = document.createElement("div");
      card.className = "customer-card" + (currentCustomer?.id === c.id ? " active" : "");
      card.innerHTML = `
        <div class="customer-icon">${c.suspicious ? "🕵️" : "🧑"}</div>
        <div style="font-weight:700; font-size:12px;">Customer #${c.id}</div>
        <div style="font-size:11px; color:#6b7280;">${c.items.length} items</div>
      `;
      card.onclick = () => selectCustomer(c);
      $queue.appendChild(card);
    });
  }

  // ====== Checkout process ======
  function selectCustomer(customer) {
    if (currentCustomer) {
      log("Complete current customer first!");
      return;
    }

    currentCustomer = customer;
    scannedItems = [];
    totalPrice = 0;
    
    $customerInfo.innerHTML = `<strong>Serving Customer #${customer.id}</strong> ${customer.suspicious ? '🕵️ <span style="color:#f59e0b;">SUSPICIOUS</span>' : ''}`;
    $itemsGrid.innerHTML = "";
    $register.style.display = "block";
    $registerItems.innerHTML = "";
    $registerTotal.textContent = "0.00";
    $completeSale.disabled = true;
    $flagSecurity.disabled = !customer.suspicious;

    customer.items.forEach((item, idx) => {
      const itemDiv = document.createElement("div");
      itemDiv.className = "item" + (item.expired ? " expired" : "") + (customer.suspicious ? " suspicious" : "");
      itemDiv.innerHTML = `
        <div class="item-icon">${item.icon}</div>
        <div class="item-name">${item.name}</div>
        <div class="item-price" style="${item.scanned ? 'opacity:0.3' : ''}">$${item.price.toFixed(2)}</div>
        ${item.expired ? '<div class="badge expired">EXPIRED</div>' : ''}
      `;
      itemDiv.onclick = () => scanItem(item, idx, itemDiv);
      $itemsGrid.appendChild(itemDiv);
    });

    renderQueue();
    log(`Started serving Customer #${customer.id}`);
  }

  function scanItem(item, idx, itemDiv) {
    if (item.scanned) return;

    if (item.expired) {
      stats.scanErrors++;
      log(`ERROR: Scanned EXPIRED ${item.name}!`);
      setStatsPills();
      return;
    }

    item.scanned = true;
    scannedItems.push(item);
    totalPrice += item.price;
    itemDiv.classList.add("scanned");
    stats.scanCorrect++;

    // Track for memory questions
    if (item.name === "Milk") memoryTracking.milkCount++;
    if (item.name === "Bread") memoryTracking.breadCount++;

    const line = document.createElement("div");
    line.className = "register-line";
    line.innerHTML = `<span>${item.name}</span><span>$${item.price.toFixed(2)}</span>`;
    $registerItems.appendChild(line);
    $registerTotal.textContent = totalPrice.toFixed(2);

    log(`Scanned ${item.name} ($${item.price.toFixed(2)})`);
    setStatsPills();

    // Check if all non-expired items scanned
    const allScanned = currentCustomer.items.filter(i => !i.expired).every(i => i.scanned);
    $completeSale.disabled = !allScanned;
  }

  $completeSale.addEventListener("click", () => {
    if (!currentCustomer) return;

    const timeSpent = (Date.now() - currentCustomer.startTime) / 1000;
    stats.customersServed++;
    stats.salesComplete++;

    if (currentCustomer.suspicious && !currentCustomer.flagged) {
      stats.scanErrors++;
      log(`WARNING: Failed to flag suspicious Customer #${currentCustomer.id}!`);
    }

    log(`Completed sale for Customer #${currentCustomer.id} (${timeSpent.toFixed(1)}s, $${totalPrice.toFixed(2)})`);
    
    customerQueue = customerQueue.filter(c => c.id !== currentCustomer.id);
    currentCustomer = null;
    scannedItems = [];
    totalPrice = 0;

    $customerInfo.innerHTML = "Select next customer...";
    $itemsGrid.innerHTML = "";
    $register.style.display = "none";
    $completeSale.disabled = true;
    $flagSecurity.disabled = true;

    renderQueue();
    setStatsPills();
  });

  $flagSecurity.addEventListener("click", () => {
    if (!currentCustomer || !currentCustomer.suspicious) return;
    
    currentCustomer.flagged = true;
    stats.securityCorrect++;
    log(`✓ Flagged suspicious Customer #${currentCustomer.id}`);
    $flagSecurity.disabled = true;
    setStatsPills();
  });

  // ====== Interruptions ======
  function maybeCreateInterrupt() {
    if (!shift || activeInterrupt) return;
    if (Math.random() > difficulty.interruptRate) return;

    const type = Math.random() < 0.6 ? "manager" : "security";
    
    if (type === "manager") {
      createManagerQuestion();
    } else {
      createSecurityAlert();
    }
  }

  function createManagerQuestion() {
    const questions = [
      { q: "How many customers have bought MILK so far?", answer: memoryTracking.milkCount },
      { q: "How many customers have bought BREAD so far?", answer: memoryTracking.breadCount },
    ];
    const selected = questions[rnd(0, questions.length - 1)];
    
    activeInterrupt = { type: "manager", ...selected };
    
    const div = document.createElement("div");
    div.className = "interrupt manager";
    div.innerHTML = `
      <strong>📞 Manager calling:</strong>
      <p style="margin:8px 0;">"${selected.q}"</p>
      <div style="display:flex; gap:8px;">
        <input type="number" id="managerAnswer" min="0" style="width:80px; padding:6px;" />
        <button onclick="answerManager()" class="secondary">Submit</button>
        <button onclick="dismissInterrupt()" class="ghost">Ignore</button>
      </div>
    `;
    $interruptBox.innerHTML = "";
    $interruptBox.appendChild(div);
    log("Manager is calling with a question!");
  }

  function createSecurityAlert() {
    const item = ITEMS[rnd(0, ITEMS.length - 1)];
    activeInterrupt = { type: "security", item: item.name };
    
    const div = document.createElement("div");
    div.className = "interrupt security";
    div.innerHTML = `
      <strong>🚨 Security Alert:</strong>
      <p style="margin:8px 0;">"Watch for customers with <strong>${item.name}</strong> - flag if you see it!"</p>
      <button onclick="dismissInterrupt()" class="secondary">Acknowledged</button>
    `;
    $interruptBox.innerHTML = "";
    $interruptBox.appendChild(div);
    log(`Security alert: Watch for ${item.name}`);
  }

  window.answerManager = function() {
    if (!activeInterrupt || activeInterrupt.type !== "manager") return;
    
    const input = document.getElementById("managerAnswer");
    const answer = parseInt(input.value) || 0;
    
    if (answer === activeInterrupt.answer) {
      stats.memoryCorrect++;
      log(`✓ Correct answer to manager: ${answer}`);
    } else {
      stats.memoryErrors++;
      log(`✗ Wrong answer to manager: ${answer} (correct: ${activeInterrupt.answer})`);
    }
    
    dismissInterrupt();
    setStatsPills();
  };

  window.dismissInterrupt = function() {
    activeInterrupt = null;
    $interruptBox.innerHTML = "";
  };

  // ====== Shift control ======
  function startShift() {
    shift = { startedAt: Date.now(), elapsed: 0 };
    stats = {
      customersServed: 0,
      scanCorrect: 0,
      scanErrors: 0,
      salesComplete: 0,
      memoryCorrect: 0,
      memoryErrors: 0,
      securityCorrect: 0
    };
    csvRows = [["epoch", "clock", "event"]];
    customerQueue = [];
    currentCustomer = null;
    customerIdCounter = 0;
    memoryTracking = { milkCount: 0, breadCount: 0 };
    activeInterrupt = null;

    $start.disabled = true;
    $briefing.innerHTML = "<strong>Shift active!</strong> Serve customers quickly and accurately.";
    $customerInfo.innerHTML = "Waiting for customers...";
    $itemsGrid.innerHTML = "";
    $register.style.display = "none";
    $interruptBox.innerHTML = "";
    logEl.textContent = "";
    
    log("Shift started");
    setStatsPills();
    updateTimerUI();

    // Add first customer immediately
    setTimeout(() => addCustomerToQueue(), 2000);

    // Timer tick
    timers.push(setInterval(() => {
      shift.elapsed = Math.min(SHIFT_SECONDS, Math.floor((Date.now() - shift.startedAt) / 1000));
      updateTimerUI();
    }, 1000));

    // Customer spawner
    timers.push(setInterval(() => {
      if (customerQueue.length < 5) addCustomerToQueue();
    }, difficulty.customerInterval * 1000));

    // Interrupt spawner
    timers.push(setInterval(maybeCreateInterrupt, 20000));
  }

  function endShift() {
    clearTimers();
    $start.disabled = false;
    $timer.textContent = "00:00";
    
    log("Shift ended");
    $briefing.innerHTML = "<strong>Shift complete!</strong> Review your performance above.";
    
    if (!difficulty.lockAdapt) {
      adaptDifficulty();
    } else {
      log("Difficulty locked: auto-adaptation disabled");
    }

    persistDifficulty();
    setStatsPills();
  }

  function adaptDifficulty() {
    const accuracy = stats.scanCorrect / Math.max(1, stats.scanCorrect + stats.scanErrors);
    const memoryAccuracy = stats.memoryCorrect / Math.max(1, stats.memoryCorrect + stats.memoryErrors);
    const avgScore = (accuracy + memoryAccuracy) / 2;

    if (avgScore >= 0.85 && stats.customersServed >= 5) {
      // Increase difficulty
      difficulty.itemsPerCustomer = Math.min(8, difficulty.itemsPerCustomer + 1);
      difficulty.customerInterval = Math.max(15, difficulty.customerInterval - 3);
      difficulty.expiredRate = Math.min(0.3, difficulty.expiredRate + 0.05);
      difficulty.suspiciousRate = Math.min(0.4, difficulty.suspiciousRate + 0.05);
      difficulty.interruptRate = Math.min(0.35, difficulty.interruptRate + 0.05);
      log("Performance excellent - difficulty increased");
    } else if (avgScore < 0.6 || stats.customersServed < 3) {
      // Decrease difficulty
      difficulty.itemsPerCustomer = Math.max(3, difficulty.itemsPerCustomer - 1);
      difficulty.customerInterval = Math.min(45, difficulty.customerInterval + 3);
      difficulty.expiredRate = Math.max(0, difficulty.expiredRate - 0.05);
      difficulty.suspiciousRate = Math.max(0, difficulty.suspiciousRate - 0.05);
      difficulty.interruptRate = Math.max(0.05, difficulty.interruptRate - 0.05);
      log("Difficulty eased to support learning");
    } else {
      log("Difficulty unchanged");
    }
  }

  function persistDifficulty() {
    localStorage.setItem("marketManagerDifficulty", JSON.stringify(difficulty));
  }

  // ====== CSV Download ======
  function getClinicianComment() {
    const ta = document.getElementById("clinician-comment");
    return ta ? ta.value : "";
  }

  $download.addEventListener("click", () => {
    const note = getClinicianComment();
    if (note) {
      csvRows.push([Date.now(), fmt(shift ? shift.elapsed : 0), "clinician_comment: " + note]);
    }

    const csv = csvRows
      .map(r => r.map(x => '"' + String(x).replaceAll('"', '""') + '"').join(","))
      .join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "market_manager_log.csv";
    a.click();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  });

  // ====== Modals ======
  $start.addEventListener("click", startShift);
  
  $help.addEventListener("click", () => {
    el("helpBackdrop").style.display = "flex";
  });
  el("closeHelpBtn").addEventListener("click", () => {
    el("helpBackdrop").style.display = "none";
  });

  $difficultyBtn.addEventListener("click", () => {
    hydrateDiffUI();
    el("difficultyBackdrop").style.display = "flex";
  });
  el("closeDiffBtn").addEventListener("click", () => {
    el("difficultyBackdrop").style.display = "none";
  });

  // ====== Difficulty panel ======
  function hydrateDiffUI() {
    el("itemsPerCustomer").value = difficulty.itemsPerCustomer;
    el("itemsPerCustomerOut").textContent = difficulty.itemsPerCustomer;
    el("customerInterval").value = difficulty.customerInterval;
    el("customerIntervalOut").textContent = difficulty.customerInterval;
    el("expiredRate").value = difficulty.expiredRate;
    el("expiredRateOut").textContent = difficulty.expiredRate.toFixed(2);
    el("suspiciousRate").value = difficulty.suspiciousRate;
    el("suspiciousRateOut").textContent = difficulty.suspiciousRate.toFixed(2);
    el("interruptRate").value = difficulty.interruptRate;
    el("interruptRateOut").textContent = difficulty.interruptRate.toFixed(2);
    el("lockAdapt").checked = !!difficulty.lockAdapt;
  }

  function attachRange(range, out, transform = v => v) {
    range.addEventListener("input", () => {
      out.textContent = transform(Number(range.value));
    });
  }

  attachRange(el("itemsPerCustomer"), el("itemsPerCustomerOut"));
  attachRange(el("customerInterval"), el("customerIntervalOut"));
  attachRange(el("expiredRate"), el("expiredRateOut"), v => v.toFixed(2));
  attachRange(el("suspiciousRate"), el("suspiciousRateOut"), v => v.toFixed(2));
  attachRange(el("interruptRate"), el("interruptRateOut"), v => v.toFixed(2));

  el("saveDiffBtn").addEventListener("click", () => {
    difficulty.itemsPerCustomer = Number(el("itemsPerCustomer").value);
    difficulty.customerInterval = Number(el("customerInterval").value);
    difficulty.expiredRate = Number(el("expiredRate").value);
    difficulty.suspiciousRate = Number(el("suspiciousRate").value);
    difficulty.interruptRate = Number(el("interruptRate").value);
    difficulty.lockAdapt = !!el("lockAdapt").checked;
    persistDifficulty();
    log("Difficulty settings saved (apply next shift)");
    el("difficultyBackdrop").style.display = "none";
  });

  el("resetDiffBtn").addEventListener("click", () => {
    difficulty = { ...DEFAULTS };
    persistDifficulty();
    hydrateDiffUI();
    log("Difficulty reset to defaults");
  });

  // ESC to close modals
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      el("helpBackdrop").style.display = "none";
      el("difficultyBackdrop").style.display = "none";
    }
  });

  // Initial UI
  setStatsPills();
  </script>
</body>
</html>
