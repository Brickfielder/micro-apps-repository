<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Market Manager — Price & Stock Practice</title>

  <!-- Identify the app to the shared frame -->
  <meta name="app-slug" content="market-manager"/>
  <!-- Optional overrides for catalog title/desc -->
  <meta name="app-title" content="Market Manager"/>
  <meta name="app-desc" content="Adjust prices and stock, respond to demand, and export a session CSV for review."/>
  <!-- Toggles: 'bold' and/or 'dense' -->
  <meta name="theme" content="bold"/>

  <!-- Micro-Apps shared assets (the frame auto-detects /shared or /docs/shared) -->
  <link rel="stylesheet" href="/micro-apps-repository/shared/theme.css?v=3"/>
  <script defer src="/micro-apps-repository/shared/frame.js?v=3"></script>
  <script defer src="/micro-apps-repository/shared/clinician_feedback.js?v=3"></script>

  <style>
    /* App-specific styling (kept light; base look from shared theme) */
    .grid { display:grid; gap:14px; }
    .cols-2 { grid-template-columns: 1fr 1fr; }
    @media (max-width: 860px){ .cols-2 { grid-template-columns: 1fr; } }

    .card{
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: clamp(14px, 1.6vw, 22px);
    }
    .row{ display:grid; grid-template-columns: 1fr 110px 110px 110px 110px auto; gap:10px; align-items:center; }
    .row.header{ font-weight:700; color:#0f172a; }
    .row + .row{ margin-top:10px; }
    .pill{ margin:0; }
    .muted{ color: var(--muted); }

    .toolbar { justify-content: space-between; }
    .toolbar .right { display:flex; gap:10px; flex-wrap:wrap; }

    .totals{ display:flex; gap:16px; flex-wrap:wrap; }
    .totals .pill{ background:#eef2ff; }
    @media (prefers-color-scheme: dark){ .totals .pill{ background:#1f2937; } }

    .note { font-size:.95rem; color:var(--muted); }
    .wide{ width:100% }
    .center { text-align:center; }
  </style>
</head>
<body>
  <div id="app-root">
    <!-- Toolbar -->
    <div class="toolbar">
      <div>
        <span class="pill">Session: <span id="sessionId"></span></span>
        <span class="pill">Week <span id="weekNo">1</span></span>
      </div>
      <div class="right">
        <button class="button" id="resetBtn">Reset</button>
        <a id="downloadCsv" class="button primary" href="#" download="market_manager_session.csv">Download CSV</a>
      </div>
    </div>

    <!-- Totals summary -->
    <div class="card totals">
      <span class="pill">Cash: £<span id="cash">100.00</span></span>
      <span class="pill">Revenue (wk): £<span id="revWeek">0.00</span></span>
      <span class="pill">Profit (wk): £<span id="profitWeek">0.00</span></span>
      <span class="pill">Customer Satisfaction: <span id="csat">—</span></span>
    </div>

    <!-- Controls -->
    <div class="card">
      <div class="grid cols-2">
        <div>
          <label for="demand">Baseline demand (customers / week)</label>
          <input id="demand" type="range" min="10" max="120" value="60" />
          <div class="helper">Current: <strong><span id="demandVal">60</span></strong></div>
        </div>
        <div>
          <label for="elasticity">Price elasticity (higher = more sensitive)</label>
          <input id="elasticity" type="range" min="0" max="200" value="90" />
          <div class="helper">Current: <strong><span id="elasticityVal">0.90</span></strong></div>
        </div>
      </div>
      <p class="note">Tip: Run one week at a time. Adjust price/stock per item; demand shifts with price and random events.</p>
      <div class="center">
        <button class="button primary" id="runWeekBtn">Run one week</button>
      </div>
    </div>

    <!-- Products table -->
    <div class="card">
      <div class="row header">
        <div>Item</div>
        <div>Price (£)</div>
        <div>Cost (£)</div>
        <div>Stock</div>
        <div>Restock</div>
        <div>Actions</div>
      </div>
      <div id="rows"></div>
      <hr style="margin:16px 0; border-color:var(--line)"/>
      <div class="grid cols-2">
        <div>
          <label for="newName">Add new item</label>
          <input id="newName" type="text" placeholder="e.g. Apples"/>
        </div>
        <div class="grid" style="grid-template-columns: repeat(4, 1fr); gap:10px;">
          <input id="newPrice" type="number" step="0.05" placeholder="Price"/>
          <input id="newCost"  type="number" step="0.05" placeholder="Cost"/>
          <input id="newStock" type="number" step="1" placeholder="Stock"/>
          <button id="addItemBtn" class="button">Add</button>
        </div>
      </div>
    </div>

    <!-- Session log (compact) -->
    <div class="card">
      <label>Weekly log</label>
      <textarea id="log" rows="6" readonly class="wide" style="resize:vertical"></textarea>
      <p class="helper">CSV export includes each week’s metrics + any clinician note you add below.</p>
    </div>
  </div>

  <script>
    // ---------- Model ----------
    const fmt = n => (Math.round(Number(n) * 100) / 100).toFixed(2);
    const state = {
      week: 1,
      cash: 100,
      demand: 60,
      elasticity: 0.9,
      items: [
        { id: 'apples',  name:'Apples',  price: 0.80, cost: 0.40, stock: 40, restock: 20 },
        { id: 'bananas', name:'Bananas', price: 0.70, cost: 0.35, stock: 36, restock: 18 },
        { id: 'bread',   name:'Bread',   price: 1.20, cost: 0.70, stock: 20, restock: 10 },
        { id: 'milk',    name:'Milk',    price: 1.00, cost: 0.60, stock: 24, restock: 12 },
      ],
      logs: [],
      sessionId: Math.random().toString(36).slice(2, 8).toUpperCase()
    };

    // ---------- UI refs ----------
    const el = id => document.getElementById(id);
    const rows = el('rows');
    el('sessionId').textContent = state.sessionId;

    // ---------- Render product rows ----------
    function renderRows(){
      rows.innerHTML = '';
      state.items.forEach((it, idx) => {
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
          <div><strong>${it.name}</strong><div class="muted">On hand: <span id="${it.id}-onhand">${it.stock}</span></div></div>
          <input id="${it.id}-price" type="number" step="0.05" value="${fmt(it.price)}"/>
          <input id="${it.id}-cost"  type="number" step="0.05" value="${fmt(it.cost)}"/>
          <input id="${it.id}-stock" type="number" step="1" value="${it.stock}"/>
          <input id="${it.id}-restock" type="number" step="1" value="${it.restock}"/>
          <div style="display:flex; gap:8px;">
            <button class="button" data-act="apply" data-id="${it.id}">Apply</button>
            <button class="button" data-act="remove" data-id="${it.id}">Remove</button>
          </div>
        `;
        rows.appendChild(row);
      });
    }

    function syncControls(){
      el('weekNo').textContent = state.week;
      el('cash').textContent = fmt(state.cash);
      el('demand').value = state.demand;
      el('demandVal').textContent = state.demand;
      el('elasticity').value = Math.round(state.elasticity * 100);
      el('elasticityVal').textContent = state.elasticity.toFixed(2);
    }

    // ---------- Interactions ----------
    rows.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button[data-act]');
      if(!btn) return;
      const id = btn.getAttribute('data-id');
      const it = state.items.find(x=>x.id === id);
      if(!it) return;

      if(btn.dataset.act === 'apply'){
        it.price   = parseFloat(el(`${id}-price`).value || it.price);
        it.cost    = parseFloat(el(`${id}-cost`).value  || it.cost);
        it.stock   = Math.max(0, Math.round(parseFloat(el(`${id}-stock`).value || it.stock)));
        it.restock = Math.max(0, Math.round(parseFloat(el(`${id}-restock`).value || it.restock)));
        el(`${id}-onhand`).textContent = it.stock;
      } else if(btn.dataset.act === 'remove'){
        state.items = state.items.filter(x=>x.id !== id);
        renderRows();
      }
    });

    el('addItemBtn').addEventListener('click', ()=>{
      const name  = (el('newName').value || '').trim();
      const price = parseFloat(el('newPrice').value || '1');
      const cost  = parseFloat(el('newCost').value  || '0.5');
      const stock = Math.max(0, Math.round(parseFloat(el('newStock').value || '10')));
      if(!name) return;
      const id = name.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
      state.items.push({ id, name, price, cost, stock, restock: Math.max(0, Math.round(stock/2)) });
      el('newName').value=''; el('newPrice').value=''; el('newCost').value=''; el('newStock').value='';
      renderRows();
    });

    el('demand').addEventListener('input', e=>{
      state.demand = parseInt(e.target.value,10);
      el('demandVal').textContent = state.demand;
    });
    el('elasticity').addEventListener('input', e=>{
      state.elasticity = parseInt(e.target.value,10) / 100;
      el('elasticityVal').textContent = state.elasticity.toFixed(2);
    });

    el('resetBtn').addEventListener('click', ()=>{
      state.week = 1; state.cash = 100; state.logs.length = 0;
      state.demand = 60; state.elasticity = 0.9;
      state.items = [
        { id: 'apples',  name:'Apples',  price: 0.80, cost: 0.40, stock: 40, restock: 20 },
        { id: 'bananas', name:'Bananas', price: 0.70, cost: 0.35, stock: 36, restock: 18 },
        { id: 'bread',   name:'Bread',   price: 1.20, cost: 0.70, stock: 20, restock: 10 },
        { id: 'milk',    name:'Milk',    price: 1.00, cost: 0.60, stock: 24, restock: 12 },
      ];
      renderRows(); syncControls(); updateWeekSummary(0,0,0,'Reset');
      el('log').value = '';
    });

    // ---------- Simulation ----------
    function randn(){ // ~N(0,1) via Box-Muller
      let u=0,v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random();
      return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
    }

    function simulateWeek(){
      // Demand shock (events/weather/etc.)
      const shock = 1 + (randn() * 0.15);
      const baseCustomers = Math.max(0, Math.round(state.demand * shock));

      // Price “index” (simple mean of item prices / costs ratio)
      const meanMarkup = state.items.length
        ? state.items.reduce((a,it)=>a + (it.price/Math.max(0.01,it.cost)),0)/state.items.length
        : 1.5;

      // Price sensitivity factor (elasticity)
      const priceFactor = Math.max(0.2, 2.0 - (state.elasticity * (meanMarkup - 1)));
      const customers = Math.max(0, Math.round(baseCustomers * priceFactor));

      // Allocate baskets to items (biased to lower price vs cost)
      let revenue = 0, cogs = 0, soldTotal = 0, stockouts = 0;
      const mix = [...state.items];
      mix.sort((a,b)=> (a.price/a.cost) - (b.price/b.cost)); // cheaper (relative) sells earlier

      let buyers = customers;
      for(const it of mix){
        if(buyers <= 0) break;
        const desire = Math.max(0, Math.round(buyers * (1 / mix.length) * (1.3 - (it.price/Math.max(0.01,it.cost))*0.15)));
        const canSell = Math.min(it.stock, desire);
        it.stock -= canSell;
        revenue += canSell * it.price;
        cogs    += canSell * it.cost;
        soldTotal += canSell;
        buyers -= Math.round(desire * 0.9); // many buy once
        if(canSell < desire) stockouts++;
      }

      // Restock using “restock” targets if we can afford it
      let restockSpend = 0, unitsRestocked = 0;
      for(const it of state.items){
        const want = Math.max(0, it.restock);
        if(want <= 0) continue;
        const spend = want * it.cost;
        if(spend <= state.cash){
          it.stock += want; restockSpend += spend; unitsRestocked += want; state.cash -= spend;
        }
      }

      const profit = revenue - cogs;
      state.cash += revenue;

      // Proxy “satisfaction”: fewer stockouts & reasonable markup
      const csat = Math.max(0, 100 - (stockouts*8) - Math.max(0, (meanMarkup-1.7)*25));
      return { customers, revenue, cogs, profit, soldTotal, stockouts, restockSpend, unitsRestocked, csat: Math.round(csat) };
    }

    function updateWeekSummary(rev, prof, csat, label){
      el('revWeek').textContent = fmt(rev);
      el('profitWeek').textContent = fmt(prof);
      el('csat').textContent = (csat===0 && label==='Reset') ? '—' : (csat + '/100');
    }

    el('runWeekBtn').addEventListener('click', ()=>{
      const res = simulateWeek();
      state.week++;
      syncControls();
      updateWeekSummary(res.revenue, res.profit, res.csat);

      const line = [
        new Date().toISOString(),
        state.sessionId,
        state.week-1,
        state.demand,
        state.elasticity.toFixed(2),
        res.customers,
        res.soldTotal,
        res.stockouts,
        res.revenue.toFixed(2),
        res.cogs.toFixed(2),
        res.profit.toFixed(2),
        res.restockSpend.toFixed(2),
        res.unitsRestocked,
        res.csat
      ].join(',');

      if(state.logs.length === 0){
        state.logs.push('timestamp,session_id,week,demand,elasticity,customers,sold,stockouts,revenue,cogs,profit,restock_spend,units_restocked,csat');
      }
      state.logs.push(line);
      el('log').value = state.logs.join('\n');
    });

    // ---------- Download CSV (clinician_feedback.js will append clinician_comment) ----------
    el('downloadCsv').addEventListener('click', (e)=>{
      e.preventDefault();
      if(state.logs.length === 0){
        alert('No session data yet. Run at least one week.');
        return;
      }
      const csv = state.logs.join('\n');
      const href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
      const a = e.currentTarget;
      a.setAttribute('href', href);
      a.click(); // clinician_feedback.js augments and re-triggers
    });

    // ---------- Boot ----------
    renderRows();
    syncControls();
  </script>
</body>
</html>