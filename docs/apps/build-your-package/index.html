<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Build your package</title>
  <link rel="stylesheet" href="../../shared/theme.css" />
  <meta name="theme" content="bold dense" />
  <meta name="app-slug" content="build-your-package" />
  <script>
    window.__THEME_URL__ = new URL('../../shared/theme.css', location.href).toString();
    window.__FRAME_URL__ = new URL('../../shared/frame.js', location.href).toString();
    window.__CLINICIAN_FEEDBACK_URL__ = new URL('../../shared/clinician_feedback.js', location.href).toString();
    window.__CATALOG_URL__ = new URL('../../catalog.json', location.href).toString();
  </script>
  <script defer src="../../shared/frame.js"></script>
  <script defer src="../../shared/clinician_feedback.js"></script>
  <style>
    :root {
      --page-gap: clamp(18px, 4vw, 32px);
      --panel-bg: var(--surface, #fff);
      --panel-border: var(--line, #e2e8f0);
      --panel-radius: var(--radius, 16px);
      --panel-shadow: var(--shadow, 0 10px 25px rgba(15, 23, 42, 0.08));
      --accent: var(--brand, #0a66c2);
    }

    body {
      margin: 0;
      background: var(--background, #f7f8fb);
      color: var(--text, #1f2937);
      font-family: var(--font-body, "Inter", system-ui, -apple-system, "Segoe UI", sans-serif);
    }

    #app-root {
      max-width: 980px;
      margin: 0 auto var(--page-gap);
      padding: 0 clamp(14px, 3vw, 24px) var(--page-gap);
      display: grid;
      gap: var(--page-gap);
    }

    .panel {
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: var(--panel-radius);
      box-shadow: var(--panel-shadow);
      padding: clamp(16px, 2.4vw, 24px);
      display: grid;
      gap: clamp(12px, 2vw, 18px);
    }

    .panel h2 {
      margin: 0;
      font-size: clamp(1.15rem, 2.6vw, 1.35rem);
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.65rem;
    }

    .hint {
      color: var(--muted, #64748b);
      margin: 0;
      font-size: 0.95rem;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    button.btn {
      border: 0;
      border-radius: 12px;
      padding: 10px 16px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    button.btn.primary {
      background: var(--accent);
      color: white;
      box-shadow: 0 10px 18px rgba(10, 102, 194, 0.22);
    }

    button.btn.secondary {
      background: rgba(10, 102, 194, 0.12);
      color: var(--accent);
    }

    button.btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .apps {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .app-card {
      border: 1px solid var(--panel-border);
      border-radius: 14px;
      padding: 14px;
      display: grid;
      gap: 10px;
      background: rgba(255, 255, 255, 0.9);
      min-height: 100%;
    }

    .app-card header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }

    .app-card h3 {
      margin: 0;
      font-size: 1.02rem;
    }

    .app-card p {
      margin: 0;
      color: var(--muted, #64748b);
      font-size: 0.93rem;
      line-height: 1.45;
    }

    .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      border: 1px solid var(--panel-border);
      padding: 2px 10px;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted, #64748b);
      background: rgba(148, 163, 184, 0.08);
    }

    .progress {
      height: 12px;
      border-radius: 999px;
      background: rgba(10, 102, 194, 0.12);
      overflow: hidden;
      border: 1px solid rgba(10, 102, 194, 0.28);
    }

    .progress > div {
      height: 100%;
      width: 0%;
      background: var(--accent);
      transition: width 0.2s ease;
    }

    .status-row {
      color: var(--muted, #64748b);
      font-size: 0.9rem;
      min-height: 1.3em;
    }

    @media (max-width: 620px) {
      .controls {
        align-items: stretch;
      }

      .button-row {
        width: 100%;
        justify-content: stretch;
      }

      button.btn {
        flex: 1 1 auto;
        justify-content: center;
        display: flex;
      }
    }
  </style>
</head>
<body>
  <main id="app-root">
    <section class="panel">
      <h2>Bundle micro-apps for your learners</h2>
      <p class="hint">
        Choose the activities you want to include, then download a single ZIP file that contains each appâ€™s <code>index.html</code> page. The bundle works offline in most browsers and can be hosted on your own site.
      </p>
      <div class="controls">
        <div class="button-row">
          <button class="btn secondary" id="btn-select-all" type="button">Select all</button>
          <button class="btn secondary" id="btn-clear" type="button">Clear</button>
          <button class="btn primary" id="btn-download" type="button">Download ZIP</button>
        </div>
        <div class="hint" id="selection-count" aria-live="polite"></div>
      </div>
      <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div id="progress-bar"></div>
      </div>
      <div class="status-row" id="status" aria-live="polite"></div>
    </section>

    <section class="panel">
      <div class="apps" id="apps" role="list"></div>
    </section>

    <section id="clinician-notes">
      <div style="background: var(--surface); border: 1px solid var(--line); border-radius: 12px; box-shadow: var(--shadow); padding: 16px;">
        <label for="clinician-comment" style="display:block;font-weight:600;margin-bottom:8px;">
          Clinician comments (optional)
        </label>
        <textarea id="clinician-comment" placeholder="Enter any notes relevant to this session..." rows="4" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--line); font: inherit; resize: vertical;"></textarea>
        <p style="margin:8px 0 0; color: var(--muted); font-size: 0.9rem;">
          This note will be added as <code>clinician_comment</code> in the exported CSV.
        </p>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script>
    (function () {
      const appsContainer = document.getElementById('apps');
      const countEl = document.getElementById('selection-count');
      const statusEl = document.getElementById('status');
      const progressEl = document.getElementById('progress-bar');
      const btnAll = document.getElementById('btn-select-all');
      const btnClear = document.getElementById('btn-clear');
      const btnDownload = document.getElementById('btn-download');

      const FALLBACK_SLUGS = [
        'audio-errands', 'atm-practice', 'barista-chaos', 'build-your-package', 'emergency-call-simulator',
        'emergency-despatch', 'emotion-chat', 'email-composer-coach', 'errands-visual-memory', 'fluency-coach',
        'market-manager', 'maze-explorer', 'memory-in-action', 'mobile-banking-simulator', 'office-day',
        'plan-with-coco', 'shopping-trip-planner', 'signal-master', 'star-hunt', 'task-juggler', 'taskflow',
        'tower-control', 'travel-with-coco', 'visual-neglect-trainer', 'visuospatial-blocks', 'word-scavenger'
      ];

      function slugToTitle(slug) {
        return slug
          .replace(/-/g, ' ')
          .replace(/\b([a-z])/g, (m, c) => c.toUpperCase());
      }

      function normaliseEntry(entry) {
        const slug = (entry.slug || '').trim() || slugify(entry.title || entry.name || 'app');
        const title = entry.title || entry.name || slugToTitle(slug);
        const description = entry.description || entry.desc || entry.about || '';
        const tags = Array.isArray(entry.tags) ? entry.tags.filter(Boolean) : [];
        const emoji = entry.emoji || '';
        const url = new URL(`../${slug}/index.html`, location.href).toString();
        return { slug, title, description, tags, emoji, url };
      }

      function slugify(text) {
        return (text || '')
          .toString()
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '') || 'app';
      }

      function updateCount() {
        const checkboxes = appsContainer.querySelectorAll('input[type="checkbox"]');
        const selected = appsContainer.querySelectorAll('input[type="checkbox"]:checked');
        countEl.textContent = checkboxes.length ? `${selected.length}/${checkboxes.length} selected` : '';
      }

      function renderApps(apps) {
        appsContainer.innerHTML = '';
        apps.forEach(app => {
          const id = `chk-${app.slug}`;
          const card = document.createElement('article');
          card.className = 'app-card';
          card.setAttribute('role', 'listitem');
          card.innerHTML = `
            <header>
              <div>
                <h3>${app.emoji ? `${app.emoji} ` : ''}${app.title}</h3>
                ${app.description ? `<p>${app.description}</p>` : ''}
              </div>
              <label style="font-size:0.9rem; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" id="${id}" data-slug="${app.slug}" data-url="${app.url}" checked />
                Include
              </label>
            </header>
            ${app.tags.length ? `<div class="tag-row">${app.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : ''}
          `;
          appsContainer.appendChild(card);
        });
        updateCount();
      }

      function setBusy(isBusy) {
        btnDownload.disabled = isBusy;
        btnAll.disabled = isBusy;
        btnClear.disabled = isBusy;
      }

      async function loadCatalog() {
        const url = new URL('../../catalog.json', location.href);
        try {
          const response = await fetch(url, { cache: 'no-store' });
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          const json = await response.json();
          if (!Array.isArray(json)) {
            throw new Error('Unexpected catalog format');
          }
          return json;
        } catch (error) {
          console.warn('[packager] Failed to load catalog.json', error);
          statusEl.textContent = 'Unable to load catalog.json â€“ showing fallback list.';
          return FALLBACK_SLUGS.map(slug => ({ slug, title: slugToTitle(slug) }));
        }
      }

      async function init() {
        statusEl.textContent = 'Loading catalogâ€¦';
        const catalog = await loadCatalog();
        const apps = catalog
          .map(normaliseEntry)
          .filter(app => app.slug && app.slug !== 'build-your-package')
          .sort((a, b) => a.title.localeCompare(b.title));
        renderApps(apps);
        statusEl.textContent = '';
      }

      async function addFileToZip(zip, url, destination) {
        const response = await fetch(url, { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`${response.status} ${response.statusText}`);
        }
        const blob = await response.blob();
        zip.file(destination, blob);
      }

      const SHARED_ASSETS = [
        { url: window.__THEME_URL__, destination: 'shared/theme.css', label: 'theme.css' },
        { url: window.__FRAME_URL__, destination: 'shared/frame.js', label: 'frame.js' },
        { url: window.__CLINICIAN_FEEDBACK_URL__, destination: 'shared/clinician_feedback.js', label: 'clinician_feedback.js' },
      ];

      async function createZip() {
        const selected = Array.from(appsContainer.querySelectorAll('input[type="checkbox"]:checked'));
        if (!selected.length) {
          alert('Select at least one app to build a package.');
          return;
        }

        setBusy(true);
        statusEl.textContent = 'Fetching shared resourcesâ€¦';
        progressEl.style.width = '0%';
        progressEl.parentElement.setAttribute('aria-valuenow', '0');

        const zip = new JSZip();
        let completed = 0;
        let failures = 0;

        for (const asset of SHARED_ASSETS) {
          try {
            await addFileToZip(zip, asset.url, asset.destination);
          } catch (error) {
            failures += 1;
            zip.file(`${asset.destination}.ERROR.txt`, String(error));
          }
        }

        statusEl.textContent = failures
          ? 'Fetching app filesâ€¦ (shared resources had issues â€“ see ZIP for details).'
          : 'Fetching app filesâ€¦';

        try {
          for (const checkbox of selected) {
            const slug = checkbox.dataset.slug;
            const url = checkbox.dataset.url;
            const target = `${slug}/index.html`;
            try {
              await addFileToZip(zip, url, target);
            } catch (error) {
              failures += 1;
              zip.file(`${target}.ERROR.txt`, String(error));
            }
            completed += 1;
            const percentage = Math.round((completed / selected.length) * 100);
            progressEl.style.width = `${percentage}%`;
            progressEl.parentElement.setAttribute('aria-valuenow', String(percentage));
            statusEl.textContent = `Added ${completed}/${selected.length} app pagesâ€¦`;
          }

          statusEl.textContent = failures
            ? `Packaging archive (encountered ${failures} error${failures === 1 ? '' : 's'}).`
            : 'Packaging archiveâ€¦';

          const blob = await zip.generateAsync({ type: 'blob' });
          const stamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
          saveAs(blob, `micro-apps-package_${stamp}.zip`);
          statusEl.textContent = failures
            ? `Packaging complete with ${failures} error${failures === 1 ? '' : 's'} â€“ check the ZIP for details.`
            : 'Packaging complete.';
        } finally {
          setBusy(false);
        }
      }

      appsContainer.addEventListener('change', event => {
        if (event.target.matches('input[type="checkbox"]')) {
          updateCount();
        }
      });

      btnAll.addEventListener('click', () => {
        appsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.checked = true;
        });
        updateCount();
      });

      btnClear.addEventListener('click', () => {
        appsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.checked = false;
        });
        updateCount();
      });

      btnDownload.addEventListener('click', () => {
        createZip().catch(error => {
          console.error('[packager] Failed to create ZIP', error);
          statusEl.textContent = 'Something went wrong while creating the package.';
          setBusy(false);
        });
      });

      init();
    })();
  </script>
</body>
</html>
