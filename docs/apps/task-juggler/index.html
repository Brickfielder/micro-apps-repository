<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Task Juggler ‚Äî Live Desk (Streamlined)</title>

<link rel="stylesheet" href="../shared/css/theme.css?v=3">
<script defer src="../shared/js/frame.js?v=3"></script>
<script defer src="../shared/js/clinician_feedback.js?v=3"></script>
<script defer src="../shared/js/csv.js?v=1"></script>

<meta name="theme" content="bold dense">
<meta name="app-slug" content="task-juggler">
<meta name="app-title" content="Task Juggler ‚Äî Executive Function Training">
<meta name="app-desc" content="Overlapping streams with prospective memory (Tom ‚≠ê), strategy constraints, adaptive difficulty, and rich metrics.">

<style>
  .tj-wrap{max-width:1200px;margin:0 auto}
  .tj-grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
  @media (max-width:900px){ .tj-grid{grid-template-columns:1fr} }
  .tj-card{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .tj-sectionTitle{font-weight:800;margin:0 0 8px;font-size:22px}
  .tj-label{font-weight:600;font-size:14px;color:var(--muted);margin:6px 0}
  .tj-row{display:flex;gap:10px;flex-wrap:wrap}
  .tj-btn{cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;border:1px solid var(--line);border-radius:12px;padding:10px 14px;font:inherit;transition:all .15s}
  .tj-btn.primary{background:var(--accent);border-color:var(--accent-600);color:#fff}
  .tj-btn.primary:hover{background:var(--accent-600)}
  .tj-btn.ghost{background:var(--surface)}
  .tj-btn.ghost:hover{background:color-mix(in oklab, var(--surface), var(--line) 12%)}
  .tj-stat{display:inline-block;margin-right:10px;border-radius:999px;padding:6px 10px;background:#eef2ff;color:#1e3a8a;font-size:12px}
  @media (prefers-color-scheme: dark){ .tj-stat{background:#0c2250;color:#cfe3fc} }

  .timer-display{font-size:42px;font-weight:900;text-align:center;margin:8px 0;color:var(--accent);font-variant-numeric:tabular-nums}
  .timer-display.warning{color:#ef4444;animation:pulse 1s infinite}
  @keyframes pulse{0%,100%{opacity:1} 50%{opacity:.6}}

  .timers-duo{display:flex;gap:16px;justify-content:center;align-items:baseline;flex-wrap:wrap}
  .timer-label{font-size:12px;color:var(--muted);text-align:center;margin-top:-6px}

  .panel{border:1px solid var(--line);border-radius:12px;padding:12px;margin:8px 0;background:var(--surface)}
  .urgent{border-color:var(--accent);border-width:2px;background:color-mix(in oklab, var(--accent), white 95%)}
  .muted{opacity:.6}
  .task-title{font-weight:700;margin-bottom:6px}
  .helper{font-size:12px;color:var(--muted)}

  .msg-bubble{background:#e8f1fb;border:1px solid #cfe3fc;border-radius:12px;padding:10px 12px;margin:8px 0;display:flex;align-items:center;gap:10px}
  .msg-sender{font-weight:700;font-size:13px}
  .msg-text{flex:1;font-size:14px}

  .pip{position:fixed;inset:auto 16px 16px auto;background:var(--surface);border:1px solid var(--line);border-radius:12px;padding:10px 12px;box-shadow:var(--shadow);z-index:50}
  .pip-word{font-size:24px;font-weight:900;margin-bottom:8px;text-align:center}
  .pip-grid{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}

  .note{background:var(--paper);border:1px dashed var(--line);border-radius:12px;padding:8px;margin-top:8px}
  .note small{display:block;color:var(--muted);margin-top:4px}

  .lock{pointer-events:none;opacity:.35}
  .hidden{display:none}
</style>
</head>
<body>
<main class="tj-wrap">
  <div class="tj-grid">
    <!-- LEFT: Controls -->
    <div class="tj-card">
      <div class="tj-sectionTitle">Session</div>

      <label class="tj-label">Duration</label>
      <select id="timeSel">
        <option value="180">3 minutes</option>
        <option value="240" selected>4 minutes</option>
        <option value="300">5 minutes</option>
      </select>

      <label class="tj-label" style="margin-top:8px">Strategy</label>
      <select id="strategySel">
        <option value="none" selected>None</option>
        <option value="prioritisation">Prioritisation</option>
        <option value="external">External aids (2 notes, costly)</option>
        <option value="chunking">Chunking (batch windows)</option>
        <option value="timeblock">Time-blocking (panels gated)</option>
      </select>
      <div id="strategyInfo" class="helper" style="margin-top:4px">No constraints applied.</div>

      <div class="tj-row" style="margin-top:12px">
        <button id="btnStart" class="tj-btn primary">Start</button>
        <button id="btnDownload" class="tj-btn ghost">Download CSV</button>
        <button id="btnReset" class="tj-btn ghost">Reset</button>
      </div>

      <div style="margin-top:12px">
        <span class="tj-stat" id="statTime">Time: 4 min</span>
        <span class="tj-stat" id="statLoad">Load: baseline</span>
        <span class="tj-stat" id="pmBadge">PM: ‚≠ê Star Tom before replying</span>
      </div>

      <div class="tj-card" style="margin-top:12px">
        <div class="tj-sectionTitle" style="font-size:16px">Live metrics</div>
        <div class="helper" id="liveMetrics">Switch median: ‚Äî | On-time: ‚Äî | Inhibition: 0 | PM hits: 0 | Pip acc: ‚Äî</div>
      </div>

      <!-- External aids (if chosen) -->
      <div id="notesBox" class="note hidden">
        <div class="tj-label">Notes (max 2; opening costs 1s)</div>
        <textarea id="note1" rows="2" placeholder="Note 1"></textarea>
        <textarea id="note2" rows="2" placeholder="Note 2" style="margin-top:6px"></textarea>
        <small id="noteInfo">Opens: 0 | Chars: 0</small>
      </div>
    </div>

    <!-- RIGHT: Live Desk -->
    <div class="tj-card">
      <div class="tj-sectionTitle">Live Desk</div>
      <div class="pill">Handle overlapping tasks, timers, Tom‚Äôs PM cue, and 7-second Stroop.</div>

      <!-- Dual clocks: countdown + elapsed -->
      <div class="timers-duo">
        <div>
          <div class="timer-display" id="timerDisplay">4:00</div>
          <div class="timer-label">Countdown</div>
        </div>
        <div>
          <div class="timer-display" id="elapsedDisplay">0:00</div>
          <div class="timer-label">Elapsed</div>
        </div>
      </div>

      <div id="desk">
        <div class="panel" id="recipePanel">
          <div class="task-title">üçù Recipe</div>
          <div class="helper">Do each step within its time window.</div>
          <div id="recipeList"></div>
        </div>

        <div class="panel" id="messagesPanel">
          <div class="task-title">üí¨ Messages <span class="helper">(‚≠ê Tom before replying)</span></div>
          <div id="messagesList"></div>
        </div>

        <div class="panel" id="timersPanel">
          <div class="task-title">‚è∞ Timers</div>
          <div class="helper">Acknowledge important alerts promptly.</div>
          <div id="timersList"></div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Micro Stroop ‚Äúpip‚Äù -->
<div class="pip hidden" id="pip">
  <div class="pip-word" id="pipWord">BLUE</div>
  <div class="pip-grid" id="pipBtns"></div>
</div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const el = {
    timeSel: $('#timeSel'), strategySel: $('#strategySel'), strategyInfo: $('#strategyInfo'),
    btnStart: $('#btnStart'), btnDownload: $('#btnDownload'), btnReset: $('#btnReset'),
    statTime: $('#statTime'), statLoad: $('#statLoad'), live: $('#liveMetrics'),
    pmBadge: $('#pmBadge'),
    timer: $('#timerDisplay'), elapsed: $('#elapsedDisplay'),
    recipeList: $('#recipeList'), messagesList: $('#messagesList'),
    timersList: $('#timersList'),
    pip: $('#pip'), pipWord: $('#pipWord'), pipBtns: $('#pipBtns'),
    recipePanel: $('#recipePanel'), messagesPanel: $('#messagesPanel'),
    timersPanel: $('#timersPanel'),
    notesBox: $('#notesBox'), note1: $('#note1'), note2: $('#note2'), noteInfo: $('#noteInfo')
  };

  // ---------- Session clock & queue ----------
  let T=0, Tlimit=240, running=false;
  let queue=[]; // {at, kind, payload}
  const now = ()=>T;
  function schedule(kind,payload,inSec){ queue.push({at: now()+inSec, kind, payload}); queue.sort((a,b)=>a.at-b.at); }
  function drain(){ while(queue.length && queue[0].at<=now()) dispatch(queue.shift()); }

  // ---------- Audio pings ----------
  const AudioCtx = window.AudioContext || window.webkitAudioContext; let ac=null;
  function ping(freq=880, dur=0.06){ try{ ac=ac||new AudioCtx(); const o=ac.createOscillator(), g=ac.createGain(); o.frequency.value=freq; g.gain.value=0.05; o.connect(g); g.connect(ac.destination); o.start(); setTimeout(()=>o.stop(), dur*1000);}catch(e){} }

  // ---------- Data seeds ----------
  const recipeSteps = [
    {id:0, text:"Boil water", window:[20,50]},
    {id:1, text:"Add pasta", window:[70,110]},
    {id:2, text:"Stir pasta", window:[130,170]},
    {id:3, text:"Check doneness", window:[190,230]},
  ];
  const messagePool = [
    {sender:"Anna", family:true, text:"Can you grab milk?"},
    {sender:"Tom", family:false, text:"Are we still on for 6?"},
    {sender:"Sarah", family:false, text:"Did you see my email?"},
    {sender:"Chris", family:true, text:"Can you call me later?"}
  ];

  // Strategies
  let strategy = 'none';
  let chunkWindowOpen=false;
  let timeBlocks=[ [0,9999,'all'] ];
  let noteOpens=0, noteChars=0;

  // Adaptation
  let difficulty = 1; // 1..4
  function setLoadLabel(){ el.statLoad.textContent = `Load: ${['baseline','‚Üë','‚Üë‚Üë','‚Üë‚Üë‚Üë'][difficulty-1]}`; }

  // Metrics
  const metrics = {
    actions:[], switchCosts:[], lastPanel:null, lastActTs:0,
    deadlines:{onTime:0, early:0, late:0, lateMs:0},
    inhibErrors:0,
    pmHits:0, pmMisses:0,
    pips:{hits:0,total:0},
    strategy:'none', noteOpens:0, noteChars:0,
    adaptations:0,
    log:[]
  };
  function logAction(panel){
    const tPerf = performance.now();
    if(metrics.lastPanel && metrics.lastPanel!==panel) metrics.switchCosts.push(tPerf - metrics.lastActTs);
    metrics.lastPanel = panel; metrics.lastActTs = tPerf;
    metrics.actions.push({t:now(), panel});
    updateLive();
  }

  // ---------- Rendering ----------
  function ts(s){ const m=Math.floor(s/60), x=s%60; return `${m}:${String(x).padStart(2,'0')}`; }
  function updateTimer(){
    const rem=Tlimit-now();
    el.timer.textContent=ts(rem);
    el.elapsed.textContent=ts(now());
    rem<=30?el.timer.classList.add('warning'):el.timer.classList.remove('warning');
  }

  function renderRecipe(){
    el.recipeList.innerHTML = "";
    recipeSteps.forEach(st=>{
      const within = (now()>=st.window[0] && now()<=st.window[1]);
      const row = document.createElement('div');
      row.className = "panel " + (within?'urgent':'');

      row.innerHTML = `<div><strong>${st.text}</strong> <span class="helper">[${ts(st.window[0])}‚Äì${ts(st.window[1])}]</span></div>
        <div class="tj-row" style="margin-top:6px">
          <button class="tj-btn ghost" data-act="doStep" data-id="${st.id}">Do it</button>
        </div>`;
      el.recipeList.appendChild(row);
    });
  }

  function renderMessage(msg){
    const bubble = document.createElement('div');
    bubble.className = "msg-bubble";
    bubble.dataset.id = msg.id;
    bubble.dataset.sender = msg.sender;
    bubble.dataset.family = msg.family? '1':'0';
    bubble.innerHTML = `
      <div style="flex:1">
        <div class="msg-sender">${msg.sender} ${msg.sender==='Tom'?'‚≠ê':''}</div>
        <div class="msg-text">${msg.text}</div>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
        <button class="tj-btn ghost" data-act="star" data-id="${msg.id}">Star</button>
        ${["Yes","No","Later"].map(x=>`<button class="tj-btn ghost" data-act="reply" data-id="${msg.id}" data-ans="${x}">${x}</button>`).join('')}
      </div>`;
    el.messagesList.prepend(bubble);
  }

  function renderTimerAlert(alert){
    const row = document.createElement('div');
    row.className="msg-bubble";
    row.innerHTML = `<div style="flex:1">
      <div class="msg-sender">Timer</div>
      <div class="msg-text">${alert.text}</div>
    </div>
    <button class="tj-btn ghost" data-act="ack" data-id="${alert.id}">Acknowledge</button>`;
    el.timersList.prepend(row);
  }

  // ---------- Pip (micro Stroop) ----------
  const COLORS=[{name:"RED", css:"red"},{name:"GREEN", css:"green"},{name:"BLUE", css:"blue"},{name:"YELLOW", css:"goldenrod"}];
  function showPip(){
    const word = COLORS[Math.floor(Math.random()*COLORS.length)];
    const ink  = COLORS[Math.floor(Math.random()*COLORS.length)];
    let answered = false;
    el.pipWord.textContent=word.name; el.pipWord.style.color=ink.css;
    el.pipBtns.innerHTML="";
    COLORS.forEach(c=>{
      const b=document.createElement('button'); b.className="tj-btn ghost"; b.textContent=c.name;
      b.onclick=()=>{ 
        if (answered) return;
        answered = true;
        metrics.pips.total++; 
        if(c.name===ink.name) metrics.pips.hits++; 
        hidePip(); 
        updateLive(); 
      };
      el.pipBtns.appendChild(b);
    });
    el.pip.classList.remove('hidden');
    setTimeout(()=>{
      if(!answered){ metrics.pips.total++; updateLive(); }
      hidePip();
    }, 7000);
  }
  function hidePip(){ el.pip.classList.add('hidden'); }

  // ---------- Strategy constraints ----------
  function applyStrategy(){
    strategy = el.strategySel.value;
    metrics.strategy = strategy;
    el.notesBox.classList.toggle('hidden', strategy!=='external');
    if(strategy==='none') el.strategyInfo.textContent = 'No constraints applied.';
    if(strategy==='prioritisation') el.strategyInfo.textContent = 'Deadlines: on-time bonus; early small; late penalty.';
    if(strategy==='external') el.strategyInfo.textContent = 'Two notes max. Opening notes costs 1s each; chars tracked.';
    if(strategy==='chunking') el.strategyInfo.textContent = 'Batch window: committing in one panel locks others for 6s (inhibition).';
    if(strategy==='timeblock') el.strategyInfo.textContent = 'Panels gated by time: 0‚Äì60s Recipe; 60‚Äì120s Messages; 120‚Äì180s Mixed; then open.';
    if(strategy==='timeblock'){
      timeBlocks = [[0,60,'recipe'],[60,120,'messages'],[120,180,'mixed'],[180,9999,'all']];
    } else timeBlocks = [[0,9999,'all']];
  }
  function gatePanels(){
    const t=now();
    const block = timeBlocks.find(b=>t>=b[0] && t<b[1]) || timeBlocks[0];
    const mode = block[2];
    const lockMsgs = mode!=='messages' && mode!=='mixed' && mode!=='all';
    const lockRec  = mode!=='recipe'   && mode!=='mixed' && mode!=='all';
    el.messagesPanel.classList.toggle('lock', lockMsgs);
    el.recipePanel.classList.toggle('lock', lockRec);
    el.timersPanel.classList.toggle('lock', false);
  }

  // notes costs
  function openNotesCost(){
    if(strategy!=='external') return;
    noteOpens++; metrics.noteOpens = noteOpens;
    T = Math.min(T+1, Tlimit-1); // add 1s
    el.noteInfo.textContent = `Opens: ${noteOpens} | Chars: ${noteChars}`;
    updateTimer();
  }
  el.note1?.addEventListener('focus', openNotesCost);
  el.note2?.addEventListener('focus', openNotesCost);
  el.note1?.addEventListener('input', ()=>{ noteChars = (el.note1.value+el.note2.value).length; metrics.noteChars = noteChars; el.noteInfo.textContent = `Opens: ${noteOpens} | Chars: ${noteChars}`; });
  el.note2?.addEventListener('input', ()=>{ noteChars = (el.note1.value+el.note2.value).length; metrics.noteChars = noteChars; el.noteInfo.textContent = `Opens: ${noteOpens} | Chars: ${noteChars}`; });

  // chunking lock
  function maybeOpenChunk(panel){
    if(strategy!=='chunking') return;
    if(!chunkWindowOpen){
      chunkWindowOpen = true;
      [el.recipePanel, el.messagesPanel, el.timersPanel].forEach(p=>{
        const lockOthers = !p.id.includes(panel);
        p.classList.toggle('lock', lockOthers);
      });
      schedule('chunkClose', {}, 6);
    }
  }
  function closeChunk(){
    chunkWindowOpen=false;
    [el.recipePanel, el.messagesPanel, el.timersPanel].forEach(p=>p.classList.remove('lock'));
  }

  // ---------- Event handling ----------
  const sessionData = { seenTomAt:null, starredTomAt:null, tomSent:false };
  document.addEventListener('click', (e)=>{
    const b = e.target.closest('[data-act]'); if(!b) return;
    const act = b.getAttribute('data-act'); if(b.closest('.lock')) return;
    let panel = 'other';
    if(act.startsWith('doStep')) panel='recipe';
    if(act==='reply' || act==='star') panel='messages';
    if(act==='ack') panel='timers';
    logAction(panel);

    if(strategy==='chunking'){ maybeOpenChunk(panel); }

    if(act==='doStep'){
      const id = +b.getAttribute('data-id');
      const step = recipeSteps.find(s=>s.id===id);
      const t = now(); const [a,bw] = step.window;
      if(t < a) metrics.deadlines.early++;
      else if(t > bw){ metrics.deadlines.late++; metrics.deadlines.lateMs += (t-bw)*1000; }
      else metrics.deadlines.onTime++;
      b.disabled=true; b.textContent='Done';
      renderRecipe();
      return;
    }

    if(act==='star'){
      const id=b.getAttribute('data-id'); const node = el.messagesList.querySelector(`.msg-bubble[data-id="${id}"]`);
      if(node){
        node.dataset.starred = '1';
        const sender = node.dataset.sender;
        if(sender==='Tom'){ sessionData.starredTomAt = performance.now(); }
        node.querySelector('[data-act="star"]').classList.add('muted');
      }
      return;
    }

    if(act==='reply'){
      const id=b.getAttribute('data-id');
      const node = el.messagesList.querySelector(`.msg-bubble[data-id="${id}"]`);
      if(!node) return;
      // PM check for Tom (no rule grading)
      const sender = node.dataset.sender;
      if(sender==='Tom'){
        const starred = node.dataset.starred==='1';
        if(!starred){ metrics.pmMisses++; }
        else{
          const dt = performance.now() - (sessionData.seenTomAt||performance.now());
          if(dt <= 4000) metrics.pmHits++; else metrics.pmMisses++;
        }
      }
      node.style.opacity=0.6;
      return;
    }

    if(act==='ack'){
      const node=b.closest('.msg-bubble'); if(node) node.style.opacity=0.6;
      return;
    }
  });

  // ---------- Generators ----------
  function seedSession(){
    // reset UI
    el.messagesList.innerHTML=""; el.timersList.innerHTML="";
    renderRecipe();

    // messages: exactly one Tom, others from non-Tom senders
    const nonTomPool = messagePool.filter(m=>m.sender!=='Tom');
    const mcount = 4 + Math.floor(Math.random()*3) + (difficulty>2?1:0);
    const tomMsg = {id:'mT', sender:'Tom', family:false, text: messagePool.find(m=>m.sender==='Tom').text};
    const tomTime = 12 + Math.floor(Math.random()*(Tlimit-18));
    schedule('message', tomMsg, tomTime);
    for(let i=0;i<mcount-1;i++){
      const base = nonTomPool[Math.floor(Math.random()*nonTomPool.length)];
      const msg = Object.assign({id:'m'+i}, base);
      const t = 12 + Math.floor(Math.random()*(Tlimit-18));
      schedule('message', msg, t);
    }

    // timers
    const timers = [{id:'t1',text:'Oven ready ‚Äî check now!'},{id:'t2',text:'Sauce needs stirring!'},{id:'t3',text:'Lower heat to simmer.'}];
    const tcount = 2 + (difficulty>2?1:0);
    for(let i=0;i<tcount;i++){
      const alert=timers[i]; const t= 25 + Math.floor(Math.random()*(Tlimit-30));
      schedule('timer', alert, t);
    }

    // Stroop pips
    for(let t=14; t<Tlimit-5; t += (difficulty>=3?9:12) + Math.floor(Math.random()*10)){
      schedule('pip', {}, t);
    }
  }

  // ---------- Dispatch ----------
  function dispatch(e){
    switch(e.kind){
      case 'ping': ping(1100,0.05); break;
      case 'message':
        renderMessage(e.payload);
        if(e.payload.sender==='Tom'){ sessionData.seenTomAt = performance.now(); }
        ping(880,0.05); break;
      case 'timer':
        renderTimerAlert(e.payload); ping(660,0.05); break;
      case 'pip':
        showPip(); break;
      case 'chunkClose':
        closeChunk(); break;
    }
  }

  // ---------- Adaptation ----------
  function maybeAdapt(){
    const d = metrics.deadlines;
    const total = d.onTime + d.early + d.late;
    const onPct = total? d.onTime/total : 0;
    const errRate = metrics.inhibErrors / Math.max(1, now()/60);
    let delta = 0;
    if(onPct>0.8 && errRate<1 && difficulty<4) delta=+1;
    if(errRate>2 && difficulty>1) delta=-1;
    if(delta!==0){ difficulty+=delta; metrics.adaptations++; setLoadLabel(); }
  }

  // ---------- Loop ----------
  function step(){
    if(!running) return;
    T+=1; drain(); gatePanels(); updateTimer();
    if(T>=Tlimit){ endSession(); return; }
    if(T%15===0) maybeAdapt();
    setTimeout(step, 1000);
  }

  // ---------- CSV helpers ----------
function snapshotRow(){
  const sc = metrics.switchCosts.slice().sort((a,b)=>a-b);
  const scMed = sc.length ? Math.round(sc[Math.floor(sc.length/2)]) : '';
  const d=metrics.deadlines; const totalDead=d.onTime+d.early+d.late;
  const onPct = totalDead? Math.round(d.onTime/totalDead*100) : '';
  const pipAcc = metrics.pips.total? Math.round(metrics.pips.hits/metrics.pips.total*100) : '';
  return {
    timestamp:new Date().toISOString(),
    duration_s:Tlimit,
    elapsed_s: now(),
    strategy:metrics.strategy,
    difficulty_final:difficulty,
    switch_median_ms:scMed,
    deadlines_on_time:d.onTime, deadlines_early:d.early, deadlines_late:d.late,
    deadlines_on_time_pct:onPct, deadlines_late_ms_total:d.lateMs,
    inhib_errors:metrics.inhibErrors,
    pm_hits:metrics.pmHits, pm_misses:metrics.pmMisses,
    pip_hits:metrics.pips.hits, pip_total:metrics.pips.total, pip_acc_pct:pipAcc,
    note_opens:metrics.noteOpens, note_chars:metrics.noteChars,
    adaptations:metrics.adaptations
  };
}

function ensureLogged(){
  if(!metrics.log.length){ metrics.log.push(snapshotRow()); }
}

function downloadCSV(){
  try{
    ensureLogged(); // snapshot even if mid-session

    const columns = Object.keys(metrics.log[0] || {});
    const filename = 'task_juggler_session.csv';

    if (window.sharedCSV && typeof window.sharedCSV.triggerDownload === 'function') {
      window.sharedCSV.triggerDownload({ records: metrics.log, columns, filename });
      return;
    }

    const esc = (v) => {
      const text = v == null ? '' : String(v);
      return '"' + text.replace(/"/g,'""') + '"';
    };
    const lines = [columns.join(',')].concat(metrics.log.map(r=>columns.map(k=>esc(r[k])).join(',')));
    const csv  = '\uFEFF' + lines.join('\r\n');
    const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });

    if (window.navigator && window.navigator.msSaveOrOpenBlob) {
      window.navigator.msSaveOrOpenBlob(blob, filename);
      return;
    }

    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    const root = document.body || document.documentElement;
    if (root && root.appendChild) {
      root.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 0);
    } else {
      window.open(url, '_blank');
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }
  }catch(err){
    console.error('CSV download failed:', err);
    alert('CSV download failed. See console for details.');
  }
}

  // ---------- UI, live ----------
  function updateLive(){
    const sc = metrics.switchCosts.slice().sort((a,b)=>a-b);
    const med = sc.length ? Math.round(sc[Math.floor(sc.length/2)]) : '‚Äî';
    const d = metrics.deadlines; const total = d.onTime+d.early+d.late;
    const onPct = total? Math.round(d.onTime/total*100): '‚Äî';
    const pipAcc = metrics.pips.total? Math.round(metrics.pips.hits/metrics.pips.total*100): '‚Äî';
    el.live.textContent = `Switch median: ${med} ms | On-time: ${onPct}% | Inhibition: ${metrics.inhibErrors} | PM hits: ${metrics.pmHits} | Pip acc: ${pipAcc}%`;
  }

  function startSession(){
    Object.assign(metrics, {
      actions:[], switchCosts:[], lastPanel:null, lastActTs:performance.now(),
      deadlines:{onTime:0, early:0, late:0, lateMs:0}, inhibErrors:0,
      pmHits:0, pmMisses:0, pips:{hits:0,total:0},
      strategy: strategy, noteOpens:0, noteChars:0, adaptations:0,
      log:[]
    });
    noteOpens=0; noteChars=0;
    difficulty=1; setLoadLabel();
    sessionData.seenTomAt=null; sessionData.starredTomAt=null; sessionData.tomSent=false;
    T=0; Tlimit=parseInt(el.timeSel.value,10); running=true; queue.length=0;
    el.btnStart.disabled=true;
    renderRecipe(); seedSession(); updateTimer(); step();
  }

  function endSession(){
    running=false; el.btnStart.disabled=false; el.btnDownload.disabled=false;
    metrics.log.push(snapshotRow());
    updateLive(); ping(520,0.08);
  }

  function onStrategyChange(){ applyStrategy(); }

  el.btnStart.addEventListener('click', startSession);
  el.btnReset.addEventListener('click', ()=>location.reload());
  el.btnDownload.addEventListener('click', downloadCSV);
  el.timeSel.addEventListener('change', ()=>{ el.statTime.textContent=`Time: ${Math.floor(+el.timeSel.value/60)} min`; });
  el.strategySel.addEventListener('change', onStrategyChange);

  // init
  applyStrategy(); renderRecipe(); updateTimer(); updateLive(); setLoadLabel();
})();
</script>
</body>
</html>
