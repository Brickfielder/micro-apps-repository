<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title data-i18n="screen.title">Signal Master ‚Äî Mirror Train v1.1 (CSV export)</title>
  <meta name="description" content="Train routing game: single switch, evolving rules, and a Phase-3 Mirror train that follows the opposite of the previous train‚Äôs correct route. Includes CSV export of session stats." data-i18n="screen.description" data-i18n-attr="content"/>

  <!-- Frame meta (used by shared frame.js / theme.css) -->
  <meta name="app-slug" content="signal-master"/>
  <meta name="app-title" content="Signal Master ‚Äî Mirror Train" data-i18n="screen.appTitle" data-i18n-attr="content"/>
  <meta name="app-desc" content="Single switch. Route quickly & accurately. Rules evolve." data-i18n="screen.appDesc" data-i18n-attr="content"/>
  <meta name="theme" content="bold"/>
  <meta name="i18n-langs" content="en,it,es"/>

  <!-- Shared assets -->
  <link rel="stylesheet" href="../../shared/theme.css"/>
  <script defer src="../../shared/frame.js"></script>
  <script defer src="../../shared/clinician_feedback.js"></script>
  <script defer src="../../shared/i18n.js"></script>

  <style>
    :root{
      color-scheme: light; /* force light theme */
      --bg:#f7f8fb; --paper:repeating-linear-gradient(0deg,#f7f8fb 0px,#f7f8fb 6px,#f2f4f7 6px,#f2f4f7 12px);
      --card:#ffffff; --text:#1f2937; --muted:#6b7280; --accent:#ff7a6e; --line:#e5e7eb; --radius:16px;
      --shadow:0 8px 24px rgba(31,41,55,.10);
      --train-red:#ef4444;   /* Passenger */
      --train-blue:#3b82f6;  /* Cargo */
      --train-yellow:#f59e0b;/* Express */
    }
    :root { --game-width: 1180px; }

.stage{ width:min(var(--game-width),100%); } /* already present */
#clinician-notes{
  width:min(var(--game-width),100%) !important;
  max-width:none !important;
  margin:24px auto 32px; /* keep your spacing */
  box-sizing:border-box; /* include padding/borders in width */
}
    *{box-sizing:border-box}
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
          background:var(--paper); color:var(--text); min-height:100svh; display:flex; flex-direction:column; }

    header.topbar{ position:sticky; top:0; z-index:10; backdrop-filter:blur(6px);
      background: color-mix(in oklab, var(--paper) 80%, transparent); border-bottom:1px solid var(--line); }
    .bar{ max-width:1200px; margin:0 auto; padding:12px clamp(12px,3vw,20px); display:flex; align-items:center; justify-content:space-between; gap:10px }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800 }
    .badge{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:var(--card); border:1px solid var(--line); box-shadow:var(--shadow); font-size:13px; color:var(--muted) }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:999px; background:var(--card); border:1px solid var(--line); font-weight:600; color:var(--text) }
    .pill small{ font-weight:500; color:var(--muted) }

    .stage{ width:min(1180px,100%); aspect-ratio:16/9; background:var(--card); border:1px solid var(--line); box-shadow:var(--shadow);
      border-radius:var(--radius); padding:clamp(10px,2vw,16px); display:grid; grid-template-rows:auto 1fr auto; gap:10px; margin:14px auto 0; }
    .hud{ display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:8px }
    .hud .left,.hud .center,.hud .right{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .hud .center{ justify-content:center; font-weight:700; text-align:center }
    .hud .right{ justify-content:flex-end }

    .legend{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    .swatch{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--card); border:1px solid var(--line); color:var(--muted); font-size:13px }
    .dot{ width:12px; height:12px; border-radius:999px; display:inline-block }
    .dot.red{ background:var(--train-red) } .dot.blue{ background:var(--train-blue) } .dot.yellow{ background:var(--train-yellow) }
    .dot.mirror{ background:repeating-linear-gradient(45deg,#111 0 4px,#ddd 4px 8px) }

    .track-wrap{ position:relative; overflow:hidden; border-radius:calc(var(--radius) - 6px); border:1px dashed var(--line);
      background: radial-gradient(1400px 500px at 50% 0%, color-mix(in oklab, var(--paper) 65%, transparent), transparent),
                  linear-gradient(180deg, color-mix(in oklab, var(--paper) 30%, transparent), transparent); }
    svg{ width:100%; height:100%; display:block }

    .controls{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap }
    .lever{ display:flex; align-items:center; gap:12px; background:var(--card); border:1px solid var(--line); border-radius:14px; padding:10px 12px }
    .lever button{ appearance:none; border:none; border-radius:12px; padding:12px 14px; min-width:56px; background:var(--accent); color:white; font-weight:700; font-size:15px; box-shadow:0 6px 14px rgba(242,79,64,.35); cursor:pointer; touch-action:manipulation }
    .lever button.alt{ background: var(--text) }
    .lever button:disabled{ opacity:.5; cursor:not-allowed }
    .rules{ flex:1; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end }
    .rule{ background:var(--card); border:1px dashed var(--line); border-radius:14px; padding:10px 12px; font-size:14px; color:var(--muted) }

    /* Train visuals */
    .train{ position:absolute; transform: translate(-50%, -50%); will-change:left, top; z-index:5 }
    .car{ width:70px; height:30px; border-radius:6px; position:relative; box-shadow:0 2px 6px rgba(0,0,0,.2); display:flex; align-items:center; justify-content:center; font-size:16px }
    .car.passenger{ background:var(--train-red) }
    .car.cargo{ background:var(--train-blue) }
    .car.express{ background:var(--train-yellow) }
    .car.mirror{ background:repeating-linear-gradient(45deg,#0f172a 0 6px,#e5e7eb 6px 12px); color:#0f172a; text-shadow:0 1px 0 rgba(255,255,255,.55) }
    .chip{ position:absolute; left:-8px; top:6px; width:14px; height:14px; background:#111827; border-radius:50% }
    .car.cargo .chip{ border-radius:2px }
    .car.express .chip{ width:0; height:0; border-left:8px solid transparent; border-right:8px solid transparent; border-bottom:14px solid #111827; left:-10px; top:4px }
    .car.mirror .chip{ border-radius:50%; background:repeating-linear-gradient(45deg,#111 0 4px,#eee 4px 8px) }
    .w{ position:absolute; bottom:-6px; width:14px; height:14px; border-radius:50%; background:#111827 }
    .w.l{ left:14px } .w.r{ right:14px }
    .label{ position:absolute; top:-18px; left:0; right:0; text-align:left; font-size:12px; color:var(--muted) }
    .label em{ font-style:normal; opacity:.9 }

    /* Overlays */
    .overlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; z-index:20;
      background: color-mix(in oklab, var(--card) 70%, transparent); backdrop-filter: blur(4px); border-radius:calc(var(--radius) - 8px); border:1px solid var(--line); }
    .banner{ background:var(--card); border:2px dashed var(--line); border-radius:18px; padding:18px 20px; max-width:840px; box-shadow:var(--shadow); text-align:center }
    .banner h3{ margin:0 0 8px; font-size:20px } .banner p{ margin:6px 0; color:var(--muted) } .banner .big{ font-weight:700; font-size:16px }

    /* Summary modal */
    dialog{ border:none; border-radius:16px; box-shadow:var(--shadow); width:min(620px, 94vw); padding:0 }
    dialog::backdrop{ background: rgba(0,0,0,.35) }
    .modal{ padding:16px } .modal header{ position:static; border:0; background:transparent; padding:0 0 8px 0 } .modal h2{ margin:0 0 8px 0 }
    table{ width:100%; border-collapse: collapse; font-size:14px } th, td{ text-align:left; padding:8px 6px; border-bottom:1px solid var(--line) }
    .end-actions{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding-top:10px; flex-wrap:wrap }
    .btn{ appearance:none; border:1px solid var(--line); background:var(--card); border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer }
    .btn.primary{ background:var(--accent); color:white; border:none }
    .note{ color:var(--muted); font-size:12px }

    @media (max-width: 640px){
      .hud{ grid-template-columns:1fr; gap:6px }
      .controls{ flex-direction: column; align-items: stretch }
      .lever{ justify-content:space-between }
      .lever button{ width:100% }
      .stage{ aspect-ratio: 10/16 }
    }
  </style>
</head>
<body>
  <!-- top bar -->
  <header class="topbar" data-i18n="screen.topbarAria" data-i18n-attr="aria-label">
    <div class="bar">
      <div class="brand"><span aria-hidden="true">üöÇ</span><span data-i18n="topbar.brand">Signal Master</span></div>
      <div class="right">
        <div class="badge"><strong data-i18n="topbar.score">Score:</strong>&nbsp;<span id="score">0</span></div>
        <div class="badge">‚è± <strong data-i18n="topbar.time">Time:</strong>&nbsp;<span id="time">3:00</span></div>
      </div>
    </div>
  </header>

  <!-- game surface -->
  <section class="stage" aria-label="Gameplay" role="region" data-i18n="track.aria" data-i18n-attr="aria-label">
    <div class="hud">
      <div class="left">
        <span class="pill"><span data-i18n="hud.level">Level</span><small data-i18n="hud.levelDetail">Mirror Train</small></span>
        <div class="legend" aria-label="Train legend" data-i18n="hud.legendAria" data-i18n-attr="aria-label">
          <span class="swatch"><span class="dot red"></span><span data-i18n="hud.legend.passenger">Passenger</span></span>
          <span class="swatch"><span class="dot blue"></span><span data-i18n="hud.legend.cargo">Cargo</span></span>
          <span class="swatch"><span class="dot yellow"></span><span data-i18n="hud.legend.express">Express</span></span>
          <span class="swatch"><span class="dot mirror"></span><span data-i18n="hud.legend.mirror">Mirror</span></span>
        </div>
      </div>
      <div class="center" id="ruleHeadline" data-i18n="hud.ruleHeadline.phase1">Rules over speed ‚Äî route correctly in real time</div>
      <div class="right">
        <span class="badge" id="prevCorrectBadge" style="display:none" data-i18n="hud.prevCorrect" data-i18n-value="‚Äî">Prev correct: ‚Äî</span>
        <span class="pill" data-i18n="hud.sessionLength">Session ‚Ä¢ 3 min</span>
      </div>
    </div>

    <!-- Track View -->
    <div class="track-wrap" id="track" role="img" aria-label="Track with single junction" data-i18n="track.aria" data-i18n-attr="aria-label">
      <div class="overlay" id="overlay" style="display:none"><div class="banner" id="banner"></div></div>
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1100 560" aria-hidden="true">
        <defs>
          <pattern id="sleepers" width="20" height="20" patternUnits="userSpaceOnUse">
            <rect x="0" y="9" width="20" height="2" fill="currentColor" opacity="0.12"></rect>
          </pattern>
        </defs>
        <g stroke="#475569" stroke-linecap="round" stroke-width="6" opacity="0.9">
          <line x1="80"  y1="280" x2="480" y2="280"></line>
          <line x1="480" y1="280" x2="1040" y2="210"></line> <!-- LEFT end -->
          <line x1="480" y1="280" x2="1040" y2="350"></line> <!-- RIGHT end -->
        </g>
        <g fill="url(#sleepers)" stroke="none">
          <rect x="80"  y="268" width="400" height="24"></rect>
          <polygon points="480,268 1040,198 1040,222 480,292"></polygon>
          <polygon points="480,268 1040,338 1040,362 480,292"></polygon>
        </g>
        <circle cx="480" cy="280" r="10" fill="#f24f40"></circle>
        <g fill="#6b7280" font-family="system-ui" font-size="16">
          <text x="1048" y="212" data-i18n="track.left">LEFT</text>
          <text x="1048" y="352" data-i18n="track.right">RIGHT</text>
        </g>
      </svg>
    </div>

    <!-- Controls -->
    <div class="controls" aria-label="Controls and rules" data-i18n="controls.aria" data-i18n-attr="aria-label">
      <div class="lever">
        <span aria-hidden="true">üîÄ</span><strong data-i18n="controls.mainSwitch">Main Switch:</strong>
        <button id="btnLeft" type="button" aria-label="Set switch LEFT" data-i18n="controls.buttonLeft">LEFT</button>
        <button id="btnRight" type="button" class="alt" aria-label="Set switch RIGHT" data-i18n="controls.buttonRight">RIGHT</button>
        <span class="badge" id="switchState" style="margin-left:8px">Current: RIGHT</span>
      </div>
      <div class="rules" aria-live="polite">
        <div class="rule" id="rule1">Phase 1: Passenger (red üë§) ‚Üí LEFT</div>
        <div class="rule" id="rule2">Phase 1: Cargo (blue üì¶) ‚Üí RIGHT</div>
      </div>
    </div>

    <!-- Start overlay -->
    <div class="overlay" id="startOverlay">
      <div class="banner">
        <h3 data-i18n="start.title">Signal Master</h3>
        <p class="big" data-i18n="start.subtitle">Single switch. Route quickly &amp; accurately. Rules evolve.</p>
        <p data-i18n="start.phase1" data-i18n-target="html"><strong>Phase 1 (0‚Äì60s):</strong> Passenger (üë§) ‚Üí LEFT; Cargo (üì¶) ‚Üí RIGHT.</p>
        <p data-i18n="start.phase2" data-i18n-target="html"><strong>Phase 2 (60‚Äì120s):</strong> Express (‚ö°) appears ‚Üí RIGHT.</p>
        <p data-i18n="start.phase3" data-i18n-target="html"><strong>Phase 3 (120‚Äì180s):</strong> Mirror (‚óºÔ∏è‚óªÔ∏è) must go the <strong>opposite</strong> of the previous train‚Äôs <em>correct</em> route.<br/><small>(First Mirror defaults to RIGHT.)</small></p>
        <button class="btn primary" id="btnStart" type="button" data-i18n="start.startButton">Start</button>
      </div>
    </div>
  </section>

  <!-- Summary modal -->
  <dialog id="summary">
    <form method="dialog" class="modal">
      <header><h2 data-i18n="summary.title">Session Summary</h2></header>
      <table>
        <tr><th data-i18n="summary.total">Total trains</th><td id="sumTotal">0</td></tr>
        <tr><th data-i18n="summary.correct">Correct routes</th><td id="sumCorrect">0</td></tr>
        <tr><th data-i18n="summary.wrong">Wrong routes</th><td id="sumWrong">0</td></tr>
        <tr><th data-i18n="summary.accuracy">Accuracy</th><td id="sumAcc">0%</td></tr>
        <tr><th data-i18n="summary.avgRT">Avg reaction time</th><td id="sumRT">‚Äì</td></tr>
        <tr><th data-i18n="summary.finalScore">Final score</th><td id="sumScore">0</td></tr>
      </table>
      <div class="end-actions">
        <div>
          <button class="btn" id="btnCsv" type="button" data-i18n="summary.download">Download CSV</button>
          <span class="note" data-i18n="summary.downloadHint">Detailed per-train log</span>
        </div>
        <div>
          <button class="btn" value="close" data-i18n="summary.close">Close</button>
          <button class="btn primary" type="button" onclick="location.reload()" data-i18n="summary.playAgain">Play again</button>
        </div>
      </div>
      <!-- hidden link used for download -->
      <a id="csvLink" style="display:none"></a>
    </form>
  </dialog>

  <!-- Always-on clinician notes (also exported in CSV) -->
  <section id="clinician-notes" style="max-width:1180px;margin:24px auto 32px;padding:16px;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);background:var(--card)">
    <label for="clinician-comment" style="display:block;font-weight:600;margin-bottom:8px;" data-i18n="clinician.title">Clinician comments (optional)</label>
    <textarea id="clinician-comment" rows="4" placeholder="Enter any notes relevant to this session..." style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--line);font:inherit;resize:vertical" data-i18n="clinician.placeholder" data-i18n-attr="placeholder"></textarea>
    <p style="margin:8px 0 0;color:var(--muted);font-size:.9rem" data-i18n="clinician.note" data-i18n-target="html">This note will be added as <code>clinician_comment</code> in the exported CSV.</p>
  </section>

  <script>
  (()=>{
    const whenI18N = window.I18N?.ready ?? new Promise(resolve => {
      const handle = () => resolve();
      window.addEventListener('i18n:applied', handle, { once: true });
    });

    whenI18N.then(() => {
      const t = (key, vars={}) => window.I18N?.t ? window.I18N.t(key, vars) : key;

      // ===== Geometry (SVG viewBox units) =====
      const START = {x:80, y:280};
      const JUNC  = {x:480, y:280};
      const LEFT_END   = {x:1040, y:210};
      const RIGHT_END  = {x:1040, y:350};

      // ===== State =====
      let switchDir = 'RIGHT';
      let score = 0;
      let total=0, correct=0, wrong=0;
      let reactionTimes = [];
      let idCounter = 0;

      let remaining = 180;
      let elapsedGameplay = 0;
      let phase = 1;
      let isPaused = true;
      let spawnTimer = null, tickTimer = null;

      let lastCorrectRoute = null; // 'LEFT' | 'RIGHT' | null

      const events = []; // {seq,t_s,phase,type,player,correct,outcome,score}

      // ===== DOM =====
      const scoreEl = document.getElementById('score');
      const timeEl  = document.getElementById('time');
      const switchStateEl = document.getElementById('switchState');
      const trackEl = document.getElementById('track');
      const svgEl = trackEl.querySelector('svg');
      const overlay = document.getElementById('overlay');
      const banner  = document.getElementById('banner');
      const startOverlay = document.getElementById('startOverlay');
      const summaryDlg = document.getElementById('summary');
      const rule1 = document.getElementById('rule1');
      const rule2 = document.getElementById('rule2');
      const ruleHeadline = document.getElementById('ruleHeadline');
      const prevCorrectBadge = document.getElementById('prevCorrectBadge');
      const btnCsv = document.getElementById('btnCsv');
      const csvLink = document.getElementById('csvLink');
      const clinicianTA = document.getElementById('clinician-comment');
      const btnLeft = document.getElementById('btnLeft');
      const btnRight = document.getElementById('btnRight');

      // ===== Helpers =====
      const directionLabel = (dir) => {
        if(!dir) return t('hud.prevCorrectNone');
        return t(dir === 'LEFT' ? 'controls.direction.left' : 'controls.direction.right');
      };
      const updateSwitchState = () => {
        const dirKey = switchDir === 'LEFT' ? 'controls.direction.left' : 'controls.direction.right';
        const direction = t(dirKey);
        switchStateEl.setAttribute('data-i18n', 'controls.current');
        switchStateEl.setAttribute('data-i18n-direction', direction);
        switchStateEl.textContent = t('controls.current', { direction });
      };
      const updatePrevCorrectBadge = () => {
        if(phase === 3){
          const value = lastCorrectRoute ? directionLabel(lastCorrectRoute) : t('hud.prevCorrectNone');
          prevCorrectBadge.setAttribute('data-i18n', 'hud.prevCorrect');
          prevCorrectBadge.setAttribute('data-i18n-value', value);
          prevCorrectBadge.textContent = t('hud.prevCorrect', { value });
          prevCorrectBadge.style.display = '';
        } else {
          prevCorrectBadge.style.display = 'none';
        }
      };
      const applyButtonLabels = () => {
        btnLeft.setAttribute('aria-label', t('controls.setLeft'));
        btnRight.setAttribute('aria-label', t('controls.setRight'));
      };

      // ===== Controls =====
      btnLeft.addEventListener('click', ()=>{ switchDir = 'LEFT'; updateSwitchState(); });
      btnRight.addEventListener('click', ()=>{ switchDir = 'RIGHT'; updateSwitchState(); });
      document.getElementById('btnStart').addEventListener('click', ()=>{ startOverlay.style.display = 'none'; beginSession(); });

      // ===== Utils =====
      function lerp(a,b,t){ return a + (b-a)*t }
      function pointOnLine(p1,p2,t){ return {x: lerp(p1.x,p2.x,t), y: lerp(p1.y,p2.y,t)} }
      function fmtTime(s){ const m = Math.floor(s/60); const r = String(s%60).padStart(2,'0'); return `${m}:${r}` }
      function flash(color){
        const el = document.createElement('div');
        el.style.position='absolute'; el.style.inset='0'; el.style.background=color; el.style.opacity='0.12';
        el.style.pointerEvents='none'; el.style.transition='opacity .35s ease';
        trackEl.appendChild(el); requestAnimationFrame(()=>{ el.style.opacity='0' }); setTimeout(()=> el.remove(), 400);
      }
      // Map SVG viewBox coordinates -> on-screen CSS pixels
      function toPx(pt){
        const vb = svgEl.viewBox.baseVal;
        const rect = svgEl.getBoundingClientRect();
        const sx = rect.width  / vb.width;
        const sy = rect.height / vb.height;
        return { x: pt.x * sx, y: pt.y * sy };
      }
      const ruleCopy = {
        1: { main: 'rules.phase1a', aux: 'rules.phase1b', headline: 'hud.ruleHeadline.phase1' },
        2: { main: 'rules.phase2a', aux: 'rules.phase2b', headline: 'hud.ruleHeadline.phase2' },
        3: { main: 'rules.phase3a', aux: 'rules.phase3b', headline: 'hud.ruleHeadline.phase3' }
      };
      const applyRuleCopy = (el, key) => {
        el.setAttribute('data-i18n', key);
        el.textContent = t(key);
      };
      function setRulesText(){
        const current = ruleCopy[phase];
        applyRuleCopy(rule1, current.main);
        applyRuleCopy(rule2, current.aux);
        applyRuleCopy(ruleHeadline, current.headline);
        updatePrevCorrectBadge();
      }
      const updateDocumentTitle = () => {
        document.title = t('screen.title');
      };

      // ===== Train factory =====
      function spawnTrain(){
        if(isPaused) return;

        let type;
        if(phase===1){
          type = Math.random() < 0.5 ? 'Passenger' : 'Cargo';
        } else if(phase===2){
          const r = Math.random();
          type = r < 0.4 ? 'Passenger' : (r < 0.8 ? 'Cargo' : 'Express');
        } else {
          const r = Math.random();
          if(r < 0.30) type = 'Passenger';
          else if(r < 0.60) type = 'Cargo';
          else if(r < 0.80) type = 'Express';
          else type = 'Mirror';
        }

        const el = document.createElement('div');
        el.className = 'train';
        el.dataset.id = (++idCounter).toString();
        el.dataset.type = type;

        const carClass = type==='Passenger' ? 'passenger' :
                         type==='Cargo' ? 'cargo' :
                         type==='Express' ? 'express' : 'mirror';

        el.innerHTML = `<div class="label"><em>${type} ${type==='Passenger'?'üë§':type==='Cargo'?'üì¶':type==='Express'?'‚ö°':'‚ÜîÔ∏é'}</em></div>
                      <div class="car ${carClass}"><span class="chip"></span></div>
                      <div class="w l"></div><div class="w r"></div>`;
        const sp = toPx(START);
        el.style.left = sp.x + 'px';
        el.style.top  = sp.y + 'px';
        trackEl.appendChild(el);

        const data = { el, type, t0: performance.now() };
        animateTrain(data);
      }

      function correctDirectionFor(type){
        if(type==='Cargo') return 'RIGHT';
        if(type==='Passenger') return 'LEFT';
        if(type==='Express') return (phase>=2) ? 'RIGHT' : 'LEFT';
        if(type==='Mirror'){
          const base = lastCorrectRoute ?? 'RIGHT';
          return base === 'LEFT' ? 'RIGHT' : 'LEFT';
        }
        return 'LEFT';
      }

      function animateTrain(data){
        const SPEED = 170; // px/s
        let last = performance.now();
        let seg = 0; // 0: to main junc, 1: to end
        let t = 0;

        let choiceMain = null;
        let target = null;

        const correctDir = correctDirectionFor(data.type);
        if(phase===3){ updatePrevCorrectBadge(); }

        function raf(){
          const now = performance.now();
          const dt = (now - last)/1000; last = now;
          if(isPaused){ requestAnimationFrame(raf); return; }

          if(seg===0){
            const len = Math.hypot(JUNC.x-START.x, JUNC.y-START.y);
            t += (SPEED*dt)/len;
            if(t>=1){
              t = 0; seg = 1;

              choiceMain = switchDir;
              const ok = (choiceMain === correctDir);
              total++;
              if(ok){ correct++; score += 10; flash('#00c853'); }
              else { wrong++; score -= 20; flash('#ff1744'); }
              scoreEl.textContent = String(score);

              events.push({
                seq: total,
                t_s: elapsedGameplay,
                phase,
                type: data.type,
                player: choiceMain,
                correct: correctDir,
                outcome: ok ? 'correct' : 'wrong',
                score
              });

              lastCorrectRoute = correctDir;
              if(phase===3){ updatePrevCorrectBadge(); }

              target = (choiceMain==='LEFT') ? LEFT_END : RIGHT_END;
            }
            const p0 = toPx(pointOnLine(START, JUNC, Math.min(t,1)));
            data.el.style.left = `${p0.x}px`; data.el.style.top  = `${p0.y}px`;
          } else {
            const from = JUNC;
            const len = Math.hypot(target.x-from.x, target.y-from.y);
            t += (SPEED*dt)/len;
            if(t>=1){ data.el.remove(); return; }
            const p1 = toPx(pointOnLine(from, target, Math.min(t,1)));
            data.el.style.left = `${p1.x}px`; data.el.style.top  = `${p1.y}px`;
          }

          requestAnimationFrame(raf);
        }
        requestAnimationFrame(raf);
      }

      // ===== Timers & phases =====
      function beginSession(){
        setRulesText();
        updateSwitchState();
        applyButtonLabels();
        timeEl.textContent = fmtTime(remaining);
        isPaused = false;

        tickTimer = setInterval(()=>{
          if(isPaused) return;
          remaining--; elapsedGameplay++;
          timeEl.textContent = fmtTime(remaining);
          if(elapsedGameplay===60){ triggerPhaseBreak(2); }
          if(elapsedGameplay===120){ triggerPhaseBreak(3); }
          if(remaining<=0){ endSession(); }
        }, 1000);

        setTimeout(()=>{
          clearInterval(spawnTimer);
          spawnTimer = setInterval(spawnTrain, 2400);
          spawnTrain();
        }, 600);
      }

      function triggerPhaseBreak(nextPhase){
        isPaused = true;
        const resumeLine = `<p style="margin-top:8px;color:var(--muted)">${t('phases.break.resume')}</p>`;
        if(nextPhase === 2){
          banner.innerHTML = `
            <h3>${t('phases.break.phase2.title')}</h3>
            <p class="big">${t('phases.break.phase2.big')}</p>
            <p>${t('phases.break.phase2.line')}</p>
            ${resumeLine}
          `;
        } else {
          banner.innerHTML = `
            <h3>${t('phases.break.phase3.title')}</h3>
            <p class="big">${t('phases.break.phase3.big')}</p>
            <p>${t('phases.break.phase3.line1')}</p>
            <p>${t('phases.break.phase3.line2')}</p>
            ${resumeLine}
          `;
        }
        overlay.style.display = 'flex';
        setTimeout(()=>{
          phase = nextPhase;
          setRulesText();
          overlay.style.display = 'none';
          isPaused = false;
        }, 10000);
      }

      function endSession(){
        clearInterval(tickTimer); clearInterval(spawnTimer); isPaused = true;
        const acc = total>0 ? Math.round((correct/total)*100) : 0;
        const avgRTms = reactionTimes.length ? Math.round(reactionTimes.reduce((a,b)=>a+b,0)/reactionTimes.length) : null;
        document.getElementById('sumTotal').textContent = String(total);
        document.getElementById('sumCorrect').textContent = String(correct);
        document.getElementById('sumWrong').textContent = String(wrong);
        document.getElementById('sumAcc').textContent = acc + '%';
        document.getElementById('sumRT').textContent = avgRTms ? (avgRTms/1000).toFixed(2)+' s' : '‚Äì';
        document.getElementById('sumScore').textContent = String(score);
        summaryDlg.showModal();

        btnCsv.onclick = ()=> downloadCsv();
      }

      // ===== CSV Export (adds clinician_comment) =====
      function csvEscape(val){
        if(val === null || val === undefined) return '';
        const s = String(val);
        if(!(/[",\r\n]/.test(s))) return s;
        const escaped = s
          .replace(/"/g,'""')
          .replace(/\r\n|\r|\n/g,'\\n');
        return `"${escaped}"`;
      }
      function buildCsv(){
        const comment = clinicianTA ? clinicianTA.value.trim() : '';
        const header = [
          'event','seq','t_game_s','phase','type','player_choice','correct_choice','outcome','score_after','clinician_comment'
        ];
        const rows = [header.join(',')];
        events.forEach(e=>{
          rows.push([
            'trial', e.seq, e.t_s, e.phase, e.type, e.player, e.correct, e.outcome, e.score, comment
          ].map(csvEscape).join(','));
        });
        rows.push([
          'summary','',elapsedGameplay,'','','','','',score,comment
        ].map(csvEscape).join(','));
        return rows.join('\n');
      }
      function downloadCsv(){
        const csv = buildCsv();
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const ts = new Date().toISOString().replace(/[:.]/g,'-');
        const filename = `signal_master_session_${ts}.csv`;
        const url = URL.createObjectURL(blob);
        csvLink.href = url;
        csvLink.download = filename;
        csvLink.click();
        setTimeout(()=> URL.revokeObjectURL(url), 1500);
      }

      // Prevent accidental zoom on double-tap for mobile buttons
      document.addEventListener('touchend', function(e){
        const now = Date.now();
        if (this._lastTouch && (now - this._lastTouch) < 300) { e.preventDefault(); }
        this._lastTouch = now;
      }, {passive:false});

      window.addEventListener('i18n:applied', () => {
        setRulesText();
        updateSwitchState();
        applyButtonLabels();
        updateDocumentTitle();
      });

      // initial setup once translations are ready
      setRulesText();
      updateSwitchState();
      applyButtonLabels();
      updateDocumentTitle();
    });
  })();
  </script>
</body>
</html>
