<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Signal Master Ã¢â‚¬â€ Mirror Train v1.1 (CSV export)</title>
<meta content="Train routing game: single switch, evolving rules, and a Phase-3 Mirror train that follows the opposite of the previous trainÃ¢â‚¬â„¢s correct route. Includes CSV export of session stats." name="description"/>
<style>
  :root{
    color-scheme: light dark;
    --bg:#f7f8fb; --paper:repeating-linear-gradient(0deg,#f7f8fb 0px,#f7f8fb 6px,#f2f4f7 6px,#f2f4f7 12px);
    --card:#ffffff; --text:#1f2937; --muted:#6b7280; --accent:#ff7a6e; --line:#e5e7eb; --radius:16px;
    --shadow:0 8px 24px rgba(31,41,55,.10);
    --train-red:#ef4444;   /* Passenger */
    --train-blue:#3b82f6;  /* Cargo */
    --train-yellow:#f59e0b;/* Express */
    --train-mirror:#6b7280;/* Mirror base */
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0f1216; --paper:repeating-linear-gradient(0deg,#0f1216 0px,#0f1216 6px,#0b0e12 6px,#0b0e12 12px);
           --card:#12161c; --text:#e5e7eb; --muted:#9ca3af; --line:#1f2937; --shadow:0 8px 24px rgba(0,0,0,.35); }
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
        background:var(--paper); color:var(--text); min-height:100svh; display:flex; flex-direction:column; }
  header{ position:sticky; top:0; z-index:10; backdrop-filter:blur(6px);
          background: color-mix(in oklab, var(--paper) 80%, transparent); border-bottom:1px solid var(--line); }
  .bar{ max-width:1200px; margin:0 auto; padding:12px clamp(12px,3vw,20px); display:flex; align-items:center; justify-content:space-between; gap:10px }
  .brand{ display:flex; align-items:center; gap:10px; font-weight:800 }
  .badge{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:var(--card); border:1px solid var(--line); box-shadow:var(--shadow); font-size:13px; color:var(--muted) }
  .pill{ display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:999px; background:var(--card); border:1px solid var(--line); font-weight:600; color:var(--text) }
  .pill small{ font-weight:500; color:var(--muted) }
  main{ flex:1; display:flex; justify-content:center; padding:14px }
  .stage{ width:min(1180px,100%); aspect-ratio:16/9; background:var(--card); border:1px solid var(--line); box-shadow:var(--shadow);
          border-radius:var(--radius); padding:clamp(10px,2vw,16px); display:grid; grid-template-rows:auto 1fr auto; gap:10px }
  .hud{ display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:8px }
  .hud .left,.hud .center,.hud .right{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
  .hud .center{ justify-content:center; font-weight:700; text-align:center }
  .hud .right{ justify-content:flex-end }
  .legend{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
  .swatch{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--card); border:1px solid var(--line); color:var(--muted); font-size:13px }
  .dot{ width:12px; height:12px; border-radius:999px; display:inline-block }
  .dot.red{ background:var(--train-red) } .dot.blue{ background:var(--train-blue) } .dot.yellow{ background:var(--train-yellow) } .dot.mirror{ background:repeating-linear-gradient(45deg,#111 0 4px,#ddd 4px 8px) }
  .track-wrap{ position:relative; overflow:hidden; border-radius:calc(var(--radius) - 6px); border:1px dashed var(--line);
               background: radial-gradient(1400px 500px at 50% 0%, color-mix(in oklab, var(--paper) 65%, transparent), transparent),
                           linear-gradient(180deg, color-mix(in oklab, var(--paper) 30%, transparent), transparent); }
  svg{ width:100%; height:100%; display:block }

  .controls{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap }
  .lever{ display:flex; align-items:center; gap:12px; background:var(--card); border:1px solid var(--line); border-radius:14px; padding:10px 12px }
  .lever button{ appearance:none; border:none; border-radius:12px; padding:12px 14px; min-width:56px; background:var(--accent); color:white; font-weight:700; font-size:15px; box-shadow:0 6px 14px rgba(242,79,64,.35); cursor:pointer; touch-action:manipulation }
  .lever button.alt{ background: var(--text) }
  .lever button:disabled{ opacity:.5; cursor:not-allowed }
  .rules{ flex:1; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end }
  .rule{ background:var(--card); border:1px dashed var(--line); border-radius:14px; padding:10px 12px; font-size:14px; color:var(--muted) }

  /* Trains + icon/shape cues */
  .train{ position:absolute; transform: translate(-50%, -50%); will-change:left, top; z-index:5 }
  .car{ width:70px; height:30px; border-radius:6px; position:relative; box-shadow:0 2px 6px rgba(0,0,0,.2); display:flex; align-items:center; justify-content:center; font-size:16px }
  .car.passenger{ background:var(--train-red); }
  .car.cargo{ background:var(--train-blue); }
  .car.express{ background:var(--train-yellow); }
  .car.mirror{ background:repeating-linear-gradient(45deg,#0f172a 0 6px,#e5e7eb 6px 12px); color:#0f172a; text-shadow:0 1px 0 rgba(255,255,255,.55) }
  .chip{ position:absolute; left:-8px; top:6px; width:14px; height:14px; background:#111827; border-radius:50% }
  .car.cargo .chip{ border-radius:2px }
  .car.express .chip{ width:0; height:0; border-left:8px solid transparent; border-right:8px solid transparent; border-bottom:14px solid #111827; left:-10px; top:4px }
  .car.mirror .chip{ border-radius:50%; background:repeating-linear-gradient(45deg,#111 0 4px,#eee 4px 8px) }
  .w{ position:absolute; bottom:-6px; width:14px; height:14px; border-radius:50%; background:#111827 }
  .w.l{ left:14px } .w.r{ right:14px }
  .label{ position:absolute; top:-18px; left:0; right:0; text-align:left; font-size:12px; color:var(--muted) }
  .label em{ font-style:normal; opacity:.9 }

  /* Overlays */
  .overlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; z-index:20;
            background: color-mix(in oklab, var(--card) 70%, transparent); backdrop-filter: blur(4px); border-radius:calc(var(--radius) - 8px); border:1px solid var(--line); }
  .banner{ background:var(--card); border:2px dashed var(--line); border-radius:18px; padding:18px 20px; max-width:840px; box-shadow:var(--shadow); text-align:center }
  .banner h3{ margin:0 0 8px; font-size:20px } .banner p{ margin:6px 0; color:var(--muted) } .banner .big{ font-weight:700; font-size:16px }

  /* Summary modal */
  dialog{ border:none; border-radius:16px; box-shadow:var(--shadow); width:min(620px, 94vw); padding:0 }
  dialog::backdrop{ background: rgba(0,0,0,.35) }
  .modal{ padding:16px } .modal header{ position:static; border:0; background:transparent; padding:0 0 8px 0 } .modal h2{ margin:0 0 8px 0 }
  table{ width:100%; border-collapse: collapse; font-size:14px } th, td{ text-align:left; padding:8px 6px; border-bottom:1px solid var(--line) }
  .end-actions{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding-top:10px; flex-wrap:wrap }
  .btn{ appearance:none; border:1px solid var(--line); background:var(--card); border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer }
  .btn.primary{ background:var(--accent); color:white; border:none }
  .btn.ghost{ background:transparent }
  .note{ color:var(--muted); font-size:12px }
  @media (max-width: 640px){
    .hud{ grid-template-columns:1fr; gap:6px }
    .controls{ flex-direction: column; align-items: stretch }
    .lever{ justify-content:space-between }
    .lever button{ width:100% }
    .stage{ aspect-ratio: 10/16 }
  }
</style>
<meta content="signal_master" name="app-slug"/><link href="/shared/theme.css" rel="stylesheet"/><script defer="" src="/shared/frame.js"></script><link href="../../../shared/theme.css" rel="stylesheet"/><script defer="" src="../../../shared/frame.js"></script><script defer="" src="../../../shared/clinician_feedback.js"></script>  <meta name="app-slug" content="signal-master">
</head>
<body><main id="app-root">
<header aria-label="Top bar">
<div class="bar">
<div class="brand"><span aria-hidden="true">Ã°Å¸Å¡â€š</span><span>Signal Master</span></div>
<div class="right">
<div class="badge"><strong>Score:</strong>Ã‚Â <span id="score">0</span></div>
<div class="badge">Ã¢ÂÂ± <strong>Time:</strong>Ã‚Â <span id="time">3:00</span></div>
</div>
</div>
</header>
<main>
<section aria-label="Gameplay" class="stage" role="region">
<div class="hud">
<div class="left">
<span class="pill"><span>Level</span><small>Mirror Train</small></span>
<div aria-label="Train legend" class="legend">
<span class="swatch"><span class="dot red"></span> Passenger</span>
<span class="swatch"><span class="dot blue"></span> Cargo</span>
<span class="swatch"><span class="dot yellow"></span> Express</span>
<span class="swatch"><span class="dot mirror"></span> Mirror</span>
</div>
</div>
<div class="center" id="ruleHeadline">Rules over speed Ã¢â‚¬â€ route correctly in real time</div>
<div class="right">
<span class="badge" id="prevCorrectBadge" style="display:none">Prev correct: Ã¢â‚¬â€</span>
<span class="pill">Session Ã¢â‚¬Â¢ 3 min</span>
</div>
</div>
<!-- Track View -->
<div aria-label="Track with single junction" class="track-wrap" id="track" role="img">
<div class="overlay" id="overlay" style="display:none"><div class="banner" id="banner"></div></div>
<svg aria-hidden="true" viewbox="0 0 1100 560" xmlns="http://www.w3.org/2000/svg">
<defs>
<pattern height="20" id="sleepers" patternunits="userSpaceOnUse" width="20">
<rect fill="currentColor" height="2" opacity="0.12" width="20" x="0" y="9"></rect>
</pattern>
</defs>
<g opacity="0.9" stroke="#475569" stroke-linecap="round" stroke-width="6">
<line x1="80" x2="480" y1="280" y2="280"></line>
<line x1="480" x2="1040" y1="280" y2="210"></line> <!-- LEFT end -->
<line x1="480" x2="1040" y1="280" y2="350"></line> <!-- RIGHT end -->
</g>
<g fill="url(#sleepers)" stroke="none">
<rect height="24" width="400" x="80" y="268"></rect>
<polygon points="480,268 1040,198 1040,222 480,292"></polygon>
<polygon points="480,268 1040,338 1040,362 480,292"></polygon>
</g>
<circle cx="480" cy="280" fill="#f24f40" r="10"></circle>
<g fill="#6b7280" font-family="system-ui" font-size="16">
<text x="1048" y="212">LEFT</text>
<text x="1048" y="352">RIGHT</text>
</g>
</svg>
</div>
<!-- Controls -->
<div aria-label="Controls and rules" class="controls">
<div class="lever">
<span aria-hidden="true">Ã°Å¸â€â‚¬</span><strong>Main Switch:</strong>
<button aria-label="Set switch LEFT" id="btnLeft" type="button">LEFT</button>
<button aria-label="Set switch RIGHT" class="alt" id="btnRight" type="button">RIGHT</button>
<span class="badge" id="switchState" style="margin-left:8px">Current: RIGHT</span>
</div>
<div aria-live="polite" class="rules">
<div class="rule" id="rule1">Phase 1: Passenger (red Ã°Å¸â€˜Â¤) Ã¢â€ â€™ LEFT</div>
<div class="rule" id="rule2">Phase 1: Cargo (blue Ã°Å¸â€œÂ¦) Ã¢â€ â€™ RIGHT</div>
</div>
</div>
<!-- Start overlay -->
<div class="overlay" id="startOverlay">
<div class="banner">
<h3>Signal Master</h3>
<p class="big">Single switch. Route quickly &amp; accurately. Rules evolve.</p>
<p><strong>Phase 1 (0Ã¢â‚¬â€œ60s):</strong> Passenger (Ã°Å¸â€˜Â¤) Ã¢â€ â€™ LEFT; Cargo (Ã°Å¸â€œÂ¦) Ã¢â€ â€™ RIGHT.</p>
<p><strong>Phase 2 (60Ã¢â‚¬â€œ120s):</strong> Express (Ã¢Å¡Â¡) appears Ã¢â€ â€™ RIGHT.</p>
<p><strong>Phase 3 (120Ã¢â‚¬â€œ180s):</strong> Mirror (Ã¢â€”Â¼Ã¯Â¸ÂÃ¢â€”Â»Ã¯Â¸Â) must go the <strong>opposite</strong> of the previous trainÃ¢â‚¬â„¢s <em>correct</em> route.<br/><small>(First Mirror defaults to RIGHT.)</small></p>
<button class="btn primary" id="btnStart">Start</button>
</div>
</div>
</section>
</main>
<dialog id="summary">
<form class="modal" method="dialog">
<header><h2>Session Summary</h2></header>
<table>
<tr><th>Total trains</th><td id="sumTotal">0</td></tr>
<tr><th>Correct routes</th><td id="sumCorrect">0</td></tr>
<tr><th>Wrong routes</th><td id="sumWrong">0</td></tr>
<tr><th>Accuracy</th><td id="sumAcc">0%</td></tr>
<tr><th>Avg reaction time</th><td id="sumRT">Ã¢â‚¬â€œ</td></tr>
<tr><th>Final score</th><td id="sumScore">0</td></tr>
</table>
<div class="end-actions">
<div>
<button class="btn" id="btnCsv" type="button">Download CSV</button>
<span class="note">Detailed per-train log</span>
</div>
<div>
<button class="btn" value="close">Close</button>
<button class="btn primary" onclick="location.reload()">Play again</button>
</div>
</div>
<!-- hidden link used for download -->
<a id="csvLink" style="display:none"></a>
</form>
</dialog>
<script>
(()=>{
  // ===== Geometry =====
  const START = {x:80, y:280};
  const JUNC  = {x:480, y:280};
  const LEFT_END   = {x:1040, y:210};
  const RIGHT_END  = {x:1040, y:350};

  // ===== State =====
  let switchDir = 'RIGHT';
  let score = 0;
  let total=0, correct=0, wrong=0;
  let reactionTimes = []; // reserved if you later track it
  let idCounter = 0;

  let remaining = 180;         // gameplay seconds only
  let elapsedGameplay = 0;     // increases only when not paused
  let phase = 1;               // 1,2,3
  let isPaused = true;         // start paused
  let spawnTimer = null, tickTimer = null;

  // Mirror baseline: previous train's CORRECT route
  let lastCorrectRoute = null; // 'LEFT' | 'RIGHT' | null

  // Per-train event log (for CSV)
  const events = []; // each: {seq, t_s, phase, type, player, correct, outcome, score}

  // ===== DOM =====
  const scoreEl = document.getElementById('score');
  const timeEl  = document.getElementById('time');
  const switchStateEl = document.getElementById('switchState');
  const trackEl = document.getElementById('track');
  const overlay = document.getElementById('overlay');
  const banner  = document.getElementById('banner');
  const startOverlay = document.getElementById('startOverlay');
  const summaryDlg = document.getElementById('summary');
  const rule1 = document.getElementById('rule1');
  const rule2 = document.getElementById('rule2');
  const ruleHeadline = document.getElementById('ruleHeadline');
  const prevCorrectBadge = document.getElementById('prevCorrectBadge');
  const btnCsv = document.getElementById('btnCsv');
  const csvLink = document.getElementById('csvLink');

  // ===== Controls =====
  document.getElementById('btnLeft').addEventListener('click', ()=>{ switchDir = 'LEFT'; switchStateEl.textContent = 'Current: LEFT'; });
  document.getElementById('btnRight').addEventListener('click', ()=>{ switchDir = 'RIGHT'; switchStateEl.textContent = 'Current: RIGHT'; });
  document.getElementById('btnStart').addEventListener('click', ()=>{ startOverlay.style.display = 'none'; beginSession(); });

  // ===== Utils =====
  function lerp(a,b,t){ return a + (b-a)*t }
  function pointOnLine(p1,p2,t){ return {x: lerp(p1.x,p2.x,t), y: lerp(p1.y,p2.y,t)} }
  function fmtTime(s){ const m = Math.floor(s/60); const r = String(s%60).padStart(2,'0'); return `${m}:${r}` }
  function flash(color){
    const el = document.createElement('div');
    el.style.position='absolute'; el.style.inset='0'; el.style.background=color; el.style.opacity='0.12';
    el.style.pointerEvents='none'; el.style.transition='opacity .35s ease';
    trackEl.appendChild(el); requestAnimationFrame(()=>{ el.style.opacity='0' }); setTimeout(()=> el.remove(), 400);
  }
  function setRulesText(){
    if(phase===1){
      rule1.textContent = 'Phase 1: Passenger (red Ã°Å¸â€˜Â¤) Ã¢â€ â€™ LEFT';
      rule2.textContent = 'Phase 1: Cargo (blue Ã°Å¸â€œÂ¦) Ã¢â€ â€™ RIGHT';
      ruleHeadline.textContent = 'Rules over speed Ã¢â‚¬â€ route correctly in real time';
      prevCorrectBadge.style.display = 'none';
    } else if(phase===2){
      rule1.textContent = 'Phase 2: Passenger (Ã°Å¸â€˜Â¤) Ã¢â€ â€™ LEFT; Express (Ã¢Å¡Â¡) Ã¢â€ â€™ RIGHT';
      rule2.textContent = 'Phase 2: Cargo (Ã°Å¸â€œÂ¦) Ã¢â€ â€™ RIGHT';
      ruleHeadline.textContent = 'Timetable change Ã¢â‚¬â€ Express (yellow Ã¢Å¡Â¡) goes RIGHT';
      prevCorrectBadge.style.display = 'none';
    } else {
      rule1.textContent = 'Phase 3: Mirror (Ã¢â€”Â¼Ã¯Â¸ÂÃ¢â€”Â»Ã¯Â¸Â) goes OPPOSITE the previous trainÃ¢â‚¬â„¢s correct route';
      rule2.textContent = 'Passenger: LEFT Ã¢â‚¬Â¢ Express: RIGHT Ã¢â‚¬Â¢ Cargo: RIGHT Ã¢â‚¬Â¢ Mirror: opposite of previous correct';
      ruleHeadline.textContent = 'Two-step routing (in your head) Ã¢â‚¬â€ remember the previous correct and flip it';
      prevCorrectBadge.style.display = '';
      prevCorrectBadge.textContent = 'Prev correct: ' + (lastCorrectRoute ?? 'Ã¢â‚¬â€');
    }
  }

  // ===== Train factory =====
  function spawnTrain(){
    if(isPaused) return;

    // Phase-dependent type mix
    let type;
    if(phase===1){
      type = Math.random() < 0.5 ? 'Passenger' : 'Cargo';
    } else if(phase===2){
      const r = Math.random();
      type = r < 0.4 ? 'Passenger' : (r < 0.8 ? 'Cargo' : 'Express');
    } else {
      // Phase 3 includes Mirror
      const r = Math.random();
      if(r < 0.30) type = 'Passenger';
      else if(r < 0.60) type = 'Cargo';
      else if(r < 0.80) type = 'Express';
      else type = 'Mirror';
    }

    const el = document.createElement('div');
    el.className = 'train';
    el.dataset.id = (++idCounter).toString();
    el.dataset.type = type;
    el.style.left = START.x+'px'; el.style.top = START.y+'px';

    const carClass = type==='Passenger' ? 'passenger' :
                     type==='Cargo' ? 'cargo' :
                     type==='Express' ? 'express' : 'mirror';
    const icon = type==='Passenger' ? 'Ã°Å¸â€˜Â¤' : type==='Cargo' ? 'Ã°Å¸â€œÂ¦' : type==='Express' ? 'Ã¢Å¡Â¡' : 'Ã¢â€ â€Ã¯Â¸Å½';

    el.innerHTML = `<div class="label"><em>${type} ${icon}</em></div>
                    <div class="car ${carClass}">
                      <span class="chip"></span>
                    </div>
                    <div class="w l"></div><div class="w r"></div>`;
    trackEl.appendChild(el);

    const data = { el, type, t0: performance.now() };
    animateTrain(data);
  }

  // Compute CORRECT side for a given type now
  function correctDirectionFor(type){
    if(type==='Cargo') return 'RIGHT';
    if(type==='Passenger') return 'LEFT';
    if(type==='Express') return (phase>=2) ? 'RIGHT' : 'LEFT';
    if(type==='Mirror'){
      const base = lastCorrectRoute ?? 'RIGHT';
      return base === 'LEFT' ? 'RIGHT' : 'LEFT';
    }
    return 'LEFT';
  }

  function animateTrain(data){
    const SPEED = 170; // px/s
    let last = performance.now();
    let seg = 0; // 0: to main junc, 1: to end
    let t = 0;

    let choiceMain = null;
    let target = null;

    // Snapshot the correct direction at SPAWN (stable per train)
    const correctDir = correctDirectionFor(data.type);
    if(phase===3){
      document.getElementById('prevCorrectBadge').textContent = 'Prev correct: ' + (lastCorrectRoute ?? 'Ã¢â‚¬â€');
    }

    function raf(){
      const now = performance.now();
      const dt = (now - last)/1000; last = now;
      if(isPaused){ requestAnimationFrame(raf); return; }

      if(seg===0){
        const len = Math.hypot(JUNC.x-START.x, JUNC.y-START.y);
        t += (SPEED*dt)/len;
        if(t>=1){
          t = 0; seg = 1;

          // Snapshot player choice & score
          choiceMain = switchDir;
          const ok = (choiceMain === correctDir);
          total++;
          if(ok){ correct++; score += 10; flash('#00c853'); }
          else { wrong++; score -= 20; flash('#ff1744'); }
          scoreEl.textContent = String(score);

          // Log the event
          events.push({
            seq: total,
            t_s: elapsedGameplay,          // gameplay seconds at decision
            phase,
            type: data.type,
            player: choiceMain,
            correct: correctDir,
            outcome: ok ? 'correct' : 'wrong',
            score
          });

          // Update Mirror baseline for NEXT train
          lastCorrectRoute = correctDir;
          if(phase===3){
            prevCorrectBadge.textContent = 'Prev correct: ' + lastCorrectRoute;
          }

          target = (choiceMain==='LEFT') ? LEFT_END : RIGHT_END;
        }
        const p = pointOnLine(START, JUNC, Math.min(t,1));
        data.el.style.left = `${p.x}px`; data.el.style.top  = `${p.y}px`;
      } else {
        const from = JUNC;
        const len = Math.hypot(target.x-from.x, target.y-from.y);
        t += (SPEED*dt)/len;
        if(t>=1){ data.el.remove(); return; }
        const p = pointOnLine(from, target, Math.min(t,1));
        data.el.style.left = `${p.x}px`; data.el.style.top  = `${p.y}px`;
      }

      requestAnimationFrame(raf);
    }
    requestAnimationFrame(raf);
  }

  // ===== Timers & phases =====
  function beginSession(){
    setRulesText();
    timeEl.textContent = fmtTime(remaining);
    isPaused = false;

    tickTimer = setInterval(()=>{
      if(isPaused) return;
      remaining--; elapsedGameplay++;
      timeEl.textContent = fmtTime(remaining);
      if(elapsedGameplay===60){ triggerPhaseBreak(2,
        `<h3>New Timetable</h3>
         <p class="big">Express (Ã¢Å¡Â¡) now spawns and must go <strong>RIGHT</strong>.</p>
         <p>Passenger (Ã°Å¸â€˜Â¤) Ã¢â€ â€™ LEFT Ã¢â‚¬Â¢ Cargo (Ã°Å¸â€œÂ¦) Ã¢â€ â€™ RIGHT</p>`); }
      if(elapsedGameplay===120){ triggerPhaseBreak(3,
        `<h3>Mirror Train</h3>
         <p class="big">Mirror (Ã¢â€”Â¼Ã¯Â¸ÂÃ¢â€”Â»Ã¯Â¸Â) must go the <strong>OPPOSITE</strong> of the previous trainÃ¢â‚¬â„¢s correct route.</p>
         <p>Passenger: LEFT Ã¢â‚¬Â¢ Cargo: RIGHT Ã¢â‚¬Â¢ Express: RIGHT</p>
         <p><small>First Mirror defaults to RIGHT if there isnÃ¢â‚¬â„¢t a previous.</small></p>`); }
      if(remaining<=0){ endSession(); }
    }, 1000);

    setTimeout(()=>{
      clearInterval(spawnTimer);
      spawnTimer = setInterval(spawnTrain, 2400);
      spawnTrain();
    }, 600);
  }

  function triggerPhaseBreak(nextPhase, html){
    isPaused = true;
    banner.innerHTML = html + `<p style="margin-top:8px;color:var(--muted)">Resuming in ~10 secondsÃ¢â‚¬Â¦</p>`;
    overlay.style.display = 'flex';
    setTimeout(()=>{
      phase = nextPhase;
      setRulesText();
      overlay.style.display = 'none';
      isPaused = false;
    }, 10000);
  }

  function endSession(){
    clearInterval(tickTimer); clearInterval(spawnTimer); isPaused = true;
    const acc = total>0 ? Math.round((correct/total)*100) : 0;
    const avgRTms = reactionTimes.length ? Math.round(reactionTimes.reduce((a,b)=>a+b,0)/reactionTimes.length) : null;
    document.getElementById('sumTotal').textContent = String(total);
    document.getElementById('sumCorrect').textContent = String(correct);
    document.getElementById('sumWrong').textContent = String(wrong);
    document.getElementById('sumAcc').textContent = acc + '%';
    document.getElementById('sumRT').textContent = avgRTms ? (avgRTms/1000).toFixed(2)+' s' : 'Ã¢â‚¬â€œ';
    document.getElementById('sumScore').textContent = String(score);
    summaryDlg.showModal();

    // Prepare CSV once at session end
    btnCsv.onclick = ()=> downloadCsv();
  }

  // ===== CSV Export =====
  function csvEscape(val){
    if(val === null || val === undefined) return '';
    const s = String(val);
    return (/[",\n]/.test(s)) ? `"${s.replace(/"/g,'""')}"` : s;
  }
  function buildCsv(){
    const header = [
      'event','seq','t_game_s','phase','type','player_choice','correct_choice','outcome','score_after'
    ];
    const rows = [header.join(',')];
    events.forEach(e=>{
      rows.push([
        'trial', e.seq, e.t_s, e.phase, e.type, e.player, e.correct, e.outcome, e.score
      ].map(csvEscape).join(','));
    });
    // Summary row
    rows.push([
      'summary','',elapsedGameplay, '', '', '', '', `accuracy_${(total?Math.round(correct/total*100):0)}%`, score
    ].map(csvEscape).join(','));
    return rows.join('\n');
  }
  function downloadCsv(){
    const csv = buildCsv();
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const ts = new Date().toISOString().replace(/[:.]/g,'-');
    const filename = `signal_master_session_${ts}.csv`;
    const url = URL.createObjectURL(blob);
    csvLink.href = url;
    csvLink.download = filename;
    csvLink.click();
    setTimeout(()=> URL.revokeObjectURL(url), 1500);
  }

  // Prevent accidental zoom on double-tap for mobile buttons
  document.addEventListener('touchend', function(e){
    const now = Date.now();
    if (this._lastTouch && (now - this._lastTouch) < 300) { e.preventDefault(); }
    this._lastTouch = now;
  }, {passive:false});
})();
</script>
<section id="clinician-notes">
<div style="background: var(--surface); border: 1px solid var(--line); border-radius: 12px; box-shadow: var(--shadow); padding: 16px; margin-top: 24px;">
<label for="clinician-comment" style="display:block;font-weight:600;margin-bottom:8px;">
      Clinician comments (optional)
    </label>
<textarea id="clinician-comment" placeholder="Enter any notes relevant to this session..." rows="4" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--line); font: inherit; resize: vertical;"></textarea>
<p style="margin:8px 0 0; color: var(--muted); font-size: 0.9rem;">
      This note will be added as <code>clinician_comment</code> in the exported CSV.
    </p>
</div>
</section></main></body>
</html>

