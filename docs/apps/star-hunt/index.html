<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Star Hunting (20×8, Visible, Sweep)</title>

<!-- Optional hero metadata (works with your frame.js) -->
<meta name="app-slug" content="star-hunt">
<meta name="app-title" content="Star Hunting">
<meta name="app-desc"  content="20×8 grid • stars visible • optional sweep guide • CSV export">

<link rel="stylesheet" href="/shared/theme.css">
<link rel="stylesheet" href="../../../shared/theme.css">
<script defer src="/shared/frame.js"></script>
<script defer src="../../../shared/frame.js"></script>
<script defer src="/shared/clinician_feedback.js"></script>
<script defer src="../../../shared/clinician_feedback.js"></script>

<style>
  :root{ --cols:20; --rows:8; --cell-gap:3px; }
  *{ box-sizing:border-box; }
  body{
    margin:0; font-family:system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    background:#f3f4f6; color:#111827; min-height:100svh;
    display:flex; align-items:center; justify-content:center; padding:20px;
  }
  #app-root .app{ width:min(96vw,1100px); display:grid; gap:14px; justify-items:center; }

  /* Title */
  .app-title{
    width:100%;
    background:#fff; border:1px solid #d1d5db; border-radius:12px;
    padding:14px 16px;
  }
  .app-title h1{ margin:0 0 4px; font-size:22px; line-height:1.2; }
  .app-title p{ margin:0; color:#6b7280; }

  /* Collapsible instructions */
  details.instructions{
    width:100%;
    background:#fff8e1; border:1px solid #facc15; color:#374151;
    border-radius:12px; font-size:15px; line-height:1.45;
    padding:0;
  }
  details.instructions > summary{
    list-style:none; cursor:pointer; padding:12px 16px; font-weight:700; color:#b45309;
  }
  details.instructions > summary::-webkit-details-marker{ display:none; }
  details.instructions[open] > summary{ border-bottom:1px dashed #facc15; }
  details.instructions .inst-body{ padding:12px 16px; }

  .header{
    width:100%;
    background:#ffffff; border:1px solid #d1d5db; border-radius:12px; padding:12px;
    display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between;
  }
  .group{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  label{ font-size:14px; color:#374151; }
  select,button{
    background:#fff; color:#111827; border:1px solid #9ca3af; border-radius:10px;
    padding:8px 12px; font-size:14px; cursor:pointer;
  }
  button.primary{ background:#10b981; border:0; color:#fff; font-weight:600; }
  button.ghost{ background:#f9fafb; }
  .stats{ display:flex; gap:14px; font-size:14px; color:#374151; }
  .stats b{ color:#111827; }

  .board-wrap{ width:100%; }
  .board{
    width:100%; aspect-ratio:var(--cols)/var(--rows); margin:0 auto;
    display:grid; gap:var(--cell-gap);
    grid-template-columns:repeat(var(--cols),1fr);
    grid-template-rows:repeat(var(--rows),1fr);
    background:#ffffff; border:2px solid #d1d5db; border-radius:12px; padding:8px; position:relative;
    box-shadow:0 1px 0 rgba(0,0,0,.03), 0 8px 24px rgba(0,0,0,.06);
  }
  .cell{
    background:#e5e7eb; border:1px solid #cbd5e1; border-radius:6px;
    display:flex; align-items:center; justify-content:center; user-select:none; cursor:pointer;
    font-size:clamp(14px,2.6vmin,28px);
    transition:transform 80ms ease, border-color 140ms ease, background 140ms ease;
  }
  .cell:hover{ transform:translateY(-1px); border-color:#9ca3af; }
  .cell:active{ transform:translateY(0); }
  .cell .star{ color:#f59e0b; text-shadow:0 0 6px rgba(245,158,11,.45); }
  .cell.found{ background:#d1fae5; border-color:#10b981; }

  .miss{
    position:absolute; pointer-events:none; z-index:5; width:28px; height:28px;
    transform:translate(-50%,-50%); opacity:0; animation:pop 600ms ease forwards;
  }
  .miss::before,.miss::after{ content:""; position:absolute; left:50%; top:50%;
    width:3px; height:30px; background:#ef4444; border-radius:2px; transform-origin:center; }
  .miss::before{ transform:translate(-50%,-50%) rotate(45deg); }
  .miss::after{  transform:translate(-50%,-50%) rotate(-45deg); }
  @keyframes pop{ 0%{opacity:0; transform:translate(-50%,-50%) scale(.6);} 20%{opacity:1; transform:translate(-50%,-50%) scale(1);} 100%{opacity:0; transform:translate(-50%,-50%) scale(1.1);} }

  .overlay{
    position:absolute; inset:8px; display:none; align-items:center; justify-content:center;
    background:rgba(31,41,55,.72); border-radius:10px; z-index:6; text-align:center; padding:24px;
  }
  .overlay.show{ display:flex; }
  .overlay h2{ margin:0; font-size:clamp(18px,4.5vmin,36px); color:#fef3c7; }
  .overlay p{ margin:8px 0 16px; color:#f9fafb; }
  .overlay .row{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }

  .sweep{
    position:absolute; top:8px; bottom:8px; left:8px;
    width:40px; border-radius:8px; pointer-events:none; z-index:5;
    background:linear-gradient(180deg, rgba(59,130,246,.10), rgba(59,130,246,.16));
    box-shadow:inset 0 0 0 1px rgba(59,130,246,.18);
    transition:left 200ms linear;
  }

  .footer{ font-size:12px; color:#6b7280; text-align:center; }
  .kbd{ font-family:ui-monospace, monospace; background:#e5e7eb; border:1px solid #9ca3af; padding:2px 6px; border-radius:6px; color:#111827; }
</style>
</head>
<body>
<main id="app-root" role="main" aria-label="Star Hunting app">
  <div class="app">

    <!-- Title block -->
    <header class="app-title" aria-label="App title">
      <h1>Star Hunting</h1>
      <p>20×8 grid • stars visible • optional sweep guide • CSV export</p>
    </header>

    <!-- Collapsible instructions (closed by default) -->
    <details class="instructions" id="instructions">
      <summary>Instructions</summary>
      <div class="inst-body">
        Click on every ★ star you see inside the grid. Scan across the whole board until all stars are found.
        Try to avoid clicking empty squares. When you complete the grid, you can download your report or start a new session.
      </div>
    </details>

    #app-root {
  width:100%;
  max-width: 960px;   /* or 1100px if you prefer */
}

#app-root .app {
  width:100%;
}

    <section class="header" role="region" aria-label="Controls and status">
      <div class="group">
        <label for="stars">Stars</label>
        <select id="stars" aria-label="Number of stars">
          <option value="8">8</option>
          <option value="10" selected>10</option>
          <option value="12">12</option>
          <option value="15">15</option>
          <option value="20">20</option>
          <option value="25">25</option>
          <option value="30">30</option>
        </select>
        <button id="new" type="button" class="primary">New Session</button>
        <button id="download" type="button" class="ghost">Download Report (CSV)</button>
      </div>

      <div class="group" aria-label="Guiding sweep controls">
        <label for="sweep">Sweep</label>
        <select id="sweep">
          <option value="off">Off</option>
          <option value="on" selected>On</option>
        </select>

        <label for="sweepSpeed">Speed</label>
        <select id="sweepSpeed">
          <option value="500">0.5s</option>
          <option value="1000" selected>1s</option>
        </select>

        <label for="sweepDir">Direction</label>
        <select id="sweepDir">
          <option value="rtl" selected>Right → Left</option>
          <option value="ltr">Left → Right</option>
        </select>
      </div>

      <div class="stats" role="status" aria-live="polite">
        <div>Timer (grid): <b id="timer">00:00</b></div>
        <div>Found: <b id="found">0</b>/<span id="total">0</span></div>
        <div>Clicks: <b id="clicks">0</b></div>
        <div>Errors: <b id="errors">0</b></div>
        <div>Grids done: <b id="grids">0</b></div>
        <div>Total time: <b id="totaltime">00:00</b></div>
      </div>
    </section>

    <section class="board-wrap">
      <div id="board" class="board" role="grid" aria-label="Hunting grid"></div>
    </section>

    <p class="footer">
      Tip: navigate with <span class="kbd">Tab</span> + <span class="kbd">Enter</span>. Stars are always visible; tap all ★’s.
    </p>

  </div>

  <script>
  (function(){
    const COLS=20, ROWS=8;
    const boardEl=document.getElementById('board');
    const timerEl=document.getElementById('timer');
    const foundEl=document.getElementById('found');
    const totalEl=document.getElementById('total');
    const clicksEl=document.getElementById('clicks');
    const errorsEl=document.getElementById('errors');
    const gridsEl=document.getElementById('grids');
    const totalTimeEl=document.getElementById('totaltime');

    const starsSel=document.getElementById('stars');
    const newBtn=document.getElementById('new');
    const dlBtn=document.getElementById('download');

    const sweepSel=document.getElementById('sweep');
    const sweepSpeedSel=document.getElementById('sweepSpeed');
    const sweepDirSel=document.getElementById('sweepDir');

    let STAR_COUNT=Number(starsSel.value);
    let starSet=new Set(), found=new Set();
    let clicks=0, errors=0;

    let started=false, startTs=0, tick=null;
    const records=[]; let totalTimeMs=0, gridIndex=0;

    let sweepDiv=null, sweepTimer=null, sweepCol=0, cellW=0, gap=0, padLeft=8;

    function fmtTime(ms){ const t=Math.floor(ms/1000); const m=String(Math.floor(t/60)).padStart(2,'0'); const s=String(t%60).padStart(2,'0'); return m+':'+s; }
    function startTimer(){ if(started) return; started=true; startTs=performance.now(); tick=setInterval(()=>{ timerEl.textContent=fmtTime(performance.now()-startTs); },200); }
    function stopTimer(){ if(tick){ clearInterval(tick); tick=null; } }

    function randInt(n){ return Math.floor(Math.random()*n); }
    function placeStars(){
      starSet.clear();
      const total=COLS*ROWS, target=Math.min(STAR_COUNT,total);
      while(starSet.size<target){ starSet.add(randInt(total)); }
    }

    function buildBoard(){
      boardEl.innerHTML='';
      boardEl.style.setProperty('--cols',COLS);
      boardEl.style.setProperty('--rows',ROWS);

      for(let i=0;i<COLS*ROWS;i++){
        const cell=document.createElement('button');
        cell.type='button'; cell.className='cell'; cell.dataset.index=i; cell.setAttribute('role','gridcell');
        if(starSet.has(i)){ const span=document.createElement('span'); span.className='star'; span.textContent='★'; cell.appendChild(span); }
        cell.addEventListener('click', handleCellClick);
        cell.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); handleCellClick.call(cell,e); }});
        boardEl.appendChild(cell);
      }

      sweepDiv=document.createElement('div'); sweepDiv.className='sweep'; boardEl.appendChild(sweepDiv);

      const overlay=document.createElement('div'); overlay.id='overlay'; overlay.className='overlay'; overlay.setAttribute('aria-hidden','true');
      overlay.innerHTML=`
        <div>
          <h2>Grid completed!</h2>
          <p>Nice. All stars clicked.</p>
          <div class="row">
            <button id="nextGrid" class="primary" type="button">Restart Grid</button>
            <button id="download2" class="ghost" type="button">Download Report</button>
            <button id="resetSession" class="ghost" type="button">New Session</button>
          </div>
        </div>`;
      boardEl.appendChild(overlay);
      overlay.querySelector('#nextGrid').addEventListener('click', ()=>{ hideOverlay(); nextGrid(); });
      overlay.querySelector('#download2').addEventListener('click', downloadCSV);
      overlay.querySelector('#resetSession').addEventListener('click', ()=>{ hideOverlay(); newSession(); });

      calcSweepGeometry();
      applySweepVisibility();
    }

    function flashMiss(x,y){
      const miss=document.createElement('div'); miss.className='miss';
      const rect=boardEl.getBoundingClientRect();
      miss.style.left=(x-rect.left)+'px'; miss.style.top=(y-rect.top)+'px';
      boardEl.appendChild(miss); setTimeout(()=>miss.remove(),620);
    }

    function showOverlay(){ const o=document.getElementById('overlay'); if(o){ o.classList.add('show'); o.setAttribute('aria-hidden','false'); } }
    function hideOverlay(){ const o=document.getElementById('overlay'); if(o){ o.classList.remove('show'); o.setAttribute('aria-hidden','true'); } }

    function completeGrid(){
      stopTimer(); stopSweep();
      const timeMs=performance.now()-startTs;
      totalTimeMs+=timeMs; gridIndex++;

      const correct=found.size; const totalClicks=clicks; const pct=totalClicks>0?(correct/totalClicks):0;
      records.push({
        gridIndex, grid_cols:COLS, grid_rows:ROWS, starCount:STAR_COUNT,
        clicks:totalClicks, correct, errors, pctCorrect:pct, timeMs,
        sweepOn:(sweepSel.value==='on'), sweepMs:Number(sweepSpeedSel.value), dir:sweepDirSel.value
      });

      gridsEl.textContent=String(gridIndex);
      totalTimeEl.textContent=fmtTime(totalTimeMs);
      showOverlay();
    }

    function handleCellClick(e){
      if(!started) startTimer();
      const idx=Number(this.dataset.index);
      clicks++; clicksEl.textContent=clicks;

      if(starSet.has(idx)){
        if(!found.has(idx)){
          found.add(idx); this.classList.add('found');
          foundEl.textContent=String(found.size);
          if(found.size===starSet.size){ completeGrid(); }
        }
      } else {
        errors++; errorsEl.textContent=errors;
        const x=(e.clientX ?? (e.touches?.[0]?.clientX));
        const y=(e.clientY ?? (e.touches?.[0]?.clientY));
        if(typeof x==='number' && typeof y==='number') flashMiss(x,y);
      }
    }

    function resetGrid(reseed=true){
      stopTimer(); stopSweep(); started=false; timerEl.textContent='00:00';
      clicks=0; errors=0; found.clear();
      clicksEl.textContent='0'; errorsEl.textContent='0'; foundEl.textContent='0';
      hideOverlay();

      STAR_COUNT=Number(starsSel.value);
      totalEl.textContent=String(STAR_COUNT);

      if(reseed) placeStars();
      buildBoard();

      if(sweepSel.value==='on'){ startSweep(); }
      const first=boardEl.querySelector('.cell'); if(first) first.focus({preventScroll:true});
    }

    function newSession(){
      records.splice(0,records.length);
      gridIndex=0; totalTimeMs=0;
      gridsEl.textContent='0'; totalTimeEl.textContent='00:00';
      resetGrid(true);
    }

    function nextGrid(){ resetGrid(true); }

    function downloadCSV(){
      const headers=["grid_index","grid_cols","grid_rows","star_count","clicks_total","correct_clicks","errors","correct_pct","time_s","sweep_on","sweep_period_s","sweep_direction"];
      const rows=[headers.join(",")];

      let sumClicks=0,sumCorrect=0,sumErrors=0,sumTimeMs=0;
      for(const r of records){
        sumClicks+=r.clicks; sumCorrect+=r.correct; sumErrors+=r.errors; sumTimeMs+=r.timeMs;
        rows.push([r.gridIndex,r.grid_cols,r.grid_rows,r.starCount,r.clicks,r.correct,r.errors,(r.pctCorrect*100).toFixed(2),(r.timeMs/1000).toFixed(2),r.sweepOn?1:0,(r.sweepMs/1000).toFixed(1),r.dir].join(","));
      }
      const overallPct=sumClicks>0?(sumCorrect/sumClicks)*100:0;
      rows.push(["TOTAL","","","",sumClicks,sumCorrect,sumErrors,overallPct.toFixed(2),(sumTimeMs/1000).toFixed(2),"","",""].join(","));

      const blob=new Blob([rows.join("\n")],{type:"text/csv;charset=utf-8;"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`star_hunting_report_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0);
    }

    /* ===== Guiding Sweep ===== */
    function calcSweepGeometry(){
      const cs=getComputedStyle(boardEl);
      gap=parseFloat(cs.gap)||0;
      padLeft=parseFloat(cs.paddingLeft)||8;
      const first=boardEl.querySelector('.cell');
      cellW=first ? first.getBoundingClientRect().width : 0;
      if(sweepDiv){
        sweepDiv.style.width=cellW+'px';
        sweepCol=(sweepDirSel.value==='rtl')?(COLS-1):0;
        positionSweep();
      }
    }
    function positionSweep(){ if(!sweepDiv) return; const left=padLeft + sweepCol*(cellW+gap); sweepDiv.style.left=left+'px'; }
    function stepSweep(){
      if(sweepDirSel.value==='rtl'){ sweepCol--; if(sweepCol<0) sweepCol=COLS-1; }
      else{ sweepCol++; if(sweepCol>COLS-1) sweepCol=0; }
      positionSweep();
    }
    function startSweep(){
      if(!sweepDiv) return;
      applySweepVisibility(true);
      clearInterval(sweepTimer);
      calcSweepGeometry();
      sweepTimer=setInterval(stepSweep, Number(sweepSpeedSel.value));
    }
    function stopSweep(){ clearInterval(sweepTimer); sweepTimer=null; applySweepVisibility(false); }
    function applySweepVisibility(show){
      if(!sweepDiv) return;
      const on=(typeof show==='boolean')?show:(sweepSel.value==='on');
      sweepDiv.style.display=on?'block':'none';
    }

    // Events
    starsSel.addEventListener('change', ()=> resetGrid(true));
    newBtn.addEventListener('click', newSession);
    dlBtn.addEventListener('click', downloadCSV);

    sweepSel.addEventListener('change', ()=>{ if(sweepSel.value==='on') startSweep(); else stopSweep(); });
    sweepSpeedSel.addEventListener('change', ()=>{ if(sweepSel.value==='on') startSweep(); });
    sweepDirSel.addEventListener('change', ()=>{ if(sweepSel.value==='on') startSweep(); });

    window.addEventListener('resize', ()=>{ calcSweepGeometry(); positionSweep(); });

    // Init
    (function init(){
      totalEl.textContent=String(STAR_COUNT);
      placeStars();
      buildBoard();
      if(sweepSel.value==='on') startSweep();
    })();
  })();
  </script>

  <!-- Fallback clinician notes -->
  <section id="clinician-notes" aria-label="Clinician notes">
    <div style="background: var(--surface); border: 1px solid var(--line); border-radius: 12px; box-shadow: var(--shadow); padding: 16px; margin-top: 24px;">
      <label for="clinician-comment" style="display:block;font-weight:600;margin-bottom:8px;">Clinician comments (optional)</label>
      <textarea id="clinician-comment" placeholder="Enter any notes relevant to this session..." rows="4" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--line); font: inherit; resize: vertical;"></textarea>
      <p style="margin:8px 0 0; color: var(--muted); font-size: 0.9rem;">This note will be added as <code>clinician_comment</code> in the exported CSV.</p>
    </div>
  </section>
</main>
</body>
</html>
