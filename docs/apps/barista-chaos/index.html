<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Barista Chaos Ã¢â‚¬â€ Micro Rehab App</title>
<style>
    :root{
      --bg:#faf7f2;
      --card:#ffffff;
      --ink:#222;
      --muted:#6b7280;
      --accent:#0ea5e9;
      --success:#22c55e;
      --danger:#ef4444;
      --warning:#f59e0b;
      --pill:#f3f4f6;
      --shadow:0 10px 30px rgba(0,0,0,.07);
      --radius:14px;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, "Noto Sans", Arial, sans-serif;}
    header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.6));backdrop-filter: blur(8px);border-bottom:1px solid #eaeaea; padding:10px 16px; display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap}
    header h1{font-size:18px;margin:0 16px 0 0;display:flex;gap:8px;align-items:center}
    .instructions{font-size:14px; line-height:1.45; color:var(--ink); background:var(--card); border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; max-width:900px}
    .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .btn{border:1px solid #e5e7eb;background:var(--card); padding:10px 14px;border-radius:999px; box-shadow: var(--shadow); cursor:pointer; font-weight:600}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .btn.primary{background:var(--accent); color:white; border-color: transparent}
    .btn.success{background:var(--success); color:white; border-color: transparent}
    .btn.warn{background:var(--warning); color:black; border-color: transparent}

    .seg{display:flex; background:var(--pill); border-radius:999px; padding:4px; gap:4px; box-shadow: var(--shadow)}
    .seg button{border:none;background:transparent;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600;color:var(--muted)}
    .seg button.active{background:white; color:var(--ink); box-shadow: var(--shadow)}

    main{max-width:1100px; margin:18px auto; padding:0 16px}
    .layout{display:grid; grid-template-columns: 1fr; gap:16px}
    @media(min-width:900px){.layout{grid-template-columns: 1.1fr .9fr}}
    .card{background:var(--card); border-radius:var(--radius); box-shadow: var(--shadow); padding:16px}
    .statusbar{display:grid; grid-template-columns: 1fr auto; gap:16px; align-items:center}
    .timer{font-weight:700; font-variant-numeric: tabular-nums}
    .sign{justify-self:end; padding:8px 14px; border-radius:999px; font-weight:700; color:white; box-shadow:0 8px 24px rgba(0,0,0,.2); display:flex; align-items:center; gap:8px}
    .sign.none{background:linear-gradient(120deg,#10b981,#34d399)}
    .sign.plant{background:linear-gradient(120deg,#3b82f6,#06b6d4)}
    .sign.sugar{background:linear-gradient(120deg,#f97316,#f59e0b)}

    .order .ticket{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .chip{display:inline-flex; align-items:center; gap:6px; background:var(--pill); border-radius:999px; padding:8px 12px; border:1px solid #e5e7eb; font-weight:600}

    .tray{min-height:90px; border:2px dashed #d1d5db; border-radius:var(--radius); padding:12px; display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .pill{user-select:none; background:white; border-radius:999px; padding:10px 14px; border:1px solid #e5e7eb; display:inline-flex; align-items:center; gap:8px; box-shadow: var(--shadow); cursor:pointer}
    .pill .emoji{font-size:18px}

    .grid{display:grid; grid-template-columns: repeat(2, 1fr); gap:10px}
    @media(min-width:700px){.grid{grid-template-columns: repeat(3, 1fr)}}

    dialog{border:none; border-radius:16px; padding:0; box-shadow:0 30px 70px rgba(0,0,0,.3)}
    .modal{padding:18px; max-width:520px}
    .modal h3{margin:0 0 8px}
    .modal p{margin:0 0 12px; color:var(--muted)}
    .modal .actions{display:flex; gap:8px; justify-content:flex-end}
    .kudos{color:var(--success); font-weight:700}
  </style>
<meta content="Barista_Chaos" name="app-slug"/><link href="/shared/theme.css" rel="stylesheet"/><script defer="" src="/shared/frame.js"></script><link href="../../../shared/theme.css" rel="stylesheet"/><script defer="" src="../../../shared/frame.js"></script><script defer="" src="../../../shared/clinician_feedback.js"></script>  <meta name="app-slug" content="barista-chaos">
</head>
<body><main id="app-root">
<header>
<h1><span class="cup">Ã¢Ëœâ€¢</span><span>Barista Chaos</span></h1>
<div class="instructions">
<strong>How it works</strong><br/>
      Build each order by adding items from the <em>Options</em> on the right into your <em>Preparation Tray</em>, then press <strong>Serve</strong>.
      <ul style="margin:8px 0 0 18px; padding:0">
<li>Match the ticket chips (e.g., size, coffee, milk, sweetener, temp).</li>
<li><strong>Rule 1 Ã¢â‚¬â€ Decaf bell:</strong> if the ticket shows <em>Decaf</em>, you must click <strong>Ã°Å¸â€â€ Ring Bell</strong> before serving. <em>Ringing the bell when there is no decaf is neutral (not an error).</em></li>
<li><strong>Rule 2 Ã¢â‚¬â€ Extra-hot sleeve:</strong> if the ticket shows <em>Extra hot</em>, you must click <strong>Ã°Å¸Â§Â» Add Sleeve</strong> before serving.</li>
<li><strong>Any-of requirement:</strong> when the ticket says <em>add honey or soy</em>, either one satisfies the ticket; choosing both is allowed and not penalized.</li>
<li>Incidents happen often: sometimes sugar becomes <em>Honey</em>, or milk must be <em>Soy</em>. The ticket will update accordingly.</li>
</ul>
</div>
<div class="controls">
<div aria-label="Countdown" class="seg" role="group">
<button class="active" data-timer="90">90s</button>
<button data-timer="60">60s</button>
<button data-timer="45">45s</button>
<button data-timer="30">30s</button>
<button data-timer="15">15s</button>
</div>
<button class="btn primary" id="newOrderBtn">Start new order</button>
<button class="btn" disabled="" id="serveBtn">Serve</button>
<button class="btn" id="ringBtn" title="Ring for decaf">Ã°Å¸â€â€ Ring Bell</button>
<button class="btn" id="sleeveBtn" title="Add sleeve for extra-hot">Ã°Å¸Â§Â» Add Sleeve</button>
<button class="btn" id="downloadBtn" title="Download CSV log">Ã¢Â¬â€¡Ã¯Â¸Â Download CSV</button>
</div>
</header>
<main>
<div class="layout">
<section class="card order">
<div class="statusbar">
<div class="timer">Order <span id="orderNum">Ã¢â‚¬â€</span> Ã‚Â· Ã¢ÂÂ³ <span id="countdown">--:--</span></div>
<div class="sign none" id="sign"><span id="signText">No incident</span></div>
</div>
<h2 style="margin:10px 0 8px;font-size:18px">Ticket</h2>
<div class="ticket" id="ticket"></div>
<h3 style="margin:16px 0 8px;font-size:16px">Preparation tray</h3>
<div class="tray" id="tray"></div>
<p id="feedback" style="margin:10px 0 0; color:var(--muted)">Add items to match the ticket, then press <strong>Serve</strong>.</p>
</section>
<aside class="card">
<h2 style="margin:0 0 8px;font-size:18px">Options</h2>
<div class="grid" id="options"></div>
</aside>
</div>
</main>
<dialog id="incidentDlg">
<div class="modal">
<h3 id="incidentTitle">Incident</h3>
<p id="incidentMsg">Ã¢â‚¬â€</p>
<div class="actions"><button class="btn" id="incidentClose">OK</button></div>
</div>
</dialog>
<dialog id="resultDlg">
<div class="modal">
<h3 id="resultTitle">Result</h3>
<p id="resultMsg">Ã¢â‚¬â€</p>
<div class="actions"><button class="btn success" id="nextOrderBtn">OK</button></div>
</div>
</dialog>
<script>
    // ===== State: timer + logging =====
    const logs = []; // per-order records
    let timerDurationSec = 90; // default, set by seg buttons
    let remainingSec = 0;
    let timerHandle = null;
    let orderStartTs = null;
    let currentOrderRunning = false;

    // ===== Options & rules =====
    const BASE_OPTIONS = [
      {key:'size_s', label:'Small', emoji:'Ã°Å¸Â¥â€º', group:'size'},
      {key:'size_m', label:'Medium', emoji:'Ã°Å¸Â¥Â¤', group:'size'},
      {key:'size_l', label:'Large', emoji:'Ã°Å¸Â§â€¹', group:'size'},

      {key:'coffee_latte', label:'Latte', emoji:'Ã¢Ëœâ€¢', group:'coffee'},
      {key:'coffee_capp', label:'Cappuccino', emoji:'Ã°Å¸ÂÂ¶', group:'coffee'},
      {key:'coffee_americano', label:'Americano', emoji:'Ã°Å¸Â«Ëœ', group:'coffee'},

      {key:'milk_dairy', label:'Dairy milk', emoji:'Ã°Å¸Â¥â€º', group:'milk'},
      {key:'milk_oat', label:'Oat milk', emoji:'Ã°Å¸Å’Â¾', group:'milk'},
      {key:'milk_almond', label:'Almond milk', emoji:'Ã°Å¸Å’Â°', group:'milk'},
      {key:'milk_soy', label:'Soy milk', emoji:'Ã°Å¸Â«Ëœ', group:'milk'},

      {key:'sweet_sugar', label:'Sugar', emoji:'Ã°Å¸ÂÂ¬', group:'sweet'},
      {key:'sweet_honey', label:'Honey', emoji:'Ã°Å¸ÂÂ¯', group:'sweet'},
      {key:'sweet_none', label:'No sweetener', emoji:'Ã°Å¸Å¡Â«', group:'sweet'},

      {key:'temp_hot', label:'Hot', emoji:'Ã°Å¸â€Â¥', group:'temp'},
      {key:'temp_iced', label:'Iced', emoji:'Ã°Å¸Â§Å ', group:'temp'},

      {key:'flag_decaf', label:'Decaf', emoji:'Ã°Å¸Å¸Â¤', group:'flag'},
      {key:'flag_extrahot', label:'Extra hot', emoji:'Ã°Å¸â€Â¥Ã°Å¸â€Â¥', group:'flag'},
    ];

    let allOptions = [...BASE_OPTIONS];
    let tray = [];          // chosen keys
    let ticket = [];        // target keys
    let needsBell = false;  // rule 1 (decaf ticket)
    let needsSleeve = false;// rule 2 (extra hot ticket)
    let bellRang = false;
    let sleeveAdded = false;
    let orderCount = 0;

    const el = id => document.getElementById(id);
    const ticketEl = el('ticket');
    const trayEl = el('tray');
    const optionsEl = el('options');
    const serveBtn = el('serveBtn');
    const ringBtn = el('ringBtn');
    const sleeveBtn = el('sleeveBtn');
    const newOrderBtn = el('newOrderBtn');
    const orderNum = el('orderNum');
    const sign = el('sign');
    const signText = el('signText');
    const countdownEl = el('countdown');

    const isFlag = key => key.startsWith('flag_');

    // ===== UI helpers =====
    function chip(obj){
      const d = document.createElement('span');
      d.className = 'chip';
      d.innerHTML = `<span class="emoji">${obj.emoji}</span> ${obj.label}`;
      return d;
    }
    function pill(obj){
      const d = document.createElement('button');
      d.type = 'button';
      d.className = 'pill';
      d.dataset.key = obj.key;
      d.innerHTML = `<span class="emoji">${obj.emoji}</span> ${obj.label}`;
      d.addEventListener('click', ()=> addToTray(obj.key));
      return d;
    }
    function renderOptions(){ optionsEl.innerHTML = ''; allOptions.forEach(o=> optionsEl.appendChild(pill(o))); }
    function renderTicket(){ ticketEl.innerHTML = ''; ticket.map(key=> allOptions.find(o=>o.key===key)).forEach(o=> ticketEl.appendChild(chip(o))); }
    function renderTray(){
      trayEl.innerHTML = '';
      tray.map(key=> allOptions.find(o=>o.key===key)).forEach(o=> {
        const p = pill(o);
        p.classList.add('selected');
        p.addEventListener('click', ()=> removeFromTray(o.key));
        trayEl.appendChild(p);
      });
      serveBtn.disabled = tray.length === 0;
    }

    function addToTray(key){ if(!tray.includes(key)) tray.push(key); renderTray(); }
    function removeFromTray(key){ tray = tray.filter(k=>k!==key); renderTray(); }

    // ===== Order generation =====
    function randomOrder(){
      const pick=(group)=>{
        const arr = allOptions.filter(x=>x.group===group);
        return arr[Math.floor(Math.random()*arr.length)];
      };
      const size = pick('size');
      const coffee = pick('coffee');
      const milk = pick('milk');
      const sweet = pick('sweet');
      const temp = pick('temp');

      // probabilities
      needsBell = Math.random() < 0.35; // ~35% need decaf
      needsSleeve = (temp.key==='temp_hot') && (Math.random() < 0.6); // sleeve often for hot

      const arr = [size.key, coffee.key, milk.key, sweet.key, temp.key];
      if(needsBell) arr.push('flag_decaf');
      if(needsSleeve) arr.push('flag_extrahot');
      return arr;
    }

    function applyIncidentAdjustments(){
      // incidents ~60% of orders
      const r = Math.random();
      if(r < 0.3){
        const sugarIdx = ticket.findIndex(k=>k==='sweet_sugar');
        if(sugarIdx!==-1) ticket[sugarIdx] = 'sweet_honey';
        showIncident('Sweetener change', 'We are out of sugar. Use HONEY for this order.', 'sugar');
      } else if(r < 0.6){
        const milkIdx = ticket.findIndex(k=> /^milk_/.test(k));
        if(milkIdx!==-1) ticket[milkIdx] = 'milk_soy';
        showIncident('Milk change', 'Customer requested SOY MILK for this order.', 'plant');
      } else {
        sign.className = 'sign none';
        signText.textContent = 'No incident';
      }
    }

    function showIncident(title,msg,type='none'){
      const dlg = el('incidentDlg');
      el('incidentTitle').textContent = title;
      el('incidentMsg').textContent = msg;
      sign.className = 'sign ' + (type==='plant'?'plant': type==='sugar'?'sugar':'none');
      signText.textContent = title;
      dlg.showModal();
    }

    el('incidentClose').addEventListener('click', ()=> el('incidentDlg').close());

    // ===== Timer =====
    function fmt(sec){
      const m = Math.floor(sec/60).toString().padStart(2,'0');
      const s = Math.floor(sec%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }
    function stopTimer(){
      if(timerHandle){
        clearInterval(timerHandle);
        timerHandle = null;
      }
    }
    function startTimer(){
      stopTimer();
      remainingSec = timerDurationSec;
      countdownEl.textContent = fmt(remainingSec);
      timerHandle = setInterval(()=>{
        remainingSec--;
        countdownEl.textContent = fmt(Math.max(0,remainingSec));
        if(remainingSec<=0){
          stopTimer();
          currentOrderRunning = false;
          serveBtn.disabled = true;
          finalizeOrder({ timedOut:true });
        }
      },1000);
    }

    // ===== New order & controls =====
    function resetForNewOrder(){
      tray = [];
      bellRang = false;
      sleeveAdded = false;
      renderTray();
      orderCount += 1;
      orderNum.textContent = orderCount;
      ticket = randomOrder();
      applyIncidentAdjustments();
      renderTicket();
      el('feedback').textContent = 'Add items to match the ticket, then press Serve.';
    }

    function beginOrder(){
      currentOrderRunning = true;
      orderStartTs = performance.now();
      startTimer();
    }

    newOrderBtn.addEventListener('click', ()=>{
      resetForNewOrder();
      beginOrder();
    });

    document.querySelectorAll('.seg button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.seg button').forEach(b=> b.classList.remove('active'));
        btn.classList.add('active');
        timerDurationSec = parseInt(btn.dataset.timer,10);
      });
    });

    ringBtn.addEventListener('click', ()=>{
      bellRang = true;
      ringBtn.classList.add('success');
      setTimeout(()=> ringBtn.classList.remove('success'), 500);
    });
    sleeveBtn.addEventListener('click', ()=>{
      sleeveAdded = true;
      sleeveBtn.classList.add('warn');
      setTimeout(()=> sleeveBtn.classList.remove('warn'), 500);
    });

    // ===== Evaluation & results =====
    function finalizeOrder({timedOut=false}){
      stopTimer();
      const endTs = performance.now();
      const secs = orderStartTs? (endTs - orderStartTs)/1000 : 0;

      // Split expected vs flags
      let wantCore = ticket.filter(k=> !isFlag(k));
      const gotAll  = tray.slice();
      const gotFlags = gotAll.filter(k=> isFlag(k));
      const gotCore  = gotAll.filter(k=> !isFlag(k));

      const errors = [];
      const notes  = [];

      // --- Any-of "honey OR soy" requirement -------------------------
      const ANY_OF = ['sweet_honey','milk_soy'];
      const anyOfOnTicket = wantCore.some(k => ANY_OF.includes(k));
      if(anyOfOnTicket){
        // Remove any-of tokens from the strict set and require at least one present
        wantCore = wantCore.filter(k => !ANY_OF.includes(k));
        const satisfied = gotCore.some(k => ANY_OF.includes(k));
        if(!satisfied){
          errors.push('Need at least one of: Honey OR Soy');
        } else {
          const both = ANY_OF.every(k => gotCore.includes(k));
          if(both) notes.push('Both Ã¢â‚¬Å“honeyÃ¢â‚¬Â and Ã¢â‚¬Å“soyÃ¢â‚¬Â selected Ã¢â‚¬â€ allowed, not penalized.');
        }
      }

      // --- Decaf + bell logic ----------------------------------------
      if(ticket.includes('flag_decaf')){ // ticket truly requires decaf
        const decafChosen = gotFlags.includes('flag_decaf');
        if(!decafChosen){
          errors.push('Decaf required but not selected.');
        }
        if(decafChosen && !bellRang){
          errors.push('Bell must be rung for decaf orders.');
        }
        if(!decafChosen && bellRang){
          notes.push('Bell rung without decaf Ã¢â‚¬â€ neutral (not an error).');
        }
      } else {
        if(bellRang){
          notes.push('Bell rung Ã¢â‚¬â€ neutral (no decaf required).');
        }
      }

      // --- Extra-hot sleeve rule -------------------------------------
      if(ticket.includes('flag_extrahot') && !sleeveAdded){
        errors.push('No sleeve for extra-hot.');
      }

      // --- Content errors (compare ONLY core items) -------------------
      const extras  = gotCore.filter(k=>{
        // If any-of is on the ticket, both honey/soy are allowed (not extras)
        if(anyOfOnTicket && ANY_OF.includes(k)) return false;
        return !wantCore.includes(k);
      });
      const missing = wantCore.filter(k=> !gotCore.includes(k));
      if(extras.length)  errors.push('Extra items: ' + extras.map(k=> BASE_OPTIONS.find(o=>o.key===k)?.label).join(', '));
      if(missing.length) errors.push('Missing items: ' + missing.map(k=> BASE_OPTIONS.find(o=>o.key===k)?.label).join(', '));

      const passed = !timedOut && errors.length===0;

      logs.push({
        order: orderCount,
        duration_s: Math.round(secs),
        timed_out: timedOut,
        correct: passed,
        errors: errors.join(' | ')
      });

      const dlg = el('resultDlg');
      el('resultTitle').textContent = passed ? 'Ã¢Å“â€¦ Served!' : (timedOut ? 'Ã¢ÂÂ° Time up' : 'Ã¢Å¡Â Ã¯Â¸Â Check again');
      el('resultMsg').textContent = passed
        ? 'Perfect match within time.'
        : (errors.length ? errors.join(' | ') : (notes.length ? notes.join(' | ') : 'Order not correct.'));
      dlg.showModal();
    }

    serveBtn.addEventListener('click', ()=> finalizeOrder({timedOut:false}));
    el('nextOrderBtn').addEventListener('click', ()=> el('resultDlg').close());

    // ===== CSV download =====
    function downloadCSV(){
      const headers = ['order','duration_s','timed_out','correct','errors'];
      const rows = logs.map(r=> headers.map(h=> String(r[h] ?? '')).join(','));
      const csv = [headers.join(','), ...rows].join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'barista_log.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }
    el('downloadBtn').addEventListener('click', downloadCSV);

    // ===== Init =====
    function init(){
      renderOptions();
      countdownEl.textContent = '--:--';
      orderNum.textContent = 'Ã¢â‚¬â€';
    }
    init();
  </script>
<section id="clinician-notes">
<div style="background: var(--surface); border: 1px solid var(--line); border-radius: 12px; box-shadow: var(--shadow); padding: 16px; margin-top: 24px;">
<label for="clinician-comment" style="display:block;font-weight:600;margin-bottom:8px;">
      Clinician comments (optional)
    </label>
<textarea id="clinician-comment" placeholder="Enter any notes relevant to this session..." rows="4" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--line); font: inherit; resize: vertical;"></textarea>
<p style="margin:8px 0 0; color: var(--muted); font-size: 0.9rem;">
      This note will be added as <code>clinician_comment</code> in the exported CSV.
    </p>
</div>
</section></main></body>
</html>

