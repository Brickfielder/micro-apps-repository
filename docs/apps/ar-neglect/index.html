<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>AR Neglect Scanner ‚Äî Prototype</title>

<!-- A-Frame + AR.js (marker-based) -->
<script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.7/aframe/build/aframe-ar.min.js"></script>

<style>
  :root{ --ink:#0f172a; --muted:#475569; --ok:#16a34a; --accent:#2563eb; --danger:#dc2626; --bg:rgba(255,255,255,.92); --shadow:0 10px 30px rgba(0,0,0,.18) }
  html,body{margin:0;height:100%;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .topbar{position:fixed;top:0;left:0;right:0;padding:.6rem;display:flex;gap:.5rem;justify-content:space-between;z-index:10}
  .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.6rem .9rem;border-radius:12px;border:0;cursor:pointer;box-shadow:var(--shadow);background:#fff;color:var(--ink);font-weight:600}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.danger{background:var(--danger);color:#fff}
  .card{background:var(--bg);border-radius:14px;padding:.6rem .9rem;box-shadow:var(--shadow)}
  .pill{display:inline-block;padding:.25rem .6rem;border-radius:999px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.1);font-size:.85rem}
  .notice{position:fixed;top:60px;left:50%;transform:translateX(-50%);background:var(--bg);padding:.5rem .75rem;border-radius:10px;box-shadow:var(--shadow);z-index:10;font-size:.95rem}
  .hidden{display:none}
  .hud{position:fixed;inset:auto 0 0 0;pointer-events:none;display:grid;gap:.75rem;padding:1rem;z-index:10;grid-template-columns:1fr auto}
  .kpi{display:flex;gap:1rem;align-items:center;flex-wrap:wrap}
  .fallback{position:fixed;inset:0;display:grid;place-items:center;padding:2rem;text-align:center;background:#0b1220;color:#e2e8f0}
  .fallback a{color:#93c5fd}
</style>
</head>
<body>

<!-- Fallback / primer -->
<div id="primer" class="fallback">
  <div class="box" style="max-width:720px">
    <h2>AR Neglect Scanner (Prototype)</h2>
    <p>This needs camera access. On Android Chrome, tap the button below to grant permission, then the AR view will start.</p>
    <ol style="text-align:left;max-width:520px;margin:1rem auto">
      <li>Use a <strong>GitHub Pages</strong> link (HTTPS), not the GitHub code viewer.</li>
      <li>Allow camera access when prompted.</li>
      <li>Point at a <strong>Hiro marker</strong> (search ‚Äúhiro marker ar.js‚Äù).</li>
    </ol>
    <button id="btnPrime" class="btn primary">Enable camera</button>
    <p id="primeStatus" style="margin-top:.75rem;opacity:.85"></p>
  </div>
</div>

<!-- Status toast -->
<div id="status" class="notice hidden">Point your camera at the marker‚Ä¶</div>

<!-- HUD -->
<div class="hud hidden" id="hud">
  <div class="card kpi">
    <span>‚è± <strong id="timer">00:00</strong></span>
    <span>‚¨ÖÔ∏è Left: <strong id="scoreL">0/0</strong></span>
    <span>‚û°Ô∏è Right: <strong id="scoreR">0/0</strong></span>
    <span>üéØ Remaining: <strong id="remain">0</strong></span>
    <span id="firstLeft" class="pill">Time to first left: ‚Äî</span>
  </div>
  <div class="card">
    <button id="btnCSV" class="btn">Download CSV</button>
    <button id="btnReset" class="btn">Reset</button>
    <button id="btnExit" class="btn danger">Exit</button>
  </div>
</div>

<!-- A-Frame / AR.js scene (hidden until primed) -->
<a-scene
  id="scene"
  embedded
  class="hidden"
  vr-mode-ui="enabled: false"
  renderer="precision: mediump; antialias: true; alpha: true; physicallyCorrectLights: false"
  arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;
        trackingMethod: best; 
        sourceWidth: 1280; sourceHeight: 720; displayWidth: 1280; displayHeight: 720;
        facingMode: environment;">
  <a-entity id="cursor" cursor="rayOrigin: mouse" raycaster="objects: .clickable; far: 20"></a-entity>
  <a-marker type="preset" preset="hiro" id="marker">
    <a-entity light="type: ambient; intensity: 0.9"></a-entity>
    <a-entity light="type: directional; intensity: 0.6" position="0 1 1"></a-entity>
    <a-plane id="plane" position="0 0 0" rotation="-90 0 0" width="1" height="0.6" visible="false" color="#ccc"></a-plane>
    <a-entity id="targets"></a-entity>
  </a-marker>
  <a-entity camera></a-entity>
</a-scene>

<script>
  // ---- Prime camera (forces permission prompt), then start AR
  const btnPrime = document.getElementById('btnPrime');
  const primeStatus = document.getElementById('primeStatus');
  const scene = document.getElementById('scene');
  const hud = document.getElementById('hud');
  const statusEl = document.getElementById('status');
  let primed = false;

  btnPrime.addEventListener('click', async () => {
    try {
      primeStatus.textContent = 'Requesting camera‚Ä¶';
      // Prompt for camera (rear preferred), then immediately release.
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' }, width: {ideal:1280}, height:{ideal:720} },
        audio: false
      });
      stream.getTracks().forEach(t => t.stop());
      primed = true;
      primeStatus.textContent = 'Camera enabled ‚úì Starting AR‚Ä¶';
      // show scene + HUD
      document.getElementById('primer').classList.add('hidden');
      scene.classList.remove('hidden');
      hud.classList.remove('hidden');
      statusEl.classList.remove('hidden');
    } catch (e) {
      primeStatus.textContent = 'Could not access camera: ' + e.message + ' (Check Chrome ‚ñ∏ lock icon ‚ñ∏ Site settings ‚ñ∏ Camera: Allow)';
    }
  });

  // ---- Minimal game logic (same as before)
  const targetsEl = () => document.getElementById('targets');
  const timerEl = document.getElementById('timer');
  const scoreL = document.getElementById('scoreL');
  const scoreR = document.getElementById('scoreR');
  const remainEl = document.getElementById('remain');
  const firstLeftEl = document.getElementById('firstLeft');
  const btnReset = document.getElementById('btnReset');
  const btnCSV = document.getElementById('btnCSV');
  const btnExit = document.getElementById('btnExit');

  let config = { totalLeft: 8, totalRight: 8, spreadX: 0.48, spreadY: 0.22, height: 0.04 };
  let started=false,startTime=0,interval=null,firstLeftTime=null;
  let counts = { left:0, right:0, remain:0, leftTotal:0, rightTotal:0 };
  let log = [];

  function mmss(ms){ const s=Math.max(0,Math.floor(ms/1000)); const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${m}:${ss}` }
  function startTimer(){ startTime=performance.now(); interval=setInterval(()=>{ timerEl.textContent = mmss(performance.now()-startTime); }, 200); }
  function stopTimer(){ clearInterval(interval); interval=null; }
  function rand(min,max){ return Math.random()*(max-min)+min }

  function spawnTargets(){
    targetsEl().innerHTML = '';
    counts.left=0; counts.right=0;
    counts.leftTotal=config.totalLeft; counts.rightTotal=config.totalRight;
    counts.remain=config.totalLeft+config.totalRight;
    scoreL.textContent = `${counts.left}/${counts.leftTotal}`;
    scoreR.textContent = `${counts.right}/${counts.rightTotal}`;
    remainEl.textContent = counts.remain;
    firstLeftEl.textContent = 'Time to first left: ‚Äî';
    firstLeftTime=null;

    const mk = (side, i) => {
      const color = side==='left' ? '#ef4444' : '#10b981';
      const e = document.createElement('a-sphere');
      e.setAttribute('radius', 0.03);
      e.setAttribute('color', color);
      e.setAttribute('class', 'clickable');
      e.dataset.side = side;
      e.dataset.id = `${side}-${i}`;
      const x = side==='left' ? rand(-config.spreadX, -0.12) : rand(0.12, config.spreadX);
      const y = rand(0.0, config.spreadY);
      e.setAttribute('position', `${x} ${config.height} ${-y}`);
      e.setAttribute('animation__bob', `property=position; dir=alternate; dur=1400; easing=easeInOutSine; loop=true; to=${x} ${config.height+0.015} ${-y}`);
      e.addEventListener('click', ()=>{
        const ts = performance.now()-startTime;
        log.push({ts:Math.round(ts), side, id:e.dataset.id});
        e.setAttribute('animation__pop','property=scale; to=1.6 1.6 1.6; dur=120; easing=easeOutQuad');
        setTimeout(()=> e.parentNode && e.parentNode.removeChild(e), 120);
        if (side==='left'){ counts.left++; if (!firstLeftTime){ firstLeftTime=ts; firstLeftEl.textContent = `Time to first left: ${mmss(firstLeftTime)}`; } }
        else { counts.right++; }
        counts.remain--;
        scoreL.textContent = `${counts.left}/${counts.leftTotal}`;
        scoreR.textContent = `${counts.right}/${counts.rightTotal}`;
        remainEl.textContent = counts.remain;
        if (counts.remain<=0){ stopTimer(); statusEl.textContent='Session complete ‚Äî download CSV for log.'; statusEl.classList.remove('hidden'); }
      });
      targetsEl().appendChild(e);
    };
    for (let i=0;i<config.totalLeft;i++) mk('left', i+1);
    for (let i=0;i<config.totalRight;i++) mk('right', i+1);
  }

  // Start automatically when marker first appears
  document.addEventListener('DOMContentLoaded', ()=>{
    const marker = document.getElementById('marker');
    marker.addEventListener('markerFound', ()=>{
      if (!started && primed){ started=true; statusEl.classList.add('hidden'); spawnTargets(); startTimer(); }
    });
    marker.addEventListener('markerLost', ()=>{
      if (started){ statusEl.textContent='Marker lost ‚Äî hold steady or move closer.'; statusEl.classList.remove('hidden'); }
    });
  });

  function resetSession(){
    stopTimer(); started=false; log=[];
    timerEl.textContent='00:00'; firstLeftEl.textContent='Time to first left: ‚Äî';
    targetsEl().innerHTML='';
    counts={left:0,right:0,remain:0,leftTotal:0,rightTotal:0};
    scoreL.textContent='0/0'; scoreR.textContent='0/0'; remainEl.textContent='0';
    statusEl.textContent='Reset ‚Äî point at the marker'; statusEl.classList.remove('hidden');
  }

  function downloadCSV(){
    const headers=['timestamp_ms','side','id','elapsed_total_ms','left_found','right_found','left_total','right_total','time_to_first_left_ms'];
    let L=0,R=0;
    const rows = log.map(e=>{ if(e.side==='left')L++; else R++; return [e.ts,e.side,e.id,Math.round(e.ts),L,R,config.totalLeft,config.totalRight,firstLeftTime?Math.round(firstLeftTime):''].join(',') });
    const csv=[headers.join(','),...rows].join('\n');
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download=`ar-neglect-log-${Date.now()}.csv`; a.click(); URL.revokeObjectURL(a.href);
  }

  btnReset.addEventListener('click', resetSession);
  btnCSV.addEventListener('click', downloadCSV);
  btnExit.addEventListener('click', ()=> location.reload());
</script>
</body>
</html>
