<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üéß Audio Errand Planner üéß</title>

  <!-- Frame header: pulls title/description from catalog.json via this slug -->
 <meta name="app-slug"content= "audio-errands" />
  <meta name="theme" content="bold dense" />

  <!-- Shared assets published from repo/docs/ as site root (no /docs in URL) -->
<link rel="stylesheet" href="../shared/css/theme.css?v=3">
<script defer src="../shared/js/frame.js?v=3"></script>
<script defer src="../shared/js/clinician_feedback.js?v=3"></script>

<meta name="app-slug" content="audio-errands">
<meta name="theme" content="bold dense">

  <style>
    :root{ --ok:#12b886; --warn:#f59f00; --err:#e03131; }
    /* space below injected header */
    .frame-hero + #app-root{ margin-top: 12px; }

    /* ===== Layout ===== */
    #app-root .grid{ display:grid; grid-template-columns: 1fr 320px; gap:16px; max-width:min(1100px, 92vw); margin:0 auto; }
    @media (max-width:900px){ #app-root .grid{ grid-template-columns:1fr; } }

    #app-root .status{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; max-width:min(1100px, 92vw); margin:8px auto; }
    #app-root .status .dot{ width:10px; height:10px; border-radius:50%; background:var(--err); }

    #app-root .boards{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px; }
    @media (max-width:700px){ #app-root .boards{ grid-template-columns:1fr; } }
    #app-root .board{ min-height:120px; padding:12px; border-radius:12px; border:1px dashed var(--line, #d0d5dd); background:#fafbff; }
    #app-root .board h3{ margin:0 0 8px; font-size:14px; color:var(--muted, #667085); }
    #app-root .board .drop{ min-height:52px; display:flex; gap:8px; flex-wrap:wrap; }

    #app-root .pill{ display:inline-flex; gap:8px; align-items:center; user-select:none; padding:.5rem .75rem; background:white; border:1px solid #e5e7eb; border-radius:999px; }
    #app-root .pill[data-draggable="true"]{ cursor:grab; }
    #app-root .pill.dragging{ opacity:.6; }
    #app-root .disabled{ opacity:.4; pointer-events:none; }

    #app-root .card{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 1px 2px rgba(0,0,0,.04); padding:16px; }
    #app-root .card h2{ margin:0 0 8px; font-size:18px; }
    #app-root .log{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; white-space:pre-wrap; background:#f5f7ff; border:1px solid #e5e7eb; border-radius:12px; padding:10px; max-height:200px; overflow:auto; }

    #app-root .overlay{ position:fixed; inset:0; display:none; place-items:center; background:#0009; backdrop-filter:blur(2px); z-index:20; }
    #app-root .overlay.show{ display:grid; }
    #app-root .count{ font-size:clamp(48px,8vw,96px); font-weight:700; color:#e5edff; }
    #app-root .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    #app-root .controls{ display:grid; gap:12px; }
    #app-root .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    #app-root label{ font-size:14px; color:#667085; }

    /* Hide the voice selector (we lock to Libby) */
    #app-root #voiceSel{ display:none; }
  </style>
</head>
<body>
  <!-- NOTE: no manual hero strip; frame.js injects the header based on catalog.json -->

  <div id="app-root">
    <!-- Status row -->
    <div class="status" aria-live="polite">
      <span class="dot" id="audioDot"></span>
      <span id="audioStatus">Speech: not ready</span>
    </div>

    <div class="grid">
      <!-- Left: Main card -->
      <section class="card" aria-labelledby="briefingTitle">
        <h2 id="briefingTitle">Briefing</h2>
        <p class="hint">Listen carefully. You‚Äôll hear a list of errands in order. When playback ends, drag the items into the correct sequence and submit.</p>

        <div class="controls">
          <div class="row">
            <label for="difficulty">Difficulty (items):</label>
            <select id="difficulty" aria-label="Difficulty">
              <option value="3">3</option>
              <option value="4" selected>4</option>
              <option value="5">5</option>
              <option value="6">6</option>
            </select>

            <label for="interrupts">Auditory interruptions:</label>
            <select id="interrupts" aria-label="Interruptions">
              <option value="none" selected>None</option>
              <option value="one">One</option>
              <option value="random">Random</option>
            </select>

            <label for="distractors">Distractor items shown:</label>
            <select id="distractors" aria-label="Distractors">
              <option value="0" selected>0</option>
              <option value="2">2</option>
              <option value="4">4</option>
            </select>
          </div>

          <div class="row">
            <label for="voiceSel" style="display:none">Voice:</label>
            <select id="voiceSel" aria-label="Voice" style="display:none"></select>

            <label for="rate">Rate:</label>
            <input id="rate" type="range" min="0.7" max="1.4" step="0.05" value="1" />
            <button id="hearingTest" class="ghost" title="Play a short sample">Hearing check üîä</button>
          </div>

          <div class="row">
            <button id="start" class="primary">Start Trial ‚ñ∂Ô∏è</button>
            <button id="stopSpeak" class="warn">Stop Audio ‚èπÔ∏è</button>
            <button id="reset" class="ghost">Reset</button>
          </div>
        </div>

        <!-- Boards -->
        <div class="boards">
          <div class="board">
            <h3>Available items</h3>
            <div id="pool" class="drop" aria-label="Item pool"></div>
          </div>
          <div class="board">
            <h3>Your sequence</h3>
            <div id="sequence" class="drop" aria-label="Your sequence"></div>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="submit" class="ok">Submit ‚úÖ</button>
          <button id="clearSeq" class="ghost">Clear sequence</button>
          <div id="feedback" class="hint" aria-live="polite"></div>
        </div>
      </section>

      <!-- Right: Session card -->
      <aside class="card" aria-labelledby="sessionTitle">
        <h2 id="sessionTitle">Session</h2>
        <div class="row">
          <div>Trials: <strong id="trialNum">0</strong></div>
          <div>Score: <strong id="score">0</strong></div>
          <div>Time: <strong id="timer">00:00</strong></div>
        </div>
        <div style="margin:12px 0">
          <button id="downloadCsv" class="ghost">Download CSV ‚¨áÔ∏è</button>
        </div>
        <div id="log" class="log" aria-label="Log"></div>
      </aside>
    </div>

    <!-- Countdown overlay -->
    <div id="overlay" class="overlay" aria-hidden="true">
      <div id="count" class="count">3</div>
      <span id="overlaySr" class="sr-only">Trial starts soon</span>
    </div>
  </div>

  <!-- App logic (unchanged from your working version) -->
  <script>
  (function(){
    // ====== Data ======
    const MASTER= [
      'Bakery','Post office','Pharmacy','Supermarket','Library','Bank','Hardware store',
      'Butcher','Greengrocer','Stationery shop','Dry cleaner','Pet shop','Newsagent',
      'Clinic','School','Gym','Cafe','Florist','Electronics store','Bookshop'
    ];

    let currentList=[], groundTruth=[], distractorPool=[],
        trial=0, score=0, t0=null, tick=null, logs=[];

    const els = {
      audioDot: document.getElementById('audioDot'),
      audioStatus: document.getElementById('audioStatus'),
      voiceSel: document.getElementById('voiceSel'), rate: document.getElementById('rate'),
      hearing: document.getElementById('hearingTest'),
      diff: document.getElementById('difficulty'), intr: document.getElementById('interrupts'), dist: document.getElementById('distractors'),
      start: document.getElementById('start'), stopSpeak: document.getElementById('stopSpeak'), reset: document.getElementById('reset'),
      pool: document.getElementById('pool'), seq: document.getElementById('sequence'),
      submit: document.getElementById('submit'), clearSeq: document.getElementById('clearSeq'),
      feedback: document.getElementById('feedback'),
      trialNum: document.getElementById('trialNum'), score: document.getElementById('score'), timer: document.getElementById('timer'),
      log: document.getElementById('log'),
      overlay: document.getElementById('overlay'), count: document.getElementById('count')
    };

    // ====== Speech (Libby-only + robust stop) ======
    const synth = 'speechSynthesis' in window ? window.speechSynthesis : null;
    const PREFERRED_VOICE = /libby/i; // Microsoft Libby Online (Natural) ‚Äî en-GB
    let abortSpeech = false;
    let speakingToken = 0;

    function updateSpeechStatus(msg){
      if(!synth){ els.audioStatus.textContent='Speech: unavailable'; els.audioDot.style.background='var(--err)'; return; }
      if(msg){ els.audioStatus.textContent = 'Speech: ' + msg; return; }
      const vs = synth.getVoices();
      if(vs && vs.length){ els.audioStatus.textContent='Speech: ready'; els.audioDot.style.background='var(--ok)'; }
      else { els.audioStatus.textContent='Speech: loading voices‚Ä¶'; els.audioDot.style.background='var(--warn)'; }
    }
    function chooseVoice(vs){
      const libby = vs.find(v => PREFERRED_VOICE.test(v.name));
      if (libby) return libby;
      return vs.find(v => /en-GB/i.test(v.lang)) || vs.find(v => v.default) || vs[0] || null;
    }
    function populateVoices(){
      if(!synth) return;
      const vs = synth.getVoices();
      const v = chooseVoice(vs);
      els.voiceSel.innerHTML='';
      if(v){
        const o=document.createElement('option');
        o.value='0'; o.textContent=`${v.name} ‚Äî ${v.lang}`;
        els.voiceSel.appendChild(o);
        els.voiceSel.disabled = true;
      }
      updateSpeechStatus();
    }
    async function waitForVoices(maxTries=12, delayMs=250){
      if(!synth) return false;
      for(let i=0;i<maxTries;i++){
        const vs = synth.getVoices();
        if(vs && vs.length){ return true; }
        await new Promise(r=>setTimeout(r, delayMs));
      }
      return false;
    }
    if(synth){
      synth.addEventListener && synth.addEventListener('voiceschanged', populateVoices);
      populateVoices();
      waitForVoices().then(ok => { if(ok) populateVoices(); else updateSpeechStatus('not ready (silent fallback)'); });
    } else {
      updateSpeechStatus();
    }

    function cancelAllSpeech(){
      abortSpeech = true;
      speakingToken++;
      if (synth){
        try { synth.cancel(); } catch {}
        try { synth.pause(); synth.resume(); } catch {}
        let tries = 0;
        const knock = setInterval(()=>{
          if (!synth.speaking || tries++ > 6){ clearInterval(knock); }
          else { try { synth.cancel(); } catch {} }
        }, 80);
      }
      disableBoards(false);
      try { stopTimer(); } catch {}
      try { els.overlay.classList.remove('show'); els.overlay.setAttribute('aria-hidden','true'); } catch {}
    }
    function resetAbort(){ abortSpeech = false; }

    function speak(text, {queue=false, timeoutMs=8000}={}){
      if(!synth) return Promise.resolve();
      if(abortSpeech) return Promise.resolve();
      const myToken = ++speakingToken;
      return new Promise(res=>{
        if(!queue) { try{ synth.cancel(); }catch{} }
        const u = new SpeechSynthesisUtterance(text);
        const vs = synth.getVoices();
        u.voice = chooseVoice(vs);
        u.rate = parseFloat(els.rate.value||1);
        let done=false;
        const finish=()=>{ if(done) return; done=true; clearTimeout(timer); res(); };
        u.onend = ()=>{ if(myToken!==speakingToken || abortSpeech) return finish(); finish(); };
        u.onerror = finish;
        const timer = setTimeout(finish, timeoutMs);
        try{ synth.speak(u); }catch{ finish(); }
      });
    }

    // ====== UI helpers ======
    function h(tag, attrs={}, children=[]) {
      const el = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)) {
        if(k==='_text') el.textContent=v;
        else if(k.startsWith('on')) el.addEventListener(k.slice(2), v);
        else el.setAttribute(k, v);
      }
      children.forEach(c=> el.appendChild(c));
      return el;
    }
    function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a}
    function sample(arr,n){return shuffle(arr.slice()).slice(0,n)}
    function timeNow(){return new Date().toISOString()}
    function fmt(ms){const s=Math.floor(ms/1000), m=Math.floor(s/60), r=s%60;return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`}

    function startTimer(){t0=performance.now(); tick = setInterval(()=>{els.timer.textContent=fmt(performance.now()-t0)}, 200)}
    function stopTimer(){if(tick){clearInterval(tick); tick=null}}

    function clearBoards(){els.pool.innerHTML=''; els.seq.innerHTML='';}
    function mkPill(label){ return h('div',{class:'pill', draggable:'true', 'data-draggable':'true', 'data-item':label, _text:label}); }
    function disableBoards(disabled){ [els.pool,els.seq].forEach(z=> disabled?z.classList.add('disabled'):z.classList.remove('disabled')); }

    function makeDnD(container){
      let dragging=null;
      container.addEventListener('dragstart', e=>{
        if(els.pool.classList.contains('disabled')){ e.preventDefault(); return; }
        const t=e.target.closest('.pill'); if(!t) return; dragging=t; t.classList.add('dragging'); e.dataTransfer.effectAllowed='move';
      });
      container.addEventListener('dragend', ()=>{ if(dragging){ dragging.classList.remove('dragging'); dragging=null; }});
      [els.pool, els.seq].forEach(zone=>{
        zone.addEventListener('dragover', e=>{
          if(zone.classList.contains('disabled')) return;
          e.preventDefault(); const after = getAfter(zone,e.clientX,e.clientY); const d = document.querySelector('.pill.dragging'); if(!d) return;
          after ? zone.insertBefore(d, after) : zone.appendChild(d);
        });
      });
    }
    function getAfter(container,x,y){
      const els2=[...container.querySelectorAll('.pill:not(.dragging)')];
      return els2.reduce((closest,child)=>{
        const box=child.getBoundingClientRect();
        const offset = y - box.top - box.height/2;
        if(offset<0 && offset>closest.offset) return {offset, element:child};
        else return closest;
      }, {offset:Number.NEGATIVE_INFINITY}).element;
    }
    makeDnD(document);

    // ====== Trial flow ======
    async function runCountdown(n=3){
      els.overlay.classList.add('show'); els.overlay.setAttribute('aria-hidden','false');
      for(let i=n;i>0;i--){ if(abortSpeech) break; els.count.textContent=i; await new Promise(r=>setTimeout(r,750));}
      els.overlay.classList.remove('show'); els.overlay.setAttribute('aria-hidden','true');
    }
    function buildTrial(){
      const n = parseInt(els.diff.value,10);
      groundTruth = sample(MASTER, n);
      const dnum = parseInt(els.dist.value,10);
      const leftovers = MASTER.filter(x=>!groundTruth.includes(x));
      distractorPool = sample(leftovers, dnum);
      currentList = shuffle([...groundTruth, ...distractorPool]);
      clearBoards();
      currentList.forEach(item=> els.pool.appendChild(mkPill(item)));
    }
    async function playSequence(){
      try{
        if(synth && !abortSpeech){ await speak('Listen carefully to the list of errands in order.', {timeoutMs:5000}); }
        for(let i=0;i<groundTruth.length;i++){
          if(abortSpeech) break;
          if(synth){ await speak(`${i+1}. ${groundTruth[i]}`, {queue:true, timeoutMs:5000}); }
          if(abortSpeech) break;
          if(els.intr.value!=='none' && Math.random()< (els.intr.value==='one'? (i===Math.floor(groundTruth.length/2)?1:0): 0.35)){
            if(synth && !abortSpeech){ await speak('Attention: remember to focus.', {queue:true, timeoutMs:4000}); }
          }
        }
        if(!abortSpeech && synth){ await speak('Now arrange the items in the same order, then press submit.', {queue:true, timeoutMs:6000}); }
      } finally {
        disableBoards(false);
      }
    }
    function startTrial(){
      resetAbort();
      trial++; els.trialNum.textContent=trial; els.feedback.textContent='';
      buildTrial();
      disableBoards(true);
      runCountdown(3).then(async()=>{
        if(abortSpeech) { disableBoards(false); return; }
        startTimer();
        await playSequence();
      });
    }
    function readSeq(container){ return [...container.querySelectorAll('.pill')].map(p=>p.getAttribute('data-item')); }
    function grade(){
      const attempt = readSeq(els.seq);
      if(attempt.length!==groundTruth.length){
        els.feedback.textContent = 'Sequence incomplete: drag all required items, then submit.'; return;
      }
      const correctCount = attempt.reduce((n,x,i)=> n + (x===groundTruth[i]), 0);
      const perfect = correctCount===groundTruth.length;
      const elapsed = t0? Math.round(performance.now()-t0): null;

      if(perfect){ score+=1; els.score.textContent=score; }
      stopTimer();

      const row = {
        ts: timeNow(), trial, n: groundTruth.length, distractors: distractorPool.length,
        perfect, correctCount, elapsedMs: elapsed, groundTruth: groundTruth.join('|'), attempt: attempt.join('|')
      };
      logs.push(row);
      els.log.textContent = [
        `#${row.trial} ‚Äî ${perfect? 'PERFECT ‚úÖ' : 'Partial'}; ${correctCount}/${groundTruth.length} in ${fmt(elapsed)}`,
        `Truth: ${row.groundTruth}`,
        `You:   ${row.attempt}`,
        '',
        ...els.log.textContent.split('\n')
      ].join('\n');

      els.feedback.textContent = perfect ? 'Great! Exact match. Start another trial when ready.' : 'Not quite. You can adjust and resubmit or start a new trial.';
    }
    function resetAll(){
      cancelAllSpeech();
      stopTimer(); t0=null; els.timer.textContent='00:00';
      groundTruth=[]; currentList=[]; distractorPool=[]; clearBoards();
      els.feedback.textContent=''; disableBoards(false);
    }
    function toCsv(rows){
      const cols = ['ts','trial','n','distractors','perfect','correctCount','elapsedMs','groundTruth','attempt'];
      const head = cols.join(',');
      const body = rows.map(r=> cols.map(k=>`"${String(r[k]).replaceAll('"','""')}"`).join(',')).join('\n');
      return head+'\n'+body;
    }

    // ====== Wiring ======
    els.start.addEventListener('click', ()=>{ resetAll(); startTrial(); });
    els.stopSpeak.addEventListener('click', cancelAllSpeech);
    els.reset.addEventListener('click', resetAll);
    els.submit.addEventListener('click', grade);
    els.clearSeq.addEventListener('click', ()=>{ if(els.seq.classList.contains('disabled')) return; els.seq.innerHTML=''; });
    els.pool.addEventListener('click', e=>{ if(els.pool.classList.contains('disabled')) return; const p=e.target.closest('.pill'); if(!p) return; els.seq.appendChild(p); });
    els.seq.addEventListener('click', e=>{ if(els.seq.classList.contains('disabled')) return; const p=e.target.closest('.pill'); if(!p) return; els.pool.appendChild(p); });
    els.hearing.addEventListener('click', ()=>{ if(synth) speak('This is a short audio check. One, two, three.'); });
    document.addEventListener('visibilitychange', ()=>{ if(document.hidden) cancelAllSpeech(); });

    document.getElementById('downloadCsv').addEventListener('click', ()=>{
      if(!logs.length){ alert('No data yet. Run at least one trial.'); return; }
      const csv = (window.__augmentCSV ? window.__augmentCSV(toCsv(logs)) : toCsv(logs));
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`audio-errand-planner_logs_${Date.now()}.csv`;
      a.click(); URL.revokeObjectURL(url);
    });

    document.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && e.target.classList?.contains('pill')){
        if(els.seq.classList.contains('disabled') || els.pool.classList.contains('disabled')) return;
        const p=e.target;
        const inSeq = p.parentElement===els.seq; (inSeq?els.pool:els.seq).appendChild(p);
      }
    });
  })();
  </script>
</body>
</html>
