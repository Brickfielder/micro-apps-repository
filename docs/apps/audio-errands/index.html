<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Audio Errands</title>

  <!-- Shared assets (absolute paths for GitHub Pages project site) -->
  <link rel="stylesheet" href="/micro-apps-repository/shared/theme.css"/>
  <meta name="theme" content="bold dense"/>
  <meta name="app-slug" content="audio-errands"/>
  <script defer src="/micro-apps-repository/shared/frame.js"></script>
  <script defer src="/micro-apps-repository/shared/clinician_feedback.js"></script>

  <!-- App-scoped styles -->
  <style>
    #load-check{font:12px/1.4 system-ui;color:#555;margin:6px 0}
    #app-root .status{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    #app-root .status .dot{width:10px;height:10px;border-radius:50%}
    #app-root .hint{color:var(--muted);font-size:14px}

    #app-root .layout{display:grid;grid-template-columns:1fr 320px;gap:16px}
    @media (max-width:900px){#app-root .layout{grid-template-columns:1fr}}

    #app-root .card{background:var(--surface);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:16px}
    #app-root .card h2{margin:0 0 8px;font-size:18px}

    #app-root .controls{display:grid;gap:12px;margin:8px 0 12px}
    #app-root .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    #app-root label{font-size:14px;color:var(--muted)}

    #app-root .boards{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px}
    @media (max-width:700px){#app-root .boards{grid-template-columns:1fr}}
    #app-root .board{min-height:120px;padding:12px;border-radius:12px;border:1px dashed var(--line);
      background: color-mix(in oklab, var(--surface), var(--bg) 6%)}
    #app-root .board h3{margin:0 0 8px;font-size:14px;color:var(--muted)}
    #app-root .drop{min-height:52px;display:flex;gap:8px;flex-wrap:wrap}

    #app-root .pill{display:inline-flex;gap:8px;align-items:center;user-select:none;padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);background:var(--surface)}
    #app-root .pill[draggable="true"]{cursor:grab}
    #app-root .pill.dragging{opacity:.6}
    #app-root .disabled{opacity:.4;pointer-events:none}

    #app-root .log{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;white-space:pre-wrap;
      background: color-mix(in oklab, var(--surface), var(--bg) 6%);border:1px solid var(--line);
      border-radius:12px;padding:10px;max-height:220px;overflow:auto}

    #app-root .overlay{position:fixed;inset:0;display:none;place-items:center;background:#0009;backdrop-filter:blur(2px);z-index:20}
    #app-root .overlay.show{display:grid}
    #app-root .count{font-size:clamp(48px,8vw,96px);font-weight:700;color:#e5edff}
    #app-root .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* Local clinician notes card (works even if external script doesn't inject one) */
    #app-root .note-card{margin-top:16px;padding:12px;border:1px solid var(--line);border-radius:12px;background:var(--surface)}
    #app-root .note-card textarea{width:100%;min-height:70px;border:1px solid var(--line);border-radius:8px;padding:8px}
  </style>
</head>
<body>
  <div id="load-check">Loading‚Ä¶</div>
  <main id="app-root">
    <!-- frame.js injects the hero above -->

    <!-- Status chips to confirm shared assets -->
    <div class="status" aria-live="polite">
      <span class="dot" id="audioDot" style="background:#999"></span>
      <span id="audioStatus">Speech: initializing‚Ä¶</span>
      <span id="themeStatus" class="hint">theme: ?</span>
      <span id="frameStatus" class="hint">frame: ?</span>
      <span id="clinStatus" class="hint">clinician: ?</span>
    </div>

    <div class="layout">
      <!-- Left: main -->
      <section class="card" aria-labelledby="briefingTitle">
        <h2 id="briefingTitle">Briefing</h2>
        <p class="hint">Listen to the errands in order. When playback ends, arrange the items to match the same order, then submit.</p>

        <div class="controls">
          <div class="row">
            <label for="difficulty">Difficulty (items):</label>
            <select id="difficulty" aria-label="Difficulty">
              <option value="3">3</option>
              <option value="4" selected>4</option>
              <option value="5">5</option>
              <option value="6">6</option>
            </select>

            <label for="interrupts">Auditory interruptions:</label>
            <select id="interrupts" aria-label="Interruptions">
              <option value="none" selected>None</option>
              <option value="one">One</option>
              <option value="random">Random</option>
            </select>

            <label for="distractors">Distractors shown:</label>
            <select id="distractors" aria-label="Distractors">
              <option value="0" selected>0</option>
              <option value="2">2</option>
              <option value="4">4</option>
            </select>
          </div>

          <div class="row">
            <label for="voiceSel">Voice (en-GB preferred):</label>
            <select id="voiceSel" aria-label="Voice"></select>

            <label for="rate">Rate:</label>
            <input id="rate" type="range" min="0.9" max="1.2" step="0.05" value="1"/>
            <button id="hearingTest" class="button" type="button">Hearing check üîä</button>
          </div>

          <div class="row">
            <button id="start" class="button primary" type="button">Start trial ‚ñ∂Ô∏è</button>
            <button id="stopSpeak" class="button warn" type="button">Stop audio ‚èπÔ∏è</button>
            <button id="reset" class="button" type="button">Reset</button>
          </div>
        </div>

        <div class="boards">
          <div class="board">
            <h3>Available items</h3>
            <div id="pool" class="drop" aria-label="Item pool"></div>
          </div>
          <div class="board">
            <h3>Your sequence</h3>
            <div id="sequence" class="drop" aria-label="Your sequence"></div>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="submit" class="button ok" type="button">Submit ‚úÖ</button>
          <button id="clearSeq" class="button" type="button">Clear sequence</button>
          <div id="feedback" class="hint" aria-live="polite"></div>
        </div>

        <!-- Local clinician notes (CSV includes this even if external script missing) -->
        <div class="note-card">
          <label for="clinNote"><strong>Clinician notes</strong></label>
          <textarea id="clinNote" placeholder="Observations about strategy, distractibility, supports needed‚Ä¶"></textarea>
        </div>
      </section>

      <!-- Right: session -->
      <aside class="card" aria-labelledby="sessionTitle">
        <h2 id="sessionTitle">Session</h2>
        <div class="row">
          <div>Trials: <strong id="trialNum">0</strong></div>
          <div>Score: <strong id="score">0</strong></div>
          <div>Time: <strong id="timer">00:00</strong></div>
        </div>
        <div style="margin:12px 0">
          <button id="downloadCsv" class="button" type="button">Download CSV ‚¨áÔ∏è</button>
        </div>
        <div id="log" class="log" aria-label="Log"></div>
      </aside>
    </div>

    <!-- Countdown -->
    <div id="overlay" class="overlay" aria-hidden="true">
      <div id="count" class="count">3</div>
      <span id="overlaySr" class="sr-only">Trial starts soon</span>
    </div>
  </main>

  <script>
  (function(){
    // --- Loader diagnostics
    const cssVar = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();
    document.getElementById('themeStatus').textContent = 'theme: ' + (cssVar('--text') ? 'ok' : 'MISSING');
    document.getElementById('frameStatus').textContent = 'frame: ' + (window.__frameReady ? 'ok' : 'pending');
    document.getElementById('clinStatus').textContent  = 'clinician: ' + (window.__augmentCSV ? 'ok' : 'fallback');
    document.getElementById('load-check').textContent = 'Loaded';

    // ----- Constants & State -----
    const MASTER = [
      'Bakery','Post office','Pharmacy','Supermarket','Library','Bank','Hardware store',
      'Butcher','Greengrocer','Stationery shop','Dry cleaner','Pet shop','Newsagent',
      'Clinic','School','Gym','Cafe','Florist','Electronics store','Bookshop'
    ];
    let groundTruth = [], distractorPool = [], trial = 0, score = 0, t0 = null, tick = null, logs = [];

    const $ = id => document.getElementById(id);
    function setDot(color){
      const val = color.startsWith('--') ? (getComputedStyle(document.documentElement).getPropertyValue(color) || '#999') : color;
      $('audioDot').style.background = (val || '#999').trim();
    }

    // ----- Speech (en-GB preferred) -----
    const synth = 'speechSynthesis' in window ? window.speechSynthesis : null;
    function enGbVoices(){
      if(!synth) return [];
      const vs = synth.getVoices();
      const gb = vs.filter(v => /en-GB/i.test(v.lang));
      if(gb.length) return gb;
      const en = vs.filter(v => /^en-/i.test(v.lang));
      return en.length ? en : vs;
    }
    function populateVoices(){
      if(!synth) return;
      const vs = enGbVoices();
      const sel = $('voiceSel'); sel.innerHTML='';
      vs.forEach((v,i)=>{
        const o=document.createElement('option');
        o.value=i; o.textContent=`${v.name} ‚Äî ${v.lang}${v.default?' (default)':''}`;
        sel.appendChild(o);
      });
    }
    function updateSpeechStatus(){
      if(!synth){ $('audioStatus').textContent='Speech: unavailable'; setDot('--danger'); return; }
      const vs = synth.getVoices();
      if(vs && vs.length){ populateVoices(); $('audioStatus').textContent='Speech: ready (en-GB filtered)'; setDot('--success'); }
      else { $('audioStatus').textContent='Speech: loading voices‚Ä¶'; setDot('--warning'); }
    }
    if(synth){
      function refreshVoices(attempt=0){
        updateSpeechStatus();
        if(!synth.getVoices().length && attempt < 10) setTimeout(()=>refreshVoices(attempt+1), 200);
      }
      synth.onvoiceschanged = ()=>refreshVoices();
      refreshVoices();
    } else { updateSpeechStatus(); }

    function speak(text,{queue=false}={}){
      if(!synth) return Promise.resolve();
      return new Promise(res=>{
        if(!queue) synth.cancel();
        const list = enGbVoices();
        const u = new SpeechSynthesisUtterance(text);
        const idx = Math.min(parseInt(($('voiceSel')?.value)||0,10), Math.max(0,list.length-1));
        if(list[idx]) u.voice=list[idx];
        u.rate = parseFloat(($('rate')?.value)||1);
        u.onend=res; synth.speak(u);
      });
    }
    function beep(){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)();
      const o=ctx.createOscillator(), g=ctx.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=0.1;
      o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>{o.stop();ctx.close()},250);}catch(e){} }

    // ----- Helpers -----
    const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};
    const sample=(arr,n)=>shuffle(arr.slice()).slice(0,n);
    const fmt=ms=>{const s=Math.floor(ms/1000), m=Math.floor(s/60), r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`};

    function startTimer(){ t0=performance.now(); tick=setInterval(()=>{ $('timer').textContent=fmt(performance.now()-t0); },200); }
    function stopTimer(){ if(tick){ clearInterval(tick); tick=null; } }
    function clearBoards(){ $('pool').innerHTML=''; $('sequence').innerHTML=''; }
    function disableBoards(x){ ['pool','sequence'].forEach(id=> $(id).classList.toggle('disabled', !!x)); }

    function mkPill(label){
      const d=document.createElement('div'); d.className='pill'; d.draggable=true; d.dataset.item=label; d.tabIndex=0; d.textContent=label; return d;
    }
    // drag & drop
    (function makeDnD(){
      let dragging=null;
      document.addEventListener('dragstart', e=>{
        const t=e.target.closest('.pill'); if(!t) return;
        if($('pool').classList.contains('disabled')){ e.preventDefault(); return; }
        dragging=t; t.classList.add('dragging'); e.dataTransfer.effectAllowed='move';
      });
      document.addEventListener('dragend', ()=>{ if(dragging){ dragging.classList.remove('dragging'); dragging=null; }});
      ;['pool','sequence'].forEach(id=>{
        $(id).addEventListener('dragover', e=>{
          if($(id).classList.contains('disabled')) return;
          e.preventDefault();
          const after = getAfter($(id), e.clientY);
          const d = document.querySelector('.pill.dragging'); if(!d) return;
          after ? $(id).insertBefore(d, after) : $(id).appendChild(d);
        });
      });
      function getAfter(container,y){
        const els=[...container.querySelectorAll('.pill:not(.dragging)')];
        return els.reduce((closest,child)=>{
          const box=child.getBoundingClientRect();
          const offset=y - (box.top + box.height/2);
          return (offset<0 && offset>closest.offset) ? {offset, element:child} : closest;
        }, {offset:-Infinity}).element;
      }
    })();

    // ----- Trial flow -----
    async function runCountdown(n=3){
      $('overlay').classList.add('show'); $('overlay').setAttribute('aria-hidden','false');
      for(let i=n;i>0;i--){ $('count').textContent=i; await new Promise(r=>setTimeout(r,750)); }
      $('overlay').classList.remove('show'); $('overlay').setAttribute('aria-hidden','true');
    }
    function buildTrial(){
      const n=parseInt($('difficulty').value,10);
      groundTruth=sample(MASTER,n);
      const dnum=parseInt($('distractors').value,10);
      const leftovers=MASTER.filter(x=>!groundTruth.includes(x));
      distractorPool=sample(leftovers,dnum);
      const currentList=shuffle([...groundTruth,...distractorPool]);
      clearBoards(); currentList.forEach(item=> $('pool').appendChild(mkPill(item)));
    }
    async function playSequence(){
      if(synth){ await speak('Listen carefully to the list of errands in order.'); }
      for(let i=0;i<groundTruth.length;i++){
        if(synth){ await speak(`${i+1}. ${groundTruth[i]}`, {queue:true}); }
        const intr=$('interrupts').value;
        if(intr!=='none' && Math.random() < (intr==='one' ? (i===Math.floor(groundTruth.length/2)?1:0) : 0.35)){
          if(synth) await speak('Attention: remember to focus.', {queue:true});
        }
      }
      if(synth){ await speak('Now arrange the items in the same order, then press submit.', {queue:true}); }
      disableBoards(false);
    }
    function grade(){
      const attempt=[...$('sequence').querySelectorAll('.pill')].map(p=>p.dataset.item);
      if(attempt.length!==groundTruth.length){ $('feedback').textContent='Sequence incomplete: drag all required items, then submit.'; return; }
      const correctCount=attempt.reduce((a,x,i)=>a+(x===groundTruth[i]?1:0),0);
      const perfect=correctCount===groundTruth.length;
      const elapsed=t0?Math.round(performance.now()-t0):null;
      if(perfect){ score+=1; $('score').textContent=score; }
      stopTimer();
      const row={
        ts:new Date().toISOString(), trial,
        n:groundTruth.length, distractors:distractorPool.length,
        perfect, correctCount, elapsedMs:elapsed,
        groundTruth:groundTruth.join('|'), attempt:attempt.join('|'),
        clinician_comment: ($('clinNote')?.value||'').replaceAll('\n',' ')
      };
      logs.unshift(row);
      $('log').textContent=[
        `#${row.trial} ‚Äî ${perfect?'PERFECT ‚úÖ':'Partial'}; ${correctCount}/${groundTruth.length} in ${fmt(elapsed)}`,
        `Truth: ${row.groundTruth}`,
        `You:   ${row.attempt}`,
        row.clinician_comment?`Note:  ${row.clinician_comment}`:'',
        '',
        ...$('log').textContent.split('\n')
      ].join('\n');
      $('feedback').textContent = perfect ? 'Great! Exact match. Start another trial when ready.' : 'Not quite. You can adjust and resubmit or start a new trial.';
    }
    function toCsv(rows){
      const cols=['ts','trial','n','distractors','perfect','correctCount','elapsedMs','groundTruth','attempt','clinician_comment'];
      const head=cols.join(','); const body=rows.map(r=> cols.map(k=>`"${String(r[k]??'').replaceAll('"','""')}"`).join(',')).join('\n');
      return head+'\n'+body;
    }

    // ----- Robust wiring (survives frame.js DOM wrapping)
    let wired=false;
    function wireIfNeeded(){
      const startBtn=$('start'), submitBtn=$('submit');
      if(!startBtn || !submitBtn) return false;
      if(wired) return true;

      startBtn.addEventListener('click', async ()=>{
        // ensure voices list exists on mobile but don't block
        if(synth && !synth.getVoices().length){
          for(let i=0;i<8 && !synth.getVoices().length;i++) await new Promise(r=>setTimeout(r,200));
          updateSpeechStatus();
        }
        $('feedback').textContent=''; $('sequence').innerHTML='';
        trial+=1; $('trialNum').textContent=trial;
        buildTrial(); disableBoards(true);
        await runCountdown(3); startTimer(); await playSequence();
      });
      $('stopSpeak')?.addEventListener('click', ()=>{ if(synth) synth.cancel(); });
      $('reset')?.addEventListener('click', ()=>{ if(synth) synth.cancel(); stopTimer(); t0=null; $('timer').textContent='00:00';
        groundTruth=[]; distractorPool=[]; $('feedback').textContent=''; $('pool').innerHTML=''; $('sequence').innerHTML=''; disableBoards(false); });
      submitBtn.addEventListener('click', grade);
      $('clearSeq')?.addEventListener('click', ()=>{ if(!$('sequence').classList.contains('disabled')) $('sequence').innerHTML=''; });

      // Click-to-move + keyboard Enter toggle
      $('pool')?.addEventListener('click', e=>{ if($('pool').classList.contains('disabled')) return; const p=e.target.closest('.pill'); if(p) $('sequence').appendChild(p); });
      $('sequence')?.addEventListener('click', e=>{ if($('sequence').classList.contains('disabled')) return; const p=e.target.closest('.pill'); if(p) $('pool').appendChild(p); });
      document.addEventListener('keydown', e=>{
        if(e.key==='Enter' && e.target.classList?.contains('pill')){
          if($('sequence').classList.contains('disabled') || $('pool').classList.contains('disabled')) return;
          const p=e.target; const inSeq=(p.parentElement===$('sequence')); (inSeq?$('pool'):$('sequence')).appendChild(p);
        }
      });

      // Hearing check: beep + speech
      $('hearingTest')?.addEventListener('click', async ()=>{ beep(); if(synth){ 
        if(!synth.getVoices().length){ for(let i=0;i<10 && !synth.getVoices().length;i++) await new Promise(r=>setTimeout(r,200)); updateSpeechStatus(); }
        await speak('This is a short audio check. One, two, three.');
      }});

      // CSV download (use external augmenter if present)
      $('downloadCsv')?.addEventListener('click', ()=>{
        if(!logs.length){ alert('No data yet. Run at least one trial.'); return; }
        const baseCsv = toCsv(logs);
        const csv = (window.__augmentCSV ? window.__augmentCSV(baseCsv) : baseCsv);
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download=`audio-errands_logs_${Date.now()}.csv`; a.click(); URL.revokeObjectURL(url);
      });

      wired=true; return true;
    }

    // Try now; retry while frame.js sets up; then watch for future swaps
    (async function initWiring(){
      if(!wireIfNeeded()){ for(let i=0;i<20 && !wireIfNeeded(); i++) await new Promise(r=>setTimeout(r,100)); }
      const ro=new MutationObserver(()=>{ wired=false; wireIfNeeded(); });
      ro.observe(document.body, {subtree:true, childList:tr