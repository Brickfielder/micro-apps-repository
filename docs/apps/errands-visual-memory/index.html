<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <title>Errands Memory â€” Rehab Game</title>

  <!-- Shared assets from repo/docs/ published at site root -->
  <link rel="stylesheet" href="/micro-apps-repository/shared/theme.css?v=3">
  <script defer src="/micro-apps-repository/shared/frame.js?v=3"></script>
  <script defer src="/micro-apps-repository/shared/clinician_feedback.js?v=3"></script>

  <!-- Frame metadata -->
  <meta name="app-slug" content="errands-visual-memory">
  <meta name="app-title" content="Errands Memory â€” Rehab Game">
  <meta name="app-desc" content="Watch a sequence of shops light up, then click them in the same order (or in reverse). Simple, playful, and closer to real life than abstract blocks.">
  <meta name="theme" content="bold">

  <style>
    /* App-specific minimal CSS (theme handles the rest) */
    .toolbar{ justify-content:flex-start; }
    .status{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill.good{ background:#ecfdf5; color:#065f46; }

    .street-wrap{ position:relative; display:flex; align-items:center; justify-content:center; min-height:360px; }
    .street{ display:flex; gap:16px; flex-wrap:wrap; justify-content:center; }
    .shop{
      width:clamp(96px,18vw,128px); aspect-ratio:1/1.05; border-radius:16px;
      background:#f1f5f9; border:2px solid #e2e8f0;
      box-shadow: inset 0 -6px 10px rgba(0,0,0,.04);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding:10px; transition:transform .08s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .shop .emoji{ font-size:42px; line-height:1; margin-bottom:8px; }
    .shop .label{ font-weight:800; letter-spacing:.2px; }
    .shop:active{ transform:scale(.98); }
    .shop.disabled{ pointer-events:none; opacity:.6; }
    .shop.highlight{ border-color:var(--accent); box-shadow:0 0 0 6px color-mix(in oklab, var(--accent), white 82%), inset 0 -6px 10px rgba(0,0,0,.04); }
    .shop.correct{ border-color:#10b981; box-shadow:0 0 0 6px rgba(16,185,129,.18); }
    .shop.wrong{ border-color:#ef4444; box-shadow:0 0 0 6px rgba(239,68,68,.18); }

    .countdown-overlay{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; pointer-events:none; }
    .countdown-overlay.active{ display:flex; }
    .countdown-bubble{ background:rgba(17,24,39,.85); color:#fff; padding:26px 34px; border-radius:18px; box-shadow:var(--shadow); text-align:center }
    .countdown-label{ font-size:14px; color:#d1d5db; margin-bottom:6px; letter-spacing:.02em }
    .countdown-number{ font-size:clamp(38px,6vmin,72px); font-weight:900; letter-spacing:.02em }

    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0 }
  </style>
</head>
<body>

  <main id="app-root">
    <section class="grid cols-2">
      <!-- Left: Controls & status -->
      <div>
        <div class="toolbar" role="group" aria-label="Session controls">
          <button id="startBtn" class="button primary">Start session</button>
          <button id="pauseBtn" class="button" disabled>Pause</button>
          <button id="resetBtn" class="button">Reset</button>
          <button id="downloadBtn" class="button" disabled>Download CSV</button>
          <button id="demoBtn" class="button">Quick demo</button>
        </div>

        <div class="grid cols-2" style="margin-top:12px">
          <div>
            <label for="mode">Mode</label>
            <select id="mode">
              <option value="forward">Forward (standard)</option>
              <option value="backward">Backward (reverse order)</option>
            </select>
          </div>
          <div>
            <label for="shopCount">Shops shown</label>
            <select id="shopCount">
              <option value="8" selected>8</option>
              <option value="12">12</option>
              <option value="16">16</option>
            </select>
          </div>
          <div>
            <label for="startLen">Start sequence length</label>
            <input id="startLen" type="number" min="2" max="8" value="3">
          </div>
          <div>
            <label for="maxLen">Max sequence length</label>
            <input id="maxLen" type="number" min="3" max="12" value="8">
          </div>
          <div>
            <label for="onMs">Stimulus ON (ms)</label>
            <input id="onMs" type="number" min="200" max="2000" step="50" value="700">
          </div>
          <div>
            <label for="gapMs">Gap (ms)</label>
            <input id="gapMs" type="number" min="50" max="1500" step="50" value="350">
          </div>
          <div>
            <label for="trialsPerLen">Trials per length</label>
            <input id="trialsPerLen" type="number" min="1" max="5" value="1">
          </div>
          <div>
            <label for="failRule">Fail rule</label>
            <select id="failRule">
              <option value="2">Stop after 2 fails at same length</option>
              <option value="1">Stop after 1 fail at same length</option>
              <option value="3">Stop after 3 fails at same length</option>
            </select>
          </div>
        </div>

        <div class="status" id="status" style="margin-top:8px">
          <span class="pill">Length: <strong id="lenBadge" style="margin-left:6px">â€”</strong></span>
          <span class="pill" id="trialBadge">Trial: â€”</span>
          <span class="pill good" id="bestSpan">Best span: â€”</span>
        </div>
      </div>

      <!-- Right: Task area -->
      <div>
        <h2 style="margin:0 0 8px">Task area</h2>
        <p class="helper" style="margin-top:0">
          Focus on the shops. They will light up in order. Watch carefully, then click them in the same order
          (or in reverse if Backward mode is selected).
        </p>

        <div class="street-wrap">
          <div id="street" class="street" role="application" aria-label="Street of shops"></div>

          <div id="countdown" class="countdown-overlay" aria-live="assertive" aria-atomic="true">
            <div class="countdown-bubble" role="status">
              <div class="countdown-label">Get readyâ€¦</div>
              <div id="countdownNum" class="countdown-number">2</div>
            </div>
          </div>
          <span id="ariaStatus" class="sr-only"></span>
        </div>
      </div>
    </section>
    <!-- Clinician notes card injected automatically by clinician_feedback.js -->
  </main>

  <script>
    // ===== Data =====
    const ALL_SHOPS = [
      { key:'bakery', label:'Bakery', emoji:'ðŸ¥–' },
      { key:'pharmacy', label:'Pharmacy', emoji:'ðŸ’Š' },
      { key:'supermarket', label:'Supermarket', emoji:'ðŸ›’' },
      { key:'post', label:'Post Office', emoji:'ðŸ“®' },
      { key:'cafe', label:'CafÃ©', emoji:'â˜•' },
      { key:'shoes', label:'Shoe Shop', emoji:'ðŸ‘Ÿ' },
      { key:'books', label:'Bookshop', emoji:'ðŸ“š' },
      { key:'florist', label:'Florist', emoji:'ðŸŒ¸' },
      { key:'butcher', label:'Butcher', emoji:'ðŸ¥©' },
      { key:'greengrocer', label:'Greengrocer', emoji:'ðŸ¥¦' },
      { key:'fish', label:'Fishmonger', emoji:'ðŸŸ' },
      { key:'hardware', label:'Hardware', emoji:'ðŸ› ï¸' },
      { key:'electronics', label:'Electronics', emoji:'ðŸ“±' },
      { key:'bank', label:'Bank', emoji:'ðŸ¦' },
      { key:'cinema', label:'Cinema', emoji:'ðŸŽ¬' },
      { key:'toys', label:'Toy Shop', emoji:'ðŸ§¸' },
    ];
    let shops = [];

    // ===== Elements =====
    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));

    const streetEl = $('#street');
    const ariaStatus = $('#ariaStatus');
    const countdownEl = $('#countdown');
    const countdownNumEl = $('#countdownNum');

    const controls = {
      mode: $('#mode'),
      startLen: $('#startLen'),
      maxLen: $('#maxLen'),
      onMs: $('#onMs'),
      gapMs: $('#gapMs'),
      trialsPerLen: $('#trialsPerLen'),
      failRule: $('#failRule'),
      shopCount: $('#shopCount'),
      startBtn: $('#startBtn'),
      pauseBtn: $('#pauseBtn'),
      resetBtn: $('#resetBtn'),
      downloadBtn: $('#downloadBtn'),
      demoBtn: $('#demoBtn'),
    };

    const status = {
      lenBadge: $('#lenBadge'),
      trialBadge: $('#trialBadge'),
      bestSpan: $('#bestSpan'),
    };

    // ===== State =====
    let state = {
      running:false, paused:false, awaiting:false,
      seqLen:3, trialAtLen:0, failsAtLen:0, bestSpan:0,
      sequence:[], input:[], responseTimes:[], timestamps:[],
      sessionRows:[], sessionId:'E'+Math.random().toString(36).slice(2,8), mode:'forward'
    };

    // ===== Helpers =====
    function initStreet(){
      const count = parseInt(controls.shopCount?.value || '8', 10);
      shops = ALL_SHOPS.slice(0, Math.max(4, Math.min(count, ALL_SHOPS.length)));
      streetEl.innerHTML = '';
      shops.forEach((s,idx)=>{
        const btn = document.createElement('button');
        btn.className = 'shop';
        btn.setAttribute('data-idx', idx);
        btn.setAttribute('aria-label', s.label);
        btn.innerHTML = `<div class="emoji">${s.emoji}</div><div class="label">${s.label}</div>`;
        btn.addEventListener('click', onShopClick);
        streetEl.appendChild(btn);
      });
    }

    function sampleSequence(len, max){
      const arr = [...Array(max).keys()];
      for (let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
      return arr.slice(0,len);
    }

    function setShopsDisabled(v){ $$('.shop').forEach(b=>b.classList.toggle('disabled', v)); }

    function updateBadges(){
      status.lenBadge.textContent = state.seqLen;
      status.trialBadge.textContent = `Trial: ${state.trialAtLen+1}`;
      status.bestSpan.textContent = `Best span: ${state.bestSpan}`;
    }

    const sleep = ms => new Promise(r=>setTimeout(r, ms));

    async function showCountdown(seconds=2){
      countdownEl.classList.add('active');
      for(let s=seconds;s>=1;s--){
        countdownNumEl.textContent = s;
        await sleep(1000);
        if(!state.running) break;
        while(state.paused){ await sleep(100); }
      }
      countdownEl.classList.remove('active');
    }

    async function playSequence(){
      setShopsDisabled(true);
      state.awaiting=false; state.input=[]; state.responseTimes=[]; state.timestamps=[];
      const onMs = parseInt(controls.onMs.value,10);
      const gapMs = parseInt(controls.gapMs.value,10);
      const nodes = $$('.shop');
      ariaStatus.textContent = `Watch the sequence of ${state.sequence.length} shops`;
      for (let i=0;i<state.sequence.length;i++){
        while(state.paused){ await sleep(100); }
        const idx = state.sequence[i];
        nodes[idx].classList.add('highlight');
        state.timestamps.push(performance.now());
        await sleep(onMs);
        nodes[idx].classList.remove('highlight');
        await sleep(gapMs);
      }
      setShopsDisabled(false);
      state.awaiting=true; state.inputStart = performance.now();
      ariaStatus.textContent = 'Your turn. Click shops in order.';
    }

    async function runTrial(){
      $$('.shop').forEach(n=>n.classList.remove('highlight','correct','wrong'));
      updateBadges();
      state.sequence = sampleSequence(state.seqLen, shops.length);
      await showCountdown(2);
      await playSequence();
    }

    function onShopClick(e){
      if (!state.running || !state.awaiting) return;
      const idx = parseInt(e.currentTarget.getAttribute('data-idx'),10);
      const now = performance.now();
      const prev = state.input.length ? state.lastClickTs : state.inputStart;
      state.responseTimes.push(now - prev); state.lastClickTs = now;
      state.input.push(idx);
      e.currentTarget.classList.add('highlight');
      if (state.input.length >= state.sequence.length){ state.awaiting=false; evaluateResponse(); }
    }

    function evaluateResponse(){
      const presented = [...state.sequence];
      const expected = (state.mode==='forward') ? presented : [...presented].reverse();
      const isCorrect = expected.length === state.input.length && expected.every((v,i)=>v===state.input[i]);

      const nodes = $$('.shop');
      if (isCorrect){
        expected.forEach(i=>nodes[i].classList.add('correct'));
        state.bestSpan = Math.max(state.bestSpan, state.seqLen);
      } else {
        expected.forEach(i=>nodes[i].classList.add('highlight'));
        state.input.forEach((i,ix)=>{ if (expected[ix]!==i) nodes[i].classList.add('wrong'); });
      }
      updateBadges();

      // Row for CSV
      const row = {
        sessionId: state.sessionId,
        timestamp: new Date().toISOString(),
        mode: state.mode,
        seqLen: state.seqLen,
        trial: state.trialAtLen+1,
        presented: presented.join('-'),
        expected: expected.join('-'),
        response: state.input.join('-'),
        correct: isCorrect?1:0,
        rt_first_ms: state.responseTimes[0] ?? '',
        rt_mean_ms: state.responseTimes.length ? Math.round(state.responseTimes.reduce((a,b)=>a+b,0)/state.responseTimes.length) : '',
        rt_total_ms: state.responseTimes.length ? Math.round(state.responseTimes.reduce((a,b)=>a+b,0)) : ''
      };
      state.sessionRows.push(row);

      // Progression / stopping rules
      const failCap = parseInt(controls.failRule.value,10);
      if (isCorrect){
        state.trialAtLen += 1; state.failsAtLen = 0;
        if (state.trialAtLen >= parseInt(controls.trialsPerLen.value,10)){
          state.seqLen += 1; state.trialAtLen = 0;
        }
      } else {
        state.failsAtLen += 1; state.trialAtLen += 1;
        if (state.failsAtLen >= failCap){ endSession(`Stopped after ${failCap} fail(s) at length ${state.seqLen}.`); return; }
      }

      if (state.seqLen > parseInt(controls.maxLen.value,10)) { endSession(`Reached max length ${controls.maxLen.value}.`); return; }

      setTimeout(()=>{ if (state.running) runTrial(); }, 850);
    }

    function startSession(demo=false){
      state.mode = controls.mode.value;
      state.seqLen = parseInt(controls.startLen.value,10);
      state.trialAtLen = 0; state.failsAtLen = 0; state.bestSpan = 0; state.sessionRows = [];
      state.running = true; state.paused=false;
      controls.pauseBtn.disabled=false; controls.downloadBtn.disabled=true; controls.startBtn.disabled=true;

      if (demo){
        controls.mode.value='forward'; state.mode='forward';
        controls.startLen.value=3; controls.maxLen.value=4; controls.trialsPerLen.value=1;
        controls.onMs.value=600; controls.gapMs.value=250; state.seqLen=3;
      }
      runTrial();
    }

    function endSession(){
      state.running=false; state.awaiting=false;
      controls.pauseBtn.disabled=true; controls.downloadBtn.disabled=false; controls.startBtn.disabled=false;
      setShopsDisabled(false);
    }

    function resetAll(){
      state.running=false; state.awaiting=false; state.sessionRows=[];
      controls.pauseBtn.disabled=true; controls.downloadBtn.disabled=true; controls.startBtn.disabled=false;
      state.bestSpan=0; state.seqLen=parseInt(controls.startLen.value,10); state.trialAtLen=0; state.failsAtLen=0;
      $$('.shop').forEach(n=>n.classList.remove('highlight','correct','wrong','disabled'));
      updateBadges();
    }

    function togglePause(){
      if(!state.running) return;
      state.paused = !state.paused;
      controls.pauseBtn.textContent = state.paused ? 'Resume' : 'Pause';
    }

    function toCSV(rows){
      const headers=['sessionId','timestamp','mode','seqLen','trial','presented','expected','response','correct','rt_first_ms','rt_mean_ms','rt_total_ms'];
      const lines=[headers.join(',')];
      for(const r of rows){
        const vals=headers.map(h=>String(r[h]??'').replace(/,/g,';'));
        lines.push(vals.join(','));
      }
      return lines.join('\n');
    }

    // DOM-attached anchor so clinician_feedback.js can augment the CSV before save
    function downloadCSV(){
      if(!state.sessionRows.length){ alert('No data to download yet.'); return; }
      const csv=toCSV(state.sessionRows);
      const blob=new Blob([csv],{type:'text/csv'});
      const a=document.createElement('a');
      const fn=`errands_memory_${state.sessionId}.csv`;
      a.href=URL.createObjectURL(blob);
      a.download=fn;
      a.style.display='none';
      document.body.appendChild(a);
      a.click(); // clinician_feedback.js intercepts, augments, and re-clicks
      setTimeout(()=>{
        URL.revokeObjectURL(a.href);
        a.remove();
      }, 1500);
    }

    // Wire up
    controls.startBtn.addEventListener('click',()=>startSession(false));
    controls.demoBtn.addEventListener('click',()=>startSession(true));
    controls.resetBtn.addEventListener('click',resetAll);
    controls.pauseBtn.addEventListener('click',togglePause);
    controls.downloadBtn.addEventListener('click',downloadCSV);
    if (controls.shopCount){
      controls.shopCount.addEventListener('change', ()=>{ if (!state.running){ initStreet(); } });
    }

    // Init
    initStreet();
    updateBadges();
  </script>
</body>
</html>
