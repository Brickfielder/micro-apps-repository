<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Word Scavenge — USN rehab (no pause)</title>

  <!-- Tailwind utilities -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Micro-Apps shared assets -->
  <link rel="stylesheet" href="../shared/css/theme.css?v=3">
  <script defer src="../shared/js/frame.js?v=3"></script>
  <script defer src="../shared/js/clinician_feedback.js?v=3"></script>

  <meta name="app-slug" content="word-scavenger">
  <meta name="app-title" content="Word Scavenge — USN rehab">
  <meta name="app-desc" content="Left-first matching with a mandatory red anchor stripe to encourage scanning. CSV logs persist locally.">

  <style>
    @keyframes wiggle {0%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}100%{transform:translateX(0)}}
    .wiggle { animation: wiggle .22s ease-in-out; }
    .anchor-stripe {
      width:44px;background:#ef4444;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;writing-mode:vertical-rl;text-orientation:mixed;user-select:none;
    }
    .anchor-stripe.sticky { position: sticky; top: 7rem; border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,.15); }
  </style>
</head>
<body>
  <main id="app-root">
    <!-- Toolbar -->
    <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border border-slate-200 rounded-xl px-4 py-3">
      <div class="max-w-6xl mx-auto flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-slate-900 text-white grid place-content-center font-bold">WS</div>
          <div>
            <div class="text-xl font-semibold">Word Scavenge</div>
            <div class="text-xs text-slate-500">Tap the <span class="text-red-600 font-semibold">left red anchor stripe</span>, then match left → right</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="helpBtn" class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100 text-sm">Show help</button>
          <button id="settingsBtn" class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100 text-sm">Show settings</button>
          <button id="newBtn" class="px-3 py-2 rounded-xl text-sm bg-slate-900 text-white shadow">New session</button>
        </div>
      </div>
    </header>

    <!-- Help (collapsed) -->
    <section id="help" class="hidden mt-4 mb-4 p-4 rounded-2xl bg-white border border-slate-200 shadow-sm">
      <div class="font-semibold mb-1">How it works</div>
      <ul class="list-disc ml-5 text-sm text-slate-600 space-y-1">
        <li>Before <em>every</em> match, the patient must tap the <span class="font-semibold text-red-600">red left anchor stripe</span>.</li>
        <li>Then select a word on the <span class="font-semibold">left</span>, and match it with the corresponding word on the right.</li>
        <li>Correct matches are <span class="font-semibold">locked in green on both sides</span>.</li>
        <li>Starting on the right is blocked and logged as a compliance event.</li>
        <li>Download a CSV log with all sessions stored locally.</li>
      </ul>
    </section>

    <!-- Settings (collapsed) -->
    <section id="settings" class="hidden mb-6 p-4 rounded-2xl bg-white border border-slate-200 shadow-sm grid md:grid-cols-2 gap-4">
      <div class="space-y-3">
        <label class="block text-sm">Word set</label>
        <select id="setSelect" class="w-full p-2 rounded-xl border border-slate-300"></select>

        <label class="block text-sm">Number of pairs: <span id="pairCountLab">8</span></label>
        <input id="pairCount" type="range" min="4" max="12" value="8" class="w-full"/>

        <div class="flex items-center gap-2">
          <input id="requireLeftStart" type="checkbox" checked>
          <label for="requireLeftStart" class="text-sm">Require left-start (recommended)</label>
        </div>

        <div class="flex items-center gap-2">
          <input id="requireAnchor" type="checkbox" checked>
          <label for="requireAnchor" class="text-sm">Require red anchor before each match</label>
        </div>

        <div class="flex items-center gap-2">
          <input id="bigText" type="checkbox" checked>
          <label for="bigText" class="text-sm">Large text mode</label>
        </div>

        <div class="flex gap-2">
          <button id="downloadBtn" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm shadow">Download CSV log</button>
          <button id="clearBtn" class="px-3 py-2 rounded-xl bg-white text-slate-700 border border-slate-300 text-sm hover:bg-slate-50">Clear all data</button>
        </div>
      </div>

      <div class="space-y-3">
        <div class="flex items-center gap-2">
          <input id="useCustom" type="checkbox">
          <label for="useCustom" class="text-sm">Use custom list</label>
        </div>
        <textarea id="customPairs" class="w-full h-40 p-3 rounded-xl border border-slate-300 disabled:opacity-50 font-mono text-xs" placeholder="left,right&#10;cat,meow&#10;..." disabled></textarea>
        <div class="text-xs text-slate-500">Format: one pair per line, comma-separated. Left word appears on the left.</div>
      </div>
    </section>

    <!-- Stats (no Active Time) -->
    <section class="grid md:grid-cols-4 gap-3 mb-4">
      <div class="rounded-2xl bg-white border border-slate-200 shadow-sm p-3"><div class="text-xs text-slate-500">Solved</div><div id="statSolved" class="text-xl font-semibold">0/0</div></div>
      <div class="rounded-2xl bg-white border border-slate-200 shadow-sm p-3"><div class="text-xs text-slate-500">Accuracy</div><div id="statAcc" class="text-xl font-semibold">0%</div></div>
      <div class="rounded-2xl bg-white border border-slate-200 shadow-sm p-3"><div class="text-xs text-slate-500">Errors</div><div id="statErr" class="text-xl font-semibold">0</div></div>
      <div class="rounded-2xl bg-white border border-slate-200 shadow-sm p-3"><div class="text-xs text-slate-500">Right-first attempts</div><div id="statRFA" class="text-xl font-semibold">0</div></div>
    </section>

    <!-- Game area -->
    <section class="grid md:grid-cols-[auto,1fr,1fr] items-start gap-4">
      <!-- Left anchor stripe -->
      <div id="anchorBtn" class="anchor-stripe sticky">ANCHOR</div>

      <!-- Left column -->
      <div class="p-4 rounded-2xl bg-white border border-slate-200 shadow-sm">
        <div class="text-sm font-semibold mb-2">Left — start here</div>
        <div id="leftList" class="grid gap-2"></div>
      </div>

      <!-- Right column -->
      <div class="p-4 rounded-2xl bg-white border border-slate-200 shadow-sm">
        <div class="text-sm font-semibold mb-2">Right — find the match</div>
        <div id="rightList" class="grid gap-2"></div>
      </div>
    </section>

    <!-- Completion -->
    <section id="completeBanner" class="hidden mt-6 p-4 rounded-2xl bg-emerald-50 border border-emerald-200 text-emerald-900">
      <div class="font-semibold">Session complete</div>
      <div class="text-sm">Well done! Download the CSV log for your records, or start a new session.</div>
    </section>
  </main>

  <script>
    // ===== Word sets =====
    const SETS = {
      "Everyday pairs":[["dog","bark"],["rain","umbrella"],["key","lock"],["table","chair"],["tooth","brush"],["shoe","lace"],["phone","call"],["cake","birthday"],["door","handle"],["pen","write"],["light","switch"],["plant","water"]],
      "Opposites":[["hot","cold"],["up","down"],["day","night"],["open","closed"],["fast","slow"],["early","late"],["loud","quiet"],["full","empty"],["hard","soft"],["bright","dim"]],
      "Synonyms":[["happy","glad"],["quick","fast"],["angry","mad"],["small","little"],["smart","clever"],["large","big"],["silent","quiet"],["ill","sick"],["start","begin"],["finish","end"]],
      "Kitchen & home":[["knife","cut"],["pan","fry"],["broom","sweep"],["toaster","bread"],["kettle","boil"],["plate","dish"],["cup","tea"],["bin","rubbish"],["sink","wash"],["bed","sleep"]],
      "Games":[["chess","board"],["tennis","racket"],["football","goal"],["basketball","hoop"],["golf","club"],["baseball","bat"],["poker","cards"],["bowling","pins"],["video game","controller"],["hide-and-seek","count"]],
      "Jobs":[["doctor","hospital"],["teacher","classroom"],["chef","kitchen"],["pilot","airplane"],["farmer","field"],["nurse","patient"],["engineer","design"],["artist","paint"],["lawyer","court"],["firefighter","hose"]]
    };

    // ===== Persistence (sessions stored locally) =====
    const PERSIST_KEY = 'ws_persist_v2_no_pause';
    function loadPersist(){ try{ const j=localStorage.getItem(PERSIST_KEY); return j?JSON.parse(j):{sessions:[]}; }catch{ return {sessions:[]}; } }
    function savePersist(obj){ try{ localStorage.setItem(PERSIST_KEY, JSON.stringify(obj)); }catch{} }
    function clearPersist(){ try{ localStorage.removeItem(PERSIST_KEY); }catch{} }

    // ===== State =====
    let requireLeftStart = true;
    let requireAnchor = true;
    let bigText = true;
    let useCustom = false;
    let customPairsText = "left,right\ndog,bark\nkey,lock\nrain,umbrella\nshoe,lace\nphone,call\nlight,switch\nplant,water";
    let setName = "Everyday pairs";
    let pairCount = 8;

    let leftWords=[], rightWords=[], pairMap={};
    let solvedLefts = new Set(), solvedRights = new Set();
    let selectedLeft = null;
    let rightFirstAttempts = 0, errors = 0;

    // anchor + timing for latency metrics
    let anchorTapped = false;
    let anchorAtMs = 0;
    let sessionStart = Date.now();
    let currentTrial = null; // {left, leftAtMs, errors, anchorAtMs}
    let anchorReminders = 0;

    let persist = loadPersist();
    let currentSessionIdx = -1;
    const logs = [];

    // ===== Utils =====
    function shuffle(a){ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
    function beep(freq=520,duration=120){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination); o.start(); g.gain.setValueAtTime(0.2, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + duration/1000); setTimeout(()=>ctx.close(), duration+50);}catch{} }

    // ===== DOM =====
    const setSelect = document.getElementById('setSelect');
    const pairCountLab = document.getElementById('pairCountLab');
    const pairCountInp = document.getElementById('pairCount');
    const requireLeftStartInp = document.getElementById('requireLeftStart');
    const requireAnchorInp = document.getElementById('requireAnchor');
    const bigTextInp = document.getElementById('bigText');
    const useCustomInp = document.getElementById('useCustom');
    const customPairsTA = document.getElementById('customPairs');
    const downloadBtn = document.getElementById('downloadBtn');
    const clearBtn = document.getElementById('clearBtn');

    const leftList = document.getElementById('leftList');
    const rightList = document.getElementById('rightList');
    const statSolved = document.getElementById('statSolved');
    const statAcc = document.getElementById('statAcc');
    const statErr = document.getElementById('statErr');
    const statRFA = document.getElementById('statRFA');
    const completeBanner = document.getElementById('completeBanner');

    const anchorBtn = document.getElementById('anchorBtn');
    const help = document.getElementById('help');
    const helpBtn = document.getElementById('helpBtn');
    const settings = document.getElementById('settings');
    const settingsBtn = document.getElementById('settingsBtn');
    const newBtn = document.getElementById('newBtn');

    // ===== Init controls =====
    function initControls(){
      setSelect.innerHTML = Object.keys(SETS).map(k=>`<option>${k}</option>`).join('');
      setSelect.value = setName;
      pairCountInp.max = String(Math.max(4, SETS[setName].length));
      pairCountLab.textContent = String(pairCount);

      setSelect.addEventListener('change', ()=>{
        setName = setSelect.value;
        pairCountInp.max = String(Math.max(4, SETS[setName].length));
        if(pairCount > SETS[setName].length){ pairCount = SETS[setName].length; pairCountInp.value = pairCount; pairCountLab.textContent = String(pairCount); }
        newSession();
      });
      pairCountInp.addEventListener('input', ()=>{
        pairCount = parseInt(pairCountInp.value,10);
        pairCountLab.textContent = String(pairCount);
        newSession();
      });

      requireLeftStartInp.addEventListener('change', ()=> requireLeftStart = requireLeftStartInp.checked );
      requireAnchorInp.addEventListener('change', ()=> requireAnchor = requireAnchorInp.checked );
      bigTextInp.addEventListener('change', ()=>{ bigText = bigTextInp.checked; renderLists(); });

      useCustomInp.addEventListener('change', ()=>{ useCustom = useCustomInp.checked; customPairsTA.disabled = !useCustom; newSession(); });
      customPairsTA.addEventListener('input', ()=>{ customPairsText = customPairsTA.value; newSession(); });

      downloadBtn.addEventListener('click', downloadCSV);
      clearBtn.addEventListener('click', ()=>{ clearPersist(); persist = loadPersist(); currentSessionIdx = -1; newSession(); alert('All stored sessions cleared.'); });

      helpBtn.addEventListener('click', ()=>{ const hidden = help.classList.toggle('hidden'); helpBtn.textContent = hidden ? 'Show help' : 'Hide help'; });
      settingsBtn.addEventListener('click', ()=>{ const hidden = settings.classList.toggle('hidden'); settingsBtn.textContent = hidden ? 'Show settings' : 'Hide settings'; });

      newBtn.addEventListener('click', newSession);
    }

    // ===== Persistence helpers =====
    function finalizePersistSession(){
      if(currentSessionIdx < 0) return;
      const now = Date.now();
      const rec = persist.sessions[currentSessionIdx];
      rec.ended_at = now;
      rec.errors = errors;
      rec.right_first_attempts = rightFirstAttempts;
      rec.anchor_reminders = anchorReminders;
      rec.setName = setName; rec.pairCount = pairCount;
      savePersist(persist);
    }
    function beginPersistSession(){
      persist = loadPersist();
      const now = Date.now();
      const id = (crypto.randomUUID ? crypto.randomUUID() : ('s_'+now));
      const rec = { id, started_at: now, setName, pairCount, trials: [], errors: 0, right_first_attempts: 0, anchor_reminders: 0 };
      persist.sessions.push(rec);
      currentSessionIdx = persist.sessions.length - 1;
      savePersist(persist);
    }

    // ===== Session lifecycle =====
    function newSession(){
      finalizePersistSession();

      sessionStart = Date.now();
      solvedLefts = new Set(); solvedRights = new Set();
      selectedLeft = null; errors = 0; rightFirstAttempts = 0; anchorReminders = 0;
      logs.length = 0;
      anchorTapped = false; anchorAtMs = 0; currentTrial = null;

      const raw = useCustom
        ? customPairsText.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).map(l=>l.split(',').map(s=>s.trim())).filter(a=>a.length===2)
        : SETS[setName];
      const clipped = raw.slice(0, Math.min(pairCount, raw.length));
      const left = shuffle(clipped.map(p=>p[0]));
      const right = shuffle(clipped.map(p=>p[1]));
      const map = {}; clipped.forEach(([l,r])=> map[l]=r);
      leftWords = left; rightWords = right; pairMap = map;

      renderLists(); updateStats(); completeBanner.classList.add('hidden');
      beginPersistSession();
      setTimeout(adjustAnchorHeight, 0);
    }

    // ===== Render =====
    function makeWordBtn(text, side){
      const btn = document.createElement('button');
      btn.textContent = text;
      btn.className = ['text-left px-4 py-3 rounded-2xl border shadow-sm transition-transform', (bigText? 'text-xl':'text-base'), 'bg-white hover:bg-slate-50 border-slate-300'].join(' ');
      btn.dataset.word = text;
      btn.dataset.side = side;
      return btn;
    }

    function renderLists(){
      leftList.innerHTML=''; rightList.innerHTML='';
      leftWords.forEach(w=>{
        const b = makeWordBtn(w,'left');
        if(solvedLefts.has(w)) makeGreen(b);
        b.addEventListener('click', ()=>onLeftClick(w,b));
        leftList.appendChild(b);
      });
      rightWords.forEach(w=>{
        const b = makeWordBtn(w,'right');
        if(solvedRights.has(w)) makeGreen(b);
        b.addEventListener('click', ()=>onRightClick(w,b));
        rightList.appendChild(b);
      });
      adjustAnchorHeight();
    }

    function makeGreen(el){
      el.classList.remove('bg-white','hover:bg-slate-50','border-slate-300');
      el.classList.add('bg-emerald-500','text-white','border-emerald-600');
      el.disabled = true;
    }

    function highlightPair(left, right){
      [...leftList.children].forEach(el=>{ if(el.dataset.word===left){ makeGreen(el); }});
      [...rightList.children].forEach(el=>{ if(el.dataset.word===right){ makeGreen(el); }});
    }

    function onLeftClick(w, btn){
      if(requireAnchor && !anchorTapped){
        anchorReminders++;
        if(currentSessionIdx>=0){ persist.sessions[currentSessionIdx].anchor_reminders = anchorReminders; savePersist(persist); }
        anchorBtn.classList.add('wiggle','ring-4','ring-red-200');
        setTimeout(()=>anchorBtn.classList.remove('wiggle','ring-4','ring-red-200'),220);
        beep(360,120);
        return;
      }
      if(solvedLefts.has(w)) return;
      selectedLeft = w;
      [...leftList.children].forEach(el=> el.classList.remove('ring-2','ring-amber-500'));
      btn.classList.add('ring-2','ring-amber-500');
      const nowBase = Date.now() - sessionStart;
      currentTrial = { left:w, leftAtMs:nowBase, errors:0, anchorAtMs };
    }

    function onRightClick(w, btn){
      if(!selectedLeft){
        if(requireLeftStart){
          rightFirstAttempts++; statRFA.textContent = String(rightFirstAttempts);
          if(currentSessionIdx>=0){ persist.sessions[currentSessionIdx].right_first_attempts = rightFirstAttempts; savePersist(persist); }
          btn.classList.add('wiggle'); setTimeout(()=>btn.classList.remove('wiggle'),220); beep(360,120);
        }
        return;
      }
      const correct = pairMap[selectedLeft];
      const nowBase = Date.now() - sessionStart;
      if(w === correct){
        solvedLefts.add(selectedLeft); solvedRights.add(w);
        highlightPair(selectedLeft, w);
        [...leftList.children].forEach(el=> el.classList.remove('ring-2','ring-amber-500'));
        const row = {
          trial: logs.length+1,
          left: selectedLeft,
          rightChosen: w,
          correct: 1,
          errorsBeforeCorrect: currentTrial?.errors||0,
          anchorAtMs: currentTrial?.anchorAtMs||0,
          leftAtMs: currentTrial?.leftAtMs||0,
          rightAtMs: nowBase,
          anchorToLeftLatencyMs: Math.max(0, (currentTrial?.leftAtMs||0) - (currentTrial?.anchorAtMs||0)),
          leftToRightLatencyMs: Math.max(0, nowBase - (currentTrial?.leftAtMs||0))
        };
        logs.push(row);
        if(currentSessionIdx>=0){
          const rec = persist.sessions[currentSessionIdx];
          rec.trials.push(row);
          rec.errors = errors;
          rec.right_first_attempts = rightFirstAttempts;
          rec.anchor_reminders = anchorReminders;
          rec.pairCount = pairCount; rec.setName = setName;
          savePersist(persist);
        }
        selectedLeft = null; currentTrial = null; anchorTapped = false; anchorAtMs = 0;
        updateStats();
        checkComplete();
      } else {
        errors++; statErr.textContent = String(errors);
        if(currentSessionIdx>=0){ persist.sessions[currentSessionIdx].errors = errors; savePersist(persist); }
        if(currentTrial) currentTrial.errors = (currentTrial.errors||0) + 1;
        btn.classList.add('wiggle'); setTimeout(()=>btn.classList.remove('wiggle'),220); beep(260,140);
      }
    }

    function checkComplete(){
      const total = leftWords.length;
      if(solvedLefts.size === total && total>0){
        completeBanner.classList.remove('hidden');
      }
    }

    // Anchor stripe
    anchorBtn.addEventListener('click', ()=>{
      anchorTapped = true; anchorAtMs = Date.now() - sessionStart;
      anchorBtn.classList.add('ring-4','ring-red-200'); setTimeout(()=>anchorBtn.classList.remove('ring-4','ring-red-200'),200);
    });

    // Stats
    function updateStats(){
      const total = leftWords.length; const solved = solvedLefts.size;
      statSolved.textContent = `${solved}/${total}`;
      const attempts = solved + errors;
      statAcc.textContent = attempts ? `${Math.round((solved/attempts)*100)}%` : '0%';
      statErr.textContent = String(errors);
      statRFA.textContent = String(rightFirstAttempts);
    }

    // Anchor height to taller column
    function adjustAnchorHeight(){
      const leftCard = leftList.parentElement;
      const rightCard = rightList.parentElement;
      const h = Math.max(leftCard.offsetHeight, rightCard.offsetHeight);
      anchorBtn.style.height = h + 'px';
    }

    // CSV export (across all persisted sessions)
    function downloadCSV(){
      finalizePersistSession();
      persist = loadPersist();

      const trialsHeader = ['session_index','session_id','setName','pairCount','trial','left','rightChosen','correct','errorsBeforeCorrect','anchorAtMs','leftAtMs','rightAtMs','anchorToLeftLatencyMs','leftToRightLatencyMs'];
      const trialRows = [];
      (persist.sessions||[]).forEach((s,idx)=>{
        (s.trials||[]).forEach(t=>{
          trialRows.push([idx+1, s.id, s.setName||'', s.pairCount||'', t.trial||'', t.left||'', t.rightChosen||'', t.correct||0, t.errorsBeforeCorrect||0, t.anchorAtMs||0, t.leftAtMs||0, t.rightAtMs||0, t.anchorToLeftLatencyMs||0, t.leftToRightLatencyMs||0]);
        });
      });

      const sumHeader = ['session_index','session_id','setName','pairCount','errors','anchor_reminders','right_first_attempts'];
      const sumRows = (persist.sessions||[]).map((s,idx)=>[
        idx+1, s.id, s.setName||'', s.pairCount||'', s.errors||0, s.anchor_reminders||0, s.right_first_attempts||0
      ]);

      const csv = [
        ['TRIALS'], trialsHeader, ...trialRows,
        [], ['SUMMARY_PER_SESSION'], sumHeader, ...sumRows
      ].map(r=> Array.isArray(r) ? r.join(',') : r).join('\n');

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `word_scavenge_sessions_${new Date().toISOString().replace(/[:.]/g,'-')}.csv`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // Kick off
    function boot(){
      initControls();
      helpBtn.textContent = 'Show help';
      settingsBtn.textContent = 'Show settings';
      newSession();
    }
    boot();
  </script>
</body>
</html>
