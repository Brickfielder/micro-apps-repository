<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cash Point Coach — ATM Practice</title>

  <!-- Identify the app for the shared frame -->
  <meta name="app-slug" content="atm-practice">
  <meta name="app-title" content="Cash Point Coach">
  <meta name="app-desc" content="Practise ATM skills: insert card, enter PIN, choose withdrawal, check balance, handle insufficient funds.">
  <meta name="theme" content="bold">

  <!-- Shared assets (adjust the base path to your repo if needed) -->
  <link rel="stylesheet" href="/micro-apps-repository/shared/theme.css?v=3">
  <script defer src="/micro-apps-repository/shared/frame.js?v=3"></script>
  <script defer src="/micro-apps-repository/shared/clinician_feedback.js?v=3"></script>

  <style>
    :root{ --atm:#0f172a; --screen:#0b1220; --edge:#1f2937; --btn:#e5e7eb; --accent:#2563eb; --ok:#16a34a; --warn:#b45309; }
    body { background: var(--bg, #f7f8fb); }
    .app { max-width: 980px; margin: 0 auto; padding: 16px; display: grid; gap: 12px; }
    .row { display:grid; gap:12px; grid-template-columns: 1fr; }
    .controls { display:flex; flex-wrap:wrap; gap:8px; align-items:center }
    .select, .btn { appearance:none; border:1px solid #d1d5db; background:#fff; padding:10px 12px; border-radius:10px; cursor:pointer; font:inherit }
    .btn.primary{ background:var(--accent); color:#fff; border-color:transparent }
    .btn.ghost{ background:#f3f4f6 }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#eef2ff; border:1px solid #e5e7eb; font-size:14px }
    .atm { background:var(--atm); color:#e5e7eb; border-radius:16px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.15); }
    .atm-inner { display:grid; grid-template-columns: 1fr 300px; gap:16px; }
    .screen { background:var(--screen); border-radius:14px; padding:16px; min-height:240px; display:grid; grid-template-rows:auto 1fr auto; gap:12px; }
    .screen h3{ margin:0; color:#dbeafe }
    .screen .display{ background:#0c182e; border:1px solid #1f3a6d; border-radius:10px; padding:12px; color:#c7d2fe; min-height:100px }
    .keypad, .actions { display:grid; gap:10px }
    .keypad { grid-template-columns: repeat(3, 1fr); }
    .key { padding:16px 0; border-radius:12px; background:#111827; color:#e5e7eb; border:1px solid #374151; font-weight:600; font-size:18px; cursor:pointer }
    .key.wide { grid-column: span 3; }
    .actions .btn { width:100% }
    .status { display:flex; gap:8px; flex-wrap:wrap }
    .sr-only{ position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden }
    @media (max-width: 900px){
      .atm-inner{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- Hero & shared frame header are injected by frame.js using meta tags -->

    <!-- Quick session controls -->
    <div class="row card">
      <div class="controls">
        <button id="startSession" class="btn primary">Start session</button>
        <button id="speechTest" class="btn ghost">Test voice</button>
        <span class="pill">Ambience
          <select id="ambienceSelect" class="select" aria-label="Ambience">
            <option value="off">Off</option>
            <option value="cafe">Cafe</option>
            <option value="street">Street</option>
          </select>
        </span>
        <span class="pill">Volume
          <input id="ambVol" type="range" min="0" max="1" step="0.05" value="0.6" aria-label="Ambience volume">
        </span>
        <span class="pill" id="voiceName">Voice: <em>loading…</em></span>
      </div>
      <p class="muted">Tip: you can use either the on-screen buttons or your mouse to follow the steps. Spoken prompts will guide the sequence.</p>
    </div>

    <!-- ATM body -->
    <div class="atm">
      <div class="atm-inner">
        <section class="screen" aria-live="polite">
          <h3>ATM Screen</h3>
          <div id="display" class="display">Welcome. Press <strong>Start session</strong> to begin.</div>
          <div class="status">
            <span class="pill" id="scenarioPill">Scenario: Standard withdrawal</span>
            <span class="pill" id="balancePill">Balance: £250.00</span>
            <span class="pill" id="cashPill">Dispensed: £0</span>
          </div>
        </section>

        <aside>
          <div class="actions">
            <button class="btn" id="insertCardBtn">Insert card</button>
            <button class="btn" id="enterPinBtn" disabled>Enter PIN</button>
            <button class="btn" id="withdrawBtn" disabled>Withdraw cash</button>
            <button class="btn" id="balanceBtn" disabled>Show balance</button>
            <button class="btn" id="printBtn" disabled>Print receipt</button>
            <button class="btn" id="ejectBtn" disabled>Eject card</button>
          </div>
          <div style="height:12px"></div>
          <div class="keypad" aria-label="PIN keypad">
            <button class="key">1</button><button class="key">2</button><button class="key">3</button>
            <button class="key">4</button><button class="key">5</button><button class="key">6</button>
            <button class="key">7</button><button class="key">8</button><button class="key">9</button>
            <button class="key wide">0</button>
          </div>
        </aside>
      </div>
    </div>

    <!-- Clinician feedback (shared script will enhance this) -->
    <div class="card" data-clinician-feedback>
      <h3>Clinician notes</h3>
      <p class="muted">Use this space to note strategies, supports used, and any difficulties observed.</p>
      <textarea rows="4" style="width:100%; border:1px solid #e5e7eb; border-radius:12px; padding:10px"></textarea>
    </div>
  </div>

  <script>
  /* ========================
     Ambience (local files + safe fallback)
     Put MP3s at: apps/atm-practice/audio/ambient_cafe_loop.mp3 and ambient_street_loop.mp3
  =========================*/
  const ambience = {};
  const LOCAL = {
    cafe: './audio/ambient_cafe_loop.mp3',
    street: './audio/ambient_street_loop.mp3'
  };

  function makeAudio(src){
    try{
      const a = new Audio(src);
      a.loop = true; a.preload = 'auto'; a.crossOrigin = 'anonymous';
      return a;
    }catch(e){ return null; }
  }

  ambience.cafe = makeAudio(LOCAL.cafe);
  ambience.street = makeAudio(LOCAL.street);

  // Minimal pink-noise fallback (if files missing or blocked)
  let audioCtx=null, noiseNode=null, noiseGain=null;
  function startNoise(){
    if(audioCtx) return;
    const AC = window.AudioContext || window.webkitAudioContext;
    if(!AC) return;
    audioCtx = new AC();
    const bufferSize = 2 * audioCtx.sampleRate;
    const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const out = noiseBuffer.getChannelData(0);
    let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
    for(let i=0;i<bufferSize;i++){
      const white = Math.random()*2-1;
      b0 = 0.99886*b0 + white*0.0555179;
      b1 = 0.99332*b1 + white*0.0750759;
      b2 = 0.96900*b2 + white*0.1538520;
      b3 = 0.86650*b3 + white*0.3104856;
      b4 = 0.55000*b4 + white*0.5329522;
      b5 = -0.7616*b5 - white*0.0168980;
      out[i] = (b0+b1+b2+b3+b4+b5+b6 + white*0.5362)*0.02;
      b6 = white*0.115926;
    }
    noiseNode = audioCtx.createBufferSource();
    noiseNode.buffer = noiseBuffer;
    noiseNode.loop = true;
    noiseGain = audioCtx.createGain();
    noiseGain.gain.value = 0.2;
    noiseNode.connect(noiseGain).connect(audioCtx.destination);
    noiseNode.start();
  }
  function stopNoise(){
    try{ noiseNode?.stop(); }catch(e){}
    try{ noiseNode?.disconnect(); }catch(e){}
    noiseNode=null;
    try{ audioCtx?.close(); }catch(e){}
    audioCtx=null; noiseGain=null;
  }

  function setAmbienceVolume(v){
    try{
      Object.values(ambience).forEach(a => { if(a){ a.volume = v; }});
      if(noiseGain) noiseGain.gain.value = v * 0.35;
    }catch(e){}
  }
  function playAmbience(mode){
    Object.values(ambience).forEach(a => { if(a){ a.pause(); a.currentTime = 0; }});
    stopNoise();
    if(mode==='off') return;
    const a = ambience[mode];
    if(a){
      a.play().catch(()=>startNoise());
    }else{
      startNoise();
    }
  }

  // UI bindings for ambience
  document.addEventListener('DOMContentLoaded', ()=>{
    const sel = document.getElementById('ambienceSelect');
    const vol = document.getElementById('ambVol');
    sel.addEventListener('change', ()=> playAmbience(sel.value));
    vol.addEventListener('input', ()=> setAmbienceVolume(parseFloat(vol.value)));
    setAmbienceVolume(parseFloat(vol.value));
  });

  /* ========================
     Speech: Prefer Microsoft Lilly Online (Natural), with fallbacks
  =========================*/
  const LILLY_CANDIDATES = [
    "Microsoft Lilly Online (Natural) - English (United Kingdom)",
    "Microsoft Lilly Online (Natural) – English (United Kingdom)",
    "Lilly Online (Natural)", "Lilly"
  ];
  const NEAR_VARIANTS = [
    "Microsoft Libby Online (Natural) - English (United Kingdom)",
    "Libby Online (Natural)",
    "Microsoft Lily Online (Natural) - English (United Kingdom)",
    "Lily Online (Natural)"
  ];
  let SPEECH = { voice: null, ready:false };

  function pickBestVoice(){
    const voices = speechSynthesis.getVoices() || [];
    // exact Lilly first
    for(const n of LILLY_CANDIDATES){ const v = voices.find(x=>x.name===n); if(v) return v; }
    // near variants (en-GB preferred)
    const fuzzy = voices.find(v=>{
      const n=(v.name||"").toLowerCase(), g=(v.lang||"").toLowerCase().startsWith("en-gb");
      return g && (n.includes("lilly")||n.includes("libby")||n.includes("lily"));
    });
    if(fuzzy) return fuzzy;
    // Microsoft Online Natural en-GB
    const msGb = voices.find(v=>{
      const n=(v.name||"").toLowerCase(), g=(v.lang||"").toLowerCase().startsWith("en-gb");
      return g && n.includes("microsoft") && n.includes("online") && n.includes("natural");
    });
    if(msGb) return msGb;
    // any en-GB → any English → first
    return voices.find(v=>(v.lang||"").toLowerCase().startsWith("en-gb")) ||
           voices.find(v=>(v.lang||"").toLowerCase().startsWith("en")) ||
           voices[0] || null;
  }

  function waitForVoices(timeoutMs=4000){
    return new Promise(resolve=>{
      const t0=performance.now();
      const tick=()=>{
        const ok=(speechSynthesis.getVoices()||[]).length>0;
        if(ok || performance.now()-t0>timeoutMs) return resolve();
        setTimeout(tick,100);
      };
      speechSynthesis.onvoiceschanged = ()=> resolve();
      tick();
    });
  }

  async function initSpeech(){
    if(!('speechSynthesis' in window)) return;
    await waitForVoices();
    SPEECH.voice = pickBestVoice();
    SPEECH.ready = true;
    const vLabel = document.querySelector('#voiceName em');
    if(vLabel) vLabel.textContent = SPEECH.voice ? `${SPEECH.voice.name}` : 'system default';
  }
  initSpeech();

  function say(text, {rate=0.95, pitch=1.0, volume=1.0} = {}){
    if(!('speechSynthesis' in window)) return;
    const run=()=>{
      const u=new SpeechSynthesisUtterance(text);
      u.voice=SPEECH.voice||null;
      u.lang=(SPEECH.voice && SPEECH.voice.lang) || "en-GB";
      u.rate=rate; u.pitch=pitch; u.volume=volume;
      u.onstart=()=> setAmbienceVolume(0.15);
      const restore=()=> setAmbienceVolume(parseFloat(document.getElementById('ambVol').value));
      u.onend=restore; u.onerror=restore;
      speechSynthesis.speak(u);
    };
    if(SPEECH.ready) run(); else setTimeout(()=>{ if(!SPEECH.ready) initSpeech().then(run); else run(); }, 250);
  }

  // Quick test button
  document.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('speechTest')?.addEventListener('click', ()=>{
      console.log('Voices:', speechSynthesis.getVoices().map(v=>v.name));
      say("Speech is working. This is Lilly, your Cash Point Coach.");
    });
  });

  /* ========================
     Minimal ATM flow (demo)
  =========================*/
  const display = ()=> document.getElementById('display');
  const btn = id => document.getElementById(id);
  let state = { card:false, pinOk:false, balance:250, dispensed:0 };

  function refreshPills(){
    document.getElementById('balancePill').textContent = `Balance: £${state.balance.toFixed(2)}`;
    document.getElementById('cashPill').textContent = `Dispensed: £${state.dispensed}`;
  }
  function setButtons(){
    btn('enterPinBtn').disabled = !state.card;
    btn('withdrawBtn').disabled = !(state.card && state.pinOk);
    btn('balanceBtn').disabled = !state.card;
    btn('printBtn').disabled = !state.card;
    btn('ejectBtn').disabled = !state.card;
  }

  function startSession(){
    state = { card:false, pinOk:false, balance:250, dispensed:0 };
    refreshPills(); setButtons();
    display().innerHTML = "Welcome. Insert your card to begin.";
    say("Welcome to Cash Point Coach. When you are ready, insert your card.");
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    btn('startSession').addEventListener('click', ()=> startSession(), {once:false});

    btn('insertCardBtn').addEventListener('click', ()=>{
      state.card = true; setButtons();
      display().innerHTML = "Card detected. Please enter your four digit PIN using the keypad.";
      say("Card detected. Please enter your four digit PIN using the keypad.");
    });

    // Simple PIN capture (not secure; demo only)
    let pinBuffer = "";
    document.querySelectorAll('.keypad .key').forEach(k=>{
      k.addEventListener('click', ()=>{
        if(!state.card) return;
        if(pinBuffer.length>=4) return;
        pinBuffer += k.textContent.trim();
        display().innerHTML = `PIN: ${"•".repeat(pinBuffer.length)}${"&nbsp;".repeat(4-pinBuffer.length)}`;
        if(pinBuffer.length===4){
          setTimeout(()=>{
            state.pinOk = (pinBuffer === "1234"); // demo PIN
            pinBuffer = "";
            if(state.pinOk){
              display().innerHTML = "PIN accepted. Choose an option: Withdraw cash, Show balance, or Print receipt.";
              say("PIN accepted. Choose withdraw cash, show balance, or print receipt.");
              setButtons();
            } else {
              display().innerHTML = "PIN incorrect. Try again or eject your card.";
              say("The PIN is incorrect. Please try again, or eject your card.");
            }
          }, 200);
        }
      });
    });

    btn('enterPinBtn').addEventListener('click', ()=>{
      if(!state.card){ return; }
      display().innerHTML = "Enter your four digit PIN on the keypad.";
      say("Please enter your four digit PIN now.");
    });

    btn('withdrawBtn').addEventListener('click', ()=>{
      if(!(state.card && state.pinOk)) return;
      // Demo: attempt to withdraw £50, with insufficient funds branch at < £50
      if(state.balance < 50){
        display().innerHTML = "Insufficient funds for £50. Choose a smaller amount or check your balance.";
        say("Insufficient funds for fifty pounds. Choose a smaller amount or check your balance.");
        return;
      }
      state.balance -= 50; state.dispensed += 50; refreshPills();
      display().innerHTML = "Dispensing £50. Please take your cash. Would you like a receipt?";
      say("Dispensing fifty pounds. Please take your cash. Would you like a receipt?");
    });

    btn('balanceBtn').addEventListener('click', ()=>{
      if(!state.card) return;
      display().innerHTML = `Your available balance is £${state.balance.toFixed(2)}.`;
      say(`Your available balance is ${state.balance} pounds.`);
    });

    btn('printBtn').addEventListener('click', ()=>{
      if(!state.card) return;
      display().innerHTML = "Printing receipt. Would you like to perform another transaction, or eject your card?";
      say("Printing receipt. Would you like another transaction, or would you like to eject your card?");
    });

    btn('ejectBtn').addEventListener('click', ()=>{
      if(!state.card) return;
      display().innerHTML = "Please take your card. Thank you for using Cash Point Coach.";
      say("Please take your card. Thank you for using Cash Point Coach.");
      state.card=false; state.pinOk=false; setButtons();
    });

    // boot
    refreshPills(); setButtons();
    display().innerHTML = "Welcome. Press Start session to begin.";
  });
  </script>
</body>
</html>
