<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CashPoint Coach — ATM Practice</title>

  <!-- Micro-Apps shared assets -->
  <meta name="app-slug" content="cashpoint-coach"/>
  <meta name="app-title" content="CashPoint Coach — ATM Practice"/>
  <meta name="app-desc" content="Practice common ATM tasks with spoken instructions and per-card PINs."/>
  <meta name="theme" content="bold"/>

  <link rel="stylesheet" href="../shared/css/theme.css?v=3"/>
  <script defer src="../shared/js/frame.js?v=3"></script>
  <script defer src="../shared/js/clinician_feedback.js?v=3"></script>

  <style>
    :root{ color-scheme: light; }
    body{ margin:0; }
    #app-root{ display:flex; flex-direction:column; gap:14px; padding:16px; }
    .toolbar{ display:flex; flex-wrap:wrap; align-items:center; gap:10px; }
    .toolbar .group{ display:flex; align-items:center; gap:8px; }
    .toolbar select,.toolbar input[type="text"],.toolbar input[type="number"]{ min-height:36px; }

    /* ATM chrome */
    .atm-shell{ background:linear-gradient(180deg,#d5dae0,#c5ccd4); border:2px solid #b0b8c2; border-radius:18px; padding:20px; box-shadow:inset 0 2px 6px rgba(255,255,255,.6),0 10px 30px rgba(2,6,23,.15); max-width:760px; margin:0 auto; }
    .atm-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .atm-header .brand{ font-weight:700; font-size:1.1rem; letter-spacing:.1em; color:#1e293b; }
    .atm-header .cam{ width:28px; height:28px; background:radial-gradient(circle at 50% 50%,#1f2937 0,#0b1220 60%); border-radius:50%; position:relative; }
    .atm-header .cam::after{ content:""; position:absolute; top:8px; left:8px; width:12px; height:12px; border-radius:50%; background:radial-gradient(circle at 30% 30%,#3b82f6 0,#1d4ed8 70%); }
    .atm-header .grill{ flex:1; height:8px; margin-left:16px; background:repeating-linear-gradient(90deg,rgba(0,0,0,.2) 0 12px,rgba(255,255,255,.25) 12px 16px); border-radius:6px; opacity:.6; }

    .screen-bezel{ border-radius:12px; padding:12px; background:linear-gradient(180deg,#1e293b,#0f172a); box-shadow:inset 0 2px 12px rgba(0,0,0,.65); margin-bottom:16px; }
    .screen{ background:linear-gradient(180deg,#0d2338 0,#0a2034 100%); border:1px solid #10283f; border-radius:8px; min-height:200px; padding:14px; color:#e8f1ff; }
    .screen h2{ margin:0 0 8px 0; font-size:1.1rem; color:#93c5fd; }
    .screen .buttons{ margin-top:12px; display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; }
    .screen .buttons .button{ background:#eaf2ff; border:1px solid #cfe0ff; color:#0b253a; }

    .atm-lower{ display:grid; grid-template-columns:1fr 280px; gap:16px; }
    .keypad{ background:linear-gradient(180deg,#f8fafc,#f1f5f9); border:1px solid #cbd5e1; border-radius:12px; padding:14px; }
    .keys{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
    .keys .button{ padding:14px 0; font-size:1.1rem; border:1px solid #c7cfdb; background:linear-gradient(180deg,#f9fafb,#e5e7eb); box-shadow:inset 0 1px 0 rgba(255,255,255,.9); cursor:pointer; }
    .keys .fn-cancel{ background:linear-gradient(180deg,#fee2e2,#fecaca); border-color:#fca5a5; }
    .keys .fn-clear{ background:linear-gradient(180deg,#fef9c3,#fef08a); border-color:#facc15; }
    .keys .fn-enter{ background:linear-gradient(180deg,#dcfce7,#bbf7d0); border-color:#34d399; }

    .slots{ background:linear-gradient(180deg,#f8fafc,#f1f5f9); border:1px solid #cbd5e1; border-radius:12px; padding:14px; display:flex; flex-direction:column; gap:12px; }
    .slot{ background:linear-gradient(180deg,#0b1220,#0a0f1a); border:1px solid #101827; border-radius:8px; padding:10px; color:#f9fafb; cursor:pointer; }
    .slot .label{ display:block; font-weight:600; color:#f1f5f9; }
    .slot .cash,.slot .paper{ height:0; overflow:hidden; transition:height .3s ease; background:#fff; border:1px solid #cbd5e1; border-radius:6px; margin-top:6px; }

    .pill{ background:#eef2ff; border:1px solid #c7d2fe; border-radius:999px; padding:4px 10px; display:inline-flex; align-items:center; gap:8px; }
    .helper{ color:#6b7280; font-size:.95rem; }
    .badge{ background:#eef2ff; border:1px solid #c7d2fe; border-radius:8px; padding:4px 8px; font-size:.9rem; }

    @media (max-width:720px){ .atm-lower{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div id="app-root">
    <section class="toolbar">
      <div class="group">
        <label for="scenario">Scenario</label>
        <select id="scenario">
          <option value="withdraw20">Withdraw £20 — printed receipt</option>
          <option value="balance_screen">Check balance — on screen</option>
          <option value="topup10">Mobile top-up £10</option>
          <option value="change_pin">Change PIN</option>
        </select>
      </div>
      <div class="group">
        <label for="card">Card</label>
        <select id="card"></select>
        <span id="pinBadge" class="pill hidden"><span>PIN:</span> <strong id="pinText">0000</strong></span>
      </div>
      <div class="group">
        <label for="assist">Mode</label>
        <select id="assist">
          <option value="guided">Guided</option>
          <option value="standard" selected>Standard</option>
          <option value="assessment">Assessment</option>
        </select>
      </div>
      <div class="group">
        <label for="ambienceSel">Ambience</label>
        <select id="ambienceSel">
          <option value="off" selected>Off</option>
          <option value="cafe">Cafe (loop)</option>
          <option value="street">Street (loop)</option>
        </select>
        <label for="ambVol" class="sr">Volume</label>
        <input id="ambVol" type="range" min="0" max="1" step="0.05" value="0.35"/>
      </div>
      <div class="group">
        <label for="testCond">Test condition</label>
        <select id="testCond">
          <option value="normal" selected>Normal</option>
          <option value="insufficient">Insufficient funds</option>
        </select>
      </div>
      <div class="group">
        <button id="start" class="button primary" type="button">Start Task</button>
        <button id="reset" class="button" type="button">Reset</button>
        <button id="testVoice" class="button" type="button">Test voice</button>
        <span class="pill">Voice: <strong>en-GB (default)</strong></span>
        <a id="downloadCsv" class="button" href="#" download="cashpoint_results.csv">Export CSV</a>
      </div>
    </section>

    <section class="atm-shell">
      <div class="atm-header">
        <div class="brand">CASHPOINT</div>
        <div class="grill"></div>
        <div class="cam"></div>
      </div>
      <div class="screen-bezel">
        <div id="screen" class="screen" aria-live="polite" aria-atomic="true">
          <h2 id="screenTitle">Ready</h2>
          <div id="screenText" class="text">Choose a scenario and press <em>Start Task</em>.</div>
          <div id="screenButtons" class="buttons"></div>
        </div>
      </div>
      <div class="atm-lower">
        <div class="keypad">
          <div class="helper" id="pinEcho"></div>
          <div class="keys" id="keys"></div>
          <div class="helper">Use the keypad for PINs and amounts; then press <b>Enter</b>.</div>
        </div>
        <div class="slots">
          <div class="slot" id="slot-card"><span class="label">Card slot</span><div class="helper">Tap to insert/eject card</div></div>
          <div class="slot" id="slot-cash"><span class="label">Cash dispenser</span><div id="cashStack" class="cash"></div></div>
          <div class="slot" id="slot-receipt"><span class="label">Receipt slot</span><div id="receiptPaper" class="paper"></div></div>
        </div>
      </div>
    </section>

    <!-- (Clinician feedback panel auto-inserted by clinician_feedback.js) -->
  </div>

  <!-- ambience audio -->
  <audio id="amb-cafe" src="ambient_cafe_loop.mp3" preload="auto" loop></audio>
  <audio id="amb-street" src="ambient_street_loop.mp3" preload="auto" loop></audio>

  <script>
  /* ===== Minimal, robust en-GB speech (no named voice binding) ===== */
  var ttsEnabled = true, _ttsPrimed = false;
  function primeTTS(){
    if(_ttsPrimed) return; _ttsPrimed = true;
    try{ speechSynthesis.cancel(); }catch(_){}
    try{
      var u = new SpeechSynthesisUtterance(" ");
      u.lang = 'en-GB'; u.volume = 0; // inaudible primer
      speechSynthesis.speak(u);
      setTimeout(function(){ try{ speechSynthesis.cancel(); }catch(_){ } }, 60);
    }catch(_){}
  }
  function speak(text, flush){
    if(!ttsEnabled || !text) return;
    try{
      if(flush){ try{ speechSynthesis.cancel(); }catch(_){} }
      var u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-GB'; u.rate = 1; u.pitch = 1; u.volume = 1;
      try{ if(speechSynthesis.resume) speechSynthesis.resume(); }catch(_){}
      speechSynthesis.speak(u);
    }catch(_){}
  }
  ['click','keydown','touchstart'].forEach(function(evt){
    window.addEventListener(evt, primeTTS, { once:true, capture:true });
  });

  /* ===== Data ===== */
  var cards=[{id:'A',label:'Card A',pin:'5241'},{id:'B',label:'Card B',pin:'7309'},{id:'C',label:'Card C',pin:'1086'}];
  var scenarios={
    withdraw20:{id:'withdraw20',title:'Withdraw £20 — printed receipt',kind:'withdraw',amount:20,receipt:'printed'},
    balance_screen:{id:'balance_screen',title:'Check balance — on screen',kind:'balance',receipt:'screen'},
    topup10:{id:'topup10',title:'Mobile top-up £10',kind:'topup',amount:10},
    change_pin:{id:'change_pin',title:'Change PIN',kind:'change_pin'}
  };

  /* ===== State/els ===== */
  function el(id){ return document.getElementById(id); }
  var $scenario=el('scenario'), $card=el('card'), $assist=el('assist'), $pinBadge=el('pinBadge'), $pinText=el('pinText');
  var $screenTitle=el('screenTitle'), $screenText=el('screenText'), $screenButtons=el('screenButtons'), $pinEcho=el('pinEcho');
  var $ambSel=el('ambienceSel'), $ambVol=el('ambVol'), $testCond=el('testCond');
  var ambAudio={cafe:el('amb-cafe'), street:el('amb-street')};
  var $cashStack=el('cashStack'), $receiptPaper=el('receiptPaper');
  var KEYS=['1','2','3','4','5','6','7','8','9','Clear','0','Enter'];
  var run=null; var csvRows=[["timestamp_iso","participant_id","scenario_id","scenario_title","card_id","assist","success","pin_attempts","wrong_keys","t_total_ms","receipt","cash_dispensed","notes_auto","decline_reason"]];

  /* ===== UI bootstrap ===== */
  function bootstrap(){
    // Cards — ensure a default is selected
    for(var i=0;i<cards.length;i++){
      var c=cards[i]; var o=document.createElement('option'); o.value=c.id; o.textContent=c.label;
      if(i===0) o.selected = true;
      $card.appendChild(o);
    }
    if(!$card.value){ $card.value = cards[0].id; }

    // Keypad (explicit type="button")
    var $keys=el('keys');
    KEYS.forEach(function(k){
      var b=document.createElement('button');
      b.className='button';
      b.type='button';
      b.textContent=k;
      b.dataset.key=k;
      if(k==='Clear') b.classList.add('fn-clear');
      if(k==='Enter') b.classList.add('fn-enter');
      $keys.appendChild(b);
    });
    $keys.addEventListener('click', onKeypadClick);

    // Slots & controls
    el('slot-card').addEventListener('click', onCardSlot);
    el('slot-cash').addEventListener('click', onCashSlot);
    el('slot-receipt').addEventListener('click', onReceiptSlot);
    el('start').addEventListener('click', startScenario);
    el('reset').addEventListener('click', resetAll);
    el('downloadCsv').addEventListener('click', downloadCsv);
    el('testVoice').addEventListener('click', function(){ primeTTS(); speak('This is a test of the voice instructions.', true); });
    $ambVol.addEventListener('input', function(){ setAmbienceVolume(parseFloat($ambVol.value)); });
  }

  /* ===== Ambience ===== */
  function stopAllAmbience(){ [ambAudio.cafe, ambAudio.street].forEach(function(a){ try{ a.pause(); a.currentTime=0; }catch(_){} }); }
  function setAmbienceVolume(v){ [ambAudio.cafe,ambAudio.street].forEach(function(a){ if(a) a.volume=v; }); }
  function maybeStartAmbience(){ stopAllAmbience(); var sel=$ambSel.value; if(sel==='off') return; var a=ambAudio[sel]; if(!a) return; a.volume=parseFloat($ambVol.value||'0.35'); a.play().catch(function(){}); }

  /* ===== Engine ===== */
  function setScreen(text,title){ if(title) $screenTitle.textContent=title; $screenText.textContent=text; $screenButtons.innerHTML=''; }
  function showButtons(labels){ $screenButtons.innerHTML=''; labels.forEach(function(l){ var b=document.createElement('button'); b.className='button'; b.type='button'; b.textContent=l.label; if(l.id) b.dataset.id=l.id; if(l.hint && run && run.assist==='guided') b.classList.add('pulse'); b.addEventListener('click', function(){ if(l.onClick) l.onClick(); }); $screenButtons.appendChild(b); }); }

  function resetUI(){ $screenButtons.innerHTML=''; $screenText.innerHTML='Choose a scenario and press <em>Start Task</em>.'; $screenTitle.textContent='Ready'; $pinEcho.innerHTML=''; $cashStack.style.height='0px'; $receiptPaper.style.height='0px'; }
  function resetAll(){ stopAllAmbience(); run=null; resetUI(); }

  function onCardSlot(){
    if(!run) return;
    if(run.step==='await_insert'){
      run.step='pin';
      setScreen('Enter your 4-digit PIN, then press Enter.','PIN required');
      if(run.assist==='guided'){ $pinEcho.innerHTML='<span class="badge">Enter PIN for '+run.card.label+'</span>'; } else { $pinEcho.innerHTML=''; }
      if(ttsEnabled){ speak('Enter your four digit PIN, then press Enter.'); }
      return;
    }
    if(run.step==='eject_ready'){
      run.step='done';
      setScreen('Thank you.','Complete');
      if(ttsEnabled){ speak('Scenario complete.'); }
      finalizeRun(true);
    }
  }

  function onCashSlot(){ if(!run) return; if(run.step==='collect_cash'){ $cashStack.style.height='0px'; run.step = (run.scen.kind==='balance') ? 'eject_ready' : 'collect_receipt'; proceed(); } }
  function onReceiptSlot(){ if(!run) return; if(run.step==='collect_receipt'){ $receiptPaper.style.height='0px'; run.step='eject_ready'; proceed(); } }
  function onKeypadClick(ev){
    var t=ev.target; var k=(t&&t.dataset)? t.dataset.key: null; if(!k||!run) return;
    if(['Clear','Cancel','Enter'].indexOf(k)===-1 && !/^[0-9]$/.test(k)) return;
    switch(run.step){
      case 'pin': handlePinKey(k); break;
      case 'amount_entry': handleAmountKey(k); break;
      case 'change_pin_new': handleNewPinKey(k); break;
      case 'change_pin_confirm': handleConfirmPinKey(k); break;
      default: if(/^[0-9]$/.test(k)) run.wrongKeys++;
    }
  }

  function handlePinKey(k){
    if(k==='Clear'){ run.pinBuffer=''; $pinEcho.innerHTML='<span class="badge">PIN cleared</span>'; return; }
    if(k==='Cancel'){ run.step='eject_ready'; proceed(); return; }
    if(k==='Enter'){
      if(run.pinBuffer===run.card.pin){ run.step='menu'; $pinEcho.innerHTML=''; proceed(); }
      else{
        run.pinAttempts++; run.pinBuffer='';
        setScreen('Incorrect PIN. Try again.','PIN incorrect');
        if(ttsEnabled){ speak('Incorrect PIN. Try again.'); }
        if(run.pinAttempts>=3){
          setScreen('Card retained. Please seek assistance.','Card retained');
          if(ttsEnabled){ speak('Card retained. Please seek assistance.'); }
          finalizeRun(false); run=null;
        }
      }
      return;
    }
    run.pinBuffer+=k;
    $pinEcho.innerHTML='<span class="badge">PIN: '+new Array(run.pinBuffer.length+1).join('•')+'</span>';
  }

  var amountBuffer='';
  function handleAmountKey(k){
    if(k==='Clear'){ amountBuffer=''; setScreen('Amount cleared. Enter amount then press Enter.','Enter amount'); return; }
    if(k==='Cancel'){ run.step = run.scen.kind==='withdraw' ? 'withdraw_options' : 'topup_amount'; proceed(); return; }
    if(k==='Enter'){
      var v=parseInt(amountBuffer,10);
      if(!v || v%10!==0){
        setScreen('Enter a multiple of £10 (e.g., 10, 20, 30).','Invalid amount');
        if(ttsEnabled){ speak('Please enter a multiple of 10 pounds.'); }
        return;
      }
      run.pendingAmount=v; amountBuffer=''; run.step='account_choice'; proceed(); return;
    }
    amountBuffer += k; setScreen('£'+amountBuffer,'Enter amount');
  }

  var newPinBuffer='', confirmPinBuffer='';
  function handleNewPinKey(k){
    if(k==='Clear'){ newPinBuffer=''; $pinEcho.innerHTML='<span class="badge">New PIN cleared</span>'; return; }
    if(k==='Cancel'){ run.step='menu'; proceed(); return; }
    if(k==='Enter'){
      if(newPinBuffer.length!==4){ setScreen('Please enter a 4-digit PIN, then press Enter.','New PIN'); return; }
      run.newPin=newPinBuffer; newPinBuffer=''; run.step='change_pin_confirm';
      setScreen('Re-enter your new PIN to confirm, then press Enter.','Confirm new PIN');
      if(ttsEnabled){ speak('Re enter your new PIN to confirm, then press enter.'); }
      return;
    }
    if(/^[0-9]$/.test(k) && newPinBuffer.length<4){
      newPinBuffer+=k;
      $pinEcho.innerHTML='<span class="badge">New PIN: '+new Array(newPinBuffer.length+1).join('•')+'</span>';
    }
  }
  function handleConfirmPinKey(k){
    if(k==='Clear'){ confirmPinBuffer=''; $pinEcho.innerHTML='<span class="badge">Confirm cleared</span>'; return; }
    if(k==='Cancel'){ run.step='menu'; proceed(); return; }
    if(k==='Enter'){
      if(confirmPinBuffer===run.newPin){
        run.card.pin=run.newPin; run.newPin=null; confirmPinBuffer=''; run.step='eject_ready';
        setScreen('PIN changed. Take your card.','Success');
        if(ttsEnabled){ speak('Your PIN has been changed. Take your card.'); }
      } else {
        confirmPinBuffer=''; setScreen('PINs do not match. Try again.','Mismatch');
        if(ttsEnabled){ speak('The two PINs do not match. Please try again.'); }
      }
      return;
    }
    if(/^[0-9]$/.test(k) && confirmPinBuffer.length<4){
      confirmPinBuffer+=k;
      $pinEcho.innerHTML='<span class="badge">Confirm: '+new Array(confirmPinBuffer.length+1).join('•')+'</span>';
    }
  }

  function proceed(){
    if(!run) return;
    switch(run.step){
      case 'menu':
        setScreen('Choose an option','Main menu');
        showButtons([
          {label:'Cash withdrawal',onClick:function(){run.step='withdraw_options'; proceed();},hint:true},
          {label:'Balance enquiry',onClick:function(){run.step='balance_options'; proceed();}},
          {label:'Mobile top-up',onClick:function(){run.step='topup_network'; proceed();}},
          {label:'Change PIN',onClick:function(){run.step='change_pin_new'; setScreen('Enter your new 4-digit PIN, then press Enter.','New PIN'); if(ttsEnabled){ speak('Enter your new four digit PIN, then press enter.'); } }}
        ]);
        if(ttsEnabled){ speak('Choose an option.'); }
        break;

      case 'withdraw_options':
        setScreen('Choose an amount','Cash withdrawal');
        var quick=[10,20,30,50], labels=[];
        quick.forEach(function(q){ labels.push({label:'£'+q, onClick:function(){ run.pendingAmount=q; run.step='account_choice'; proceed(); }, hint: run.scen.kind==='withdraw' && run.scen.amount===q}); });
        labels.push({label:'Other amount', onClick:function(){ run.step='amount_entry'; amountBuffer=''; setScreen('Enter amount in multiples of £10, then press Enter.','Enter amount'); if(ttsEnabled){ speak('Enter amount in multiples of ten pounds, then press enter.'); } }});
        showButtons(labels);
        break;

      case 'account_choice':
        setScreen('Select account','Account');
        showButtons([
          {label:'Current account',onClick:function(){ run.accountType='Current account'; run.step='receipt_choice'; proceed(); },hint:true},
          {label:'Savings account',onClick:function(){ run.accountType='Savings account'; run.step='receipt_choice'; proceed(); }}
        ]);
        break;

      case 'receipt_choice':
        setScreen('Receipt options','Receipt');
        showButtons([
          {label:'Printed receipt',onClick:function(){ run.receipt='printed'; run.step='confirm_operation'; proceed(); }},
          {label:'No receipt',onClick:function(){ run.receipt='none'; run.step='confirm_operation'; proceed(); }}
        ]);
        break;

      case 'balance_options':
        setScreen('Show balance','Balance enquiry');
        showButtons([
          {label:'On-screen',onClick:function(){ run.receipt='screen'; run.step='show_balance'; proceed(); }},
          {label:'Printed receipt',onClick:function(){ run.receipt='printed'; run.step='print_balance'; proceed(); }}
        ]);
        break;

      case 'topup_network':
        setScreen('Choose your network','Mobile top-up');
        showButtons([
          {label:'O2',onClick:function(){ run.network='O2'; run.step='topup_amount'; proceed(); }},
          {label:'EE',onClick:function(){ run.network='EE'; run.step='topup_amount'; proceed(); }},
          {label:'Vodafone',onClick:function(){ run.network='Vodafone'; run.step='topup_amount'; proceed(); }},
          {label:'Three',onClick:function(){ run.network='Three'; run.step='topup_amount'; proceed(); }}
        ]);
        break;

      case 'topup_amount':
        setScreen('Choose top-up amount','Amount');
        showButtons([
          {label:'£10',onClick:function(){ run.pendingAmount=10; run.step='confirm_operation'; proceed(); }},
          {label:'£20',onClick:function(){ run.pendingAmount=20; run.step='confirm_operation'; proceed(); }}
        ]);
        break;

      case 'confirm_operation':
        var text='';
        if(run.scen.kind==='withdraw'){
          var acct=run.accountType||'Current account';
          text='Withdraw £'+run.pendingAmount+' from your '+acct+(run.receipt==='printed'?' with printed receipt':'')+'?';
        } else if(run.scen.kind==='balance'){
          text='Show balance '+(run.receipt==='printed'?'on paper':'on screen')+'?';
        } else if(run.scen.kind==='topup'){
          text='Top-up '+run.network+' for £'+run.pendingAmount+'?';
        }
        setScreen(text,'Confirm');
        showButtons([
          {label:'Confirm',onClick:function(){ run.step=dispenseOrShow(); proceed(); }, hint:true},
          {label:'Cancel',onClick:function(){ run.step='menu'; proceed(); }}
        ]);
        break;

      case 'declined_insufficient':
        setScreen('Unable to dispense cash — insufficient funds.','Transaction declined');
        showButtons([
          {label:'Choose a different amount',onClick:function(){ run.step='withdraw_options'; proceed(); },hint:true},
          {label:'Cancel',onClick:function(){ run.step='eject_ready'; proceed(); }}
        ]);
        if(ttsEnabled){ speak('Unable to dispense cash. You have insufficient funds for this transaction.'); }
        break;

      case 'show_balance':
        setScreen('Your balance is £1,234.56','Balance enquiry');
        if(run.receipt==='screen'){ run.step='eject_ready'; }
        break;

      case 'print_balance':
        setScreen('Printing balance…','Balance enquiry'); showReceiptPaper('BALANCE: £1234.56'); run.step='collect_receipt'; break;

      case 'collect_cash':
        setScreen('Please take your cash.','Dispensed'); showCashNotes(run.pendingAmount||20); break;

      case 'collect_receipt':
        setScreen('Please take your receipt.','Receipt'); showReceiptPaper('RECEIPT'); break;

      case 'eject_ready':
        setScreen('Please take your card.','Ejecting card');
        if(ttsEnabled){ speak('Please take your card.'); }
        break;
    }
  }

  function dispenseOrShow(){
    if(run.scen.kind==='withdraw'){
      if(run.testCond==='insufficient'){ run.declineReason='insufficient_funds'; return 'declined_insufficient'; }
      return 'collect_cash';
    }
    if(run.scen.kind==='balance'){ return run.receipt==='printed' ? 'print_balance' : 'show_balance'; }
    if(run.scen.kind==='topup'){ return 'eject_ready'; }
    return 'eject_ready';
  }

  function showCashNotes(amount){ $cashStack.style.height = Math.min(60, 12 + Math.floor((amount||10)/10)*6) + 'px'; }
  function showReceiptPaper(){ $receiptPaper.style.height='40px'; }

  function finalizeRun(success){
    stopAllAmbience();
    var start=(run&&run.startedAt)? run.startedAt: performance.now();
    var tTotal=Math.round(performance.now()-start);
    csvRows.push([new Date().toISOString(),'',(run&&run.scen&&run.scen.id)||'',(run&&run.scen&&run.scen.title)||'',(run&&run.card&&run.card.id)||'',(run&&run.assist)||'',!!success,(run&&run.pinAttempts)||0,(run&&run.wrongKeys)||0,tTotal,(run&&run.receipt)||'none',(run&&run.cashDispensed)||0,((run&&run.notes)||[]).join('; '),(run&&run.declineReason)||'' ]);
  }
  function toCsv(rows){ return rows.map(function(r){ return r.map(function(v){ return '"'+String(v).replace(/"/g,'""')+'"'; }).join(','); }).join('\r\n'); }

  // Robust CSV download (temp anchor)
  function downloadCsv(e){
    if(e) e.preventDefault();
    var csv=toCsv(csvRows);
    var blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');
    a.href=url; a.download='cashpoint_results.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(function(){ URL.revokeObjectURL(url); }, 1000);
  }

  /* ===== Start ===== */
  function startScenario(){
    resetUI();
    var scen=scenarios[$scenario.value];
    // Guard: ensure a valid card is selected
    if(!$card.value){ $card.value = cards[0].id; }
    var card = cards.find(function(c){ return c.id === $card.value; }) || cards[0];

    var assist=$assist.value, testCond=$testCond.value;

    // Zero voice in Assessment mode
    ttsEnabled = (assist !== 'assessment');

    $pinBadge.classList.toggle('hidden', assist==='assessment');
    $pinText.textContent=card.pin;

    run={scen:scen, card:card, assist:assist, testCond:testCond, step:'await_insert', startedAt:performance.now(), pinBuffer:'', pinAttempts:0, wrongKeys:0, notes:[], success:false, cashDispensed:0, receipt:'none'};

    primeTTS();
    setScreen('Insert card to begin', scen.title);
    if(ttsEnabled){ speak(scen.title, true); speak('Insert your card to begin.'); }
    maybeStartAmbience();
  }

  (function(){ bootstrap(); })();
  </script>
</body>
</html>
