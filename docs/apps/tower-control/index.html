<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme" content="bold dense"/>
  <meta name="color-scheme" content="light"/>
  <meta name="app-slug" content="tower-control"/>
  <meta name="app-title" content="Tower Control — Trainer"/>
  <meta name="app-desc" content="Match planes to actions under changing protocols. Timed spawns, accuracy stats, and difficulty levels."/>

  <title>Tower Control — Trainer</title>
  <meta name="description" content="Tower Control trainer with instructions, difficulty levels, and timed spawns."/>

  <!-- Shared assets at site root -->
  <link rel="stylesheet" href="/micro-apps-repository/shared/theme.css?v=3"/>
  <script defer src="/micro-apps-repository/shared/frame.js?v=3"></script>
  <script defer src="/micro-apps-repository/shared/clinician_feedback.js?v=3"></script>

  <style>
    :root{ --radar-h: 320px; }
    #app-root{ display:grid; gap:clamp(12px,1.2vw,18px); }

    /* Order in DOM = radar, controls, side; on desktop, keep controls under radar */
    .tc-app{ display:grid; gap:clamp(12px,1.2vw,18px); }
    @media (min-width:1024px){
      .tc-app{
        grid-template-areas:
          "radar side"
          "controls side";
        grid-template-columns: 2fr 1fr;
        align-items:start;
      }
      #radar{ grid-area:radar; }
      .controls{ grid-area:controls; }
      #side-stack{ grid-area:side; display:grid; gap:clamp(12px,1.2vw,18px); }
      :root{ --radar-h: 440px; }
    }
    @media (min-width:768px){ :root{ --radar-h: 380px; } }

    .panel{
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: clamp(16px, 2vw, 24px);
    }

    /* Radar */
    .radar{
      position:relative; height:var(--radar-h); border-radius:16px;
      overflow:hidden; isolation:isolate;
      background:
        radial-gradient(circle at 50% 50%, transparent 0 1px, var(--surface) 1px 8%, transparent 8%),
        radial-gradient(circle at 50% 50%, transparent 0 1px, var(--surface) 1px 16%, transparent 16%),
        radial-gradient(circle at 50% 50%, transparent 0 1px, var(--surface) 1px 24%, transparent 24%),
        radial-gradient(circle at 50% 50%, var(--line) 0, var(--line) 1px, transparent 1px);
    }
    .radar::before, .radar::after{ content:""; position:absolute; inset:0; pointer-events:none; }
    .radar::before{
      background:
        linear-gradient(var(--line),var(--line)) 50% 0/1px 100% no-repeat,
        linear-gradient(var(--line),var(--line)) 0 50%/100% 1px no-repeat;
      opacity:.6;
    }
    @media (prefers-reduced-motion: no-preference){
      .radar::after{
        background: conic-gradient(from 0turn, color-mix(in oklab, var(--accent), transparent 88%) 0turn, transparent .15turn);
        mix-blend-mode: plus-lighter;
        animation: tc-sweep 3.6s linear infinite;
      }
      @keyframes tc-sweep{ to { transform: rotate(1turn); } }
    }

    .plane{
      position:absolute; translate:-50% -50%;
      width:28px; height:28px; line-height:0;
      color:#3b82f6; filter:drop-shadow(0 1px 1px rgba(0,0,0,.25));
      cursor:pointer;
    }
    .plane svg{ width:100%; height:100%; display:block; }
    .plane[data-color=green]{ color:#16a34a; }
    .plane[data-color=blue]{ color:#3b82f6; }
    .plane[data-color=yellow]{ color:#f59e0b; }
    .plane[data-color=red]{ color:#ef4444; }
    .plane.selected::after{
      content:""; position:absolute; inset:-8px; border-radius:999px;
      border:2px solid var(--accent); box-shadow:0 0 0 2px color-mix(in oklab, var(--accent), transparent 75%);
    }

    .kv{ display:grid; grid-template-columns:auto 1fr; gap:.25rem .75rem; }
    .kv dt{ color: var(--muted); }
    .kv dd{ margin:0; }

    .controls{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:clamp(10px,1vw,14px);
    }
    @media (min-width:768px){
      .controls{ grid-template-columns: repeat(4, minmax(0,1fr)); }
    }

    table.map{ width:100%; border-collapse:separate; border-spacing:0 6px; }
    .map td{
      padding:8px 10px; border:1px solid var(--line); border-radius:10px;
      background: var(--surface);
    }

    /* Tiny utilities */
    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{ display:inline-block; padding:6px 12px; border-radius:999px; background:var(--pill); color:var(--text); font-size:.85rem; font-weight:500; }
  </style>
</head>
<body>
  <div id="app-root">
    <main class="tc-app" data-app-title="Tower Control" data-app-tags="executive, attention" data-app-version="trainer-1">

      <!-- Radar -->
      <section class="panel radar" id="radar" aria-label="Radar display" role="img"></section>

      <!-- Controls directly under radar -->
      <section class="panel controls" aria-label="Actions">
        <button type="button" class="button primary" data-action="clear">CLEAR</button>
        <button type="button" class="button primary" data-action="land">LAND</button>
        <button type="button" class="button primary" data-action="hold">HOLD</button>
        <button type="button" class="button primary" data-action="redirect">REDIRECT</button>
      </section>

      <!-- Right column (desktop) -->
      <div id="side-stack">
        <section class="panel" id="task-panel" aria-labelledby="task-h">
          <h2 id="task-h">Active Protocols</h2>
          <p class="helper">Match planes to actions according to today’s rules.</p>
          <table class="map" id="protocols"></table>
          <div class="toolbar">
            <label class="pill">Difficulty&nbsp;
              <select id="difficulty">
                <option value="easy">Easy</option>
                <option value="normal" selected>Normal</option>
                <option value="hard">Hard</option>
              </select>
            </label>
            <button class="button" id="reshuffle" type="button">New Round</button>
            <button class="button" id="show-help" type="button">Instructions</button>
            <button class="button primary" id="start" type="button">Start</button>
            <button class="button" id="pause" type="button">Pause</button>
            <button class="button" id="reset" type="button">Reset</button>
            <!-- CSV -->
            <button class="button" id="downloadCsv" type="button" title="Download session data (CSV)">Download CSV</button>
          </div>
        </section>

        <section class="panel" id="status-panel" aria-labelledby="status-h">
          <h2 id="status-h">Status</h2>
          <dl class="kv">
            <dt>Success rate</dt><dd><span id="succ">0%</span></dd>
            <dt>Completed</dt><dd><span id="done">0</span></dd>
            <dt>Failed</dt><dd><span id="fail">0</span></dd>
            <dt>On screen</dt><dd><span id="onscreen">0</span></dd>
          </dl>
        </section>
      </div>
    </main>
  </div>

  <!-- Instructions dialog -->
  <dialog class="app-dialog" id="help">
    <h3>How to play</h3>
    <ol>
      <li><strong>Check Active Protocols</strong> (color → required action).</li>
      <li><strong>Tap a plane</strong> to select it, then <strong>tap an action</strong>.</li>
      <li>Correct action → counts as <em>Completed</em>. Wrong action → <em>Failed</em>.</li>
      <li>New planes spawn over time. Difficulty controls spawn rate &amp; max planes.</li>
      <li>Use <em>New Round</em> anytime to reshuffle the protocols.</li>
    </ol>
    <div class="toolbar" style="justify-content:flex-end">
      <button class="button" id="close-help" type="button">Close</button>
    </div>
  </dialog>

  <script>
  (function(){
    // ======= Config & State =======
    const DIFF = {
      easy:   { spawnMs: 2500, maxOnScreen: 3 },
      normal: { spawnMs: 1800, maxOnScreen: 5 },
      hard:   { spawnMs: 1100, maxOnScreen: 7 },
    };
    const COLORS = ["green","blue","yellow","red"];
    const ACTIONS = ["clear","land","hold","redirect"];
    const PLANE_SVG = '<svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M20.5 13.5l-7.7-2.2 3.7-8.1c.2-.5-.2-1.2-.8-1.2-.3 0-.5.1-.7.3L8.2 8.3 3.3 6.9 2 8.2l4.4 3.1-2.2 4.8-1.8.6-.4 1.1 2.7-.3 1.1-1.6 4.4-1.5 4.9 3.4c.2.2.5.3.7.3.6 0 1-.7.8-1.2l-2.2-5 7.7-2.2c.3-.1.5-.3.5-.6 0-.2-.2-.5-.5-.6z"/></svg>';

    let cfg = DIFF.normal;
    let running = false, spawnTimer = null;
    let selected = null, planes = [], completed = 0, failed = 0;
    let map = {};               // color -> required action
    let sessionRows = [];        // CSV rows (actions only)
    const sessionStart = new Date();

    // ======= DOM =======
    const el = {
      radar: document.getElementById('radar'),
      protocols: document.getElementById('protocols'),
      succ: document.getElementById('succ'),
      done: document.getElementById('done'),
      fail: document.getElementById('fail'),
      onscreen: document.getElementById('onscreen'),
      start: document.getElementById('start'),
      pause: document.getElementById('pause'),
      reset: document.getElementById('reset'),
      reshuffle: document.getElementById('reshuffle'),
      diff: document.getElementById('difficulty'),
      help: document.getElementById('help'),
      showHelp: document.getElementById('show-help'),
      closeHelp: document.getElementById('close-help'),
      downloadCsv: document.getElementById('downloadCsv'),
    };

    // ======= Helpers =======
    function toast(msg){ if(window.frame?.toast) frame.toast(msg); else console.log(msg); }
    function rand(min,max){ return Math.random()*(max-min)+min; }
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    const fmtTime = d => new Date(d).toISOString();

    function setDifficulty(name){
      cfg = DIFF[name] || DIFF.normal;
      if (running) { stopSpawning(); startSpawning(); }
    }

    function newRound(){
      // shuffle one-to-one mapping of COLORS to ACTIONS
      const shuffled = [...ACTIONS].sort(()=>Math.random()-0.5);
      map = {};
      COLORS.forEach((c, i)=> map[c] = shuffled[i % shuffled.length]);
      renderProtocols();
      toast('Protocols updated');
    }

    function renderProtocols(){
      el.protocols.innerHTML = COLORS.map(c => {
        const a = map[c];
        return `<tr>
          <td><span class="pill" style="border:1px solid var(--line)">${c}</span></td>
          <td><strong>${(a||'—').toUpperCase()}</strong></td>
        </tr>`;
      }).join('');
    }

    function updateStatus(){
      el.done.textContent = completed;
      el.fail.textContent = failed;
      const total = completed + failed;
      el.succ.textContent = total ? Math.round((completed/total)*100)+'%' : '0%';
      el.onscreen.textContent = planes.length;
    }

    function renderPlanes(){
      el.radar.innerHTML = '';
      planes.forEach(p => {
        const d = document.createElement('div');
        d.className = 'plane';
        d.dataset.id = p.id;
        d.dataset.color = p.color;
        d.style.left = p.x + '%';
        d.style.top  = p.y + '%';
        if (selected?.id === p.id) d.classList.add('selected');
        d.innerHTML = PLANE_SVG;
        d.addEventListener('click', ()=>{ selected = p; renderPlanes(); });
        el.radar.appendChild(d);
      });
      updateStatus();
    }

    function spawnPlane(){
      if (planes.length >= cfg.maxOnScreen) return;
      const id = 'p' + Math.random().toString(36).slice(2,7);
      const color = pick(COLORS);
      const x = Math.round(rand(12,88)), y = Math.round(rand(12,88));
      planes.push({ id, color, x, y, bornAt: Date.now() });
      renderPlanes();
    }

    function startSpawning(){
      clearInterval(spawnTimer);
      spawnTimer = setInterval(spawnPlane, cfg.spawnMs);
    }
    function stopSpawning(){
      clearInterval(spawnTimer); spawnTimer = null;
    }

    function handleAction(action){
      if(!selected){ toast('Select a plane first'); return; }
      const needed = map[selected.color];
      const ok = (action === 'clear') || (action === needed);

      // CSV: log a tidy row for this action
      sessionRows.push({
        timestamp: fmtTime(Date.now()),
        session_start: fmtTime(sessionStart),
        difficulty: Object.keys(DIFF).find(k=>DIFF[k]===cfg) || 'normal',
        plane_id: selected.id,
        plane_color: selected.color,
        required_action: needed,
        chosen_action: action,
        correct: ok ? 1 : 0,
        onscreen_before: planes.length,
      });

      if (ok){ completed++; toast(`✓ ${action.toUpperCase()} accepted for ${selected.color}`); }
      else { failed++; toast(`✕ ${action.toUpperCase()} not allowed for ${selected.color}`); }

      planes = planes.filter(p => p.id !== selected.id);
      selected = null;
      renderPlanes();
    }

    function resetAll(){
      running = false; stopSpawning();
      selected = null; planes = []; completed = 0; failed = 0;
      renderPlanes();
    }

    // ======= CSV Export =======
    function toCSV(rows){
      const headers = [
        "timestamp","session_start","difficulty","plane_id","plane_color",
        "required_action","chosen_action","correct","onscreen_before"
      ];
      const esc = v => {
        if (v == null) return "";
        const s = String(v);
        return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      };
      const body = rows.map(r => headers.map(h => esc(r[h])).join(",")).join("\n");
      return headers.join(",") + "\n" + body + "\n";
    }

    function downloadCSV(){
      const csv = toCSV(sessionRows);
      const blob = new Blob([csv], {type: "text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const stamp = new Date().toISOString().replace(/[:.]/g,'-');
      a.href = url;
      a.download = `tower-control_${stamp}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ======= Wire UI =======
    document.querySelector('.controls').addEventListener('click', e=>{
      const b = e.target.closest('button[data-action]'); if(!b) return;
      handleAction(b.dataset.action);
    });
    el.start.addEventListener('click', ()=>{ if(!running){ running=true; startSpawning(); toast('Started'); }});
    el.pause.addEventListener('click', ()=>{ if(running){ running=false; stopSpawning(); toast('Paused'); }});
    el.reset.addEventListener('click', ()=>{ resetAll(); toast('Reset'); });
    el.reshuffle.addEventListener('click', ()=> newRound());
    el.diff.addEventListener('change', e=> setDifficulty(e.target.value));
    el.showHelp.addEventListener('click', ()=> el.help.showModal());
    el.closeHelp.addEventListener('click', ()=> el.help.close());
    el.downloadCsv.addEventListener('click', downloadCSV);

    // ======= Init =======
    newRound();
    updateStatus();
    el.help.showModal(); // first-run instructions

    // Expose for hooks
    window.app = { handleAction, setDifficulty, newRound, downloadCSV };
  })();
  </script>
</body>
</html>
