<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Left-Anchor Reader — Visuo-Spatial Neglect Trainer</title>

  <!-- Micro-Apps shared assets -->
  <meta name="app-slug" content="neglect-reader" />
  <meta name="app-title" content="Left-Anchor Reader — Visuo-Spatial Neglect Trainer" />
  <meta name="app-desc" content="Read a short story with optional left-attentional anchors: a pulsating stripe, a sweeping right→left light, or red lead-words per line." />
  <meta name="theme" content="bold dense" />

  <link rel="stylesheet" href="/micro-apps-repository/shared/theme.css?v=3" />
  <script defer="defer" src="/micro-apps-repository/shared/frame.js?v=3"></script>
  <script defer="defer" src="/micro-apps-repository/shared/clinician_feedback.js?v=3"></script>

  <style>
    :root{
      --stripe-width: 56px;      /* wider anchor stripe */
      --stripe-color: #ef3b2a;   /* anchor/red */
      --sweep-duration: 3.6s;
    }

    /* Toolbar */
    .toolbar .mode-label{ font-weight:600; margin-right:6px; }
    .segmented{
      display:inline-flex; border:1px solid var(--line); border-radius:12px; overflow:hidden;
      box-shadow: var(--shadow); background:var(--surface);
    }
    .segmented input{ position:absolute; opacity:0; pointer-events:none; }
    .segmented label{
      padding:.55rem .9rem; cursor:pointer; user-select:none; border-right:1px solid var(--line);
    }
    .segmented label:last-child{ border-right:none; }
    .segmented input:checked + label{ background:var(--accent); color:#fff; border-color:var(--accent-600); }

    /* Reader surface */
    .reader{
      position:relative;
      max-width: 760px;
      margin: 0 auto;
      background:
        linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.96)),
        var(--surface);
      border-radius: 14px;
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      padding: clamp(18px, 3vw, 28px);
      padding-left: calc(clamp(18px, 3vw, 28px) + var(--stripe-width) + 10px);
      overflow:hidden;
      min-height: 56svh;
    }
    .reader .title{
      margin: 0 0 .4rem;
      font-weight: 700;
      font-size: 1.06rem;
      color:#0f172a;
      letter-spacing:.2px;
    }

    /* Pages */
    .pages{ position: relative; }
    .page{
      display:none;
      font-family: Georgia, "Iowan Old Style", "Times New Roman", serif;
      font-size: clamp(1rem, .3vw + .98rem, 1.1rem);
      line-height: 1.7;
      hyphens:auto;
      text-wrap: pretty;
      min-height: 42svh;
    }
    .page.current{ display:block; }
    .page p{ margin: 0 0 1rem; }

    /* Support 1: Pulsating left stripe */
    .left-stripe{
      pointer-events:none;
      position:absolute; inset:0 auto 0 0;
      width: var(--stripe-width);
      background: var(--stripe-color);
      opacity:0; transform: translateX(-100%);
      box-shadow: 0 0 0 2px color-mix(in oklab, var(--stripe-color), white 35%);
    }
    .mode-stripe .left-stripe{
      transform:none; opacity:1;
      animation: stripePulse 1300ms ease-in-out infinite;
    }
    @keyframes stripePulse{
      0%,100%{ opacity:.9; filter:saturate(1); }
      50%{   opacity:.55; filter:saturate(.9); }
    }

    /* Support 2: Sweeping right→left bright light */
    .sweep{
      pointer-events:none;
      position:absolute; top:0; bottom:0; width:180%; left:100%;
      background:
        linear-gradient(90deg,
          rgba(255,255,255,0) 0%,
          rgba(255,255,220,.85) 30%,
          rgba(255,255,255,0) 65%);
      mix-blend-mode: normal;
      backdrop-filter: brightness(1.18) saturate(1.05);
      -webkit-backdrop-filter: brightness(1.18) saturate(1.05);
      opacity:0;
    }
    .mode-sweep .sweep{
      opacity:1;
      animation: sweepLeft var(--sweep-duration) linear infinite;
    }
    @keyframes sweepLeft{
      0%{ transform: translateX(0); }
      100%{ transform: translateX(-280%); }
    }

    /* Support 3: Lead-words colouring (first 2 per visual line) */
    .page .wd{ display:inline; }            /* each word span */
.mode-firstwords .page .lead{
  color: var(--stripe-color);
  text-decoration: underline;          /* or 'underline 0.06em' if supported */
  text-underline-offset: 0.12em;       /* keeps it readable */
}
    /* Pager */
    .pager{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-top:10px; color:var(--muted);
      font-size:.92rem;
    }
    .pager .hint{ opacity:.8; }
    .pager .buttons{ margin-left:auto; display:flex; gap:8px; }
    .btn{
      appearance:none; border:1px solid var(--line); background:var(--surface); color:var(--text);
      padding:.5rem .7rem; border-radius:999px; font-weight:600; cursor:pointer;
      box-shadow: var(--shadow);
    }
    .btn[disabled]{ opacity:.4; cursor:not-allowed; }
    .btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent-600); }
    .next-fab{
      position: fixed; right: clamp(14px, 3vw, 22px); bottom: clamp(14px, 3vw, 22px);
      z-index: 20; border-radius: 999px; padding:.9rem 1rem; line-height:1;
    }

    .reader:focus-within{ outline: 3px solid var(--accent); outline-offset: 4px; }
  </style>
</head>
<body>
  <div id="app-root">

    <!-- Toolbar -->
    <div class="toolbar" role="group" aria-label="Support mode">
      <span class="mode-label">Support:</span>
      <div class="segmented" id="modeControl">
        <input type="radio" id="mode-none"   name="mode" value="none" checked="checked" />
        <label for="mode-none" title="No external support">None</label>

        <input type="radio" id="mode-stripe" name="mode" value="stripe" />
        <label for="mode-stripe" title="Pulsating red stripe on the left">Left stripe</label>

        <input type="radio" id="mode-sweep"  name="mode" value="sweep" />
        <label for="mode-sweep" title="Right-to-left sweeping light">Right→Left sweep</label>

        <input type="radio" id="mode-firstwords" name="mode" value="firstwords" />
        <label for="mode-firstwords" title="Colour the first two words on each line">Lead-words (first 2)</label>
      </div>
    </div>

    <!-- How to use moved BEFORE story -->
    <details open>
      <summary><strong>How to use</strong></summary>
      <p class="helper">
        Choose a support mode above. <em>Left stripe</em> provides a wide, pulsating red anchor at the left edge.
        <em>Right→Left sweep</em> adds a brighter light moving across the text to guide attention leftwards.
        <em>Lead-words</em> colours the first two words of every visible line in red to create multiple left anchors.
        Swipe left/right to change page or tap the bottom-right arrow.
      </p>
    </details>

    <!-- Story -->
    <section class="reader mode-none" id="reader" aria-live="polite">
      <div class="left-stripe" aria-hidden="true"></div>
      <div class="sweep" aria-hidden="true"></div>

      <h2 class="title">Short Story</h2>

      <div class="pages" id="pages" tabindex="0" aria-label="Story pages">
        <!-- Page 1 -->
        <article class="page current" data-index="0">
          <p>
            On the edge of a quiet village, a boy named Leo often sat by the river after school, skipping stones and talking to himself about the day’s little dramas. One afternoon, an old man appeared on the opposite bank, fishing with a rod so worn it looked older than Leo’s grandparents. For a while, they just nodded at each other across the water, strangers bound by the same silence. Then the man called out, “You’re throwing them too flat—let the stone breathe before it flies.” Leo tried again, and the stone danced five times before sinking. The old man smiled, and from that day, they met there most evenings.
          </p>
        </article>

        <!-- Page 2 -->
        <article class="page" data-index="1">
          <p>
            The old man’s name was Arthur. He had been a carpenter once, a widower now, his stories shaped by both laughter and ache. Leo would bring his homework, and Arthur would bring tales of his youth—of building boats, of losing a friend in the war, of the first time he held his newborn daughter. Sometimes, they spoke little. Sometimes, they said everything without needing words. Leo started to notice how the sun seemed to linger a little longer when Arthur laughed, how the world felt smaller and kinder when they sat side by side.
          </p>
        </article>

        <!-- Page 3 -->
        <article class="page" data-index="2">
          <p>
            When winter came and the river froze, Arthur stopped coming. Leo crossed the bridge and found the old house shuttered, the chair by the hearth empty but warm with memory. He sat by the fire, holding a small wooden boat Arthur had carved for him weeks before, its hull smooth as a wish. Years later, when Leo was grown and teaching his own son to skip stones, he told him, “Let the stone breathe before it flies.” And as the boy’s laughter echoed across the water, Leo smiled—because the river still remembered.
          </p>
        </article>
      </div>

      <div class="pager" aria-live="polite">
        <span id="pageStatus" class="hint">Page 1 of 3 — swipe to navigate</span>
        <div class="buttons">
          <button class="btn" id="prevBtn" aria-label="Previous page" disabled="disabled">← Prev</button>
          <button class="btn primary" id="nextBtn" aria-label="Next page">Next →</button>
        </div>
      </div>
    </section>

    <!-- Floating next arrow at bottom-right -->
    <button class="btn primary next-fab" id="fabNext" aria-label="Next page (bottom-right)">
      ➜
    </button>
  </div>

  <script>
    (function(){
      const reader   = document.getElementById('reader');
      const control  = document.getElementById('modeControl');
      const pagesEl  = document.getElementById('pages');
      const pageStatus = document.getElementById('pageStatus');
      const prevBtn  = document.getElementById('prevBtn');
      const nextBtn  = document.getElementById('nextBtn');
      const fabNext  = document.getElementById('fabNext');

      const pages = Array.from(pagesEl.querySelectorAll('.page'));
      let index = 0;

      /* ---------- Paging ---------- */
      function render(){
        pages.forEach((p,i)=>p.classList.toggle('current', i===index));
        pageStatus.textContent = `Page ${index+1} of ${pages.length} — swipe to navigate`;
        prevBtn.disabled = (index===0);
        nextBtn.disabled = (index===pages.length-1);
        fabNext.disabled = nextBtn.disabled;
        pagesEl.setAttribute('aria-label', `Story page ${index+1} of ${pages.length}`);
        if (currentMode() === 'firstwords') applyLeadWords();
      }
      function go(delta){
        index = Math.max(0, Math.min(pages.length-1, index + delta));
        render();
      }
      prevBtn.addEventListener('click', ()=>go(-1));
      nextBtn.addEventListener('click', ()=>go(1));
      fabNext.addEventListener('click', ()=>go(1));

      // Keyboard: ← →  /  1=None, 2=Stripe, 3=Sweep, 4=Lead-words
      document.addEventListener('keydown', (e) => {
        if (e.target && /input|textarea|select/i.test(e.target.tagName)) return;
        if (e.key === 'ArrowLeft')  go(-1);
        if (e.key === 'ArrowRight') go(1);
        if (e.key === '1') document.getElementById('mode-none').checked = true;
        if (e.key === '2') document.getElementById('mode-stripe').checked = true;
        if (e.key === '3') document.getElementById('mode-sweep').checked = true;
        if (e.key === '4') document.getElementById('mode-firstwords').checked = true;
        updateMode();
      });

      // Touch swipe
      let touchStartX = 0, touchStartY = 0;
      const SWIPE_X = 40, SWIPE_Y = 50;
      pagesEl.addEventListener('touchstart', (e)=>{
        const t = e.changedTouches[0];
        touchStartX = t.clientX; touchStartY = t.clientY;
      }, {passive:true});
      pagesEl.addEventListener('touchend', (e)=>{
        const t = e.changedTouches[0];
        const dx = t.clientX - touchStartX;
        const dy = t.clientY - touchStartY;
        if (Math.abs(dx) > SWIPE_X && Math.abs(dy) < SWIPE_Y) {
          if (dx < 0) go(1); else go(-1);
        }
      }, {passive:true});

      /* ---------- Modes ---------- */
      function currentMode(){
        return control.querySelector('input[name="mode"]:checked')?.value || 'none';
      }
      function updateMode(){
        const mode = currentMode();
        reader.classList.remove('mode-none','mode-stripe','mode-sweep','mode-firstwords');
        reader.classList.add('mode-' + mode);
        reader.setAttribute('aria-label', 'Reader, support mode: ' + mode);
        if (mode === 'firstwords') applyLeadWords();
        else clearLeadWords(); // remove colouring when leaving mode
      }
      control.addEventListener('change', updateMode);

      /* ---------- Lead-words (first 2 words per visual line) ---------- */

      // Wrap words one-time per page
      function ensureWrapped(page){
        if (page.dataset.wrapped === '1') return;
        page.dataset.wrapped = '1';

        const walker = document.createTreeWalker(page, NodeFilter.SHOW_TEXT, {
          acceptNode(node){
            return node.parentElement && node.nodeType === 3 && node.nodeValue.trim().length
              ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT;
          }
        });

        const textNodes = [];
        while(walker.nextNode()) textNodes.push(walker.currentNode);

        const wordRe = /[\w’'-]+/g; // words incl. ’ and hyphen/apostrophes

        for (const tn of textNodes){
          const frag = document.createDocumentFragment();
          const text = tn.nodeValue;
          let lastIndex = 0, m;

          while ((m = wordRe.exec(text)) !== null){
            const [w] = m;
            const start = m.index;
            const end = start + w.length;

            // add any text before the word
            if (start > lastIndex) frag.appendChild(document.createTextNode(text.slice(lastIndex, start)));

            // word span
            const span = document.createElement('span');
            span.className = 'wd';
            span.textContent = w;
            frag.appendChild(span);
            lastIndex = end;
          }
          // trailing text
          if (lastIndex < text.length) frag.appendChild(document.createTextNode(text.slice(lastIndex)));

          tn.parentNode.replaceChild(frag, tn);
        }
      }

      function clearLeadWords(){
        const page = pages[index];
        if (!page) return;
        page.querySelectorAll('.wd.lead').forEach(el => el.classList.remove('lead'));
      }

      function applyLeadWords(){
        const page = pages[index];
        if (!page) return;

        ensureWrapped(page);
        clearLeadWords();

        const words = Array.from(page.querySelectorAll('.wd'));
        if (!words.length) return;

        // Group words by their visual line using a stable top-coordinate key.
        // Multiplying by devicePixelRatio avoids collisions caused by sub-pixel
        // differences between lines (e.g. fractional layout rounding).
        const precision = Math.max(1, Math.round(window.devicePixelRatio || 1));
        const lineMap = new Map();

        for (const word of words){
          const rect = word.getBoundingClientRect();
          const topKey = Math.round(rect.top * precision);
          if (!lineMap.has(topKey)) lineMap.set(topKey, []);
          lineMap.get(topKey).push({ el: word, left: rect.left });
        }

        // Highlight only the first two words (by left-to-right order) per line.
        for (const group of lineMap.values()){
          group.sort((a,b)=>a.left - b.left);
          for (let i = 0; i < Math.min(2, group.length); i++){
            group[i].el.classList.add('lead');
          }
        }
      }

      // Recompute on resize/orientation if mode active
      let resizeTimer = null;
      window.addEventListener('resize', () => {
        if (currentMode() !== 'firstwords') return;
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(applyLeadWords, 120);
      });

      // Init
      updateMode();
      render();
    })();
  </script>
</body>
</html>
