<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Travel with Coco Ã¢â‚¬â€ Milestones v0.3</title>
<style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --brand:#2563eb; --brand-2:#7c3aed; --ok:#16a34a; --warn:#b45309; --danger:#dc2626;
      --border:#e5e7eb; --pill:#f3f4f6; --chip:#eef2ff; --shadow:0 12px 30px rgba(17,24,39,0.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#f9fafb,#f6f7fb 30%,#f6f7fb 100%);
         color:var(--text);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.9);
           backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--border)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .sub{color:var(--muted);margin:.25rem 0 0}

    .dash{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
    .tile{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
    .tile .label{font-size:12px;color:var(--muted)}
    .tile .value{font-weight:800;letter-spacing:.2px}
    .value.bad{color:var(--danger)} .value.warn{color:var(--warn)} .value.good{color:var(--ok)}

    main .card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:18px;margin:18px auto}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:12px;padding:12px 14px;
         font-size:15px;cursor:pointer;transition:.15s box-shadow,.15s transform;box-shadow:0 2px 0 rgba(0,0,0,.04)}
    .btn:hover{box-shadow:0 10px 20px rgba(0,0,0,.08);transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));border-color:transparent;color:#fff}
    .btn.ghost{background:transparent}
    .btn.chip{background:var(--chip);border-color:#e9e5ff}

    .choice{display:flex;gap:12px;border:1px dashed var(--border);border-radius:16px;padding:14px;margin:12px 0;background:#fbfcff}
    .choice h4{margin:0 0 4px}
    .choice small{color:var(--muted)}
    .hr{height:1px;background:var(--border);margin:16px 0}
    .muted{color:var(--muted)}

    .progress{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .chip.done{background:#ecfdf5;border-color:#d1fae5}
    .chip.current{background:#eff6ff;border-color:#dbeafe}

    .toolbar{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-top:8px}
    .toolbar .right{display:flex;gap:10px;align-items:center}

    @media (max-width:680px){ .dash{grid-template-columns:repeat(2,1fr)} }
  </style>
<meta content="travel_with_coco" name="app-slug"/><link href="/shared/theme.css" rel="stylesheet"/><script defer="" src="/shared/frame.js"></script><link href="../../../shared/theme.css" rel="stylesheet"/><script defer="" src="../../../shared/frame.js"></script><script defer="" src="../../../shared/clinician_feedback.js"></script>  <meta name="app-slug" content="travel-with-coco">
</head>
<body><main id="app-root">
<header>
<div class="wrap">
<h1>Ã°Å¸Å’Â Travel with Coco <span class="muted">Ã¢â‚¬â€ Prototype v0.3</span></h1>
<p class="sub">Plan a journey with your cheeky companion. Reach your destination city before you run out of resources.</p>
<div aria-live="polite" class="dash">
<div class="tile"><div class="label">Ã°Å¸â€™Â° Money</div><div class="value" id="moneyVal">Ã¢â‚¬â€</div></div>
<div class="tile"><div class="label">Ã¢ÂÂ³ Time left (days)</div><div class="value" id="timeVal">Ã¢â‚¬â€</div></div>
<div class="tile"><div class="label">Ã°Å¸â€â€¹ Energy</div><div class="value" id="energyVal">Ã¢â‚¬â€</div></div>
<div class="tile"><div class="label">Ã°Å¸ÂÂ¦ CocoÃ¢â‚¬â„¢s Mood</div><div class="value" id="moodVal">Ã¢â‚¬â€</div></div>
</div>
</div>
</header>
<main aria-live="polite" class="wrap" id="app"></main>
<script>
    // ----------------------
    // Game State v0.3 Ã¢â‚¬â€ Presets + CSV + Sleek UI
    // ----------------------
    const ROUTE_PRESETS = {
      'UK Ã¢â€ â€™ Italy (City Hop)': ['London','Paris','Milan','Florence','Rome'],
      'Japan Golden Route': ['Tokyo','Hakone','Kyoto','Osaka'],
      'US West Coast': ['Seattle','Portland','San Francisco','Los Angeles','San Diego'],
      'Alps Highlights': ['Geneva','Chamonix','Aosta','Zermatt','St. Moritz']
    };

    const game = {
      phase: 'start',
      day: 1,
      routeCities: [...ROUTE_PRESETS['UK Ã¢â€ â€™ Italy (City Hop)']],
      routeIndex: 0,
      money: 200,
      time: 5,
      energy: 100,
      mood: 50,
      followedCocoCount: 0,
      ignoredCocoCount: 0,
      log: [],
      lastCoco: null,
      csvRows: []
    };

    // Derived
    const startCity = ()=> game.routeCities[0];
    const destination = ()=> game.routeCities[game.routeCities.length-1];
    const currentCity = ()=> game.routeCities[game.routeIndex];
    const nextCity = (advance=1)=> game.routeCities[Math.min(game.routeIndex+advance, game.routeCities.length-1)];

    // Utils
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
    const chance = p => Math.random() < p;
    const pick = arr => arr[Math.floor(Math.random()*arr.length)];
    const app = document.getElementById('app');
    const html = (s,...v)=>s.map((x,i)=>x+(v[i]??'')).join('');

    // Dashboard
    function updateDash(){
      const money = document.getElementById('moneyVal');
      const time  = document.getElementById('timeVal');
      const energy= document.getElementById('energyVal');
      const mood  = document.getElementById('moodVal');
      const set = (el,val)=>{ el.textContent=val; el.className='value'; if(+val<=0) el.classList.add('bad'); };
      set(money, `Ã‚Â£${game.money}`); set(time, `${game.time}`); set(energy, `${game.energy}`); set(mood, `${game.mood}`);
      if(game.energy>=70) energy.classList.add('good'); else if(game.energy<=30) energy.classList.add('warn');
      if(game.money<=20) money.classList.add('warn'); if(game.time<=1) time.classList.add('warn');
      if(game.mood>=80) mood.classList.add('good'); else if(game.mood<20) mood.classList.add('warn');
    }

    // Progress UI
    function progressBar(){
      return `<div class="progress">${
        game.routeCities.map((c,i)=>{
          const cls = i<game.routeIndex? 'chip done' : (i===game.routeIndex? 'chip current':'chip');
          const dot = i<game.routeIndex? 'Ã¢Å“â€¦' : (i===game.routeIndex? 'Ã°Å¸â€Âµ':'Ã¢Å¡Âª');
          return `<span class="${cls}">${dot} <span>${c}</span></span>`;
        }).join('<span class="muted">Ã¢â€ â€™</span>')
      }</div>`;
    }

    // Options
    function genCocoSuggestion(){
      if(game.mood<20) return null;
      let sensibleP=0.2, whimsicalP=0.5, luckyP=0.2, sabotageP=0.1;
      if(game.mood>80){ sensibleP=0.3; luckyP=0.3; whimsicalP=0.3; sabotageP=0.1; }
      const r=Math.random();
      let type='whimsical';
      if(r<sensibleP) type='sensible';
      else if(r<sensibleP+whimsicalP) type='whimsical';
      else if(r<sensibleP+whimsicalP+luckyP) type='lucky';
      else type='sabotage';

      let advance=1, cost=0, energy=0, timeCost=1, detail='Coco has a planÃ¢â‚¬Â¦';
      if(type==='sensible'){ advance=1; cost=-50; energy=-8;  timeCost=1; detail='Ã¢â‚¬Å“LetÃ¢â‚¬â„¢s grab a cheap regional train.Ã¢â‚¬Â'; }
      else if(type==='whimsical'){ advance=1; cost=-40; energy=-22; timeCost=2; detail='Ã¢â‚¬Å“Rent a tandem bike across the hills!Ã¢â‚¬Â'; }
      else if(type==='lucky'){ advance=2; cost=0;   energy=-8;  timeCost=1; detail='Ã¢â‚¬Å“Free carpool! We can skip a stop.Ã¢â‚¬Â'; }
      else { advance=0; cost=-20; energy=-15; timeCost=1; detail='Ã¢â‚¬Å“Quick detour to see a giant spoon!Ã¢â‚¬Â (doesnÃ¢â‚¬â„¢t advance)'; }
      const target = nextCity(advance);
      return { key:'coco', label:`Follow Coco Ã¢â€ â€™ ${target}`, detail, cost, energy, time:timeCost, advance, type };
    }

    function baseTravelOptions(){
      const jump2 = Math.min(2, game.routeCities.length-1 - game.routeIndex);
      return [
        { key:'flight', label:`Ã¢Å“Ë†Ã¯Â¸Â Flight Ã¢â€ â€™ ${nextCity(jump2)}`, detail:'-Ã‚Â£120, -20 energy, saves a day', cost:-120, energy:-20, time:0, advance:jump2 },
        { key:'train',  label:`Ã°Å¸Å¡â€  Train Ã¢â€ â€™ ${nextCity(1)}`,      detail:'-Ã‚Â£70, -10 energy, 1 day',        cost:-70,  energy:-10, time:1, advance:1 },
        { key:'bus',    label:`Ã°Å¸Å¡Å’ Bus Ã¢â€ â€™ ${nextCity(1)}`,        detail:'-Ã‚Â£30, -15 energy, 1 day',        cost:-30,  energy:-15, time:1, advance:1 },
        { key:'walk',   label:`Ã°Å¸Å¡Â¶ Walk Ã¢â€ â€™ ${nextCity(1)}`,       detail:'Ã‚Â£0, -25 energy, 2 days',         cost:0,    energy:-25, time:2, advance:1 },
      ];
    }

    const stayOptions = [
      { key:'hotel',  label:'Ã°Å¸ÂÂ¨ Hotel',    cost:-80, energy:+30, mood:0,  detail:'-Ã‚Â£80, +30 energy' },
      { key:'hostel', label:'Ã°Å¸â€ºÂÃ¯Â¸Â Hostel',   cost:-40, energy:+20, mood:0,  detail:'-Ã‚Â£40, +20 energy' },
      { key:'camp',   label:'Ã¢â€ºÂº Camping',  cost:-10, energy:+10, mood:-5, detail:'-Ã‚Â£10, +10 energy, -5 mood' },
      { key:'nosleep',label:'Ã°Å¸ËœÂµ No sleep', cost:0,   energy:-10, mood:-10,detail:'Ã‚Â£0, -10 energy, -10 mood' },
    ];

    const foodOptions = [
      { key:'restaurant', label:'Ã°Å¸ÂÂ½Ã¯Â¸Â Restaurant', cost:-30, energy:+15, mood:+5, detail:'-Ã‚Â£30, +15 energy, +5 mood' },
      { key:'fast',       label:'Ã°Å¸Ââ€ Fast food',  cost:-15, energy:+10, mood:0,  detail:'-Ã‚Â£15, +10 energy' },
      { key:'snack',      label:'Ã°Å¸Â¥Â¨ Snacks',     cost:-5,  energy:+5,  mood:0,  detail:'-Ã‚Â£5, +5 energy' },
      { key:'nomeal',     label:'Ã°Å¸Å¡Â« No meal',    cost:0,   energy:-10, mood:-5, detail:'Ã‚Â£0, -10 energy, -5 mood' },
    ];

    // Random event
    function randomEvent(){
      if(!chance(0.2)) return null;
      const events = [
        { label:'Lost item',      effect:()=>{ game.money=Math.max(0,game.money-20);         return 'You lost an item: -Ã‚Â£20.'; } },
        { label:'Friendly local', effect:()=>{ game.energy=clamp(game.energy+20,0,100);      return 'A friendly local hosted you: +20 energy.'; } },
        { label:'Illness',        effect:()=>{ game.energy=Math.max(0,game.energy-15);       return 'You felt unwell today: -15 energy.'; } },
        { label:'Festival',       effect:()=>{ game.money=Math.max(0,game.money-15); game.mood=clamp(game.mood+10,0,100); return 'Festival day! -Ã‚Â£15, +10 mood.'; } },
        { label:'Scam',           effect:()=>{ game.money=Math.max(0,game.money-30);         return 'Oops, a travel scam: -Ã‚Â£30.'; } },
        { label:'Shortcut',       effect:()=>{ game.time=Math.max(0,game.time+1);            return 'You discovered a shortcut: +1 day.'; } },
      ];
      return pick(events);
    }

    // CSV export
    function exportCSV(){
      const header = ['Day','Phase','Action','From','To','Money','Time','Energy','Mood'];
      const rows = [header, ...game.csvRows];
      const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'travel_with_coco_log.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    // Screens
    function screenStart(){
      const presetOptions = Object.keys(ROUTE_PRESETS).map(name=>`<option value="${name}">${name}</option>`).join('');
      app.innerHTML = html`
        <div class="card">
          <h2>Set up your journey</h2>
          <div class="row" style="gap:8px;align-items:end">
            <label>Choose a preset<br>
              <select id="presetSel" class="btn chip">${presetOptions}</select>
            </label>
            <label>or edit milestones (comma-separated)<br>
              <input id="routeStr" style="min-width:520px" value="${game.routeCities.join(', ')}" aria-label="Route cities">
            </label>
            <label>Days<br><input id="days" type="number" min="3" max="20" value="${game.time}" aria-label="Time in days"></label>
            <label>Money (Ã‚Â£)<br><input id="cash" type="number" min="50" max="1000" value="${game.money}" aria-label="Starting money"></label>
          </div>
          <div class="toolbar">
            <div class="muted">First city = start Ã¢â‚¬Â¢ Last city = destination</div>
            <div class="right"><button class="btn primary" id="startBtn">Start Game</button></div>
          </div>
        </div>
      `;
      const presetSel = document.getElementById('presetSel');
      presetSel.value = 'UK Ã¢â€ â€™ Italy (City Hop)';
      presetSel.onchange = ()=>{
        const name = presetSel.value; game.routeCities = [...ROUTE_PRESETS[name]];
        document.getElementById('routeStr').value = game.routeCities.join(', ');
      };
      document.getElementById('startBtn').onclick = ()=>{
        const parts = (document.getElementById('routeStr').value||'').split(',').map(s=>s.trim()).filter(Boolean);
        if(parts.length>=2){ game.routeCities = parts; }
        game.routeIndex = 0; game.day = 1; game.csvRows = [];
        game.time = parseInt(document.getElementById('days').value)||5;
        game.money = parseInt(document.getElementById('cash').value)||200;
        game.energy = 100; game.mood = 50;
        game.phase='travel';
        game.log = [{type:'start', msg:`Start at ${startCity()} Ã¢â€ â€™ ${destination()}`}];
        updateDash();
        screenTravel();
      };
    }

    function screenTravel(){
      if(checkEnd()) return;
      const options = baseTravelOptions();
      const coco = genCocoSuggestion();
      game.lastCoco = coco;

      app.innerHTML = html`
        <div class="card">
          <div class="toolbar">
            <div>${progressBar()}</div>
            <div class="right"><button class="btn chip" id="btnExport">Ã¢Â¬â€¡Ã¯Â¸Â Download CSV</button></div>
          </div>
          <h2 style="margin-top:8px">Day ${game.day} Ã¢â‚¬â€ Travel choices</h2>
          <p><strong>Current:</strong> ${currentCity()} Ã¢â€ â€™ <strong>Goal:</strong> ${destination()}</p>

          <!-- Coco FIRST -->
          <div class="choice" ${!coco?'aria-disabled="true"':''} style="border:2px solid #dbeafe;background:#eff6ff">
            <div>Ã°Å¸ÂÂ¦</div>
            <div>
              <h4 style="margin:0 0 6px 0">Coco says:</h4>
              <div>${coco ? coco.detail : '<em>Coco is sulkingÃ¢â‚¬Â¦ no suggestions today.</em>'}</div>
              ${coco ? html`<small class="muted">Effect if followed: ${fmtTravel(coco)}</small>` : ''}
              ${coco ? html`<div style="margin-top:8px" class="row"><button class="btn" id="btnCoco">${coco.label}</button></div>` : ''}
            </div>
          </div>

          <div class="hr"></div>
          <h3 style="margin-top:0">Other options</h3>
          <div id="choices"></div>
        </div>
      `;

      document.getElementById('btnExport').onclick = exportCSV;

      const list = document.getElementById('choices');
      options.forEach(o=>{
        const div = document.createElement('div');
        div.className='choice';
        div.innerHTML = `
          <div>Ã°Å¸Â§Â­</div>
          <div>
            <h4>${o.label}</h4>
            <div>${o.detail}</div>
            <small class="muted">Effect: ${fmtTravel(o)}</small>
            <div style="margin-top:8px" class="row"><button class="btn" data-key="${o.key}">Choose ${o.label}</button></div>
          </div>`;
        list.appendChild(div);
      });

      list.querySelectorAll('button[data-key]').forEach(btn=>{
        btn.onclick = ()=>applyTravel(options.find(o=>o.key===btn.dataset.key), false);
      });
      if(coco){ document.getElementById('btnCoco').onclick = ()=>applyTravel(coco,true); }
    }

    function fmtTravel(o){
      const toCity = nextCity(o.advance||1);
      const days = `${o.time} day${o.time!==1?'s':''}`;
      const cost = `${o.cost<0?o.cost:'+'+o.cost}Ã‚Â£`;
      return `${cost}, ${o.energy} energy, ${days}, Ã¢â€ â€™ ${toCity}`;
    }

    function pushCsvRow(phase, action, from, to){
      game.csvRows.push([game.day, phase, action, from, to, game.money, game.time, game.energy, game.mood]);
    }

    function applyTravel(opt, isCoco){
      if(game.lastCoco){
        if(isCoco){ game.mood = clamp(game.mood+10,0,100); game.followedCocoCount++; }
        else { game.mood = clamp(game.mood-5,0,100); game.ignoredCocoCount++; }
      }
      const priorCity = currentCity();
      game.money = Math.max(0, game.money + (opt.cost||0));
      game.energy = clamp(game.energy + (opt.energy||0), 0, 100);
      game.time   = Math.max(0, game.time - (opt.time||0));
      game.routeIndex = Math.min(game.routeIndex + (opt.advance||1), game.routeCities.length-1);
      const newCity = currentCity();

      pushCsvRow('travel', (isCoco?`Coco: ${opt.label}`:opt.label), priorCity, newCity);
      game.log.push({type:'travel', msg:`Day ${game.day}: ${isCoco?'Coco':'Player'} chose ${opt.label} (${fmtTravel(opt)}) Ã¢â‚¬â€ ${priorCity} Ã¢â€ â€™ ${newCity}`});
      updateDash();
      if(checkEnd()) return;
      game.phase='stay'; screenStay();
    }

    function screenStay(){
      if(checkEnd()) return;
      app.innerHTML = html`
        <div class="card">
          <div class="toolbar"><div>${progressBar()}</div><div class="right"><button class="btn chip" id="btnExport">Ã¢Â¬â€¡Ã¯Â¸Â Download CSV</button></div></div>
          <h2>Evening Ã¢â‚¬â€ Where will you stay?</h2>
          <div id="stayList"></div>
        </div>
      `;
      document.getElementById('btnExport').onclick = exportCSV;
      const list=document.getElementById('stayList');
      stayOptions.forEach(s=>{
        const div=document.createElement('div');
        div.className='choice';
        div.innerHTML = `
          <div>Ã°Å¸â€ºÅ½Ã¯Â¸Â</div>
          <div>
            <h4>${s.label}</h4>
            <div>${s.detail}</div>
            <div style="margin-top:8px" class="row"><button class="btn" data-key="${s.key}">Choose ${s.label}</button></div>
          </div>`;
        list.appendChild(div);
      });
      list.querySelectorAll('button[data-key]').forEach(btn=>{
        btn.onclick=()=>{
          const s = stayOptions.find(x=>x.key===btn.dataset.key);
          game.money = Math.max(0, game.money + s.cost);
          game.energy = clamp(game.energy + s.energy, 0, 100);
          game.mood = clamp(game.mood + (s.mood||0), 0, 100);
          pushCsvRow('stay', s.label, currentCity(), currentCity());
          game.log.push({type:'stay', msg:`Stayed: ${s.label} (${s.detail})`});
          updateDash();
          if(checkEnd()) return;
          game.phase='food'; screenFood();
        };
      });
    }

    function screenFood(){
      app.innerHTML = html`
        <div class="card">
          <div class="toolbar"><div>${progressBar()}</div><div class="right"><button class="btn chip" id="btnExport">Ã¢Â¬â€¡Ã¯Â¸Â Download CSV</button></div></div>
          <h2>Food Ã¢â‚¬â€ Refuel?</h2>
          <div id="foodList"></div>
          <div class="row" style="margin-top:8px"><button class="btn ghost" id="skipFood">Skip food phase</button></div>
        </div>
      `;
      document.getElementById('btnExport').onclick = exportCSV;
      const list=document.getElementById('foodList');
      foodOptions.forEach(f=>{
        const div=document.createElement('div');
        div.className='choice';
        div.innerHTML = `
          <div>Ã°Å¸ÂÂ½Ã¯Â¸Â</div>
          <div>
            <h4>${f.label}</h4>
            <div>${f.detail}</div>
            <div style="margin-top:8px" class="row"><button class="btn" data-key="${f.key}">Choose ${f.label}</button></div>
          </div>`;
        list.appendChild(div);
      });
      list.querySelectorAll('button[data-key]').forEach(btn=>{
        btn.onclick=()=>{
          const f = foodOptions.find(x=>x.key===btn.dataset.key);
          game.money = Math.max(0, game.money + f.cost);
          game.energy = clamp(game.energy + f.energy, 0, 100);
          game.mood = clamp(game.mood + (f.mood||0), 0, 100);
          pushCsvRow('food', f.label, currentCity(), currentCity());
          game.log.push({type:'food', msg:`Ate: ${f.label} (${f.detail})`});
          updateDash(); if(checkEnd()) return; nextDayEvent();
        };
      });
      document.getElementById('skipFood').onclick=()=>{ pushCsvRow('food','Skip', currentCity(), currentCity()); nextDayEvent(); };
    }

    function nextDayEvent(){
      const ev = randomEvent();
      let note = 'No events today.'; if(ev){ note = ev.effect(); }
      game.log.push({type:'event', msg: note});
      pushCsvRow('event', note, currentCity(), currentCity());
      updateDash(); if(checkEnd()) return;
      if(game.routeIndex >= game.routeCities.length-1){ endGame(true); return; }
      game.day += 1; game.phase='travel'; screenTravel();
    }

    function checkEnd(){
      if(game.routeIndex >= game.routeCities.length-1){ endGame(true); return true; }
      if(game.money<=0){ endGame(false,'You ran out of money.'); return true; }
      if(game.time<=0){ endGame(false,'You ran out of time.'); return true; }
      if(game.energy<=0){ endGame(false,'You collapsed from exhaustion.'); return true; }
      return false;
    }

    function endGame(win, reason=''){
      game.phase='end';
      const score = (win?50:0) + game.money + game.energy + game.time + (game.mood>=80?10:0) - (game.mood<20?10:0);
      const story = game.log.map(l=>`Ã¢â‚¬Â¢ ${l.msg}`).join('\n');
      const routeStr = `${startCity()} Ã¢â€ â€™ ${destination()}`;
      const arrived = game.routeIndex >= game.routeCities.length-1;
      const title = win && arrived ? 'Ã°Å¸Å½â€° You arrived!' : (win ? 'Ã°Å¸Å½â€° Progress complete' : 'Ã°Å¸â€™Â¥ Trip over');
      const summary = win && arrived ? 'Destination reached.' : (win ? 'Route milestones cleared.' : reason);

      app.innerHTML = html`
        <div class="card">
          <div class="toolbar"><div>${progressBar()}</div><div class="right"><button class="btn chip" id="btnExport">Ã¢Â¬â€¡Ã¯Â¸Â Download CSV</button></div></div>
          <h2>${title}</h2>
          ${summary?html`<p class="muted">${summary}</p>`:''}
          <p><strong>Route:</strong> ${routeStr}</p>
          <p><strong>Final resources:</strong> Ã‚Â£${game.money}, ${game.time} day(s), ${game.energy} energy, mood ${game.mood}</p>
          <p><strong>Coco followed:</strong> ${game.followedCocoCount} time(s). Ignored: ${game.ignoredCocoCount}.</p>
          <p><strong>Score:</strong> ${score}</p>
          <details style="margin-top:8px"><summary>Trip Story (log)</summary><pre style="white-space:pre-wrap;background:#fafafa;border:1px solid var(--border);padding:10px;border-radius:12px">${story}</pre></details>
          <div class="row" style="margin-top:12px">
            <button class="btn" id="restart">Play again</button>
          </div>
        </div>
      `;
      document.getElementById('btnExport').onclick = exportCSV;
      document.getElementById('restart').onclick = ()=>{ game.phase='start'; screenStart(); updateDash(); };
    }

    // Init
    updateDash();
    screenStart();
  </script>
<section id="clinician-notes">
<div style="background: var(--surface); border: 1px solid var(--line); border-radius: 12px; box-shadow: var(--shadow); padding: 16px; margin-top: 24px;">
<label for="clinician-comment" style="display:block;font-weight:600;margin-bottom:8px;">
      Clinician comments (optional)
    </label>
<textarea id="clinician-comment" placeholder="Enter any notes relevant to this session..." rows="4" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--line); font: inherit; resize: vertical;"></textarea>
<p style="margin:8px 0 0; color: var(--muted); font-size: 0.9rem;">
      This note will be added as <code>clinician_comment</code> in the exported CSV.
    </p>
</div>
</section></main></body>
</html>

