<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emergency Dispatch ‚Äî Executive Function Trainer</title>

  <!-- Theme + shared frame (same setup as Barista / Audio Errands) -->
  <meta name="theme" content="bold dense" />
  <meta name="app-slug" content="emergency-despatch" />
  <!-- Fallbacks if catalog.json lacks this slug -->
  <meta name="app-title" content="Emergency Dispatch" />
  <meta name="app-desc"  content="Route the correct unit to each incident while following a single active restriction rule." />

  <link rel="stylesheet" href="/micro-apps-repository/docs/shared/theme.css" />
  <script defer src="/micro-apps-repository/docs/shared/frame.js"></script>
  <script defer src="/micro-apps-repository/docs/shared/clinician_feedback.js"></script>

  <style>
    /* App-specific visuals (kept lean; uses theme tokens) */
    .panel{
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      min-height: 0;
    }
    .section-title{
      margin: 6px 0 8px;
      font-size: 0.85rem;
      letter-spacing: .2px;
      color: var(--muted);
      text-transform: uppercase;
      font-weight: 800;
    }
    .rule-card{
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .rule-card.active{ outline: 2px solid color-mix(in oklab, var(--accent), white 70%); }

    .mem{ display:flex; gap:6px; flex-wrap:wrap; margin-top:10px }
    .chip{
      background:#f2f4f7; border:1px solid var(--line); border-radius:999px; padding:6px 10px;
      font-size:12px; color:#111827;
    }
    @media (prefers-color-scheme: dark){
      .chip{ background:#1f2937; color:#e5e7eb; }
    }

    /* Map */
    .map{
      position:relative; height:560px; min-height:360px;
      background: radial-gradient(1000px 380px at 50% 25%, #fafafa 0%, #f2f4f8 60%, #eef2f6 100%);
      border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;
    }
    .grid-box{
      position:absolute; inset:8% 12%;
      border:2px dashed var(--accent-600); border-radius:16px; pointer-events:none;
      box-shadow:0 0 0 2px color-mix(in oklab, var(--accent), white 80%) inset;
    }
    #mapLayer{ position:absolute; inset:8% 12%; }
    .compass{
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#fff; font-size:12px; color:var(--muted);
    }
    .district{
      position:absolute; font-weight:900; letter-spacing:1.5px; padding:6px 10px; border-radius:10px;
      background:#ffffffcc; border:1px solid var(--line); user-select:none; pointer-events:none;
      font-size:14px; color:#111827;
    }
    .district.n{ top:4%; left:50%; transform:translateX(-50%) }
    .district.s{ bottom:4%; left:50%; transform:translateX(-50%) }
    .district.w{ left:6%; top:50%; transform:translateY(-50%) rotate(-90deg) }
    .district.e{ right:6%; top:50%; transform:translateY(-50%) rotate(90deg) }

    .incident{
      position:absolute; transform:translate(-50%,-50%); padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      display:flex; gap:8px; align-items:center; font-size:13px; background:#fff; box-shadow:var(--shadow);
    }
    .incident.med{ outline:2px solid #67e8f9 }
    .incident.fire{ outline:2px solid #facc15 }
    .incident.pol{ outline:2px solid #93c5fd }
    .incident.selected{ box-shadow:0 0 0 3px color-mix(in oklab, var(--accent), white 70%), var(--shadow) }
    .pulse{ position:absolute; inset:-6px; border-radius:999px; border:2px solid rgba(0,0,0,.12); animation:pulse 1.4s infinite }
    @keyframes pulse{ 0%{transform:scale(.82);opacity:.55} 70%{transform:scale(1.2);opacity:.06} 100%{transform:scale(1.28);opacity:0} }

    /* Right panel */
    .stats{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:12px; }
    .stat{ background:#f2f4f7; border:1px solid var(--line); border-radius:12px; padding:10px; text-align:center; }
    .stat strong{ display:block; margin-top:4px; font-size:18px }
    @media (prefers-color-scheme: dark){ .stat{ background:#1f2937; } }

    .inc-list .row{
      background:#fff; border:1px solid var(--line); border-radius:12px; padding:10px; margin-bottom:10px;
      display:grid; grid-template-columns:1fr auto; gap:8px;
    }
    .row.selected{ box-shadow:0 0 0 3px color-mix(in oklab, var(--accent), white 70%) }
    .tag{
      display:inline-block; font-size:11px; background:#f2f4f7; border:1px solid var(--line);
      padding:2px 8px; border-radius:999px; margin-left:6px;
    }
    .meta{ font-size:12px; color:var(--muted); margin-top:4px }

    /* Responsive grid: same pattern as other apps via theme grid helpers */
    .layout{ display:grid; gap: clamp(12px,1.2vw,18px); grid-template-columns: 300px 1fr 320px; }
    @media (max-width: 1050px){ .layout{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <!-- The hero banner is injected above via frame.js based on app-slug/title/desc -->

  <main id="app-root">
    <!-- Collapsible controls + instructions (like the other apps) -->
    <details class="toolbar">
      <summary><strong>Session controls & instructions</strong></summary>
      <div class="pill">Level: <span id="level">1</span></div>
      <div class="pill">Score: <span id="score">0</span></div>
      <div class="pill">Time: <span id="timer">03:00</span></div>
      <button class="button primary" id="startBtn">Start New Shift</button>
      <button class="button" id="pauseBtn" disabled>Pause</button>
      <button class="button" id="downloadBtn" disabled>Download CSV</button>
      <div class="helper" style="width:100%;margin-top:6px">
        Baseline: match <em>incident type</em> to the <em>correct unit</em> (ü©∫‚Üíüöë ‚Ä¢ üî•‚Üíüöí ‚Ä¢ üö®‚Üíüöì).
        Exactly one restriction is active at any time: <span class="pill" id="rulePill">‚Äî</span>
      </div>
    </details>

    <!-- Three-panel layout -->
    <div class="layout">
      <!-- Left: Briefing & WM -->
      <section class="panel">
        <div class="section-title">Briefing</div>
        <div class="rule-card">
          <strong>Baseline</strong><br/>
          Match <em>incident type</em> to the <em>correct unit</em>: ü©∫ Medical ‚Üí Ambulance ‚Ä¢ üî• Fire ‚Üí Fire ‚Ä¢ üö® Police ‚Üí Police.
        </div>
        <div class="rule-card active" id="activeRuleCard">
          <strong>Active Restriction (Single)</strong>
          <div id="activeRuleText" style="margin-top:6px; color:var(--muted);">‚Äî</div>
        </div>
        <div class="rule-card">
          <strong>Session</strong>
          <div style="margin-top:6px; color:var(--muted);">
            3 minutes. Ends early if more than 8 incidents are pending. Incidents spawn <em>inside the dashed square</em>.
          </div>
        </div>

        <div class="section-title">Working Memory</div>
        <div class="mem" id="wmBar"></div>
      </section>

      <!-- Center: Map -->
      <section class="map">
        <div class="grid-box" id="grid"></div>
        <div class="district n">NORTH</div>
        <div class="district s">SOUTH</div>
        <div class="district w">WEST</div>
        <div class="district e">EAST</div>
        <div class="compass">N ‚Ä¢ E ‚Ä¢ S ‚Ä¢ W</div>
        <div id="mapLayer"></div>
      </section>

      <!-- Right: Incidents & Controls -->
      <section class="panel">
        <div class="stats">
          <div class="stat"><div>Success</div><strong id="success">--%</strong></div>
          <div class="stat"><div>Resolved</div><strong id="resolved">0</strong></div>
          <div class="stat"><div>Errors</div><strong id="errors">0</strong></div>
        </div>

        <div class="section-title">Incidents</div>
        <div class="inc-list" id="incList"></div>

        <div class="section-title">Dispatch</div>
        <div class="grid cols-2">
          <button class="button" id="btnAmb" disabled>üöë Ambulance</button>
          <button class="button" id="btnFire" disabled>üöí Fire</button>
          <button class="button" id="btnPol" disabled>üöì Police</button>
          <button class="button primary" id="btnHold" disabled>‚è≥ Hold</button>
        </div>

        <p class="helper" style="margin-top:10px">
          <span class="pill">Executive Skills: Working Memory ‚Ä¢ Flexibility ‚Ä¢ Inhibition</span>
        </p>
      </section>
    </div>

    <!-- Results modal -->
    <div class="note-card" id="resultModal" style="display:none; position:fixed; inset:0; background:rgba(17,24,39,.45); align-items:center; justify-content:center; z-index:50;">
      <div class="panel" style="max-width:560px; width:92%; margin:auto;">
        <h3 id="resultTitle" style="margin-top:0">Shift Complete</h3>
        <p id="resultBody"></p>
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px">
          <button class="button" id="closeModal">Close</button>
          <button class="button primary" id="nextLevel">Next Level</button>
        </div>
      </div>
    </div>
  </main>

  <script>
  // ===== Types & Data =====
  const TYPES = {
    med: {label:'Medical', icon:'ü©∫', needs:'ambulance'},
    fire:{label:'Fire',    icon:'üî•', needs:'fire'},
    pol: {label:'Police',  icon:'üö®', needs:'police'}
  };

  // Single-restriction pool (directional)
  const RESTRICTION_POOL = [
    {unit:'police', dir:'NORTH'}, {unit:'police', dir:'SOUTH'}, {unit:'police', dir:'EAST'}, {unit:'police', dir:'WEST'},
    {unit:'fire', dir:'NORTH'},   {unit:'fire', dir:'SOUTH'},   {unit:'fire', dir:'EAST'},   {unit:'fire', dir:'WEST'},
    {unit:'ambulance', dir:'NORTH'},{unit:'ambulance', dir:'SOUTH'},{unit:'ambulance', dir:'EAST'},{unit:'ambulance', dir:'WEST'}
  ];

  // ===== State =====
  let S = {
    running:false, paused:false,
    level:1, score:0, time:180,
    incidents:[], selected:null, resolved:0, errors:0,
    restriction:null,    // <-- single active restriction
    wm:[],
    log:[],
    spawnProb:0.50,
    ttlFactor:1.20,
    maxOpen:8
  };

  let loops = {tick:null, spawner:null};

  // ===== DOM =====
  const el = id => document.getElementById(id);
  const d = {
    level: el('level'), score: el('score'), timer: el('timer'),
    startBtn: el('startBtn'), pauseBtn: el('pauseBtn'), downloadBtn: el('downloadBtn'),
    wmBar: el('wmBar'),
    mapLayer: el('mapLayer'),
    incList: el('incList'), success: el('success'), resolved: el('resolved'), errors: el('errors'),
    btnAmb: el('btnAmb'), btnFire: el('btnFire'), btnPol: el('btnPol'), btnHold: el('btnHold'),
    modal: el('resultModal'), resultTitle: el('resultTitle'), resultBody: el('resultBody'),
    closeModal: el('closeModal'), nextLevel: el('nextLevel'),
    activeRuleText: el('activeRuleText'),
    rulePill: document.getElementById('rulePill')
  };

  // ===== Helpers =====
  const rnd = (a,b)=>Math.random()*(b-a)+a;
  const pick = arr => arr[Math.floor(Math.random()*arr.length)];
  const fmt = s=>{const m=Math.floor(s/60), x=s%60; return `${String(m).padStart(2,'0')}:${String(x).padStart(2,'0')}`};
  const cap = s=>s.charAt(0).toUpperCase()+s.slice(1);

  function pushWM(text){
    S.wm.push(text);
    const capLen = 4 + S.level; if(S.wm.length>capLen) S.wm.shift();
    renderWM();
  }

  // Ensure map layer sized before spawn
  function whenMapReady(cb, tries=0){
    const rect = d.mapLayer.getBoundingClientRect();
    if(rect.width>50 && rect.height>50){ cb(rect); return; }
    if(tries>40){ cb({width:500, height:360}); return; }
    requestAnimationFrame(()=>whenMapReady(cb, tries+1));
  }

  // ===== Restriction (single) =====
  function chooseSingleRestriction(prev){
    let r = pick(RESTRICTION_POOL);
    for(let i=0;i<10 && prev && r.unit===prev.unit && r.dir===prev.dir;i++){
      r = pick(RESTRICTION_POOL);
    }
    S.restriction = r;
    const text = `üö´ No ${cap(r.unit)} in ${r.dir}`;
    d.activeRuleText.textContent = text;
    if (d.rulePill) d.rulePill.textContent = text;
  }

  function violatesRestriction(kind, inc){
    const r = S.restriction; if(!r) return null;
    if(r.unit === kind && (inc.NS===r.dir || inc.EW===r.dir)){
      return `No ${cap(r.unit)} in ${r.dir}`;
    }
    return null;
  }

  function neededIsRestricted(inc){
    const r = S.restriction; if(!r) return false;
    const needs = TYPES[inc.type].needs;
    return (r.unit === needs) && (inc.NS===r.dir || inc.EW===r.dir);
  }

  // ===== Incidents =====
  function spawnIncident(){
    if(!S.running) return;
    whenMapReady((rect)=>{
      const x = rnd(16, rect.width-16);
      const y = rnd(16, rect.height-16);
      const typeKey = pick(['med','fire','pol']);

      const NS = (y < rect.height/2) ? 'NORTH' : 'SOUTH';
      const EW = (x < rect.width/2) ? 'WEST'  : 'EAST';
      const zone = `${NS}-${EW}`;

      const baseTTL = {med:30, fire:36, pol:33}[typeKey];
      const ttl = Math.round(baseTTL * S.ttlFactor);
      const id = 'inc_'+Math.random().toString(36).slice(2);
      const inc = {id, type:typeKey, label:`${TYPES[typeKey].icon} ${TYPES[typeKey].label}`, x, y, ttl, status:'open', zone, NS, EW};

      S.incidents.push(inc);
      mountIncident(inc);
      logEvent('spawn', inc);

      if(S.incidents.length > S.maxOpen){ stop('Overload: too many open incidents'); }
    });
  }

  function mountIncident(inc){
    const node = document.createElement('div');
    node.className = `incident ${inc.type}`;
    node.id = inc.id;
    node.style.left = inc.x+'px';
    node.style.top = inc.y+'px';
    node.innerHTML = `<span class="pulse"></span><span>${inc.label}</span>`;
    node.addEventListener('click',()=>selectIncident(inc.id));
    d.mapLayer.appendChild(node);
    renderIncList();
  }

  function unmountIncident(id){
    const n = document.getElementById(id); if(n) n.remove();
    renderIncList();
  }

  function selectIncident(id){
    S.selected = id;
    document.querySelectorAll('.row').forEach(r=>r.classList.toggle('selected', r.dataset.id===id));
    document.querySelectorAll('.incident').forEach(n=>n.classList.toggle('selected', n.id===id));
    updateButtons();
  }

  // ===== Dispatch & Controls =====
  function dispatch(kind){
    const inc = S.incidents.find(i=>i.id===S.selected);
    if(!inc) return;
    const needs = TYPES[inc.type].needs;

    const ruleMsg = violatesRestriction(kind, inc);
    if(ruleMsg){
      S.errors++; S.score = Math.max(0, S.score-3);
      pushWM('Rule violated: '+ruleMsg);
      logEvent('error:rule', inc, {rule:ruleMsg, attempted:kind});
      updateAll();
      return;
    }

    const correct = (kind===needs);
    if(!correct){
      S.errors++; S.score = Math.max(0, S.score-5);
      pushWM('Error: wrong unit');
      logEvent('error:wrong', inc, {attempted:kind});
    } else {
      S.score += 20; S.resolved++;
      pushWM(`Handled: ${inc.label}`);
      logEvent('dispatch:'+kind, inc);
      S.incidents = S.incidents.filter(x=>x.id!==inc.id);
      unmountIncident(inc.id);
    }
    updateAll();
  }

  function hold(){
    const inc = S.incidents.find(i=>i.id===S.selected);
    if(!inc) return;
    inc.ttl += 8; inc.status='open';
    S.score += 3; pushWM(`Hold: ${inc.label}`); logEvent('dispatch:hold', inc);
    updateAll();
  }

  // ===== Timers / Session =====
  function start(){
    if(S.running) return;
    S.running=true; S.paused=false;
    d.startBtn.disabled=true; d.pauseBtn.disabled=false; d.downloadBtn.disabled=false;
    chooseSingleRestriction(S.restriction);

    whenMapReady(()=>{ for(let i=0;i<2;i++) spawnIncident(); });
    loops.tick = setInterval(()=>{ if(!S.paused){ advanceSecond(); } }, 1000);
    loops.spawner = setInterval(()=>{ if(!S.paused && Math.random()< S.spawnProb) spawnIncident(); }, 3000);
    updateAll();
  }

  function pause(){
    if(!S.running) return; S.paused=!S.paused; d.pauseBtn.textContent = S.paused? 'Resume' : 'Pause';
  }

  function stop(endTitle='Shift Ended'){
    S.running=false; S.paused=false;
    clearInterval(loops.tick); clearInterval(loops.spawner);
    d.startBtn.disabled=false; d.pauseBtn.disabled=true;
    d.resultTitle.textContent = endTitle;
    const success = successRate();
    d.resultBody.innerHTML = `
      <div><strong>Level:</strong> ${S.level}</div>
      <div><strong>Score:</strong> ${S.score}</div>
      <div><strong>Success:</strong> ${success}%</div>
      <div><strong>Resolved:</strong> ${S.resolved}</div>
      <div><strong>Errors:</strong> ${S.errors}</div>`;
    d.modal.style.display='flex';
    updateAll();
  }

  function forceStop(){
    clearInterval(loops.tick); clearInterval(loops.spawner);
    S.running=false; S.paused=false;
    d.pauseBtn.textContent='Pause'; d.pauseBtn.disabled=true; d.downloadBtn.disabled=true; d.startBtn.disabled=false;
    d.mapLayer.innerHTML=''; S.incidents=[];
  }

  function advanceSecond(){
    S.time--; if(S.time<=0){ stop('Time Up'); return; }

    for(const inc of [...S.incidents]){
      inc.ttl--;
      if(inc.ttl<=0){
        S.incidents = S.incidents.filter(x=>x.id!==inc.id);
        unmountIncident(inc.id);
        if(neededIsRestricted(inc)){
          pushWM(`Expired (restricted): ${inc.label}`);
          logEvent('expire:restricted', inc);
        } else {
          S.errors++; pushWM(`Missed: ${inc.label}`); logEvent('expire', inc);
        }
      }
    }

    if(S.incidents.length> S.maxOpen){ stop('Overload: too many open incidents'); return; }

    // Progression
    if(S.resolved && S.resolved % (5 + Math.floor(S.level/2)) === 0){
      S.level++; pushWM(`Level ${S.level}`);
      const prev = S.restriction; chooseSingleRestriction(prev);
    }

    // Pacing adapt
    const open = S.incidents.length; const succ = successRate();
    if(open>5 || succ<70){ S.spawnProb = 0.42; S.ttlFactor = 1.30; }
    else if(succ>85 && open<3){ S.spawnProb = 0.62; S.ttlFactor = 1.10; }
    else { S.spawnProb = 0.50; S.ttlFactor = 1.20; }

    updateAll();
  }

  // ===== Rendering =====
  function renderWM(){
    d.wmBar.innerHTML = '';
    for(const t of S.wm){
      const c = document.createElement('span'); c.className='chip'; c.textContent = t; d.wmBar.appendChild(c);
    }
  }

  function renderIncList(){
    d.incList.innerHTML='';
    const sorted = [...S.incidents].sort((a,b)=> a.ttl - b.ttl);
    for(const inc of sorted){
      const row = document.createElement('div'); row.className='row'; row.dataset.id = inc.id;
      row.innerHTML = `
        <div>
          <strong>${inc.label}</strong>
          <span class="tag">Needs: ${TYPES[inc.type].needs}</span>
          <span class="tag">Zone: ${inc.zone}</span>
          <div class="meta">TTL: ${inc.ttl}s ‚Ä¢ Status: ${inc.status}</div>
        </div>
        <div style="align-self:center; color:var(--muted); font-size:12px;">Select</div>`;
      row.addEventListener('click', ()=>selectIncident(inc.id));
      d.incList.appendChild(row);
    }
    if(S.selected && !S.incidents.find(i=>i.id===S.selected)) S.selected=null;
    updateButtons();
  }

  function updateButtons(){
    const has = !!S.selected;
    d.btnAmb.disabled=!has; d.btnFire.disabled=!has; d.btnPol.disabled=!has; d.btnHold.disabled=!has;
  }

  function successRate(){
    const total = S.resolved + S.errors; return total? Math.round((S.resolved/total)*100) : 100;
  }

  function updateAll(){
    d.level.textContent = S.level; d.score.textContent = S.score; d.timer.textContent = fmt(S.time);
    d.resolved.textContent = S.resolved; d.errors.textContent = S.errors; d.success.textContent = successRate()+"%";
    renderIncList();
  }

  // ===== Logging / CSV =====
  function logEvent(action, inc, extra={}){
    S.log.push({
      ts:new Date().toISOString(),
      level:S.level,
      timeLeft:S.time,
      action,
      type:inc?.type||'',
      incId:inc?.id||'',
      zone:inc?.zone||'',
      NS:inc?.NS||'',
      EW:inc?.EW||'',
      ...extra
    });
  }
  function toCSV(){
    const cols = ['ts','level','timeLeft','action','type','incId','zone','NS','EW','rule','attempted'];
    const lines = [cols.join(',')].concat(S.log.map(r=>
      cols.map(k=>String(r[k]??'').replaceAll('"','""'))
          .map(x=>/[,"\n]/.test(x)?`"${x}"`:x).join(',')
    ));
    return lines.join('\n');
  }
  function download(){
    const blob = new Blob([toCSV()], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `dispatch_log_level${S.level}.csv`;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  }

  // ===== Events =====
  d.startBtn.addEventListener('click', ()=>{
    if(S.running){ forceStop(); }
    reset(1); start();
  });
  d.pauseBtn.addEventListener('click', pause);
  d.downloadBtn.addEventListener('click', download);
  d.btnAmb.addEventListener('click', ()=>dispatch('ambulance'));
  d.btnFire.addEventListener('click', ()=>dispatch('fire'));
  d.btnPol.addEventListener('click',  ()=>dispatch('police'));
  d.btnHold.addEventListener('click', hold);

  d.closeModal.addEventListener('click', ()=>{ d.modal.style.display='none'; });
  d.nextLevel.addEventListener('click', ()=>{ d.modal.style.display='none'; reset(S.level+1); start(); });

  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') stop(); })

  // ===== Reset =====
  function reset(level=1){
    S.level=level;
    S.score=0; S.time=180;
    S.selected=null; S.resolved=0; S.errors=0;
    S.wm=[]; S.log=[];
    S.spawnProb = 0.50; S.ttlFactor = 1.20; S.maxOpen = 8;
    d.modal.style.display='none';
    d.mapLayer.innerHTML='';

    chooseSingleRestriction(S.restriction); // single rule
    renderWM(); updateAll();
  }

  // Init
  window.addEventListener('load', ()=>reset(1));
  </script>
</body>
</html>
