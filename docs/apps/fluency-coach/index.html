<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Fluency Coach — Strategy-Led Verbal Fluency</title>

  <!-- Shared assets -->
  <link rel="stylesheet" href="/micro-apps-repository/shared/theme.css?v=3">
  <script defer src="/micro-apps-repository/shared/frame.js?v=3"></script>
  <script defer src="/micro-apps-repository/shared/clinician_feedback.js?v=3"></script>

  <meta name="app-slug" content="fluency-coach">
  <meta name="app-title" content="Fluency Coach">
  <meta name="app-desc" content="Strategy-led verbal fluency with voice input, repetition detection, and end-of-session grouping.">
</head>
<body>
<main id="app-root">
  <div class="wrap">
    <div class="row cols-3">
      <div class="card">
        <h3>1) Setup</h3>
        <div class="flex">
          <label>Category
            <select id="category">
              <option value="animals">Animals</option>
              <option value="produce">Fruits &amp; Vegetables</option>
              <option value="tools">Tools &amp; Household Objects</option>
              <option value="jobs">Occupations</option>
              <option value="transport">Transportation Modes</option>
              <option value="emotions">Emotions</option>
            </select>
          </label>
          <label>Duration
            <select id="duration">
              <option>60</option><option>90</option><option>45</option><option>30</option><option>15</option>
            </select>
          </label>
          <label>Input
            <select id="inputMode">
              <option value="speech">Speech</option>
              <option value="manual">Manual</option>
            </select>
          </label>
        </div>
        <div class="notice small" id="speechWarn" style="display:none;margin-top:10px">
          Speech recognition unavailable. Use Chrome desktop with HTTPS, or choose Manual input.
        </div>
        <div class="strategy" id="strategyBox">
          <div class="small"><strong>Strategy coach</strong></div>
          <ul class="small" id="tips" style="padding-left:18px;margin:8px 0;"></ul>
        </div>
        <div class="flex" style="margin-top:8px;justify-content:space-between">
          <div class="status">
            <span class="tag ok">On-target: <span class="live" id="okCount">0</span></span>
            <span class="tag rep">Repetitions: <span class="live" id="repCount">0</span></span>
            <span class="tag off">Off-target: <span class="live" id="offCount">0</span></span>
          </div>
          <div class="live">Timer: <span id="timer">60</span>s</div>
        </div>
        <div class="flex" style="margin-top:8px">
          <button id="btnStart">Start</button>
          <button id="btnPause" disabled>Pause</button>
          <button id="btnStop" disabled>Stop</button>
          <button id="btnExport" disabled>Download CSV</button>
        </div>
        <div class="flex" id="manualBox" style="display:none;margin-top:8px">
          <input id="manualInput" placeholder="Type a word and press Enter…" type="text"/>
          <button id="btnAdd">Add</button>
        </div>
      </div>

      <div class="card">
        <h3>2) Live Responses</h3>
        <div class="grid hdr">
          <div>+Time</div><div>Word</div><div>Status</div><div>Override</div><div>Delete</div>
        </div>
        <div id="list"></div>
      </div>

      <div class="card">
        <h3>3) Strategy Grouping (end of session)</h3>
        <div class="small">When you press Stop, valid items are automatically grouped into sub-categories.</div>
        <div class="groups" id="groups" style="margin-top:10px"></div>
      </div>
    </div>
  </div>
</main>

<script>
/* === Minimal setup (shortened for clarity) === */

let recog=null, recogActive=false, session=[];
let t0=0, timerInt=null, remaining=60, paused=false;

function qs(s,root=document){return root.querySelector(s);}
const els = {
  category:qs('#category'), duration:qs('#duration'), inputMode:qs('#inputMode'),
  speechWarn:qs('#speechWarn'),
  ok:qs('#okCount'), rep:qs('#repCount'), off:qs('#offCount'), timer:qs('#timer'),
  start:qs('#btnStart'), pauseBtn:qs('#btnPause'), stopBtn:qs('#btnStop'), exportBtn:qs('#btnExport'),
  list:qs('#list'), manualBox:qs('#manualBox'), manualInput:qs('#manualInput'), btnAdd:qs('#btnAdd'),
  groups:qs('#groups')
};

/* Basic speech availability */
const canSpeech = ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) &&
                  (location.protocol === 'https:' || location.hostname==='localhost');
if(!canSpeech){ els.speechWarn.style.display='block'; els.inputMode.value='manual'; els.manualBox.style.display='flex'; }

els.inputMode.addEventListener('change', ()=>{ els.manualBox.style.display=(els.inputMode.value==='manual')?'flex':'none'; });
els.start.addEventListener('click', startSession);
els.pauseBtn.addEventListener('click', togglePause);
els.stopBtn.addEventListener('click', stopSession);
els.exportBtn.addEventListener('click', exportCSV);
els.btnAdd.addEventListener('click', ()=>addManual(els.manualInput.value));
els.manualInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){addManual(els.manualInput.value);} });

function startSession(){
  resetSession();
  remaining=parseInt(els.duration.value,10);
  els.timer.textContent=remaining;
  t0=performance.now();
  timerInt=setInterval(tick,1000);
  els.start.disabled=true; els.pauseBtn.disabled=false; els.stopBtn.disabled=false;
  if(els.inputMode.value==='speech' && canSpeech){ startRecog(); } else { els.manualInput.focus(); }
}
function togglePause(){
  if(paused){ timerInt=setInterval(tick,1000); paused=false; els.pauseBtn.textContent='Pause'; }
  else { clearInterval(timerInt); paused=true; els.pauseBtn.textContent='Resume'; }
}
function stopSession(){ clearInterval(timerInt); els.start.disabled=false; els.pauseBtn.disabled=true; els.stopBtn.disabled=true; els.exportBtn.disabled=false; }
function tick(){ if(!paused){ remaining--; els.timer.textContent=remaining; if(remaining<=0) stopSession(); } }

function startRecog(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recog=new SR(); recog.lang='en-GB'; recog.interimResults=true; recog.continuous=true;
  recog.onresult=(e)=>{ for(let i=e.resultIndex;i<e.results.length;i++){ if(e.results[i].isFinal){ handleInput(e.results[i][0].transcript); } } };
  recog.start(); recogActive=true;
}

function addManual(text){ if(!text.trim())return; handleInput(text); els.manualInput.value=''; els.manualInput.focus(); }
function handleInput(text){
  const row=document.createElement('div'); row.className='grid item';
  row.innerHTML='<div class="mono">+'+((performance.now()-t0)/1000).toFixed(1)+'s</div><div class="word">'+escapeHtml(text)+'</div><div>ok</div><div>-</div><div>-</div>';
  els.list.prepend(row);
}

function exportCSV(){
  const lines=['word,time']; 
  session.forEach(it=>lines.push(it.word+','+it.ts));
  const blob=new Blob([lines.join('\n')],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='fluency.csv'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

function resetSession(){ session=[]; els.list.innerHTML=''; els.ok.textContent='0'; els.rep.textContent='0'; els.off.textContent='0'; }
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
</script>
</body>
</html>
