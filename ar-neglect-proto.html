<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AR Neglect Scanner Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.2.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.js"></script>
  <style>
    :root {
      color-scheme: light;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --bg: rgba(18, 18, 20, 0.75);
      --panel-bg: rgba(255, 255, 255, 0.9);
      --accent: #2b7bff;
      --accent-dark: #1b53aa;
      --danger: #d7263d;
      --success: #2aa779;
      --pill: rgba(43, 123, 255, 0.15);
      --text-strong: #0e1726;
      --text-muted: #4a5568;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: #050505;
      color: #fff;
      overflow: hidden;
    }
    #primer, #hud, #hintToast, #protocolWarning {
      position: fixed;
      z-index: 9999;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      pointer-events: none;
    }
    #primer {
      top: 0;
      bottom: 0;
      align-items: center;
      padding: 24px;
      background: rgba(5, 5, 5, 0.92);
      flex-direction: column;
      text-align: center;
      gap: 16px;
      pointer-events: auto;
    }
    #primer h1 {
      margin: 0;
      font-size: 1.6rem;
    }
    #primer p {
      margin: 0;
      line-height: 1.45;
      color: #e7e7e7;
      max-width: 460px;
    }
    .card {
      background: var(--panel-bg);
      color: var(--text-strong);
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: auto;
    }
    .card ul {
      padding-left: 18px;
      margin: 0;
      text-align: left;
      color: var(--text-muted);
      font-size: 0.95rem;
    }
    button {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 12px 20px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: transform 0.1s ease, background 0.2s ease;
    }
    button:hover, button:focus-visible { background: var(--accent-dark); }
    button:active { transform: scale(0.97); }
    button.secondary {
      background: transparent;
      color: var(--accent);
      border: 2px solid var(--accent);
    }
    button.danger { background: var(--danger); }
    button.danger:hover, button.danger:focus-visible { background: #aa1d30; }
    button.success { background: var(--success); }
    #hud {
      top: 16px;
      pointer-events: none;
    }
    #hudContent {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      width: min(680px, calc(100vw - 24px));
    }
    .hud-card {
      background: var(--panel-bg);
      color: var(--text-strong);
      border-radius: 14px;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      pointer-events: auto;
    }
    .hud-card h2 {
      margin: 0;
      font-size: 0.75rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-muted);
    }
    .hud-card strong {
      font-size: 1.35rem;
      letter-spacing: 0.04em;
    }
    .pill {
      display: inline-flex;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--pill);
      color: var(--accent-dark);
      font-weight: 600;
      font-size: 0.85rem;
    }
    #controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    @media (min-width: 600px) {
      #controls { flex-direction: row; flex-wrap: wrap; }
      #controls button { flex: 1 1 calc(50% - 8px); }
    }
    #hintToast {
      bottom: 18px;
      justify-content: center;
      pointer-events: none;
    }
    #hintToast span {
      background: rgba(0, 0, 0, 0.7);
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 0.95rem;
      border: 1px solid rgba(255, 255, 255, 0.18);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    #hintToast strong { font-weight: 700; }
    #statusLine {
      font-size: 0.9rem;
      color: var(--text-muted);
    }
    #difficultyPicker {
      display: flex;
      gap: 8px;
    }
    #difficultyPicker label {
      flex: 1;
      background: rgba(43, 123, 255, 0.12);
      color: var(--accent-dark);
      border-radius: 12px;
      padding: 10px;
      cursor: pointer;
      border: 2px solid transparent;
      display: flex;
      flex-direction: column;
      gap: 4px;
      text-align: left;
    }
    #difficultyPicker input { display: none; }
    #difficultyPicker label span.title {
      font-weight: 700;
      font-size: 0.95rem;
    }
    #difficultyPicker label span.meta {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    #difficultyPicker input:checked + label {
      border-color: var(--accent);
      background: rgba(43, 123, 255, 0.22);
    }
    #protocolWarning {
      top: 0;
      padding: 12px;
      justify-content: center;
      display: none;
    }
    #protocolWarning span {
      background: #fffbcc;
      color: #6a5200;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 0.9rem;
      border: 1px solid #f3e48b;
    }
    a-scene { display: none; }
  </style>
</head>
<body>
  <div id="protocolWarning"><span>This prototype must be served over HTTPS (e.g., GitHub Pages). Camera access is blocked for file:// URLs.</span></div>
  <div id="primer">
    <div class="card">
      <h1>AR Neglect Scanner</h1>
      <p>Host this file on GitHub Pages (HTTPS), open it on Android Chrome or iOS Safari, allow the camera, and point at a Hiro marker to begin.</p>
      <ul>
        <li>Print or display the Hiro marker. <!-- Swap to custom .patt by editing the a-marker below. --></li>
        <li>Tap “Enable camera” and approve access.</li>
        <li>Choose a difficulty and tap Start once the marker is in view.</li>
      </ul>
      <button id="enableCamera">Enable camera</button>
      <div id="statusLine">Waiting for permission…</div>
      <button class="secondary" id="dismissPrimer">Continue without camera</button>
    </div>
  </div>
  <div id="hud" hidden>
    <div id="hudContent">
      <div class="hud-card">
        <h2>Timer</h2>
        <strong id="timer">00:00</strong>
      </div>
      <div class="hud-card">
        <h2>Left</h2>
        <strong id="leftScore">0 / 0</strong>
        <span class="pill">First left: <span id="firstLeft">—</span></span>
      </div>
      <div class="hud-card">
        <h2>Right</h2>
        <strong id="rightScore">0 / 0</strong>
      </div>
      <div class="hud-card">
        <h2>Remaining</h2>
        <strong id="remaining">0</strong>
      </div>
      <div class="hud-card" id="controls">
        <div id="difficultyPicker">
          <input type="radio" name="difficulty" value="easy" id="diffEasy" />
          <label for="diffEasy"><span class="title">Easy</span><span class="meta">5 per side, wide spread</span></label>
          <input type="radio" name="difficulty" value="standard" id="diffStandard" checked />
          <label for="diffStandard"><span class="title">Standard</span><span class="meta">8 per side</span></label>
          <input type="radio" name="difficulty" value="hard" id="diffHard" />
          <label for="diffHard"><span class="title">Hard</span><span class="meta">10 per side, tighter</span></label>
        </div>
        <button id="startBtn">Start session</button>
        <button id="resetBtn" class="secondary">Reset</button>
        <button id="downloadBtn" class="success" disabled>Download CSV</button>
        <button id="exitBtn" class="danger">Exit</button>
      </div>
    </div>
  </div>
  <div id="hintToast" hidden>
    <span id="hintText">Point at the Hiro marker…</span>
  </div>

  <a-scene
    id="scene"
    embedded
    vr-mode-ui="enabled: false"
    renderer="antialias: false; alpha: true; precision: mediump; powerPreference: high-performance"
    arjs="sourceType: webcam; sourceWidth: 640; sourceHeight: 480; videoTexture: true; facingMode: environment; detectionMode: mono; maxDetectionRate: 30;"
    cursor="rayOrigin: mouse"
  >
    <a-assets>
      <img id="starTexture" alt="star"
        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%%25' y1='0%%25' x2='0%%25' y2='100%%25'%3E%3Cstop offset='0%%25' stop-color='%23ffe75f'/%3E%3Cstop offset='100%%25' stop-color='%23ff9c2f'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpolygon fill='url(%23g)' stroke='%23c77b0a' stroke-width='6' points='60 6 75 45 117 45 83 70 97 113 60 87 23 113 37 70 3 45 45 45'/%3E%3C/svg%3E" />
    </a-assets>

    <!-- Swap to a custom marker by changing preset="hiro" to url="path/to/your-marker.patt" -->
    <a-marker id="hiroMarker" type="preset" preset="hiro">
      <a-entity id="starContainer"></a-entity>
    </a-marker>
    <a-entity camera position="0 0 0">
      <a-entity cursor="fuse: false; rayOrigin: mouse" raycaster="objects: .clickable; far: 20" position="0 0 -0.1"></a-entity>
    </a-entity>
  </a-scene>

  <script>
    (function() {
      const scene = document.getElementById('scene');
      const marker = document.getElementById('hiroMarker');
      const starContainer = document.getElementById('starContainer');
      const hud = document.getElementById('hud');
      const hintToast = document.getElementById('hintToast');
      const hintText = document.getElementById('hintText');
      const timerEl = document.getElementById('timer');
      const leftScoreEl = document.getElementById('leftScore');
      const rightScoreEl = document.getElementById('rightScore');
      const remainingEl = document.getElementById('remaining');
      const firstLeftEl = document.getElementById('firstLeft');
      const startBtn = document.getElementById('startBtn');
      const resetBtn = document.getElementById('resetBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const exitBtn = document.getElementById('exitBtn');
      const statusLine = document.getElementById('statusLine');
      const primer = document.getElementById('primer');
      const enableCameraBtn = document.getElementById('enableCamera');
      const dismissPrimerBtn = document.getElementById('dismissPrimer');
      const protocolWarning = document.getElementById('protocolWarning');

      if (location.protocol !== 'https:' && location.protocol !== 'http:') {
        protocolWarning.style.display = 'flex';
      }

      let streamPrimed = false;
      let timerInterval = null;
      let frameReq = null;

      const difficulties = {
        easy: {
          perSide: 5,
          spreadX: { left: [-0.55, -0.18], right: [0.18, 0.55] },
          spreadZ: [-0.35, 0.35],
          y: 0.08,
          scale: 0.35
        },
        standard: {
          perSide: 8,
          spreadX: { left: [-0.5, -0.16], right: [0.16, 0.5] },
          spreadZ: [-0.32, 0.32],
          y: 0.09,
          scale: 0.32
        },
        hard: {
          perSide: 10,
          spreadX: { left: [-0.42, -0.12], right: [0.12, 0.42] },
          spreadZ: [-0.28, 0.28],
          y: 0.1,
          scale: 0.28
        }
      };

      const state = {
        difficulty: 'standard',
        sessionActive: false,
        starsSpawned: false,
        startTime: null,
        elapsedMs: 0,
        leftFound: 0,
        rightFound: 0,
        leftTotal: 0,
        rightTotal: 0,
        remaining: 0,
        firstLeftMs: null,
        events: [],
        markerVisible: false
      };

      function updateHUD() {
        leftScoreEl.textContent = `${state.leftFound} / ${state.leftTotal}`;
        rightScoreEl.textContent = `${state.rightFound} / ${state.rightTotal}`;
        remainingEl.textContent = state.remaining;
        firstLeftEl.textContent = state.firstLeftMs == null ? '—' : formatTime(state.firstLeftMs);
      }

      function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
        const seconds = String(totalSeconds % 60).padStart(2, '0');
        return `${minutes}:${seconds}`;
      }

      function startTimer() {
        state.startTime = performance.now();
        timerEl.textContent = '00:00';
        timerInterval = setInterval(() => {
          if (!state.sessionActive) return;
          const now = performance.now();
          state.elapsedMs = now - state.startTime;
          timerEl.textContent = formatTime(state.elapsedMs);
        }, 200);
      }

      function stopTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
        if (state.startTime) {
          state.elapsedMs = performance.now() - state.startTime;
          timerEl.textContent = formatTime(state.elapsedMs);
        }
      }

      function randomBetween(min, max) {
        return Math.random() * (max - min) + min;
      }

      function spawnStars() {
        const config = difficulties[state.difficulty];
        state.leftTotal = config.perSide;
        state.rightTotal = config.perSide;
        state.remaining = config.perSide * 2;
        updateHUD();
        const createStar = (side, index) => {
          const [minX, maxX] = config.spreadX[side];
          const [minZ, maxZ] = config.spreadZ;
          const position = `${randomBetween(minX, maxX)} ${config.y + randomBetween(-0.02, 0.02)} ${randomBetween(minZ, maxZ)}`;
          const rotation = `0 0 ${randomBetween(-20, 20)}`;
          const star = document.createElement('a-image');
          star.setAttribute('src', '#starTexture');
          star.setAttribute('width', config.scale);
          star.setAttribute('height', config.scale);
          star.setAttribute('position', position);
          star.setAttribute('rotation', rotation);
          star.classList.add('clickable');
          const id = `${side}-${index}-${Math.floor(Math.random() * 9999)}`;
          star.dataset.side = side;
          star.dataset.starId = id;
          star.setAttribute('animation__bob', `property: position; dir: alternate; dur: ${900 + Math.random() * 500}; easing: easeInOutSine; loop: true; to: ${position.split(' ').map((val, idx) => idx === 1 ? (parseFloat(val) + 0.05).toFixed(3) : val).join(' ')}`);
          star.addEventListener('click', onStarClick, { once: true });
          starContainer.appendChild(star);
        };
        for (let i = 0; i < config.perSide; i++) {
          createStar('left', i);
          createStar('right', i);
        }
        state.starsSpawned = true;
        startTimer();
        startBtn.textContent = 'In progress…';
        hintText.innerHTML = 'Targets active — collect all stars!';
        downloadBtn.disabled = true;
      }

      function onStarClick(evt) {
        const star = evt.target;
        const side = star.dataset.side;
        const id = star.dataset.starId;
        const now = performance.now();
        const elapsed = now - state.startTime;
        if (side === 'left') {
          state.leftFound += 1;
          if (state.firstLeftMs == null) {
            state.firstLeftMs = elapsed;
          }
        } else {
          state.rightFound += 1;
        }
        state.remaining -= 1;
        updateHUD();
        star.setAttribute('animation__pop', 'property: scale; to: 1.4 1.4 1.4; dir: alternate; dur: 120; easing: easeOutQuad');
        setTimeout(() => star.remove(), 140);
        state.events.push({
          timestamp: Date.now(),
          side,
          id,
          elapsed,
          leftFound: state.leftFound,
          rightFound: state.rightFound,
          leftTotal: state.leftTotal,
          rightTotal: state.rightTotal,
          firstLeftMs: state.firstLeftMs
        });
        if (state.remaining <= 0) {
          completeSession();
        }
      }

      function completeSession() {
        state.sessionActive = false;
        stopTimer();
        hintText.innerHTML = 'Complete — download CSV';
        downloadBtn.disabled = state.events.length === 0;
        startBtn.disabled = false;
        startBtn.textContent = 'Start session';
      }

      function resetSession(soft = false) {
        state.sessionActive = false;
        state.starsSpawned = false;
        state.startTime = null;
        state.elapsedMs = 0;
        state.leftFound = 0;
        state.rightFound = 0;
        state.leftTotal = 0;
        state.rightTotal = 0;
        state.remaining = 0;
        state.firstLeftMs = null;
        state.events = [];
        stopTimer();
        timerEl.textContent = '00:00';
        updateHUD();
        firstLeftEl.textContent = '—';
        downloadBtn.disabled = true;
        startBtn.disabled = false;
        startBtn.textContent = 'Start session';
        hintText.innerHTML = soft ? 'Session reset — point at the marker.' : 'Point at the Hiro marker…';
        Array.from(starContainer.children).forEach(child => child.remove());
      }

      function startSession() {
        resetSession(true);
        state.difficulty = document.querySelector('input[name="difficulty"]:checked').value;
        state.sessionActive = true;
        startBtn.disabled = true;
        startBtn.textContent = 'Waiting for marker…';
        if (state.markerVisible) {
          spawnStars();
        } else {
          hintText.innerHTML = 'Align marker to begin (auto once found).';
        }
      }

      function ensureUserGesture() {
        const provideGesture = () => {
          scene.emit('user-gesture');
        };
        document.addEventListener('touchend', provideGesture, { once: true });
        document.addEventListener('mousedown', provideGesture, { once: true });
      }

      function exportCSV() {
        if (!state.events.length) return;
        const header = 'timestamp_ms,side,id,elapsed_total_ms,left_found,right_found,left_total,right_total,time_to_first_left_ms';
        const rows = state.events.map(evt => [
          evt.timestamp,
          evt.side,
          evt.id,
          Math.round(evt.elapsed),
          evt.leftFound,
          evt.rightFound,
          evt.leftTotal,
          evt.rightTotal,
          evt.firstLeftMs == null ? '' : Math.round(evt.firstLeftMs)
        ].join(','));
        const csv = [header, ...rows].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const stamp = new Date().toISOString().replace(/[:T]/g, '-').split('.')[0];
        link.href = url;
        link.download = `ar-neglect-session-${stamp}.csv`;
        document.body.appendChild(link);
        link.click();
        setTimeout(() => {
          URL.revokeObjectURL(url);
          link.remove();
        }, 1000);
      }

      function init() {
        ensureUserGesture();
        hintToast.hidden = false;
        downloadBtn.addEventListener('click', exportCSV);
        startBtn.addEventListener('click', startSession);
        resetBtn.addEventListener('click', () => resetSession());
        exitBtn.addEventListener('click', () => location.reload());
        document.querySelectorAll('#difficultyPicker input').forEach(input => {
          input.addEventListener('change', () => {
            state.difficulty = input.value;
          });
        });
        marker.addEventListener('markerFound', () => {
          state.markerVisible = true;
          hintText.innerHTML = 'Marker found ✓';
          if (state.sessionActive && !state.starsSpawned) {
            spawnStars();
            startBtn.textContent = 'In progress…';
          }
        });
        marker.addEventListener('markerLost', () => {
          state.markerVisible = false;
          if (state.sessionActive) {
            hintText.innerHTML = 'Marker lost — hold steady / move closer';
          } else {
            hintText.innerHTML = 'Point at the Hiro marker…';
          }
        });
      }

      function revealScene() {
        hud.hidden = false;
        scene.style.display = 'block';
        primer.hidden = true;
      }

      async function requestCamera() {
        statusLine.textContent = 'Requesting camera access…';
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: { ideal: 'environment' },
              width: { ideal: 1280 },
              height: { ideal: 720 }
            },
            audio: false
          });
          stream.getTracks().forEach(track => track.stop());
          streamPrimed = true;
          statusLine.textContent = 'Camera enabled — loading AR';
          revealScene();
        } catch (err) {
          console.error(err);
          statusLine.textContent = 'Camera failed. Use Chrome, then allow via lock icon ▸ Site settings ▸ Camera: Allow.';
          primer.querySelector('button#enableCamera').textContent = 'Retry camera';
        }
      }

      enableCameraBtn.addEventListener('click', () => {
        requestCamera();
      });
      dismissPrimerBtn.addEventListener('click', () => {
        revealScene();
      });

      scene.addEventListener('loaded', () => {
        if (streamPrimed) {
          revealScene();
        }
      });

      window.addEventListener('DOMContentLoaded', init);
    })();
  </script>
</body>
</html>
